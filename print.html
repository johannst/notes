<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Notes</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-56e69066.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-7892c6d7.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Notes</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/johannst/notes" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="notes"><a class="header" href="#notes">Notes</a></h1>
<p>A personal collection of notes and cheatsheets.</p>
<p>Source code is located at <a href="https://github.com/johannst/notes">johannst/notes</a>.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="shells"><a class="header" href="#shells">Shells</a></h1>
<ul>
<li><a href="#zsh1">zsh</a></li>
<li><a href="#bash1">bash</a></li>
<li><a href="#fish1">fish</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="zsh1"><a class="header" href="#zsh1">zsh(1)</a></h1>
<h2 id="keybindings"><a class="header" href="#keybindings">Keybindings</a></h2>
<p>Change input mode:</p>
<pre><code class="language-zsh">bindkey -v              change to vi keymap
bindkey -e              change to emacs keymap
</code></pre>
<p>Define key-mappings:</p>
<pre><code class="language-zsh">bindkey                 list mappings in current keymap
bindkey in-str cmd      create mapping for `in-str` to `cmd`
bindkey -r in-str       remove binding for `in-str`

# C-v &lt;key&gt;             dump &lt;key&gt; code, which can be used in `in-str`
# zle -l                list all functions for keybindings
# man zshzle(1)         STANDARD WIDGETS: get description of functions
</code></pre>
<p>Access edit buffer in zle widget:</p>
<pre><code class="language-zsh">$BUFFER       # Entire edit buffer content
$LBUFFER      # Edit buffer content left to cursor
$RBUFFER      # Edit buffer content right to cursor

# create zle widget which adds text right of the cursor
function add-text() {
    RBUFFER="some text $RBUFFER"
}
zle -N add-text

bindkey "^p" add-text
</code></pre>
<h2 id="parameter"><a class="header" href="#parameter">Parameter</a></h2>
<p>Default value:</p>
<pre><code class="language-zsh"># default value
echo ${foo:-defval}   # defval
foo=bar
echo ${foo:-defval}   # bar
</code></pre>
<p>Alternative value:</p>
<pre><code class="language-zsh">echo ${foo:+altval}   # ''
foo=bar
echo ${foo:+altval}   # altval
</code></pre>
<p>Check variable set, error if not set:</p>
<pre><code class="language-zsh">echo ${foo:?msg}      # print `msg` and return errno `1`
foo=bar
echo ${foo:?msg}      # bar
</code></pre>
<p>Sub-string <code>${var:offset:length}</code>:</p>
<pre><code class="language-zsh">foo=abcdef
echo ${foo:1:3}       # bcd
</code></pre>
<p>Trim prefix <code>${var#prefix}</code>:</p>
<pre><code class="language-zsh">foo=bar.baz
echo ${foo#bar}       # .baz
</code></pre>
<p>Trim suffix <code>${var%suffix}</code>:</p>
<pre><code class="language-zsh">foo=bar.baz
echo ${foo%.baz}      # bar
</code></pre>
<p>Substitute pattern <code>${var/pattern/replace}</code>:</p>
<pre><code class="language-zsh">foo=aabbccbbdd
echo ${foo/bb/XX}    # aaXXccbbdd
echo ${foo//bb/XX}   # aaXXccXXdd
# replace prefix
echo ${foo/#bb/XX}   # aabbccbbdd
echo ${foo/#aa/XX}   # XXbbccbbdd
# replace suffix
echo ${foo/%bb/XX}   # aabbccbbdd
echo ${foo/%dd/XX}   # aabbccbbXX
</code></pre>
<blockquote>
<p>Note: <code>prefix</code>/<code>suffix</code>/<code>pattern</code> are expanded as pathnames.</p>
</blockquote>
<h2 id="variables"><a class="header" href="#variables">Variables</a></h2>
<pre><code class="language-zsh"># Variable with local scope
local var=val

# Read-only variable
readonly var=bal
</code></pre>
<p>Indexed arrays:</p>
<pre><code class="language-zsh">arr=(aa bb cc dd)
echo $arr[1]           # aa
echo $arr[-1]          # dd

arr+=(ee)
echo $arr[-1]          # ee

echo $arr[1,3]         # aa bb cc
</code></pre>
<p>Associative arrays:</p>
<pre><code class="language-zsh">typeset -A arr
arr[x]='aa'
arr[y]='bb'
echo $arr[x]           # aa
</code></pre>
<p>Tied arrays:</p>
<pre><code class="language-zsh">typeset -T VEC vec=(1 2 3) '|'

echo $vec              # 1 2 3
echo $VEC              # 1|2|3
</code></pre>
<p>Unique arrays (set):</p>
<pre><code>typeset -U vec=(1 2 3)

echo $vec             # 1 2 3
vec+=(1 2 4)
echo $vec             # 1 2 3 4
</code></pre>
<h3 id="expansion-flags"><a class="header" href="#expansion-flags">Expansion Flags</a></h3>
<p>Join array to string <code>j:sep:</code>:</p>
<pre><code class="language-zsh">foo=(1 2 3 4)
echo ${(j:-:)foo}     # 1-2-3-4
echo ${(j:\n:)foo}    # join with new lines
</code></pre>
<p>Split string to array <code>s:sep</code>:</p>
<pre><code class="language-zsh">foo='1-2-3-4'
bar=(${(s:-:)foo})    # capture as array
echo $bar             # 1 2 3 4
echo $bar[2]          # 2
</code></pre>
<p>Upper/Lower case string:</p>
<pre><code class="language-zsh">foo=aaBB
echo ${(L)foo}        # aabb
echo ${(U)foo}        # AABB
</code></pre>
<p>Key/values in associative arrays:</p>
<pre><code class="language-zsh">typeset -A vec; vec[a]='aa'; vec[b]='bb'

echo ${(k)vec}        # a b
echo ${(v)vec}        # aa bb
echo ${(kv)vec}       # a aa b bb

# Iterate over key value pairs.
for k v in ${(kv)vec)}; do ...; done
</code></pre>
<h2 id="io-redirections"><a class="header" href="#io-redirections">I/O redirections</a></h2>
<p>See <a href="#io-redirection">bash - I/O redirection</a></p>
<h2 id="process-substitution"><a class="header" href="#process-substitution">Process substitution</a></h2>
<p>Process substitution allows to redirect the stdout of multiple processes at
once.</p>
<pre><code class="language-bash">vim -d &lt;(grep foo bar) &lt;(grep foo moose)
</code></pre>
<h2 id="argument-parsing-with-zparseopts"><a class="header" href="#argument-parsing-with-zparseopts">Argument parsing with <code>zparseopts</code></a></h2>
<pre><code class="language-zsh">zparseopts [-D] [-E] [-A assoc] specs
</code></pre>
<p>Arguments are copied into the associative array <code>assoc</code> according to <code>specs</code>.
Each spec is described by an entry as <code>opt[:][=array]</code>.</p>
<ul>
<li><code>opt</code> is the option without the <code>-</code> char. Passing <code>-f</code> is matched against <code>f</code>
opt, <code>--long</code> is matched against <code>-long</code>.</li>
<li>Using <code>:</code> means the option will take an argument.</li>
<li>The optional <code>=array</code> specifies an alternate storage container where this
option should be stored.</li>
</ul>
<blockquote>
<p>Documentation can be found in <code>man zshmodules</code>.</p>
</blockquote>
<h3 id="example"><a class="header" href="#example">Example</a></h3>
<pre><code class="language-zsh">#!/bin/zsh
function test() {
    zparseopts -D -E -A opts f=flag o: -long:
    echo "flag $flag"
    echo "o    $opts[-o]"
    echo "long $opts[--long]"
    echo "pos  $1"
}

test -f -o OPTION --long LONG_OPT POSITIONAL

# Outputs:
#   flag -f
#   o    OPTION
#   long LONG_OPT
#   pos  POSITIONAL
</code></pre>
<h2 id="regular-expressions"><a class="header" href="#regular-expressions">Regular Expressions</a></h2>
<p>Zsh supports regular expression matching with the binary operator <code>=~</code>.
The match results can be accessed via the <code>$MATCH</code> variable and
<code>$match</code> indexed array:</p>
<ul>
<li><code>$MATCH</code> contains the full match</li>
<li><code>$match[1]</code> contains match of the first capture group</li>
</ul>
<pre><code class="language-zsh">INPUT='title foo : 1234'
REGEX='^title (.+) : ([0-9]+)$'
if [[ $INPUT =~ $REGEX ]]; then
    echo "$MATCH"       # title foo : 1234
    echo "$match[1]"    # foo
    echo "$match[2]"    # 1234
fi
</code></pre>
<h2 id="trap-handling"><a class="header" href="#trap-handling">Trap Handling</a></h2>
<pre><code class="language-zsh">trap "&lt;CMDs&gt;" &lt;SIG&gt;/EXIT

# Show current trap handler.
trap -p
# List signal names.
trap -l
</code></pre>
<h4 id="example-run-handler-only-on-error-exit"><a class="header" href="#example-run-handler-only-on-error-exit">Example: Run handler only on error exit</a></h4>
<pre><code class="language-zsh">trap 'test $? -ne 0 &amp;&amp; echo "run exit trap"' EXIT

# -&gt; no print
exit 0
# -&gt; print
exit 1
</code></pre>
<h4 id="example-mutex-in-shell-script"><a class="header" href="#example-mutex-in-shell-script">Example: Mutex in shell script</a></h4>
<p>For example if a script is triggered in unsynchronized, we may want to ensure
that a single script instance runs.</p>
<pre><code class="language-zsh"># open file=LOCK with fd=100
exec 100&gt;LOCK
# take exclusive lock, wait maximal for 3600s
flock -w 3600 -x 100 || { echo "flock timeout"; exit 1; }

# eg automatically release lock when script exits
trap "flock -u 100" EXIT
</code></pre>
<h2 id="completion"><a class="header" href="#completion">Completion</a></h2>
<h3 id="installation"><a class="header" href="#installation">Installation</a></h3>
<p>Completion functions are provided via files and need to be placed in a location
covered by <code>$fpath</code>. By convention the completion files are names as <code>_&lt;CMD&gt;</code>.</p>
<p>A completion skeleton for the command <code>foo</code>, stored in <code>_foo</code></p>
<pre><code class="language-zsh">#compdef _foo foo

function _foo() {
    ...
}
</code></pre>
<p>Alternatively one can install a completion function explicitly by calling <code>compdef &lt;FUNC&gt; &lt;CMD&gt;</code>.</p>
<h3 id="completion-variables"><a class="header" href="#completion-variables">Completion Variables</a></h3>
<p>Following variables are available in Completion functions:</p>
<pre><code class="language-zsh">$words              # array with command line in words
$#words             # number words
$CURRENT            # index into $words for cursor position
$words[CURRENT-1]   # previous word (relative to cursor position)
</code></pre>
<h3 id="completion-functions"><a class="header" href="#completion-functions">Completion Functions</a></h3>
<ul>
<li><code>_describe</code>     simple completion, just words + description</li>
<li><code>_arguments</code>    sophisticated completion, allow to specify actions</li>
</ul>
<h4 id="completion-with-_describe"><a class="header" href="#completion-with-_describe">Completion with <a href="http://zsh.sourceforge.net/Doc/Release/Completion-System.html#Completion-Functions"><code>_describe</code></a></a></h4>
<pre><code class="language-zsh">_describe MSG COMP
</code></pre>
<ul>
<li><code>MSG</code> simple string with header message</li>
<li><code>COMP</code> array of completions where each entry is <code>"opt:description"</code></li>
</ul>
<pre><code class="language-zsh">function _foo() {
    local -a opts
    opts=('bla:desc for bla' 'blu:desc for blu')
    _describe 'foo-msg' opts
}
compdef _foo foo

foo &lt;TAB&gt;&lt;TAB&gt;
 -- foo-msg --
bla  -- desc for bla
blu  -- desc for blu
</code></pre>
<h4 id="completion-with-_arguments"><a class="header" href="#completion-with-_arguments">Completion with <a href="http://zsh.sourceforge.net/Doc/Release/Completion-System.html#Completion-Functions"><code>_arguments</code></a></a></h4>
<pre><code class="language-zsh">_arguments SPEC [SPEC...]
</code></pre>
<p>where <code>SPEC</code> can have one of the following forms:</p>
<ul>
<li><code>OPT[DESC]:MSG:ACTION</code> for option flags</li>
<li><code>N:MSG:ACTION</code> for positional arguments</li>
</ul>
<p>Available actions</p>
<pre><code class="language-zsh">(op1 op2)   list possible matches
-&gt;VAL       set $state=VAL and continue, `$state` can be checked later in switch case
FUNC        call func to generate matches
{STR}       evaluate `STR` to generate matches
</code></pre>
<h3 id="example-1"><a class="header" href="#example-1">Example</a></h3>
<p>Skeleton to copy/paste for writing simple completions.</p>
<p>Assume a program <code>foo</code> with the following interface:</p>
<pre><code class="language-zsh">foo -c green|red|blue -s low|high -f &lt;file&gt; -d &lt;dir&gt; -h
</code></pre>
<p>The completion handler could be implemented as follows in a file called <code>_foo</code>:</p>
<pre><code class="language-zsh">#compdef _foo foo

function _foo_color() {
    local colors=()
    colors+=('green:green color')
    colors+=('red:red color')
    colors+=('blue:blue color')
    _describe "color" colors
}

function _foo() {
    _arguments                              \
        "-c[define color]:color:-&gt;s_color"  \
        "-s[select sound]:sound:(low high)" \
        "-f[select file]:file:_files"       \
        "-d[select dir]:dir:_files -/"      \
        "-h[help]"

    case $state in
        s_color) _foo_color;;
    esac
}
</code></pre>
<h3 id="example-with-optional-arguments"><a class="header" href="#example-with-optional-arguments">Example with optional arguments</a></h3>
<p>For this example we assume that the command <code>foo</code> takes at least three optional
arguments such as</p>
<pre><code class="language-zsh">foo arg1 arg2 arg3 [argN..]
</code></pre>
<pre><code class="language-zsh">function _foo() {
    _arguments              \
        "1:opt 1:(a b c)"   \
        ":opt next:(d e f)" \
        "*:opt all:(u v w)"
}
</code></pre>
<p>Explanation:</p>
<ul>
<li><code>1:MSG:ACTION</code> sets completion for the <strong>first</strong> optional argument</li>
<li><code>:MSG:ACTION</code> sets completion for the <strong>next</strong> optional argument</li>
<li><code>*:MSG:ACTION</code> sets completion for the optional argument where none of the
previous rules apply, so in our example for <code>arg3, argN..</code>.</li>
</ul>
<blockquote>
<p><code>_files</code> is a zsh builtin utility function to complete files/dirs see</p>
<ul>
<li><a href="http://zsh.sourceforge.net/Doc/Release/Completion-System.html#Completion-Functions">zsh completion functions</a></li>
<li><a href="https://github.com/zsh-users/zsh-completions/blob/master/zsh-completions-howto.org#utility-functions">zsh completion utility functions</a></li>
</ul>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="bash1"><a class="header" href="#bash1">bash(1)</a></h1>
<h2 id="expansion"><a class="header" href="#expansion">Expansion</a></h2>
<h3 id="generator"><a class="header" href="#generator">Generator</a></h3>
<pre><code class="language-bash"># generate sequence from n to m
{n..m}
# generate sequence from n to m step by s
{n..m..s}

# expand cartesian product
{a,b}{c,d}
</code></pre>
<h3 id="parameter-1"><a class="header" href="#parameter-1">Parameter</a></h3>
<pre><code class="language-bash"># default value
bar=${foo:-some_val}  # if $foo set, then bar=$foo else bar=some_val

# alternate value
bar=${foo:+bla $foo}  # if $foo set, then bar="bla $foo" else bar=""

# check param set
bar=${foo:?msg}  # if $foo set, then bar=$foo else exit and print msg

# indirect
FOO=foo
BAR=FOO
bar=${!BAR}  # deref value of BAR -&gt; bar=$FOO

# prefix
${foo#prefix}  # remove prefix when expanding $foo
# suffix
${foo%suffix}  # remove suffix when expanding $foo

# substitute
${foo/pattern/string}  # replace pattern with string when expanding foo
# pattern starts with
# '/'   replace all occurences of pattern
# '#'   pattern match at beginning
# '%'   pattern match at end

# set programmatically with priintf builtin
printf -v "VAR1" "abc"
NAME=VAR2
printf -v "$NAME" "%s" "def"
</code></pre>
<blockquote>
<p>Note: <code>prefix</code>/<code>suffix</code>/<code>pattern</code> are expanded as <a href="#pathname">pathnames</a>.</p>
</blockquote>
<h3 id="array"><a class="header" href="#array">Array</a></h3>
<pre><code class="language-bash"># Fill array.
FOO=(a b c)
FOO+=(d)

# Read values at index.
echo ${FOO[0]}
# a
echo ${FOO[2]}
# c
echo ${FOO[-1]}
# d

# Get all values.
echo ${FOO[@]}
# a b c d

# Number of elements.
echo ${#FOO[@]}
# 4

# Generate indexes for array.
echo ${!FOO[@]}
0 1 2 3

# mapfile builtin (read file into array)

# default delimiter is newline
mapfile FOO &lt; &lt;(echo -e "AA\nBB\nCC")
echo ${FOO[1]}
# BB

# different delimiter
mapfile -d ' ' FOO &lt; &lt;(echo "AA BB CC")
echo ${FOO[1]}
# BB

# For example, read column from tabulated data.
mapfile BAR &lt; &lt;(echo -e "a1 a2\nb1 b2\nc1 c2" | awk '{ print  $2 }')
echo ${BAR[@]}
# a2 b2 c2
</code></pre>
<h3 id="pathname"><a class="header" href="#pathname">Pathname</a></h3>
<pre><code class="language-bash">*           match any string
?           match any single char
\\          match backslash
[abc]       match any char of 'a' 'b' 'c'
[a-z]       match any char between 'a' - 'z'
[^ab]       negate, match all not 'a' 'b'
[:class:]   match any char in class, available:
              alnum,alpha,ascii,blank,cntrl,digit,graph,lower,
              print,punct,space,upper,word,xdigit
</code></pre>
<p>With <code>extglob</code> shell option enabled it is possible to have more powerful
patterns. In the following <code>pattern-list</code> is one ore more patterns separated
by <code>|</code> char.</p>
<pre><code class="language-bash">?(pattern-list)   matches zero or one occurrence of the given patterns
*(pattern-list)   matches zero or more occurrences of the given patterns
+(pattern-list)   matches one or more occurrences of the given patterns
@(pattern-list)   matches one of the given patterns
!(pattern-list)   matches anything except one of the given patterns
</code></pre>
<blockquote>
<p>Note: <code>shopt -s extglob</code>/<code>shopt -u extglob</code> to enable/disable <code>extglob</code>
option.</p>
</blockquote>
<h2 id="heredoc"><a class="header" href="#heredoc">Heredoc</a></h2>
<p>One can also use a different delimiter for the heredoc than `EOF.</p>
<pre><code class="language-bash"># Heredoc with variable substitution.
cat &lt;&lt;EOF
foobar
$HOME
EOF

# Heredoc without variable substitution.
cat &lt;&lt;"EOF"
foobar
$HOME
EOF
</code></pre>
<p>One can also build an output pipeline and redirect the output.</p>
<pre><code class="language-bash">cat &lt;&lt;EOF | grep -v '^#' &gt; foo.txt
#foobar
$HOME
EOF
</code></pre>
<p>Prefixing the delimiter with <code>-</code> has the effect that the heredoc removes any
training <strong>tab</strong> character (no whitespace).</p>
<pre><code class="language-bash"># Heredoc without variable substitution.
	cat &lt;&lt;-EOF
	$HOME
	EOF
</code></pre>
<h2 id="io-redirection"><a class="header" href="#io-redirection">I/O redirection</a></h2>
<blockquote>
<p>Note: The trick with bash I/O redirection is to interpret from left-to-right.</p>
</blockquote>
<pre><code class="language-bash"># stdout &amp; stderr to file
command &gt;file 2&gt;&amp;1
# equivalent
command &amp;&gt;file

# stderr to stdout &amp; stdout to file
command 2&gt;&amp;1 &gt;file
</code></pre>
<blockquote>
<p>The article <a href="https://catonmat.net/bash-one-liners-explained-part-three">Bash One-Liners Explained, Part III: All about
redirections</a>
contains some nice visualization to explain bash redirections.</p>
</blockquote>
<h3 id="explanation"><a class="header" href="#explanation">Explanation</a></h3>
<pre><code class="language-bash">j&gt;&amp;i
</code></pre>
<p>Duplicate <code>fd i</code> to <code>fd j</code>, making <code>j</code> a copy of <code>i</code>. See <a href="http://man7.org/linux/man-pages/man2/dup.2.html">dup2(2)</a>.</p>
<p>Example:</p>
<pre><code class="language-bash">command 2&gt;&amp;1 &gt;file
</code></pre>
<ol>
<li>duplicate <code>fd 1</code> to <code>fd 2</code>, effectively redirecting <code>stderr</code> to <code>stdout</code></li>
<li>redirect <code>stdout</code> to <code>file</code></li>
</ol>
<h2 id="process-substitution-ref"><a class="header" href="#process-substitution-ref">Process substitution (<a href="https://tldp.org/LDP/abs/html/process-sub.html">ref</a>)</a></h2>
<p>Process substitution allows to redirect the stdout of multiple processes at
once.</p>
<pre><code class="language-bash">vim -d &lt;(grep foo bar) &lt;(grep foo moose)
</code></pre>
<h2 id="command-grouping"><a class="header" href="#command-grouping">Command grouping</a></h2>
<p>Execute commands in a group with or without subshell. Can be used to easily
redirect stdout/stderr of all commands in the group into one file.</p>
<pre><code class="language-bash"># Group commands without subshell.
v=abc ; { v=foo; echo $v; } ; echo $v
# foo
# foo

# Group commands with subshell.
v=abc ; ( v=foo; echo $v; ) ; echo $v
# foo
# abc
</code></pre>
<h2 id="trap-handling-1"><a class="header" href="#trap-handling-1">Trap Handling</a></h2>
<pre><code class="language-bash">trap "&lt;CMDs&gt;" &lt;SIG&gt;

# Show current trap handler.
trap -p
# List signal names.
trap -l

# Run commands on exit.
trap "&lt;CMDs&gt;" EXIT
# Run commands on any error.
trap "&lt;CMDs&gt;" ERR
</code></pre>
<h4 id="example-run-handler-only-on-error-exit-1"><a class="header" href="#example-run-handler-only-on-error-exit-1">Example: Run handler only on error exit</a></h4>
<pre><code class="language-bash">trap 'test $? -ne 0 &amp;&amp; echo "run exit trap"' EXIT

# -&gt; no print
exit 0
# -&gt; print
exit 1
</code></pre>
<h4 id="example-mutex-in-shell-script-1"><a class="header" href="#example-mutex-in-shell-script-1">Example: Mutex in shell script</a></h4>
<p>For example if a script is triggered in unsynchronized, we may want to ensure
that a single script instance runs.</p>
<pre><code class="language-bash"># open file=LOCK with fd=100
exec 100&gt;LOCK
# take exclusive lock, wait maximal for 3600s
flock -w 3600 -x 100 || { echo "flock timeout"; exit 1; }

# eg automatically release lock when script exits
trap "flock -u 100" EXIT
</code></pre>
<h4 id="example-run-handler-only-on-error-exit-1-1"><a class="header" href="#example-run-handler-only-on-error-exit-1-1">Example: Run handler only on error exit</a></h4>
<pre><code class="language-bash"># eg use LINENO to print line number where error occured
trap 'ec=$?; echo "error at $LINENO"; exit $ec' ERR

true
# Error handled, will not trap.
false || :
# Error, will trap.
false
</code></pre>
<h2 id="argument-parsing-with-getopts"><a class="header" href="#argument-parsing-with-getopts">Argument parsing with <code>getopts</code></a></h2>
<p>The <code>getopts</code> builtin uses following global variables:</p>
<ul>
<li><code>OPTARG</code>, value of last option argument</li>
<li><code>OPTIND</code>, index of the next argument to process (user must reset)</li>
<li><code>OPTERR</code>, display errors if set to <code>1</code></li>
</ul>
<pre><code class="language-bash">getopts &lt;optstring&gt; &lt;param&gt; [&lt;args&gt;]
</code></pre>
<ul>
<li><code>&lt;optstring&gt;</code> specifies the names of supported options, eg <code>f:c</code>
<ul>
<li><code>f:</code> means <code>-f</code> option with an argument</li>
<li><code>c</code> means <code>-c</code> option without an argument</li>
</ul>
</li>
<li><code>&lt;param&gt;</code> specifies a variable name which <code>getopts</code> fills with the last parsed option argument</li>
<li><code>&lt;args&gt;</code> optionally specify argument string to parse, by default <code>getopts</code> parses <code>$@</code></li>
</ul>
<h3 id="example-2"><a class="header" href="#example-2">Example</a></h3>
<pre><code class="language-bash">#!/bin/bash
function parse_args() {
    while getopts "f:c" PARAM; do
        case $PARAM in
            f) echo "GOT -f $OPTARG";;
            c) echo "GOT -c";;
            *) echo "ERR: print usage"; exit 1;;
        esac
    done
    # users responsibility to reset OPTIND
    OPTIND=1
}

parse_args -f xxx -c
parse_args -f yyy
</code></pre>
<h2 id="regular-expressions-1"><a class="header" href="#regular-expressions-1">Regular Expressions</a></h2>
<p>Bash supports regular expression matching with the binary operator <code>=~</code>.
The match results can be accessed via the <code>$BASH_REMATCH</code> variable:</p>
<ul>
<li><code>${BASH_REMATCH[0]}</code> contains the full match</li>
<li><code>${BASH_REMATCH[1]}</code> contains match of the first capture group</li>
</ul>
<pre><code class="language-bash">INPUT='title foo : 1234'
REGEX='^title (.+) : ([0-9]+)$'
if [[ $INPUT =~ $REGEX ]]; then
    echo "${BASH_REMATCH[0]}"    # title foo : 1234
    echo "${BASH_REMATCH[1]}"    # foo
    echo "${BASH_REMATCH[2]}"    # 1234
fi
</code></pre>
<blockquote>
<p><strong>Caution</strong>: When specifying a <code>regex</code> in the <code>[[ ]]</code> block directly, quotes will be treated as part of the pattern.
<code>[[ $INPUT =~ "foo" ]]</code> will match against <code>"foo"</code> not <code>foo</code>!</p>
</blockquote>
<h2 id="completion-1"><a class="header" href="#completion-1">Completion</a></h2>
<p>The <code>complete</code> builtin is used to interact with the completion system.</p>
<pre><code class="language-bash">complete                    # print currently installed completion handler
complete -F &lt;func&gt; &lt;cmd&gt;    # install &lt;func&gt; as completion handler for &lt;cmd&gt;
complete -r &lt;cmd&gt;           # uninstall completion handler for &lt;cmd&gt;
</code></pre>
<p>Variables available in completion functions:</p>
<pre><code class="language-bash"># in
$1              # &lt;cmd&gt;
$2              # current word
$3              # privous word

COMP_WORDS      # array with current command line words
COMP_CWORD      # index into COMP_WORDS with current cursor position

# out
COMPREPLY       # array with possible completions
</code></pre>
<p>The <code>compgen</code> builtin is used to generate possible matches by comparing <code>word</code>
against words generated by <code>option</code>.</p>
<pre><code class="language-bash">compgen &lt;option&gt; &lt;word&gt;

# usefule options:
# -W &lt;list&gt;    specify list of possible completions
# -d           generate list with dirs
# -f           generate list with files
# -u           generate list with users
# -e           generate list with exported variables

# compare "f" against words "foo" "foobar" "bar" and generate matches
compgen -W "foo foobar bar" "f"

# compare "hom" against file/dir names and generate matches
compgen -d -f "hom"
</code></pre>
<h3 id="example-1-1"><a class="header" href="#example-1-1">Example</a></h3>
<p>Skeleton to copy/paste for writing simple completions.</p>
<p>Assume a program <code>foo</code> with the following interface:</p>
<pre><code class="language-bash">foo -c green|red|blue -s low|high -f &lt;file&gt; -h
</code></pre>
<p>The completion handler could be implemented as follows:</p>
<pre><code class="language-bash">function _foo() {
    local curr=$2
    local prev=$3

    local opts="-c -s -f -h"
    case $prev in
        -c) COMPREPLY=( $(compgen -W "green red blue" -- $curr) );;
        -s) COMPREPLY=( $(compgen -W "low high" -- $curr) );;
        -f) COMPREPLY=( $(compgen -f -- $curr) );;
        *)  COMPREPLY=( $(compgen -W "$opts" -- $curr) );;
    esac
}

complete -F _foo foo
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="fish1"><a class="header" href="#fish1">fish(1)</a></h1>
<h2 id="quick-info"><a class="header" href="#quick-info">Quick Info</a></h2>
<p>Fish initialization file <code>~/.config/fish/config.fish</code></p>
<p>Switch between different key bindings:</p>
<ul>
<li><code>fish_default_key_bindings</code> to use default key bindings</li>
<li><code>fish_vi_key_bindings</code> to use vi key bindings</li>
</ul>
<h2 id="variables-1"><a class="header" href="#variables-1">Variables</a></h2>
<p>Available scopes</p>
<ul>
<li><code>local</code> variable local to a block</li>
<li><code>global</code> variable global to shell instance</li>
<li><code>universal</code> variable universal to all shell instances + preserved across
shell restart</li>
</ul>
<h3 id="setunset-variables"><a class="header" href="#setunset-variables">Set/Unset Variables</a></h3>
<pre><code class="language-text">set &lt;name&gt; [&lt;values&gt;]
    -l  local scope
    -g  global scope
    -U  universal scope
    -e  erase variable
    -S  show verbose info
    -x  export to ENV
    -u  unexport from ENV
</code></pre>
<h3 id="special-variables-ref"><a class="header" href="#special-variables-ref">Special Variables <a href="https://fishshell.com/docs/current/language.html#special-variables">ref</a></a></h3>
<pre><code class="language-sh">$status      # exit code of last command
$pipestatus  # list of exit codes of pipe chain

$fish_pid    # pid of parent fish shell    ($$ in bash)
$last_pid    # pid of last started process ($! in bash)

$CMD_DURATION   # runtime of last command in ms
</code></pre>
<h3 id="lists"><a class="header" href="#lists">Lists</a></h3>
<p>In <code>fish</code> all variables are lists (start with index <code>1</code>, but lists can’t
contain lists.</p>
<pre><code class="language-sh">set foo a b c d

echo $foo[1]      # a
echo $foo[-1]     # d
echo $foo[2..3]   # b c
echo $foo[1 3]    # a c
</code></pre>
<p><code>$</code> can be seen as dereference operator.</p>
<pre><code class="language-sh">set foo a; set a 1337
echo $$foo  # outputs 1337
</code></pre>
<p>Cartesian product.</p>
<pre><code class="language-sh">echo file.{h,cc}
# file.h file.cc

echo {a,b}{1,2}
# a1 b1 a2 b2
</code></pre>
<h4 id="path-ref"><a class="header" href="#path-ref"><code>*PATH</code> <a href="https://fishshell.com/docs/current/language.html#path-variables">ref</a></a></h4>
<p>Lists ending with <code>PATH</code> are automatically split at <code>:</code> when used and joined
with <code>:</code> when quoted or exported to the environment.</p>
<pre><code class="language-sh">set -x BLA_PATH a:b:c:d
echo $BLA_PATH           # a b c d
echo "$BLA_PATH"         # a:b:c:d          (quoted)
env | grep BLA_PATH      # BLA_PATH=a:b:c:d (env)

set FOO_PATH x y z
echo $FOO_PATH           # x y z
echo "$FOO_PATH"         # x:y:z
</code></pre>
<h2 id="command-handling"><a class="header" href="#command-handling">Command Handling</a></h2>
<pre><code class="language-sh"># sub-commands are not run in quotes
echo "ls output: "(ls)
</code></pre>
<h3 id="io-redirection-1"><a class="header" href="#io-redirection-1">I/O redirection</a></h3>
<pre><code class="language-sh"># 'noclobber', fail if 'log' already exists
echo foo &gt;? log
</code></pre>
<h3 id="process-substitution-1"><a class="header" href="#process-substitution-1">Process substitution</a></h3>
<p>Redirect output of multiple processes. Same as <code>&lt;(..)</code> in bash.</p>
<pre><code class="language-sh">diff (sort a | psub) (sort b | psub)
</code></pre>
<h2 id="control-flow"><a class="header" href="#control-flow">Control Flow</a></h2>
<h3 id="if--else"><a class="header" href="#if--else"><code>if</code> / <code>else</code></a></h3>
<pre><code class="language-sh">if grep foo bar
    # do sth
else if grep foobar bar
    # do sth else
else
    # do sth else
end
</code></pre>
<h3 id="switch"><a class="header" href="#switch"><code>switch</code></a></h3>
<pre><code class="language-sh">switch (echo foo)
case 'foo*'
    # do start with foo
case bar dudel
    # do bar and dudel
case '*'
    # do else
end
</code></pre>
<h3 id="while-loop"><a class="header" href="#while-loop"><code>while</code> Loop</a></h3>
<pre><code class="language-sh">while true
    echo foo
end
</code></pre>
<h3 id="for-loop"><a class="header" href="#for-loop"><code>for</code> Loop</a></h3>
<pre><code class="language-sh">for f in (ls)
    echo $f
end
</code></pre>
<h2 id="functions"><a class="header" href="#functions">Functions</a></h2>
<p>Function arguments are passed via <code>$argv</code> list.</p>
<pre><code class="language-sh">function fn_foo
    echo $argv
end
</code></pre>
<h3 id="autoloading"><a class="header" href="#autoloading">Autoloading</a></h3>
<p>When running a command fish attempts to autoload a function. The shell looks
for <code>&lt;cmd&gt;.fish</code> in the locations defined by <code>$fish_function_path</code> and loads
the function lazily if found.</p>
<p>This is the preferred way over monolithically defining all functions in a
startup script.</p>
<h3 id="helper"><a class="header" href="#helper">Helper</a></h3>
<pre><code class="language-sh">functions         # list al functions
functions foo     # describe function 'foo'
functions -e foo  # erase function 'foo'

funced foo        # edit function 'foo'
                  # '-e vim' to edit in vim
</code></pre>
<h3 id="argument-parsing-and-completion"><a class="header" href="#argument-parsing-and-completion">Argument parsing and completion</a></h3>
<p><code>argparse</code> puts options into variables of name <code>_flag_NAME</code>.</p>
<p>References:</p>
<ul>
<li><a href="https://fishshell.com/docs/current/language.html#argument-handling">Argument Handling</a></li>
<li><a href="https://fishshell.com/docs/current/cmds/argparse.html"><code>argparse</code></a></li>
<li><a href="https://fishshell.com/docs/current/completions.html">Writing your own completions</a></li>
<li><a href="https://fishshell.com/docs/current/cmds/complete.html"><code>complete</code></a></li>
</ul>
<pre><code class="language-sh">function moose --d "my moose fn"
    # h/help   : short / long option (boolean)
    # color    : only long option (boolean)
    # u/user=  : option with required argument, only last specified is taken
    # f/file+= : option with required argument, can be specified multiple times
    #
    argparse h/help color= u/user= f/file=+ -- $argv
    or return

    if set -ql _flag_help
        echo "usage ..."
        return 0
    end

    set -ql _flag_file
    and echo "file=$_flag_file | cnt:" (count $_flag_file)

    set -ql _flag_color
    and echo "color=$_flag_color"

    set -ql _flag_user
    and echo "user=$_flag_user"
end

# Delete all previous defined completions for 'moose'.
complete -c moose -e

# Don't complete files for command.
complete -c moose --no-files

# Help completion.
#   -n specifies a conditions. The completion is only active if the command
#      returns 0.
complete -c moose -s h -l help -n "not __fish_contains_opt -s h help" \
    --description "Print usage help and exit"

# File completion.
#   -F force complete files (overwrite --no-files).
#   -r requires argument.
complete -c moose -s f -l file -F -r \
    --description "Specify file (can be passed multiple times)"

# Color completion.
#    -a options for completion.
#    -x short for -r and --no-files (-f)
complete -c moose -x -l color -a "red blue" \
    --description "Specify a color."

# User completion.
#    -a options for completion. Call a function to generate arguments.
complete -c moose -x -s u -l user -a "(__fish_complete_users)" \
    --description "Specify a user"
</code></pre>
<h2 id="prompt"><a class="header" href="#prompt">Prompt</a></h2>
<p>The prompt is defined by the output of the <code>fish_prompt</code> function.</p>
<pre><code class="language-sh">function fish_prompt
    set -l cmd_ret
    echo "&gt; "(pwd) $cmd_ret" "
end
</code></pre>
<blockquote>
<p>Use <code>set_color</code> to manipulate terminal colors and <code>set_color -c</code> to print the
current colors.</p>
</blockquote>
<h2 id="useful-builtins"><a class="header" href="#useful-builtins">Useful Builtins</a></h2>
<p>List all builtins with <code>builtins -n</code>.</p>
<pre><code class="language-sh"># history
history search &lt;str&gt;   # search history for &lt;str&gt;
history merge          # merge histories from fish sessions

# list
count $var             # count elements in list

contains /bin $PATH    # return 0 (true) 1 (false)
contains -i /bin $PATH # additionally print index on stdout

# string
string split SEP STRING

# math
math -b hex 4096       # output dec as hex
math 0x1000            # output hex as dec
math "log2(1024)"      # call functions
math -s0 7/3           # integer division (by default float)

# status
status -f              # abs path of current file
</code></pre>
<h2 id="keymaps"><a class="header" href="#keymaps">Keymaps</a></h2>
<pre><code class="language-text">  Shift-Tab .............. tab-completion with search
  Alt-Up / Alt-Down ...... search history with token under the cursor
  Alt-l .................. list content of dir under cursor
  Alt-p .................. append '2&gt;&amp;1 | less;' to current cmdline
  Alt-Left / Alt - Right . prevd / nextd, walk dir history
</code></pre>
<h2 id="debug"><a class="header" href="#debug">Debug</a></h2>
<pre><code class="language-text">  status print-stack-trace .. prints function stacktrace (can be used in scripts)
  breakpoint ................ halt script execution and gives shell (C-d | exit
                              to continue)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="cli-foo"><a class="header" href="#cli-foo">CLI foo</a></h1>
<ul>
<li><a href="#awk1">awk</a></li>
<li><a href="#cut1">cut</a></li>
<li><a href="#sed1">sed</a></li>
<li><a href="#column1">column</a></li>
<li><a href="#sort1">sort</a></li>
<li><a href="#tr1">tr</a></li>
<li><a href="#tac1">tac</a></li>
<li><a href="#rev1">rev</a></li>
<li><a href="#paste1">paste</a></li>
<li><a href="#xargs1">xargs</a></li>
<li><a href="#grep1">grep</a></li>
<li><a href="#find1">find</a></li>
<li><a href="#dd1">dd</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="awk1"><a class="header" href="#awk1">awk(1)</a></h1>
<pre><code class="language-markdown">awk [opt] program [input]
    -F &lt;sepstr&gt;        field separator string (can be regex)
    program            awk program
    input              file or stdin if not file given
</code></pre>
<h2 id="input-processing"><a class="header" href="#input-processing">Input processing</a></h2>
<p>Input is processed in two stages:</p>
<ol>
<li>Splitting input into a sequence of <code>records</code>.
By default split at <code>newline</code> character, but can be changed via the
builtin <code>RS</code> variable.</li>
<li>Splitting a <code>record</code> into <code>fields</code>. By default strings without <code>whitespace</code>,
but can be changed via the builtin variable <code>FS</code> or command line option
<code>-F</code>.</li>
</ol>
<p>Fields are accessed as follows:</p>
<ul>
<li><code>$0</code> whole <code>record</code></li>
<li><code>$1</code> field one</li>
<li><code>$2</code> field two</li>
<li>…</li>
</ul>
<h2 id="program"><a class="header" href="#program">Program</a></h2>
<p>An <code>awk</code> program is composed of pairs of the form:</p>
<pre><code class="language-markdown">pattern { action }
</code></pre>
<p>The program is run against each <code>record</code> in the input stream. If a <code>pattern</code>
matches a <code>record</code> the corresponding <code>action</code> is executed and can access the
<code>fields</code>.</p>
<pre><code class="language-markdown">INPUT
  |
  v
record ----&gt; ∀ pattern matched
  |                   |
  v                   v
fields ----&gt; run associated action
</code></pre>
<p>Any valid awk <code>expr</code> can be a <code>pattern</code>.</p>
<p>An example is the regex pattern <code>/abc/ { print $1 }</code> which prints the first
field if the record matches the regex <code>/abc/</code>. This form is actually a short
version for <code>$0 ~ /abc/ { print $1 }</code>, see the regex comparison operator
below.</p>
<h3 id="special-pattern"><a class="header" href="#special-pattern">Special pattern</a></h3>
<p>awk provides two special patterns, <code>BEGIN</code> and <code>END</code>, which can be used
multiple times. Actions with those patterns are <strong>executed exactly once</strong>.</p>
<ul>
<li><code>BEGIN</code> actions are run before processing the first record</li>
<li><code>END</code> actions are run after processing the last record</li>
</ul>
<h3 id="special-variables"><a class="header" href="#special-variables">Special variables</a></h3>
<ul>
<li><code>RS</code> <em>record separator</em>: first char is the record separator, by default
<code>&lt;newline&gt;</code></li>
<li><code>FS</code> <em>field separator</em>: regex to split records into fields, by default
<code>&lt;space&gt;</code></li>
<li><code>NR</code> <em>number record</em>: number of current record</li>
<li><code>NF</code> <em>number fields</em>: number of fields in the current record</li>
</ul>
<h3 id="special-statements--functions"><a class="header" href="#special-statements--functions">Special statements &amp; functions</a></h3>
<ul>
<li>
<p><code>printf "fmt", args...</code></p>
<p>Print format string, args are comma separated.</p>
<ul>
<li><code>%s</code> string</li>
<li><code>%d</code> decimal</li>
<li><code>%x</code> hex</li>
<li><code>%f</code> float</li>
</ul>
<p>Width can be specified as <code>%Ns</code>, this reserves <code>N</code> chars for a string.
For floats one can use <code>%N.Mf</code>, <code>N</code> is the total number including <code>.</code> and
<code>M</code>.</p>
</li>
<li>
<p><code>sprintf("fmt", expr, ...)</code></p>
<p>Format the expressions according to the format string. Similar as <code>printf</code>,
but this is a function and return value can be assigned to a variable.</p>
</li>
<li>
<p><code>strftime("fmt")</code></p>
<p>Print time stamp formatted by <code>fmt</code>.</p>
<ul>
<li><code>%Y</code> full year (eg 2020)</li>
<li><code>%m</code> month (01-12)</li>
<li><code>%d</code> day (01-31)</li>
<li><code>%F</code> alias for <code>%Y-%m-%d</code></li>
<li><code>%H</code> hour (00-23)</li>
<li><code>%M</code> minute (00-59)</li>
<li><code>%S</code> second (00-59)</li>
<li><code>%T</code> alias for <code>%H:%M:%S</code></li>
</ul>
</li>
<li>
<p><code>S ~ R</code>, <code>S !~ R</code></p>
<p>The regex comparison operator, where the former returns true if the string
<code>S</code> matches the regex <code>R</code>, and the latter is the negated form.
The regex can be either a
<a href="https://www.gnu.org/software/gawk/manual/html_node/Regexp-Usage.html">constant</a>
or <a href="https://www.gnu.org/software/gawk/manual/html_node/Computed-Regexps.html">dynamic</a>
regex.</p>
</li>
</ul>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<h3 id="filter-records"><a class="header" href="#filter-records">Filter records</a></h3>
<pre><code class="language-bash">awk 'NR%2 == 0 { print $0 }' &lt;file&gt;
</code></pre>
<p>The pattern <code>NR%2 == 0</code> matches every second record and the action <code>{ print $0 }</code>
prints the whole record.</p>
<h3 id="negative-patterns"><a class="header" href="#negative-patterns">Negative patterns</a></h3>
<pre><code class="language-bash">awk '!/^#/ { print $1 }' &lt;file&gt;
</code></pre>
<p>Matches records not starting with <code>#</code>.</p>
<h3 id="range-patterns"><a class="header" href="#range-patterns">Range patterns</a></h3>
<pre><code class="language-bash">echo -e "a\nFOO\nb\nc\nBAR\nd" | \
    awk '/FOO/,/BAR/ { print }'
</code></pre>
<p><code>/FOO/,/BAR/</code> define a range pattern of <code>begin_pattern, end_pattern</code>. When
<code>begin_pattern</code> is matched the range is <strong>turned on</strong> and when the
<code>end_pattern</code> is matched the range is <strong>turned off</strong>. This matches every record
in the range <em>inclusive</em>.</p>
<p>An <em>exclusive</em> range must be handled explicitly, for example as follows.</p>
<pre><code class="language-bash">echo -e "a\nFOO\nb\nc\nBAR\nd" | \
    awk '/FOO/,/BAR/ { if (!($1 ~ "FOO") &amp;&amp; !($1 ~ "BAR")) { print } }'
</code></pre>
<h3 id="access-last-fields-in-records"><a class="header" href="#access-last-fields-in-records">Access last fields in records</a></h3>
<pre><code class="language-bash">echo 'a b c d e f' | awk '{ print $NF $(NF-1) }'
</code></pre>
<p>Access last fields with arithmetic on the <code>NF</code> number of fields variable.</p>
<h3 id="split-on-multiple-tokens"><a class="header" href="#split-on-multiple-tokens">Split on multiple tokens</a></h3>
<pre><code class="language-bash">echo 'a,b;c:d' | awk -F'[,;:]' '{ printf "1=%s | 4=%s\n", $1, $4 }'
</code></pre>
<p>Use regex as field separator.</p>
<h3 id="capture-in-variables"><a class="header" href="#capture-in-variables">Capture in variables</a></h3>
<pre><code class="language-bash"># /proc/&lt;pid&gt;/status
#   Name:    cat
#   ...
#   VmRSS:   516 kB
#   ...

for f in /proc/*/status; do
    cat $f | awk '
             /^VmRSS/ { rss = $2/1024 }
             /^Name/ { name = $2 }
             END { printf "%16s %6d MB\n", name, rss }';
done | sort -k2 -n
</code></pre>
<p>We capture values from <code>VmRSS</code> and <code>Name</code> into variables and print them at the
<code>END</code> once processing all records is done.</p>
<h3 id="capture-in-array"><a class="header" href="#capture-in-array">Capture in array</a></h3>
<pre><code class="language-bash">echo 'a 10
b 2
b 4
a 1' | awk '{
    vals[$1] += $2
    cnts[$1] += 1
}
END {
    for (v in vals)
        printf "%s %d\n", v, vals[v] / cnts [v]
}'
</code></pre>
<p>Capture keys and values from different columns and some up the values.
At the <code>END</code> we compute the average of each key.</p>
<h3 id="run-shell-command-and-capture-output"><a class="header" href="#run-shell-command-and-capture-output">Run shell command and capture output</a></h3>
<pre><code class="language-bash">cat /proc/1/status | awk '
                     /^Pid/ {
                        "ps --no-header -o user " $2 | getline user;
                         print user
                     }'
</code></pre>
<p>We build a <code>ps</code> command line and capture the first line of the processes output
in the <code>user</code> variable and then print it.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="cut1"><a class="header" href="#cut1">cut(1)</a></h1>
<pre><code class="language-sh"># Remove sections from each line of files(s).
cut OPT FILE [FILE]
    -d DELIM     delimiter to tokenize
    -f LIST      field selector
    -c LIST      character selector
</code></pre>
<h2 id="example-only-selected-characters"><a class="header" href="#example-only-selected-characters">Example: only selected characters</a></h2>
<pre><code class="language-sh">echo 'aa bb cc dd' | cut -c "1-4"
# aa b

# Inverted selection.
echo 'aa bb cc dd' | cut --complement -c "1-4"
# b cc dd
</code></pre>
<h2 id="example-only-selected-fields"><a class="header" href="#example-only-selected-fields">Example: only selected fields</a></h2>
<p>Fields in <code>cut</code> are indexed starting from <code>1</code> rather than <code>0</code>.</p>
<pre><code class="language-sh"># Fields 2 until 3.
echo 'aa bb cc dd' | cut -d ' ' -f 2-3
# bb cc

# First field until the 2nd.
echo 'aa bb cc dd' | cut -d ' ' -f -2
# aa bb

# Third field until the end.
echo 'aa bb cc dd' | cut -d ' ' -f 3-
# cc dd

# If the number of tokens in a line is unkown but we want to remove the last 2
# tokens we can use rev(1).
echo 'aa bb cc dd' | rev | cut -d ' ' -f3- | rev
# aa bb
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="sed1"><a class="header" href="#sed1">sed(1)</a></h1>
<pre><code>sed [opts] [script] [file]
  opts:
    -i          edit file in place
    -i.bk       edit file in place and create backup file
                (with .bk suffix, can be specified differently)
    -n          quite, dont print by default
    --follow-symlinks
                follow symlinks when editing in place
    -e SCRIPT   add SCRIPT to commands to be executed
                (can be specified multiple times)
    -f FILE     add content of FILE to command to be executed

    --debug     annotate program execution
</code></pre>
<h2 id="examples-1"><a class="header" href="#examples-1">Examples</a></h2>
<h3 id="extract-range-of-lines"><a class="header" href="#extract-range-of-lines">Extract range of lines</a></h3>
<pre><code># Print lines between pattern bb and dd (inclusive).
echo -e 'aa\nbb\ncc\ndd\nee' | sed -n '/bb/,/dd/p'
# bb
# cc
# dd
</code></pre>
<h3 id="delete-lines"><a class="header" href="#delete-lines">Delete lines</a></h3>
<pre><code class="language-sh"># Delete two lines.
echo -e 'aa\nbb\ncc\ndd' | sed '1d;3d'
# bb
# dd

# Delete last ($) line.
echo -e 'aa\nbb\ncc\ndd' | sed '$d'
# aa
# bb
# cc

# Delete range of lines.
echo -e 'aa\nbb\ncc\ndd' | sed '1,3d'
# dd

# Delete lines matching pattern.
echo -e 'aa\nbb\ncc\ndd' | sed '/bb/d'
# aa
# cc
# dd

# Delete lines NOT matching pattern.
echo -e 'aa\nbb\ncc\ndd' | sed '/bb/!d'
# bb
</code></pre>
<h3 id="insert-lines"><a class="header" href="#insert-lines">Insert lines</a></h3>
<pre><code class="language-sh"># Insert before line.
echo -e 'aa\nbb' | sed '2iABC'
# aa
# ABC
# bb

# Insert after line.
echo -e 'aa\nbb' | sed '2aABC'
# aa
# bb
# ABC

# Replace line.
echo -e 'aa\nbb' | sed '2cABC'
# aa
# ABC

# Insert before pattern match.
echo -e 'aa\nbb' | sed '/bb/i 123'
# aa
# 123
# bb
</code></pre>
<h3 id="substitute-lines"><a class="header" href="#substitute-lines">Substitute lines</a></h3>
<pre><code class="language-sh"># Substitute by regex.
echo -e 'aafooaa\ncc' | sed 's/foo/MOOSE/'
# aaMOOSEaa
# cc
</code></pre>
<h3 id="multiple-scripts"><a class="header" href="#multiple-scripts">Multiple scripts</a></h3>
<pre><code class="language-sh">echo -e 'foo\nbar' | sed -e 's/foo/FOO/' -e 's/FOO/BAR/'
# BAR
# bar
</code></pre>
<h3 id="edit-inplace-through-symlink"><a class="header" href="#edit-inplace-through-symlink">Edit inplace through symlink</a></h3>
<pre><code class="language-sh">touch file
ln -s file link
ls -l link
# lrwxrwxrwx 1 johannst johannst 4 Feb  7 23:02 link -&gt; file

sed -i --follow-symlinks '1iabc' link
ls -l link
# lrwxrwxrwx 1 johannst johannst 4 Feb  7 23:02 link -&gt; file

sed -i '1iabc' link
ls -l link
# -rw-r--r-- 1 johannst johannst 0 Feb  7 23:02 link
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="column1"><a class="header" href="#column1">column(1)</a></h1>
<h2 id="examples-2"><a class="header" href="#examples-2">Examples</a></h2>
<pre><code class="language-sh"># Show as table (aligned columns), with comma as delimiter from stdin.
echo -e 'a,b,c\n111,22222,33' | column -t -s ','

# Show file as table.
column -t -s ',' test.csv
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="sort1"><a class="header" href="#sort1">sort(1)</a></h1>
<pre><code>sort [opts] [file]
  opts:
    -r      reverse output
    -b      ignore leading blanks

    -n      sort by numeric
    -h      sort by human numeric
    -V      sort by version

    -k&lt;N&gt;  sort by Nth key
    -t&lt;S&gt;  field separator
</code></pre>
<h2 id="examples-3"><a class="header" href="#examples-3">Examples</a></h2>
<pre><code class="language-sh"># Sort by directory sizes.
du -sh * | sort -h
</code></pre>
<pre><code class="language-sh"># Sort numeric by second key.
# The default key separator is non-blank to blank transition.
echo 'a 4
d 10
c 21' | sort -k2 -n

# Sort numeric by second key, split at comma.
echo 'a,4
d,10
c,21' | sort -k2 -n -t,
</code></pre>
<blockquote>
<p>Use <code>--debug</code> to annotate part of the line used to sort and hence debug the key usage.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="tr1"><a class="header" href="#tr1">tr(1)</a></h1>
<pre><code>tr [opt] str1 [str2]
    -d      delete characters in str1
    -s      squeeze repeating sequence of characters in str1
</code></pre>
<h2 id="examples-4"><a class="header" href="#examples-4">Examples</a></h2>
<h3 id="to-lower"><a class="header" href="#to-lower">To lower</a></h3>
<pre><code class="language-sh">echo MoOsE | tr '[:upper:]' '[:lower:]'
# output: moose
</code></pre>
<h3 id="replace-characters"><a class="header" href="#replace-characters">Replace characters</a></h3>
<pre><code class="language-sh">echo moose | tr 'o' '-'
# output: m--se

echo moose | tr 'os' '-'
# output: m---e
</code></pre>
<h3 id="remove-specific-characters"><a class="header" href="#remove-specific-characters">Remove specific characters</a></h3>
<pre><code class="language-sh">echo moose | tr -d 'o'
# output: mse

echo moose | tr -d 'os'
# output: me
</code></pre>
<h3 id="squeeze-character-sequences"><a class="header" href="#squeeze-character-sequences">Squeeze character sequences</a></h3>
<pre><code class="language-sh">echo moooooossse | tr -s 'os'
# output: mose
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="tac1"><a class="header" href="#tac1">tac(1)</a></h1>
<pre><code class="language-sh"># Reverse output lines of file(s) and concatenate (reverse of cat).
tac FILE [FILE]

echo -e 'a1\nb2\nc3\nd4' | tac
# d4
# c3
# b2
# a1
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="rev1"><a class="header" href="#rev1">rev(1)</a></h1>
<pre><code class="language-sh"># Reverse each line of file(s), character by character.
rev FILE [FILE]

echo -e '123\nabc' | rev
# 321
# cba
</code></pre>
<h2 id="example-remove-the-last-2-tokens-with-unknown-length"><a class="header" href="#example-remove-the-last-2-tokens-with-unknown-length">Example: remove the last 2 tokens with unknown length</a></h2>
<pre><code class="language-sh"># If the number of tokens in a line is unkown but we want to remove the last 2
# tokens we can use rev(1).
echo 'aa bb cc dd' | rev | cut -d ' ' -f3- | rev
# aa bb
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="paste1"><a class="header" href="#paste1">paste(1)</a></h1>
<pre><code># Concatenate input files linewise and join them by a TAB char.

paste FILE [FILE]
    -d CHAR     delimiter to join each line
</code></pre>
<h1 id="examples-5"><a class="header" href="#examples-5">Examples</a></h1>
<pre><code class="language-sh"># Read two files.
paste &lt;(echo -e 'a1\na2') &lt;(echo -e 'b1\nb2')
a1	b1
a2	b2

# Can read from stdin.
echo -e 'a1 a2\nb1 b2\nc1 c2\nd1 d2' | paste - -
# a1 a2	b1 b2
# c1 c2	d1 d2
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="xargs1"><a class="header" href="#xargs1">xargs(1)</a></h1>
<pre><code>xargs [opts] [cmd [init-args]]
    -l [&lt;num&gt;]   maximal number of lines per cmd invocation
                 if &lt;num&gt; it not provided, num=1 is assumed
    -I &lt;str&gt;     replace &lt;str&gt; in the [init-args] with the arg;
                 this implies -l, and hence processes one arg at a time
</code></pre>
<h2 id="example-3"><a class="header" href="#example-3">Example</a></h2>
<p>Collect arguments and prefix them with another option.</p>
<pre><code class="language-sh"># Using -l to process one arg at a time.
eval strace -f (find /dev -name 'std*' | xargs -l echo -P | xargs) ls

# Using -I to place the arg at the specified location.
eval strace -f (find /dev -name 'std*' | xargs -I {} echo -P {}) ls

# Both commands achieve the same thing and result in something like:
#   eval strace -f -P /dev/stdin -P /dev/stdout -P /dev/stderr ls
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="grep1"><a class="header" href="#grep1">grep(1)</a></h1>
<pre><code>grep [opts] [pattern] [files]
    -e &lt;pattern&gt;        pattern to search for (can be supplied multiple times)
    -i                  ignore case in patterns
    -v                  invert match

    -n                  add line numbers to matched lines
    -H                  add file name to matched lines

    -r                  recursively read all files
    -I                  skip binary files
    --include &lt;glob&gt;    search only files matching glob
    --exclude &lt;glob&gt;    skip searching files matching glob

    -c                  count occurrence of matched patterns
    -l                  list only file name which contain the pattern
</code></pre>
<blockquote>
<p><code>&lt;glob&gt;</code> patterns may need to be quoted or escaped if the shell also does glob expansion.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="find1"><a class="header" href="#find1">find(1)</a></h1>
<pre><code>find &lt;start&gt; [opts]
    -maxdepth &lt;n&gt;        maximally search n dirs deep
    -type &lt;t&gt;            match on file type
                           f    regular file
                           d    directory
    -user &lt;name&gt;         list files owned by username
    -name &lt;glob&gt;         list files matching glob (only filename)
    -iname &lt;glob&gt;        list files matching glob case-insensitive

    -exec &lt;cmd&gt; {} ;     run cmd on each file
    -exec &lt;cmd&gt; {} +     run cmd with all files as argument
</code></pre>
<blockquote>
<p>Depending on the shell the <code>&lt;glob&gt;</code> must be quoted or escaped. The
exec modifier characters <code>;</code> and <code>+</code> also may need to be escaped.</p>
</blockquote>
<h3 id="example--exec-option"><a class="header" href="#example--exec-option">Example <code>-exec</code> option</a></h3>
<pre><code class="language-sh">&gt; find . -maxdepth 1 -type d -exec echo x {} \;
# x .
# x ./.github
# x ./book
# x ./src
# x ./.git
# x ./docs

&gt; find . -maxdepth 1 -type d -exec echo x {} +
# x . ./.github ./book ./src ./.git ./docs
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="dd1"><a class="header" href="#dd1">dd(1)</a></h1>
<p>Copy data <code>block-wise</code>.</p>
<pre><code>dd [opts]
    if=&lt;path&gt;         input file to read (stdin in case not specified)
    of=&lt;path&gt;         oputput file to write
    status=progress   show progress while copying
    bs=&lt;bytes&gt;        block size
    count=&lt;n&gt;         copy only &lt;n&gt; blocks
    skip=&lt;n&gt;          skip &lt;n&gt; blocks in input (seek input)
    seek=&lt;n&gt;          skip &lt;n&gt; blocks in oputput (seek output)
    conv=&lt;conv&gt;
         notrunc      dont truncate output file
         excl         fail if output already exists
         nocreat      fail if output does not exists
</code></pre>
<h2 id="example-bootstick"><a class="header" href="#example-bootstick">Example: bootstick</a></h2>
<pre><code class="language-bash">dd bs=4M if=&lt;iso&gt; of=&lt;blkdev&gt; oflag=sync status=progress
</code></pre>
<h2 id="example-patch-file-in-place"><a class="header" href="#example-patch-file-in-place">Example: patch file in place</a></h2>
<pre><code class="language-bash"># Create a 1024 bytes file filled with zeros.
dd if=/dev/zero of=disk bs=512 count=2

# Overwrite 4 bytes starting at byte 0.
printf "aaaa" | dd of=disk bs=1 seek=0 conv=notrunc

# Overwrite 4 bytes starting at byte 512.
printf "bbbb" | dd of=disk bs=1 seek=512 conv=notrunc

hexdump disk
# 0000000 6161 6161 0000 0000 0000 0000 0000 0000
# 0000010 0000 0000 0000 0000 0000 0000 0000 0000
# *
# 0000200 6262 6262 0000 0000 0000 0000 0000 0000
# 0000210 0000 0000 0000 0000 0000 0000 0000 0000
# *
# 0000400
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="tools"><a class="header" href="#tools">Tools</a></h1>
<ul>
<li><a href="#tmux1">tmux</a></li>
<li><a href="#screen1">screen</a></li>
<li><a href="#emacs1">emacs</a></li>
<li><a href="#gpg1">gpg</a></li>
<li><a href="#radare21">radare2</a></li>
<li><a href="#qemu1">qemu</a></li>
<li><a href="#pacman1">pacman</a></li>
<li><a href="#dot1">dot</a></li>
<li><a href="#ffmpeg-1">ffmpeg</a></li>
<li><a href="#gnuplot-1">gnuplot</a></li>
<li><a href="#restic1">restic</a></li>
<li><a href="#qrencode1">qrencode</a></li>
<li><a href="#poppler">poppler</a></li>
<li><a href="#nix">nix</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="tmux1"><a class="header" href="#tmux1">tmux(1)</a></h1>
<p>Terminology:</p>
<ul>
<li><code>session</code> is a collection of pseudo terminals which can have multiple
<code>windows</code></li>
<li><code>window</code> uses the entire screen and can be split into rectangular <code>panes</code></li>
<li><code>pane</code> is a single pseudo terminal instance</li>
</ul>
<h1 id="tmux-cli"><a class="header" href="#tmux-cli">Tmux cli</a></h1>
<pre><code class="language-markdown"># Session
tmux                        creates new session
tmux ls                     list running sessions
tmux kill-session -t &lt;s&gt;    kill running session &lt;s&gt;
tmux attach -t &lt;s&gt; [-d]     attach to session &lt;s&gt;, detach other clients [-d]
tmux detach -s &lt;s&gt;          detach all clients from session &lt;s&gt;

# Environment
tmux showenv -g             show global tmux environment variables
tmux setenv -g &lt;var&gt; &lt;val&gt;  set variable in global tmux env

# Misc
tmux source-file &lt;file&gt;     source config &lt;file&gt;
tmux lscm                   list available tmux commnds
tmux show -g                show global tmux options
tmux display &lt;msg&gt;          display message in tmux status line
</code></pre>
<h2 id="scripting"><a class="header" href="#scripting">Scripting</a></h2>
<pre><code class="language-markdown"># Session
tmux list-sessions -F '#S'           list running sessions, only IDs

# Window
tmux list-windows -F '#I' -t &lt;s&gt;     list window IDs for session &lt;s&gt;
tmux selectw -t &lt;s&gt;:&lt;w&gt;              select window &lt;w&gt; in session &lt;s&gt;

# Pane
tmux list-panes -F '#P' -t &lt;s&gt;:&lt;w&gt;   list pane IDs for window &lt;w&gt; in session &lt;s&gt;
tmux selectp -t &lt;s&gt;:&lt;w&gt;.&lt;p&gt;          select pane &lt;p&gt; in window &lt;w&gt; in session &lt;s&gt;

# Run commands
tmux send -t &lt;s&gt;:&lt;w&gt;.&lt;p&gt; "ls" C-m    send cmds/keys to pane
tmux run -t &lt;p&gt; &lt;sh-cmd&gt;             run shell command &lt;sh-cmd&gt; in background and report output on pane -t &lt;p&gt;
</code></pre>
<p>For example cycle through all panes in all windows in all sessions:</p>
<pre><code class="language-bash"># bash
for s in $(tmux list-sessions -F '#S'); do
    for w in $(tmux list-windows -F '#I' -t $s); do
        for p in $(tmux list-panes -F '#P' -t $s:$w); do
            echo $s:$w.$p
        done
    done
done
</code></pre>
<h1 id="bindings"><a class="header" href="#bindings">Bindings</a></h1>
<pre><code class="language-markdown">prefix d    detach from current session
prefix c    create new window
prefix w    open window list
prefix $    rename session
prefix ,    rename window
prefix .    move current window
</code></pre>
<p>Following bindings are specific to my <a href="https://github.com/johannst/dotfiles/blob/master/tmux.conf"><code>tmux.conf</code></a>:</p>
<pre><code class="language-markdown">C-s         prefix

# Panes
prefix s    horizontal split
prefix v    vertical split
prefix f    toggle maximize/minimize current pane

# Movement
prefix Tab  toggle between window

prefix h    move to pane left
prefix j    move to pane down
prefix k    move to pane up
prefix l    move to pane right

# Resize
prefix C-h  resize pane left
prefix C-j  resize pane down
prefix C-k  resize pane up
prefix C-l  resize pane right

# Copy/Paste
prefix C-v    enter copy mode
prefix C-p    paste yanked text
prefix C-b    open copy-buffer list

# In Copy Mode
v     enable visual mode
y     yank selected text
</code></pre>
<h1 id="command-mode"><a class="header" href="#command-mode">Command mode</a></h1>
<p>To enter command mode <code>prefix :</code>.</p>
<p>Some useful commands are:</p>
<pre><code class="language-markdown">setw synchronize-panes on/off       enables/disables synchronized input to all panes
list-keys -t vi-copy                list keymaps for vi-copy mode
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="screen1"><a class="header" href="#screen1">screen(1)</a></h1>
<pre><code class="language-sh"># Create new session.
screen

# List active session.
screen -list

# Attach to specific session.
screen -r SESSION
</code></pre>
<h2 id="options"><a class="header" href="#options">Options</a></h2>
<pre><code class="language-sh"># Enable logfile, default name screenlog.0.
screen -L
# Enable log and set logfile name.
screen -L -Logfile out.txt
</code></pre>
<h2 id="keymaps-1"><a class="header" href="#keymaps-1">Keymaps</a></h2>
<pre><code class="language-sh">Ctrl-A d            # Detach from session.
Ctrl-A + \          # Terminate session.
Ctrl-A + :          # Open cmand prompt.
    kill            # Kill session.
</code></pre>
<h2 id="examples-6"><a class="header" href="#examples-6">Examples</a></h2>
<p>USB serial console.</p>
<pre><code class="language-sh"># 1500000 -&gt; baudrate
# cs8     -&gt; 8 data bits
# -cstopb -&gt; 1 stop bit
# -parenb -&gt; no parity bit
# see stty(1) for all settings.
screen /dev/ttyUSB0 1500000,cs8,-cstopb,-parenb

# Print current tty settings.
sudo stty -F /dev/ttyUSB0 -a
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="emacs1"><a class="header" href="#emacs1">emacs(1)</a></h1>
<h2 id="help"><a class="header" href="#help">help</a></h2>
<pre><code class="language-markdown">  C-h ?         list available help modes
  C-h e         show message output (`*Messages*` buffer)
  C-h f         describe function
  C-h v         describe variable
  C-h w         describe which key invoke function (where-is)
  C-h c &lt;KEY&gt;   print command bound to &lt;KEY&gt;
  C-h k &lt;KEY&gt;   describe command bound to &lt;KEY&gt;
  C-h b         list buffer local key-bindings
  C-h F         show emacs manual for command/function
  &lt;kseq&gt; C-h    list possible key-bindings with &lt;kseq&gt;
                eg C-x C-h -&gt; list key-bindings beginning with C-x
</code></pre>
<h2 id="package-manager"><a class="header" href="#package-manager">package manager</a></h2>
<pre><code class="language-markdown">  key    fn                          description
------------------------------------------------
         package-refresh-contents    refresh package list
         package-list-packages       list available/installed packages
                                     `U x` to mark packages for Upgrade &amp; eXecute
</code></pre>
<h2 id="window"><a class="header" href="#window">window</a></h2>
<pre><code class="language-markdown">  key      fn                      description
----------------------------------------------
  C-x 0    delete-window           kill focused window
  C-x 1    delete-other-windows    kill all other windows
  C-x 2    split-window-below      split horizontal
  C-x 3    split-window-right      split vertical
  C-x o    other-window            other window (cycle)

  C-x r w  window-configuration-to-register
                                   save window configuration in a register
                                   (use C-x r j to jump to the windows config again)
  C-x w d toggle-window-dedicated  toggles windows dedicated state
                                   (dedicated windows cant be reused by display functions)
</code></pre>
<h2 id="minibuffer"><a class="header" href="#minibuffer">minibuffer</a></h2>
<pre><code class="language-markdown">  key            description
----------------------------
  M-e            enter edit minibuffer edit mode

  M-up           focus previous completion
  M-down         focus next completion
  M-ret          select focused completion
</code></pre>
<h2 id="buffer"><a class="header" href="#buffer">buffer</a></h2>
<pre><code class="language-markdown">  key        fn                   description
---------------------------------------------
  C-x C-q    read-only-mode       toggle read-only mode for buffer
  C-x k      kill-buffer          kill buffer
  C-x s      save-some-buffers    save buffer
  C-x w      write-file           write buffer (save as)
  C-x b      switch-to-buffer     switch buffer
  C-x C-b    list-buffers         buffer list
  C-x x r    rename-buffer        renames a buffer (allows multiple shell, compile, grep, .. buffers)
</code></pre>
<h2 id="ibuffer"><a class="header" href="#ibuffer">ibuffer</a></h2>
<p>Builtin advanced buffer selection mode</p>
<pre><code class="language-markdown">  key        fn            description
--------------------------------------
             ibuffer       enter buffer selection

  h                        ibuffer help

  d                        mark for deletion
  x                        kill buffers marked for deletion

  o                        open buffer in other window
  C-o                      open buffer in other window keep focus in ibuffer

  O                        occur on marked buffers
  Q                        query-replace in marked buffers
  I                        query-replace-regexp in marked buffers

  s a                      sort by buffer name
  s f                      sort by file name
  s v                      sort by last viewed
  s v                      sort by major mode
  ,                        cycle sorting mode

  =                        compare buffer against file on disk (if file is dirty `*`)

  /m                       filter by major mode
  /n                       filter by buffer name
  /f                       filter by file name
  /i                       filter by modified buffers
  /E                       filter by process buffers
  //                       remove all filter

  /g                       create filter group
  /\                       remove all filter groups
</code></pre>
<h2 id="goto-navigation"><a class="header" href="#goto-navigation">goto navigation</a></h2>
<pre><code class="language-markdown">  key      fn                description
----------------------------------------
  M-g g    goto-line         go to line
  M-g M-n  next-error        go to next error (grep, xref, compilation, ...)
  M-g M-p  previous-error    go to previous error

  M-g i    imenu             go to place in buffer (symbol, ...)

  M-&lt;                        go to begin of buffer
  M-&gt;                        go to end of buffer
</code></pre>
<h2 id="isearch"><a class="header" href="#isearch">isearch</a></h2>
<pre><code class="language-markdown">  key    fn                           description
-------------------------------------------------
  C-s    isearch-forward              search forward from current position (C-s to go to next match)
  C-r    isearch-backward             search backwards from current position (C-r to go to next match)
  C-w    isearch-yank-word-or-char    feed next word to current search (extend)
  M-p    isearch-ring-advance         previous search input
  M-n    isearch-ring-retreat         next search input
  M-e    isearch-edit-string          edit search string again
  M-s o  occur                        open search string in occur
</code></pre>
<h2 id="occur"><a class="header" href="#occur">occur</a></h2>
<pre><code class="language-markdown">  key      fn           description
-----------------------------------
  M-s o    occur        get matches for regexp in buffer
                        use during `isearch` to use current search term
  e                     enter occur edit mode (C-c C-c to quit)

  n                     move to next entry and keep focus in occur buffer
  p                     move to previous entry and keep focus in occur buffer
  C-n                   goto next line
  C-p                   goto previous line
  o                     open match in other window
  C-o                   open match in other window keep focus in ibuffer
</code></pre>
<pre><code class="language-markdown">  key      fn                                 description
---------------------------------------------------------
           multi-occur-in-matching-buffers    run occur in buffers matching regexp
           occur-edit-mode                    in occur buffer, enter edit mode.
                                              C-c C-c after editing to save changes.
</code></pre>
<h2 id="grep"><a class="header" href="#grep">grep</a></h2>
<pre><code class="language-markdown">  key    fn           description
-----------------------------------
         rgrep        recursive grep
         lgrep        local dir grep
         grep         raw grep command
         find-grep    run find-grep result in *grep* buffer

  n/p                 navigate next/previous match in *grep* buffer
  q                   quit *grep* buffer
</code></pre>
<h2 id="highlight"><a class="header" href="#highlight">highlight</a></h2>
<pre><code class="language-markdown">  key      fn                                  description
----------------------------------------------------------
  M-s h .  highlight-symbol-at-point           use C-u prefix to select color
  M-s h r  highlight-regexp                    use C-u prefix to select color
  M-s h l  highlight-lines-matching-regexp     use C-u prefix to select color

  M-s h u  unhighlight-regexp                  use C-u prefix to unselect all
</code></pre>
<h2 id="yankpaste"><a class="header" href="#yankpaste">yank/paste</a></h2>
<pre><code class="language-markdown">  key         fn                      description
-------------------------------------------------
  C-&lt;SPACE&gt;   set-mark-command        set start mark to select text
  C-x C-x     exchange-point-and-mark swap mark and point position
  M-w         kill-ring-save          copy selected text
  C-w         kill-region             kill selected text
  C-y         yank                    paste selected text
  M-y         yank-pop                cycle through kill-ring (only after paste)
  M-y         yank-from-kill-ring     interactively select yank from kill ring
</code></pre>
<h2 id="register"><a class="header" href="#register">register</a></h2>
<pre><code class="language-markdown">  key             fn                 description
------------------------------------------------
  C-x r s &lt;reg&gt;   copy-to-register   save region in register &lt;reg&gt;
  C-x r i &lt;reg&gt;   insert-register    insert content of register &lt;reg&gt;
</code></pre>
<h2 id="bookmarks"><a class="header" href="#bookmarks">bookmarks</a></h2>
<pre><code>  key             fn            description
-------------------------------------------
  C-x r m  bookmark-set         set a bookmark
  C-x r b  bookmark-jump        jump to a bookmark
  C-x r l  bookmark-bmenu-list  list all bookmarks
</code></pre>
<h2 id="blockrect"><a class="header" href="#blockrect">block/rect</a></h2>
<pre><code class="language-markdown">  key          fn                    description
------------------------------------------------
  C-x &lt;SPC&gt;    rectangle-mark-mode   activate rectangle-mark-mode
               string-rectangle      insert text in marked rect
</code></pre>
<h2 id="mass-edit"><a class="header" href="#mass-edit">mass edit</a></h2>
<pre><code class="language-markdown">  key       fn                       description
------------------------------------------------
  C-x h     mark-whole-buffer        mark whole buffer
            delete-matching-line     delete lines matchng regex
            kill-matching-line       kill lines matching regex (puts them in kill ring)
            keep-lines               keep matching lines
            replace-string           replace unconditional
  M-%       query-replace            search &amp; replace
  C-M-%     query-replace-regexp     search &amp; replace regex
</code></pre>
<h2 id="narrow"><a class="header" href="#narrow">narrow</a></h2>
<pre><code class="language-markdown">  key       fn                    description
---------------------------------------------
  C-x n n   narrow-to-region      show only focused region (narrow)
  C-x n w   widen                 show whole buffer (wide)
</code></pre>
<h2 id="org"><a class="header" href="#org">org</a></h2>
<pre><code class="language-markdown">  key              fn   description
------------------------------------
  M-up/M-down           re-arrange items in same hierarchy
  M-left/M-right        change item hierarchy
  C-RET                 create new item below current
  C-S-RET               create new TODO item below current
  S-left/S-right        cycle TODO states
  C-c C-,               insert block (src, example, quote, ...)
  C-c C-e               export org document
</code></pre>
<h3 id="org-source"><a class="header" href="#org-source">org source</a></h3>
<pre><code class="language-markdown">  key       fn     description
------------------------------
  &lt;s TAB           generate a source block (requires to load org-tempo)
  C-c '            edit source block (in lang specific buffer)
  C-c C-c          eval source block
</code></pre>
<p>By default only <code>emacs-lisp</code> is loaded for evaluating code blocks. One
can customize the <code>org-babel-load-languages</code> variable to control which
languages are loaded or alternatively one can load the language library
<code>ob-&lt;lang&gt;</code> explicitly [<a href="https://orgmode.org/manual/Languages.html">ref</a>].</p>
<pre><code class="language-lisp">;; disable emacs-lisp, enable C/cpp.
(org-babel-do-load-languages
 'org-babel-load-languages
 '((emacs-lisp . nil)
   (C . t)))

;; load bable C/cpp support.
(require 'ob-C)
</code></pre>
<blockquote>
<p>A list of supporte languages is <a href="https://orgmode.org/worg/org-contrib/babel/languages/index.html">here</a>.</p>
</blockquote>
<h2 id="project"><a class="header" href="#project">project</a></h2>
<pre><code class="language-markdown">  key       fn                                 description
----------------------------------------------------------
  C-x p p   project-switch-project             switch project
  C-x p f   project-find-file                  find file in project
  C-x p r   project-query-replace-regexp       query replace on project
  C-x p x   project-execute-extended-command   exec command on project
  C-x p !   project-shell-command              shell command on project
  C-x p &amp;   project-async-shell-command        async shell command on project
</code></pre>
<h2 id="vc"><a class="header" href="#vc">vc</a></h2>
<pre><code class="language-markdown">  key       fn                          description
---------------------------------------------------
  C-x v =   vc-diff                     show diff of buffer
  C-x v ~   vc-revision-other-window    show other revison of buffer
</code></pre>
<h2 id="tags--lsp"><a class="header" href="#tags--lsp">tags / lsp</a></h2>
<p>To generate <code>etags</code> using <code>ctags</code></p>
<pre><code class="language-markdown">  ctags -R -e .         generate emacs tag file (important `-e`)
</code></pre>
<p>Navigate using tags</p>
<pre><code class="language-markdown">  key      fn                       description
-----------------------------------------------
  M-.      xref-find-definitions    find definition of tag
                                    (C-u prefix to enter symbol manually)
           xref-find-apropos        find symbols matching regexp
  M-?      xref-find-references     find references of tag
</code></pre>
<h2 id="completion-2"><a class="header" href="#completion-2">completion</a></h2>
<pre><code class="language-markdown">  key     fn                   description
------------------------------------------
  C-M-i   complete-symbol      completion on text around point
                               (based on completion-at-point-functions)

  M-/     dabbrev-expand       dynamically expand at point, press to cycles
                               (based on typed words in buffer)
  C-M-/   dabbrev-completion   provide completion at point, interactive completion
                               (based on typed words in buffer)
</code></pre>
<h2 id="abbreviation"><a class="header" href="#abbreviation">abbreviation</a></h2>
<pre><code class="language-markdown">
  key        fn                                    description
--------------------------------------------------------------
  C-x a e    expand-abbrev              expand abbrev at point

             abbrev-mode                automatically expand abbrevs while typing
             define-mode-abbrev         interactively define a new mode abbrev
             define-global-abbrev       interactively define a new global abbrev
             list-abbrev                list all available abbrevs
             edit-abbrev                interactively edit list of abbrevs
                                        (C-c C-c to apply edits)
             write-abbrev-file          write abbrevs to file
                                        (abbrev-file-name will be autoloaded)
</code></pre>
<p>One can also define a function to run when expanding an abbreviation.
For example the following define some abbreviations which expand to an
empty string but which then run a function on expansion which inserts
text.</p>
<pre><code class="language-lisp">(defun my-snippet1 ()
  (insert "foobar"))

; can run lisp code to assemble the string
(defun my-snippet2 ()
  (let ((x 10))
    (insert (format "x=%d" 10))))

(define-abbrev global-abbrev-table "s1" "" 'my-snippet1)
(define-abbrev global-abbrev-table "s2" "" 'my-snippet2)
</code></pre>
<h3 id="expandel-builtin"><a class="header" href="#expandel-builtin">expand.el (builtin)</a></h3>
<p>Allow to define <code>abbrevs</code> with slots that can be jumped to.</p>
<pre><code class="language-lisp">(defconst c-expand-list
  '(("ifn" "if () {}" (5 8))
    ("ui" "unsigned int")
    ("main" "int\nmain(int argc, char * argv[])\n{\n\n}\n" 37)))
  "Expansions for C mode")

;; Install into the c-mode abbrev table.
(expand-add-abbrevs c-mode-abbrev-table c-expand-list)
</code></pre>
<blockquote>
<p><code>C-h P expand</code> to see full example.</p>
</blockquote>
<pre><code class="language-markdown">  key        fn                                    description
--------------------------------------------------------------
  C-x a n    expand-jump-to-next-slot        jump to next slot in abbrev
  C-x a p    expand-jump-to-previous-slot    jump to previous slot in abbrev
</code></pre>
<h3 id="skeletonel-builtin"><a class="header" href="#skeletonel-builtin">skeleton.el (builtin)</a></h3>
<p>Simple template engine.</p>
<pre><code class="language-lisp">;; skeleton which can be called interactively or bound to a keymap
(define-skeleton my-c-for-loop
  ;; Documentation.
  "Insert a C-style for loop."
  ;; Prompt user, save result in 'str' variable.
  "Iteration variable name: "
  ;; Skeleton template.
  ;;   'str' input from user prompt.
  ;;   '_' marks location for cursor.
  ;;   '&gt;' indent.
  "for (int " str " = 0; " str " &lt; " (skeleton-read "Upper bound: ") "; " str "++) {\n"
  &gt; _ "\n" ;; `_` marks where the cursor ends up after expansion
  "}\n")

;; One can also define an abbrev for the skeleton , either programatically or
;; interactive when editing the abbrevs. The syntax for interactive edits is:
;;     (c-mode-abbrev-table)
;;     "for"           0    ""         my-c-for-loop
(define-abbrev c-mode-abbrev-table "for" "" 'my-c-for-loop’)
</code></pre>
<h2 id="ido"><a class="header" href="#ido">ido</a></h2>
<p>Builtin fuzzy completion mode (eg buffer select, dired, …).</p>
<pre><code class="language-markdown">  key              fn          description
------------------------------------------
                  ido-mode     toggle ido mode
  &lt;Left&gt;/&lt;Right&gt;               cycle through available competions
  &lt;RET&gt;                        select completion
</code></pre>
<p>There is also <code>fido</code>, which is the successor of <code>ido</code>, which also
supports <code>fido-vertical-mode</code> in case vertical mode is preferred.</p>
<h2 id="evil"><a class="header" href="#evil">evil</a></h2>
<pre><code class="language-markdown">  key    fn    description
--------------------------
  C-z          toggle emacs/evil mode
  C-^          toggle between previous and current buffer
  C-p          after paste cycle kill-ring back
  C-n          after paste cycle kill-ring forward
</code></pre>
<h2 id="dired"><a class="header" href="#dired">dired</a></h2>
<pre><code class="language-markdown">  key    fn    description
--------------------------
  i            open sub-dir in same buffer
  +            create new directory
  C            copy file/dir
  R            move file/dir (rename)
  S            absolute symbolic link
  Y            relative symbolic link

  d            mark for deletion
  m            mark file/dir at point
  * %          mark by regex
  * *          mark all executables
  * /          mark all dirs
  u            un-mark file/dir
  U            un-mark all
  t            toggle marks

  x            execute marked actions
  !            run shell command on marked files
  &amp;            run shell command on marked files (async)

  q            quit
</code></pre>
<h2 id="info"><a class="header" href="#info">info</a></h2>
<pre><code class="language-markdown">  key fn                    description
---------------------------------------
  n   Info-next             next page
  p   Info-prev             previous page

  l   Info-history-back     history go back
  r   Info-history-forward  history go forward

  ^   Info-Up               up in info node tree

  s   Info-search           search info
  g   Info-goto-node        goto info node (by minibuf completion)
                            a node is any section in a node tree
  m   Info-menu             goto menu (by minibuf completion)
                            a node in the current nodes menu list

      Info-history          open info history in buffer
</code></pre>
<h2 id="shell-commands"><a class="header" href="#shell-commands">shell commands</a></h2>
<pre><code class="language-markdown">  key   fn                        description
---------------------------------------------
  M-!   shell-command             run shell command synchronously
  M-&amp;   async-shell-command       run shell command asynchronously
  M-|   shell-command-on-region   run shell command on region;
                                  prefix with C-u to replace region with
                                  output of the command
</code></pre>
<h2 id="interactive-shell"><a class="header" href="#interactive-shell">interactive shell</a></h2>
<p>Set <code>ESHELL</code> environment variable before starting emacs to change
default shell, else customize the <code>explicit-shell-file-name</code> variable.</p>
<pre><code class="language-markdown">  key      fn                    description
---------------------------------------------
  M-x      shell                 start interactive shell
  C-u M-x  shell                 start interactive shell &amp; rename


  M-r      comint-history-isearch-backward-regexp
                                 search history, invoke at end of shell buffer
  M-p      comint-previous-input go one up in history
  C-&lt;UP&gt;
  M-n      comint-next-input     go one down in history
  C-&lt;DOWN&gt;

  C-c C-a                        go begin of line (honors prompt)
  C-c C-e                        go to end of line
  C-c C-c                        interrupt active command
</code></pre>
<h2 id="gdb"><a class="header" href="#gdb">gdb</a></h2>
<pre><code class="language-markdown">  key           fn                  description
------------------------------------------------
  C-x C-a C-b   gud-break           create breakpoint

                gdb-many-windows    toggle gdb many window view
</code></pre>
<h2 id="lisp"><a class="header" href="#lisp">lisp</a></h2>
<pre><code class="language-markdown">  key   fn        description
------------------------------
        ielm      open interactive elips shell
</code></pre>
<p>In <code>lisp-interaction-mode</code> (<code>*scratch*</code> buffer by default)</p>
<pre><code class="language-markdown">  key              fn                           description
-----------------------------------------------------------
  C-j              eval-print-last-sexp         evaluate &amp; print symbolic expression
                                                (last before the cursor)
  C-x C-e          eval-last-sexp               evaluate symbolic expression (last)

  C-c C-e          elisp-eval-region-or-buffer  eval buffer or region (elisp mode)

  C-M-x            eval-defun                   evaluate top-level function
                                                (surrounding cursor position)
</code></pre>
<h3 id="elisp"><a class="header" href="#elisp">elisp</a></h3>
<p>When evaluating a symbol by itself, its value is returned.</p>
<pre><code class="language-lisp">(setq foo "bar")

foo
"bar"          ;; C-j
</code></pre>
<p>When evaluating a list, the first symbol in the list is interpreted as function.</p>
<pre><code class="language-lisp">(defun foo (a b)
  (+ 1 2 a b))

(foo 1 2)
6              ;; C-j

;; Expressions are evaluated left-to-right and from inside-to-outside.
(+ 1 (string-to-number "2"))
3              ;; C-j
</code></pre>
<p>A symbol can be bound to a <code>value</code> and a <code>function</code> at the same time.</p>
<pre><code class="language-lisp">(setq moose 3)

(defun moose ()
  (concat "abc" "def"))

moose
3              ;; C-j eval as value

(moose)
"abcdef"       ;; C-j eval as function
</code></pre>
<p>If a symbol is <code>quote</code>-d it is not evaluated.</p>
<pre><code class="language-lisp">'foo
foo            ;; C-j dont eval as value

'(a b c)
(a b c)        ;; C-j dont eval as function

(setq foo '(a b)) ;; the inner list is not evaluated
foo            ;; C-j eval as value, contains un-evaluated list
(a b)

;; (quote ..) is equivalent to '
(quote bar)
bar            ;; C-j

(quote (c d))
(c d)          ;; C-j

;; print argument and print evaluated result
(defun p (arg)
  (message "arg =%s" arg)
  (message "eval=%s" (eval arg)))

;; pass quoted variable
(setq foo '(a b))
(p 'foo)
"arg =foo"     ;; C-j and take print from *Message* buffer
"eval=(a b)"

;; pass quoted function
(p '(concat "a" "b"))
"arg =(concat a b)"    ;; C-j and take print from *Message* buffer
"eval=ab"
</code></pre>
<p>If a symbol is <code>backquote</code>-d only parts of the expression are evaluated.
This can be used to build some tempaltes.</p>
<pre><code class="language-lisp">(setq val 42)
(setq vals '(1 2 3 4))

;; , is used to insert a value
`(A ,val)
(A 42)         ;; C-j
`(B ,vals)
(B (1 2 3 4))  ;; C-j

;; ,@ is used to splice in a value
`(C ,@vals)
(C 1 2 3 4)    ;; C-j

;; (backquote ..) is equivalent to `
(backquote (D ,val ,@vals))
(D 42 1 2 3 4)
</code></pre>
<p>The following gives some basic control flow.</p>
<pre><code class="language-lisp">;; (if COND THEN ELSE) ; if COND yields non-nil then run THEN else ELSE
(if t (message "true") (message "false"))
"true"
(if nil (message "true") (message "false"))
"false"

;; (when COND BODY) ; when COND yields non-nil then run BODY
(when t (message "true"))
"true"
(when nil (message "true"))
nil

;; (unless COND BODY) ; when COND yields nil then run BODY
(unless t (message "false"))
nil
(unless nil (message "false"))
"false"

;; (dolist (var LIST) BODY)
(dolist (x (list 10 20 30))
  (insert (format "%02x-%02X\n" x x)))
0a-0A
14-14
1e-1E
</code></pre>
<p>The following gives some overview over the emacs basics to load/unload
files and features.</p>
<pre><code class="language-lisp">load-path      ;; var: list of search paths for files/features
load-history   ;; var: alist with mapping of files to symbols
features       ;; var: list of loaded files/features

(add-to-list 'load-path "foo/bar") ;; fn: add search path

(load-file "&lt;path&gt;/foo.el")  ;; fn: load file with explicit path
(load "foo")                 ;; fn: load file/feature, load-path (var) search path
                             ;;     (w/o suffix, tries elc, el)

;; Compared to just loading, this creates dependencies.
;; Unloading a file/feature which some other file requires fails.
;; One either needs to unload all the dependents or do a forced unload.
(require 'foo)               ;; fn: load file/feature, add dependency
(provide 'foo)               ;; fn: declare feature wich can be required

(featurep 'foo)              ;; fn: predicate to check if file/feature is loaded

(unload-feature 'foo)        ;; fn: unload file/feature and associated functions
(unload-feature 'foo t)      ;; fn: forced unload file/feature
                             ;;     (even if some dependency exists)

(when (featurep 'foo)
    (unload-feature 'foo))   ;; example: unload foo if loaded
</code></pre>
<p>Automatically execute code on file/feature load.</p>
<pre><code class="language-lisp">;; Execute lambda when "test" is loaded, or execute lambda immediately
;; if "test" is already loaded.
(eval-after-load 'test
  (lambda ()
    (message "moose 1")
    (message "moose 2")))

;; Convenience macro around eval-after-load, to just write out the body.
(with-eval-after-load 'test
  (message "moose 1")
  (message "moose 2"))
</code></pre>
<p>Automatically execute code when a mode is activated. Each mode has a variable
<code>&lt;mode&gt;-hook</code> which one can add callbacks using <code>add-hook</code>. Callbacks take no
argument.</p>
<pre><code class="language-lisp">;; Add a hook to the c++ mode.
(add-hook 'c++-mode-hook 'display-line-numbers-mode)

;; Add another hook to the c++ mode, either use a lambda or
;; a separate function to do more work.
(add-hook 'c++-mode-hook
          (lambda ()
            '(message "in cpp")))
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="gpg1"><a class="header" href="#gpg1">gpg(1)</a></h1>
<pre><code>gpg
  -o|--output                 Specify output file
  -a|--armor                  Create ascii output
  -u|--local-user &lt;name&gt;      Specify key for signing
  -r|--recipient              Encrypt for user
</code></pre>
<h2 id="generate-new-keypair"><a class="header" href="#generate-new-keypair">Generate new keypair</a></h2>
<pre><code class="language-bash">gpg --full-generate-key
</code></pre>
<h2 id="list-keys"><a class="header" href="#list-keys">List keys</a></h2>
<pre><code>gpg -k / --list-key               # public keys
gpg -K / --list-secret-keys       # secret keys
</code></pre>
<h2 id="edit-keys"><a class="header" href="#edit-keys">Edit keys</a></h2>
<pre><code class="language-bash">gpg --edit-key &lt;KEY ID&gt;
</code></pre>
<p>Gives prompt to modify <code>KEY ID</code>, common commands:</p>
<pre><code class="language-bash">help         show help
save         save &amp; quit

list         list keys and user IDs
key &lt;N&gt;      select subkey &lt;N&gt;
uid &lt;N&gt;      select user ID &lt;N&gt;

expire       change expiration of selected key

adduid       add user ID
deluid       delete selected user ID

addkey       add subkey
delkey       delete selected subkey
</code></pre>
<h2 id="export--import-keys"><a class="header" href="#export--import-keys">Export &amp; Import Keys</a></h2>
<pre><code class="language-bash">gpg --export --armor --output &lt;KEY.PUB&gt; &lt;KEY ID&gt;
gpg --export-secret-key --armor --output &lt;KEY.PRIVATE&gt; &lt;KEY ID&gt;
gpg --import &lt;FILE&gt;
</code></pre>
<h2 id="search--send-keys"><a class="header" href="#search--send-keys">Search &amp; Send keys</a></h2>
<pre><code class="language-bash">gpg --keyserver &lt;SERVER&gt; --send-keys &lt;KEY ID&gt;
gpg --keyserver &lt;SERVER&gt; --search-keys &lt;KEY ID&gt;
</code></pre>
<h2 id="encrypt-passphrase"><a class="header" href="#encrypt-passphrase">Encrypt (passphrase)</a></h2>
<p>Encrypt file using <code>passphrase</code> and write encrypted data to <code>&lt;file&gt;.gpg</code>.</p>
<pre><code class="language-bash">gpg --symmetric &lt;file&gt;

# Decrypt using passphrase
gpg -o &lt;file&gt; --decrypt &lt;file&gt;.gpg
</code></pre>
<h2 id="encrypt-public-key"><a class="header" href="#encrypt-public-key">Encrypt (public key)</a></h2>
<p>Encrypt file with <code>public key</code> of specified <code>recipient</code> and write encrypted
data to <code>&lt;file&gt;.gpg</code>.</p>
<pre><code class="language-bash">gpg --encrypt -r foo@bar.de &lt;file&gt;

# Decrypt at foos side (private key required)
gpg -o &lt;file&gt; --decrypt &lt;file&gt;.gpg
</code></pre>
<h2 id="signing"><a class="header" href="#signing">Signing</a></h2>
<p>Generate a signed file and write to <code>&lt;file&gt;.gpg</code>.</p>
<pre><code class="language-bash"># Sign with private key of foo@bar.de
gpg --sign -u foor@bar.de &lt;file&gt;

# Verify with public key of foo@bar.de
gpg --verify &lt;file&gt;

# Extract content from signed file
gpg -o &lt;file&gt; --decrypt &lt;file&gt;.gpg
</code></pre>
<blockquote>
<p>Without <code>-u</code> use first private key in list <code>gpg -K</code> for signing.</p>
</blockquote>
<p>Files can also be <code>signed</code> and <code>encrypted</code> at once, gpg will first sign the
file and then encrypt it.</p>
<pre><code class="language-bash">gpg --sign --encrypt -r &lt;recipient&gt; &lt;file&gt;
</code></pre>
<h2 id="signing-detached"><a class="header" href="#signing-detached">Signing (detached)</a></h2>
<p>Generate a <code>detached</code> signature and write to <code>&lt;file&gt;.asc</code>.
Send <code>&lt;file&gt;.asc</code> along with <code>&lt;file&gt;</code> when distributing.</p>
<pre><code class="language-bash">gpg --detach-sign --armor -u foor@bar.de &lt;file&gt;

# Verify
gpg --verify &lt;file&gt;.asc &lt;file&gt;
</code></pre>
<blockquote>
<p>Without <code>-u</code> use first private key in list <code>gpg -K</code> for signing.</p>
</blockquote>
<h2 id="abbreviations"><a class="header" href="#abbreviations">Abbreviations</a></h2>
<ul>
<li><code>sec</code> secret key</li>
<li><code>ssb</code> secret subkey</li>
<li><code>pub</code> public key</li>
<li><code>sub</code> public subkey</li>
</ul>
<p>Key usage flags:</p>
<ul>
<li><code>[S]</code> signing</li>
<li><code>[C]</code> create certificates</li>
<li><code>[E]</code> encrypting</li>
<li><code>[A]</code> authentication</li>
</ul>
<h2 id="keyservers"><a class="header" href="#keyservers">Keyservers</a></h2>
<ul>
<li>http://pgp.mit.edu</li>
<li>http://keyserver.ubuntu.com</li>
<li>hkps://pgp.mailbox.org</li>
</ul>
<h2 id="examples-7"><a class="header" href="#examples-7">Examples</a></h2>
<h3 id="list-basic-key-information-from-file-with-long-keyids"><a class="header" href="#list-basic-key-information-from-file-with-long-keyids">List basic key information from file with long keyids</a></h3>
<pre><code class="language-bash">gpg --keyid-format 0xlong &lt;key.asc&gt;
</code></pre>
<h3 id="extend-expiring-key"><a class="header" href="#extend-expiring-key">Extend expiring key</a></h3>
<pre><code class="language-bash">gpg --edit-key &lt;key id&gt;

# By default we are on the primary key, can switch to sub key.
gpg&gt; key 1

# Update the expire date.
gpg&gt; expire

gpg&gt; save

# Update keyserver(s) and/or export new pub keyfile.
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="radare21"><a class="header" href="#radare21">radare2(1)</a></h1>
<h2 id="print"><a class="header" href="#print">print</a></h2>
<pre><code class="language-markdown">
  pd &lt;n&gt; [@ &lt;addr&gt;]     # print disassembly for &lt;n&gt; instructions
                        # with optional temporary seek to &lt;addr&gt;
</code></pre>
<h2 id="flags"><a class="header" href="#flags">flags</a></h2>
<pre><code class="language-markdown">  fs            # list flag-spaces
  fs &lt;fs&gt;       # select flag-space &lt;fs&gt;
  f             # print flags of selected flag-space
</code></pre>
<h2 id="help-1"><a class="header" href="#help-1">help</a></h2>
<pre><code class="language-markdown">  ?*~&lt;kw&gt;       # '?*' list all commands and '~' grep for &lt;kw&gt;
  ?*~...        # '..' less mode /'...' interactive search
</code></pre>
<h2 id="relocation"><a class="header" href="#relocation">relocation</a></h2>
<pre><code class="language-markdown">  &gt; r2 -B &lt;baddr&gt; &lt;exe&gt;         # open &lt;exe&gt; mapped to addr &lt;baddr&gt;
  oob &lt;addr&gt;                    # reopen current file at &lt;baddr&gt;
</code></pre>
<h1 id="examples-8"><a class="header" href="#examples-8">Examples</a></h1>
<h2 id="patch-file-alter-bytes"><a class="header" href="#patch-file-alter-bytes">Patch file (alter bytes)</a></h2>
<pre><code class="language-markdown">  &gt; r2 [-w] &lt;file&gt;
  oo+           # re-open for write if -w was not passed
  s &lt;addr&gt;      # seek to position
  wv &lt;data&gt;     # write 4 byte (dword)
</code></pre>
<h2 id="assemble--disassmble-rasm2"><a class="header" href="#assemble--disassmble-rasm2">Assemble / Disassmble (rasm2)</a></h2>
<pre><code class="language-markdown">  rasm2 -L      # list supported archs

  &gt; rasm2 -a x86 'mov eax, 0xdeadbeef'
  b8efbeadde

  &gt; rasm2 -a x86 -d "b8efbeadde"
  mov eax, 0xdeadbeef
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="qemu1"><a class="header" href="#qemu1">qemu(1)</a></h1>
<p>All the examples &amp; notes use <code>qemu-system-x86_64</code> but in most cases
this can be swapped with the system emulator for other architectures.</p>
<h2 id="keybindings-1"><a class="header" href="#keybindings-1">Keybindings</a></h2>
<p>Graphic mode:</p>
<pre><code class="language-markdown">Ctrl+Alt+g         release mouse capture from VM

Ctrl+Alt+1         switch to display of VM
Ctrl+Alt+2         switch to qemu monitor
</code></pre>
<p>No graphic mode:</p>
<pre><code class="language-markdown">Ctrl+a h           print help
Ctrl+a x           exit emulator
Ctrl+a c           switch between monitor and console
</code></pre>
<h2 id="vm-config-snippet"><a class="header" href="#vm-config-snippet">VM config snippet</a></h2>
<p>Following command-line gives a good starting point to assemble a VM:</p>
<pre><code>qemu-system-x86_64                 \
    -cpu host -enable-kvm -smp 4   \
    -m 8G                          \
    -vga virtio -display sdl,gl=on \
    -boot menu=on                  \
    -cdrom &lt;iso&gt;                   \
    -hda &lt;disk&gt;                    \
    -device qemu-xhci,id=xhci      \
    -device usb-host,bus=xhci.0,vendorid=0x05e1,productid=0x0408,id=capture-card
</code></pre>
<h3 id="cpu--ram"><a class="header" href="#cpu--ram">CPU &amp; RAM</a></h3>
<pre><code class="language-bash"># Emulate host CPU in guest VM, enabling all supported host featured (requires KVM).
# List available CPUs `qemu-system-x86_64 -cpu help`.
-cpu host

# Enable KVM instead software emulation.
-enable-kvm

# Configure number of guest CPUs.
-smp &lt;N&gt;

# Configure size of guest RAM.
-m 8G
</code></pre>
<h3 id="graphic--display"><a class="header" href="#graphic--display">Graphic &amp; Display</a></h3>
<pre><code class="language-bash"># Use sdl window as display and enable openGL context.
-display sdl,gl=on

# Use vnc server as display (eg on display `:42` here).
-display vnc=localhost:42

# Confifure virtio as 3D video graphic accelerator (requires virgl in guest).
-vga virtio

# Disable graphical output, and redirect serial console to qemu processes stdio
# (-serial stdio).
-nographic
</code></pre>
<h3 id="boot-menu"><a class="header" href="#boot-menu">Boot Menu</a></h3>
<pre><code class="language-bash"># Enables boot menu to select boot device (enter with `ESC`).
-boot menu=on
</code></pre>
<h3 id="block-devices"><a class="header" href="#block-devices">Block devices</a></h3>
<pre><code class="language-bash"># Attach cdrom drive with iso to a VM.
-cdrom &lt;iso&gt;

# Attach disk drive to a VM.
-hda &lt;disk&gt;

# Generic way to configure &amp; attach a drive to a VM.
-drive file=&lt;file&gt;,format=qcow2
</code></pre>
<h4 id="create-a-disk-with-qemu-img"><a class="header" href="#create-a-disk-with-qemu-img">Create a disk with <a href="https://qemu-project.gitlab.io/qemu/tools/qemu-img.html"><code>qemu-img</code></a></a></h4>
<p>To create a <code>qcow2</code> disk (qemu copy-on-write) of size <code>10G</code>:</p>
<pre><code class="language-bash">qemu-img create -f qcow2 disk.qcow2 10G
</code></pre>
<p>The disk does not contain any <code>partitions</code> or a <code>partition table</code>.
We can format the disk from <strong>within the <strong>guest</strong></strong> as following example:</p>
<pre><code class="language-bash"># Create `gpt` partition table.
sudo parted /dev/sda mktable gpt

# Create two equally sized primary partitions.
sudo parted /dev/sda mkpart primary 0% 50%
sudo parted /dev/sda mkpart primary 50% 100%

# Create filesystem on each partition.
sudo mkfs.ext3 /dev/sda1
sudo mkfs.ext4 /dev/sda2

lsblk -f /dev/sda
  NAME   FSTYPE LABEL UUID FSAVAIL FSUSE% MOUNTPOINT
  sda
  ├─sda1 ext3         ....
  └─sda2 ext4         ....
</code></pre>
<h3 id="usb"><a class="header" href="#usb">USB</a></h3>
<h4 id="host-controller"><a class="header" href="#host-controller">Host Controller</a></h4>
<pre><code class="language-bash"># Add XHCI USB controller to the VM (supports USB 3.0, 2.0, 1.1).
# `id=xhci` creates a usb bus named `xhci`.
-device qemu-xhci,id=xhci
</code></pre>
<h4 id="usb-device"><a class="header" href="#usb-device">USB Device</a></h4>
<pre><code class="language-bash"># Pass-through USB device from host identified by vendorid &amp; productid and
# attach to usb bus `xhci.0` (defined with controller `id`).
-device usb-host,bus=xhci.0,vendorid=0x05e1,productid=0x0408
</code></pre>
<h2 id="debugging"><a class="header" href="#debugging">Debugging</a></h2>
<pre><code class="language-bash"># Open gdbstub on tcp `&lt;port&gt;` (`-s` shorthand for `-gdb tcp::1234`).
-gdb tcp::&lt;port&gt;

# Freeze guest CPU at startup and wait for debugger connection.
-S
</code></pre>
<h2 id="io-redirection-2"><a class="header" href="#io-redirection-2">IO redirection</a></h2>
<pre><code class="language-bash"># Create raw tcp server for `serial IO` and wait until a client connects
# before executing the guest.
-serial tcp:localhost:12345,server,wait

# Create telnet server for `serial IO` and wait until a client connects
# before executing the guest.
-serial telnet:localhost:12345,server,wait

# Configure redirection for the QEMU `mointor`, arguments similar to `-serial`
# above.
-monitor ...
</code></pre>
<blockquote>
<p>In <code>server</code> mode use <code>nowait</code> to execute guest without waiting for a client
connection.</p>
</blockquote>
<h2 id="network"><a class="header" href="#network">Network</a></h2>
<pre><code class="language-bash"># Redirect host tcp port `1234` to guest port `4321`.
-nic user,hostfwd=tcp:localhost:1234-:4321
</code></pre>
<h2 id="shared-drives"><a class="header" href="#shared-drives">Shared drives</a></h2>
<pre><code class="language-bash"># Attach a `virtio-9p-pci` device to the VM.
# The guest requires 9p support and can mount the shared drive as:
#   mount -t 9p -o trans=virtio someName /mnt
-virtfs local,id=someName,path=&lt;someHostPath&gt;,mount_tag=someName,security_model=none
</code></pre>
<h2 id="debug-logging"><a class="header" href="#debug-logging">Debug logging</a></h2>
<pre><code class="language-bash"># List debug items.
-d help

# Write debug log to file instead stderr.
-D &lt;file&gt;

# Examples
-d in_asm       Log executed guest instructions.
</code></pre>
<h2 id="tracing"><a class="header" href="#tracing">Tracing</a></h2>
<pre><code class="language-bash"># List name of all trace points.
-trace help

# Enable trace points matching pattern and optionally write trace to file.
-trace &lt;pattern&gt;[,file=&lt;file&gt;]

# Enable trace points for all events listed in the &lt;events&gt; file.
# File must contain one event/pattern per line.
-trace events=&lt;events&gt;
</code></pre>
<h2 id="vm-snapshots"><a class="header" href="#vm-snapshots">VM snapshots</a></h2>
<p>VM snapshots require that there is at least on <code>qcow2</code> disk attached to the VM
(<a href="https://qemu-project.gitlab.io/qemu/system/images.html#vm-005fsnapshots">VM Snapshots</a>).</p>
<p>Commands for qemu <a href="https://qemu-project.gitlab.io/qemu/system/monitor.html">Monitor</a> or <a href="https://qemu-project.gitlab.io/qemu/interop/qemu-qmp-ref.html">QMP</a>:</p>
<pre><code class="language-bash"># List available snapshots.
info snapshots

# Create/Load/Delete snapshot with name &lt;tag&gt;.
savevm &lt;tag&gt;
loadvm &lt;tag&gt;
delvm &lt;tag&gt;
</code></pre>
<p>The snapshot can also be directly specified when invoking qemu as:</p>
<pre><code class="language-bash">qemu-system-x86_64 \
    -loadvm &lt;tag&gt;  \
    ...
</code></pre>
<h2 id="vm-migration"><a class="header" href="#vm-migration">VM Migration</a></h2>
<p><code>Online</code> migration example:</p>
<pre><code class="language-bash"># Start machine 1 on host ABC.
qemu-system-x86_64 -monitor stdio -cdrom &lt;iso&gt;

# Prepare machine 2 on host DEF as migration target.
# Listen for any connection on port 12345.
qemu-system-x86_64 -monitor stdio -incoming tcp:0.0.0.0:12345

# Start migration from the machine 1 monitor console.
(qemu) migrate tcp:DEF:12345
</code></pre>
<p>Save to external file example:</p>
<pre><code class="language-bash">```bash
# Start machine 1.
qemu-system-x86_64 -monitor stdio -cdrom &lt;iso&gt;

# Save VM state to file.
(qemu) migrate "exec:gzip -c &gt; vm.gz"

# Load VM from file.
qemu-system-x86_64 -monitor stdio -incoming "exec: gzip -d -c vm.gz"
</code></pre>
<blockquote>
<p>The migration source machine and the migration target machine should be
launched with the <strong>same</strong> parameters.</p>
</blockquote>
<h2 id="appendix-direct-kernel-boot"><a class="header" href="#appendix-direct-kernel-boot">Appendix: Direct <code>Kernel</code> boot</a></h2>
<p>Example command line to directly boot a <code>Kernel</code> with an <code>initrd</code> ramdisk.</p>
<pre><code class="language-bash">qemu-system-x86_64                                                     \
    -cpu host                                                          \
    -enable-kvm                                                        \
    -kernel &lt;dir&gt;/arch/x86/boot/bzImage                                \
    -append "earlyprintk=ttyS0 console=ttyS0 nokaslr init=/init debug" \
    -initrd &lt;dir&gt;/initramfs.cpio.gz                                    \
    ...
</code></pre>
<p>Instructions to build a minimal <a href="https://blog.memzero.de/kernel-debugging-qemu"><code>Kernel</code> and <code>initrd</code></a>.</p>
<h2 id="appendix-cheap-instruction-tracer"><a class="header" href="#appendix-cheap-instruction-tracer">Appendix: Cheap instruction tracer</a></h2>
<pre><code class="language-make">test: test.s
	as -o test.o test.s
	ld -o test test.o testc.o

trace: test
	qemu-x86_64 -singlestep -d nochain,cpu ./test 2&gt;&amp;1 | awk '/RIP/ { print $$1; }'

clean:
	$(RM) test test-bin test.o
</code></pre>
<pre><code class="language-x86asm">.section .text, "ax"

.global _start
_start:
    xor %rax, %rax
    mov $0x8, %rax
1:
    cmp $0, %rax
    je 2f
    dec %rax
    jmp 1b
2:
    # x86-64 exit(2) syscall
    mov $0, %rdi
    mov $60, %rax
    syscall
</code></pre>
<h2 id="references"><a class="header" href="#references">References</a></h2>
<ul>
<li><a href="https://github.com/qemu/qemu/blob/master/docs/usb2.txt">QEMU USB</a></li>
<li><a href="https://qemu-project.gitlab.io/qemu/tools/qemu-img.html">QEMU IMG</a></li>
<li><a href="https://qemu-project.gitlab.io/qemu/tools/index.html">QEMU Tools</a></li>
<li><a href="https://qemu-project.gitlab.io/qemu/system/index.html">QEMU System</a></li>
<li><a href="https://qemu-project.gitlab.io/qemu/system/invocation.html">QEMU Invocation (command line args)</a></li>
<li><a href="https://qemu-project.gitlab.io/qemu/system/monitor.html">QEMU Monitor</a></li>
<li><a href="https://qemu-project.gitlab.io/qemu/interop/qemu-qmp-ref.html">QEMU machine protocol (QMP)</a></li>
<li><a href="https://qemu-project.gitlab.io/qemu/system/images.html#vm-005fsnapshots">QEMU VM Snapshots</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="pacman1"><a class="header" href="#pacman1">pacman(1)</a></h1>
<h2 id="remote-package-repositories"><a class="header" href="#remote-package-repositories">Remote package repositories</a></h2>
<pre><code class="language-text">pacman -Sy              refresh package database
pacman -S &lt;pkg&gt;         install pkg
pacman -Ss &lt;regex&gt;      search remote package database
pacman -Si &lt;pkg&gt;        get info for pkg
pacman -Su              upgrade installed packages
pacman -Sc              clean local package cache
</code></pre>
<h2 id="remove-packages"><a class="header" href="#remove-packages">Remove packages</a></h2>
<pre><code class="language-text">pacman -Rsn &lt;pkg&gt;               uninstall package and unneeded deps + config files
</code></pre>
<h2 id="local-package-database"><a class="header" href="#local-package-database">Local package database</a></h2>
<p>Local package database of installed packages.</p>
<pre><code class="language-text">pacman -Q               list all installed packages
pacman -Qs &lt;regex&gt;      search local package database
pacman -Ql &lt;pkg&gt;        list files installed by pkg
pacman -Qo &lt;file&gt;       query package that owns file
pacman -Qe              only list explicitly installed packages
</code></pre>
<h2 id="local-file-database"><a class="header" href="#local-file-database">Local file database</a></h2>
<p>Local file database which allows to search packages owning certain files.
Also searches non installed packages, but database must be synced.</p>
<pre><code class="language-text">pacman -Fy              refresh file database
pacman -Fl &lt;pkg&gt;        list files in pkg (must not be installed)
pacman -Fx &lt;regex&gt;      search 
</code></pre>
<h2 id="hacks"><a class="header" href="#hacks">Hacks</a></h2>
<p>Uninstall all orphaned packages (including config files) that were installed as
dependencies.</p>
<pre><code class="language-text">pacman -Rsn $(pacman -Qtdq)
</code></pre>
<p>List explicitly installed packages that are not required as dependency by any
package and sort by size.</p>
<pre><code class="language-text">pacman -Qetq | xargs pacman -Qi |
    awk '/Name/ { name=$3 }
         /Installed Size/ { printf "%8.2f%s %s\n", $4, $5, name }' |
    sort -h
</code></pre>
<p>Install package into different <code>root</code> directory but keep using the default
database.</p>
<pre><code class="language-text">pacman --root abc --dbpath /var/lib/pacman -S mingw-w64-gcc
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="dot1"><a class="header" href="#dot1">dot(1)</a></h1>
<p><a href="https://edotor.net/">Online playground</a></p>
<h2 id="example-dot-file-to-copy--paste-from"><a class="header" href="#example-dot-file-to-copy--paste-from">Example <code>dot</code> file to copy &amp; paste from.</a></h2>
<p>Can be rendered to <code>svg</code> with the following command.</p>
<pre><code class="language-bash">dot -T svg -o g.svg g.dot
</code></pre>
<p>Example <code>dot</code> file.</p>
<pre><code class="language-dot">// file: g.dot
digraph {
    // Render ranks from left to right.
    rankdir=LR
    // Make background transparent.
    bgcolor=transparent

    // Global node attributes.
    node [shape=box]
    // Global edge attributes.
    edge [style=dotted,color=red]

    // Add nodes &amp; edge.
    stage1 -&gt; stage2
    // Add multiple edges at once.
    stage2 -&gt; { stage3_1, stage3_2 }
    // Add edge with custom attributes.
    stage3_2 -&gt; stage4 [label="some text"]

    // Set custom attributes for specific node.
    stage4 [color=green,fillcolor=lightgray,style="filled,dashed",label="s4"]

    // Create a subgraph. This can be used to group nodes/edges or as scope for
    // global node/edge attributes.
    // If the name starts with 'cluster' a border is drawn.
    subgraph cluster_1 {
        stage5_1
        stage5_2
    }

    // Add some edges to subgraph nodes.
    stage3_1 -&gt; { stage5_1, stage5_2 }
}
</code></pre>
<p>Rendered <code>svg</code> file.
<img src="tools/assets/g.svg" alt="g.svg"></p>
<h2 id="references-1"><a class="header" href="#references-1">References</a></h2>
<ul>
<li><a href="https://graphviz.org/doc/info/lang.html">DOT language</a></li>
<li><a href="https://graphviz.org/doc/info/attrs.html">Attributes</a></li>
<li><a href="https://graphviz.org/doc/info/shapes.html">Node shapes</a></li>
<li><a href="https://graphviz.org/doc/info/colors.html">Colors</a></li>
<li><a href="https://graphviz.org/pdf/dotguide.pdf">User manual</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ffmpeg-1"><a class="header" href="#ffmpeg-1">ffmpeg (1)</a></h1>
<h2 id="screen-capture-specific-window-x11"><a class="header" href="#screen-capture-specific-window-x11">screen capture specific window (x11)</a></h2>
<p>Following snippet allows to select a window which is then captured.</p>
<pre><code class="language-bash">#!/bin/bash

echo "Click on window to record .."
# Extract window size and x,y offset.
video_args=$(xwininfo \
    | awk '/Absolute upper-left X:/ { xoff = $4 }
           /Absolute upper-left Y:/ { yoff=$4 }
           /Width:/ { if ($2 % 2 == 1) { width=$2-1; } else { width=$2; } }
           /Height:/ { if ($2 % 2 == 1) { height=$2-1; } else { height=$2; } }
           END { printf "-video_size %dx%d -i :0.0+%d,%d", width, height, xoff, yoff  }')

ffmpeg -framerate 25 -f x11grab $video_args -pix_fmt yuv420p $@ output.mp4
</code></pre>
<blockquote>
<p>Use <code>yuv420p</code> pixel format if video is played on the web
(<a href="https://stackoverflow.com/questions/32829514/which-pixel-format-for-web-mp4-video">ref</a>)</p>
</blockquote>
<p>The input <code>-i 0,0+xoff,yoff</code> means to capture <code>$DISPLAY=0.0</code> starting at the
coordinate <code>(xoff, yoff)</code>, which is the left-upper corner, and the size of the
capture is defined by the <code>-video_size</code> argument.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="gnuplot-1"><a class="header" href="#gnuplot-1">gnuplot (1)</a></h1>
<pre><code># Launch interactive shell.
gnuplot

# Launch interactive shell.
gnuplot [opt]
  opt:
    -p ................ persist plot window
    -c &lt;file&gt; ......... run script file
    -e "&lt;cmd1&gt;; .." ... run cmd(s)
</code></pre>
<h2 id="frequently-used-configuration"><a class="header" href="#frequently-used-configuration">Frequently used configuration</a></h2>
<pre><code class="language-sh"># Plot title.
set title "the plot"

# Labels.
set xlabel "abc"
set ylabel "def"

# Grid.
set grind

# Output format, 'help set term' for all output formats.
set term svg
# Output file.
set output "out.svg"

# Make axis logarithmic to given base.
set logscale x 2

# Change separator, default is whitespace.
set datafile separator ","
</code></pre>
<h2 id="plot"><a class="header" href="#plot">Plot</a></h2>
<pre><code class="language-sh"># With specific style (eg lines, linespoint, boxes, steps, impulses, ..).
plot "&lt;data_file&gt;" with &lt;plot_style&gt;

&gt; cat data.txt
1 1 3
2 2 2
3 3 1
4 2 2

# Plot specific column.
plot "data.txt" using 1:2, "data.txt" using 1:3
# Equivalent using the special file "", which re-uses the previous input file.
plot "data.txt" using 1:2, "" using 1:3

# Plot piped data.
plot "&lt; head -n2 data.txt"

# Plot with alternate title.
plot "data.txt" title "moose"
</code></pre>
<h2 id="example-specify-range-directly-during-plot"><a class="header" href="#example-specify-range-directly-during-plot">Example: Specify range directly during plot</a></h2>
<pre><code class="language-sh"># Plot two functions in the range 0-10.
plot [0:10] 10*x, 20*x
</code></pre>
<h2 id="example-multiple-data-sets-in-plot"><a class="header" href="#example-multiple-data-sets-in-plot">Example: multiple data sets in plot</a></h2>
<pre><code class="language-sh"># file: mem_lat.plot

set title  "memory latency (different strides)"
set xlabel "array in KB"
set ylabel "cycles / access"

set logscale x 2

plot "stride_32.txt"  title "32"  with linespoints, \
     "stride_64.txt"  title "64"  with linespoints, \
     "stride_128.txt" title "128" with linespoints, \
     "stride_256.txt" title "256" with linespoints, \
     "stride_512.txt" title "512" with linespoints
</code></pre>
<p>On Linux x86_64, <a href="tools/gnuplot/mem_lat.c"><code>mem_lat.c</code></a> provides an example which can
be run as follows.</p>
<pre><code class="language-sh">gcc -o mem_lat mem_lat.c -g -O3 -Wall -Werror

for stride in 32 64 128 256 512; do \
    taskset -c 1 ./mem_lat 128 $stride | tee stride_$stride.txt ; \
done

gnuplot -p -c mem_lat.plot
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="restic1"><a class="header" href="#restic1">restic(1)</a></h1>
<h2 id="create-new-snapshot-repository"><a class="header" href="#create-new-snapshot-repository">Create new snapshot repository</a></h2>
<pre><code class="language-bash"># Create a local backup repository.
restic -r &lt;path&gt; init

# Create a backup repository on a remote host.
restic -r sftp:user@host:&lt;path&gt; init
</code></pre>
<h2 id="example-restore-file-pattern-from-latest-snapshot"><a class="header" href="#example-restore-file-pattern-from-latest-snapshot">Example: Restore file pattern from <code>latest</code> snapshot</a></h2>
<p>Restore files matching <code>&lt;file_pattern&gt;</code> from the <code>latest</code> snapshot (pseudo
snapshot ID) into <code>&lt;dest&gt;</code>.</p>
<pre><code class="language-bash">restic -r &lt;repo&gt; restore -i &lt;file_pattern&gt; --target &lt;dest&gt; latest
</code></pre>
<h2 id="mount-snapshots"><a class="header" href="#mount-snapshots">Mount snapshots</a></h2>
<p>Mount snapshots as user filesystem (fuse) to given mount point.</p>
<pre><code class="language-bash">restic -r &lt;repo&gt; mount &lt;mntpoint&gt;

# Mounted snapshots can be limited by host.
restic -r &lt;repo&gt; mount --host &lt;host&gt; &lt;mntpoint&gt;

# Mounted snapshots can be limited by path (abs path).
restic -r &lt;repo&gt; mount --path &lt;abspath&gt; &lt;mntpoint&gt;
</code></pre>
<h2 id="repository-maintenance"><a class="header" href="#repository-maintenance">Repository maintenance</a></h2>
<p>Check the repository for errors and report them.</p>
<pre><code class="language-bash">restic -r &lt;repo&gt; check
</code></pre>
<p>Check the repository for non-referenced data and remove it.</p>
<pre><code class="language-bash">restic -r &lt;repo&gt; prune
</code></pre>
<h2 id="references-2"><a class="header" href="#references-2">References</a></h2>
<ul>
<li><a href="https://restic.readthedocs.io/en/stable/index.html"><code>restic</code> read the docs</a></li>
<li><a href="https://restic.readthedocs.io/en/stable/030_preparing_a_new_repo.html#sftp">sftp</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="qrencode1"><a class="header" href="#qrencode1">qrencode(1)</a></h1>
<pre><code>qrencode
    -s N     pixels per feature length
</code></pre>
<p>Generate wifi qr code for WPA2 secured network.</p>
<pre><code class="language-sh"># Generate on terminal.
qrencode -t ansiutf8 'WIFI:S:&lt;wifiname&gt;;T:WPA2;P:&lt;wifipasswd&gt;;;'

# Generate picture for printing.
qrencode -t png -o wifi.png 'WIFI:S:&lt;wifiname&gt;;T:WPA2;P:&lt;wifipasswd&gt;;;'
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="poppler"><a class="header" href="#poppler">poppler</a></h1>
<pre><code class="language-sh">pdfseparate [opts] &lt;input&gt; &lt;output-pattern&gt;
  -f N   Index of first page to extract.
  -l N   Index of last page to extract.

         Use %d in output pattern if extracting multiple pages.
         If -f is absent, it defaults to page 1.
         If -l is absent, it defaults to the last page.

pdfunite &lt;input&gt; [&lt;input&gt;] &lt;output&gt;
</code></pre>
<h2 id="example-split-pdfs"><a class="header" href="#example-split-pdfs">Example: split pdfs</a></h2>
<p>Extract pages from an input pdf.</p>
<pre><code class="language-sh"># Extract single page.
pdfseparate -f 2 -l 2 2017-statement.pdf foo.pdf

# Extract multiple pages.
pdfseparate -f 2 -l 3 2017-statement.pdf foo%d.pdf
</code></pre>
<h2 id="example-merge-pdfs"><a class="header" href="#example-merge-pdfs">Example: merge pdfs</a></h2>
<p>Merge multiple pdf input files into a single output file.</p>
<pre><code class="language-sh">pdfunite 201704-statement.pdf 201705-statement.pdf 2017-statement.pdf
</code></pre>
<h1 id="references-3"><a class="header" href="#references-3">References</a></h1>
<ul>
<li>https://poppler.freedesktop.org/</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="nix"><a class="header" href="#nix">nix</a></h1>
<p>This notes assume to have the <a href="https://nix.dev/manual/nix/latest/command-ref/conf-file.html#conf-experimental-features"><code>experimental-features = nix-command flakes</code></a> enabled.</p>
<h2 id="nixconf-ref"><a class="header" href="#nixconf-ref">nix.conf (<a href="https://nix.dev/manual/nix/latest/command-ref/conf-file">ref</a>)</a></h2>
<pre><code class="language-bash">nix config show
# experimental-features
#     enable additional experimental features
# flake-registery
#     url of global registry
# tarball-ttl
#     time the downloaded tarball is treated as valid
</code></pre>
<h2 id="nix-search-ref"><a class="header" href="#nix-search-ref">nix search (<a href="https://nix.dev/manual/nix/latest/command-ref/new-cli/nix3-search">ref</a>)</a></h2>
<pre><code class="language-bash">nix search &lt;installable&gt; &lt;regex&gt;
# Flakeref from registry.
nix search nixpkgs glibc
# Explicit flakeref.
nix search nixpkgs/nixos-25.05 glibc
</code></pre>
<h2 id="nix-run-ref"><a class="header" href="#nix-run-ref">nix run (<a href="https://nix.dev/manual/nix/latest/command-ref/new-cli/nix3-run">ref</a>)</a></h2>
<pre><code class="language-bash">nix run &lt;installable&gt; -- &lt;args&gt;
nix run nixpkgs#strace -- -o strace.txt /bin/ls
nix run nixpkgs/nixos-25.05#emacs
</code></pre>
<h2 id="nix-shell-ref"><a class="header" href="#nix-shell-ref">nix shell (<a href="https://nix.dev/manual/nix/latest/command-ref/new-cli/nix3-env-shell">ref</a>)</a></h2>
<pre><code class="language-bash"># Enter interactive shell with pkgs in PATH.
nix shell &lt;installable&gt; [&lt;installable&gt;]
nix shell nixpkgs#qemu nixpkgs#zig nixpkgs/nixos-25.05#strace
</code></pre>
<h2 id="nix-profile-ref"><a class="header" href="#nix-profile-ref">nix profile (<a href="https://nix.dev/manual/nix/latest/command-ref/new-cli/nix3-profile">ref</a>)</a></h2>
<p>The history allows to install packages, update them and easily rollback.</p>
<pre><code class="language-bash"># Install/remove/upgrade package(s) (creates a new history version).
nix profile install &lt;installable&gt;
nix profile remove
nix profile upgrade --all

# List installed packages.
nix profile list

# Show different hisitory versions.
nix profile history

# Rollback profile history.
nix profile rollback [--to N]
</code></pre>
<h2 id="nix-store-ref"><a class="header" href="#nix-store-ref">nix store (<a href="https://nix.dev/manual/nix/latest/command-ref/new-cli/nix3-store">ref</a>)</a></h2>
<pre><code class="language-bash"># Show all alive store paths (paths with active reference).
nix-store --gc --print-live
# Show all dead store paths (paths w/o active reference).
nix-store --gc --print-dead

# Run garbage collection on nix store. This deletes all paths which are no
# gcroots and any dependency of any gcroot.
nix store gc

# Delete single path from store.
nix store delete &lt;path&gt;

# gcroots are for example created automatically when installing packages into
# the profile or when building a flake locally.
# gcroots are located under /nix/var/nix/gcroots
#
# One can also create mamual gcroots (eg for tmp operation).
&gt; nix-store --gc --print-dead | grep 'binutils-2.44$'
/nix/store/wcv8n2k53w8sbffpf716gxj6mjb5jf26-binutils-2.44

&gt; mkdir -p /nix/var/nix/gcroots/tmp
&gt; ln -s /nix/store/wcv8n2k53w8sbffpf716gxj6mjb5jf26-binutils-2.44 /nix/var/nix/gcroots/tmp/keep-binutils

&gt; nix-store --gc --print-dead | grep 'binutils-2.44$'
&gt; nix-store --gc --print-live | grep 'binutils-2.44$'
/nix/store/wcv8n2k53w8sbffpf716gxj6mjb5jf26-binutils-2.44
</code></pre>
<h2 id="nix-flake-ref"><a class="header" href="#nix-flake-ref">nix flake (<a href="https://nix.dev/manual/nix/latest/command-ref/new-cli/nix3-flake">ref</a>)</a></h2>
<p>Flakes provide a description for reproducible builds.</p>
<pre><code class="language-bash"># Create a new flake in a folder with name.
nix flake new &lt;name&gt;
# Create a new flake from given template.
nix flake new -t &lt;template&gt; &lt;name&gt;
# Create a new flake with the c-hello output from the templates flake.
nix flake create -t templates#c-hello myflake

# Show the outputs of a flake
nix flake show &lt;flake&gt;
# Show outputs from the default "templates" flake.
nix flake show templates
# Assumes '.' as flake (which effectively means flake.nix in cwd).
nix flake show

# Show the derivation of an installable in pretty format.
nix derivation show &lt;installable&gt;
# Show the derivation of the glibc output from the nixpkg flake.
nix derivation show nixpkgs#glibc
# Assumes '.' as flake.
nix derivation show

# Show a flakes metadata (eg store path, inputs, description, ..)
nix flake metadata &lt;flake&gt;

# Update the versions in the flake.lock file.
nix flake update
</code></pre>
<blockquote>
<p>Use <code>nix registry list</code> to list available global flakes or <code>nix registry pin &lt;flake&gt;</code>, to pin a flake to a fixed version.</p>
<p>Documentation for <a href="https://nix.dev/manual/nix/latest/command-ref/new-cli/nix#installables">installable</a> syntax.</p>
</blockquote>
<h3 id="a-bare-bones-flake"><a class="header" href="#a-bare-bones-flake">a bare bones flake</a></h3>
<p>The following shows a <em>bare bones</em> flake using the
<a href="https://nix.dev/manual/nix/latest/language/derivations"><code>builtins.derivation</code></a> function to define an output called
<strong>moose</strong>. The builtin provides an empty environment.</p>
<p>In general, a derivation is a declarative description of how to run an
<em>executable (builder)</em> on a set of <em>inputs (input derivations aka dependencies)</em>
to produce a set of <em>outputs (store paths)</em>.</p>
<pre><code class="language-nix"># The flake is effectively an attribute set with a standard set of attributes.
{
  description = "bare bones (flake)";

  # Input(s) of the flake.
  # Each input attribute is passed into the output function below.
  inputs = {
    nixpkgs.url = "github:nixos/nixpkgs?ref=nixos-unstable";
  };

  # The 'outputs' attribute is a function, accepting an attribute set with a
  # self reference and all the inputs specified above.
  # The function shall return an attribute set with different outputs.
  # There are standardized outputs for different commands such as:
  #   &gt; nix build
  #   &gt; nix develop
  outputs = { self, nixpkgs }: let
    # Define local variables with let .. in construct.
    system = "x86_64-linux";
    # Import another flake, passing an attribute set.
    # inherit system, is effectively system = system;
    pkgs = import nixpkgs { inherit system; };
  in
  # Return attribute set.
  {
    # Some output.
    moose = builtins.derivation {
      # -- Required attributes.
      inherit system;
      name = "bone";
      builder = "${pkgs.bash}/bin/bash";
      # -- Optional attributes.
      args = [ "-c" "echo hello &gt; $out" ];
    };
  };
}
</code></pre>
<p>Understanding this example is crucial as any abstractions such as the
<a href="https://nixos.org/manual/nixpkgs/stable/#chap-stdenv"><code>nixpkgs.stdenv</code></a> builds on top of this.</p>
<p>One can inspect and build the derivation as follows.</p>
<pre><code class="language-bash"># Show the derivation for the output "moose".
&gt; nix derivation show .#moose
{
  "/nix/store/q2l7g7myy5gmks7jml6hz2jd73yybplq-bone.drv": {
    ...
    "inputDrvs": {
      "/nix/store/d2gv7y7i7bw79dpfskzzk2g4h6mc0677-bash-interactive-5.2p37.drv": {
}

# Build the output 'moose' for the flake.nix in the cwd ('.').
&gt; nix build .#moose ; cat result
hello
</code></pre>
<blockquote>
<p>A derivation also defines a set of <code>outputs</code>, which by default is <code>["out"]</code>.
Outputs are passed as environment variables to the builder, from where they
can be used as install targets for example.</p>
</blockquote>
<p>An interesting point to observe is that nix computed <em>bash</em> as input derivation
(inputDrv) and hence as input dependency for this output.</p>
<h3 id="a-stdenv-flake"><a class="header" href="#a-stdenv-flake">a stdenv flake</a></h3>
<p>The <a href="https://nixos.org/manual/nixpkgs/stable/#chap-stdenv"><code>stdenv</code></a> library from the <em>nixpkgs</em> flake provides the
<code>mkDerivation</code> function to simplify building packages (defining derivations).
Many tools commonly used to build software are available out of the box.
Specifying build and runtime dependencies can also be done easiy.</p>
<p>The default builder provided by the <code>mkDerivation</code> function, organizes the build
into multiple phases like <em>config</em>, <em>build</em> and <em>install</em>. When defining the
derivation these phases can be easily overwritten.</p>
<p>Alternatively there is <code>stdenvNoCC.mkDerivation</code> which provides an environment
without a C compiler.</p>
<p>The example show a simple build and installation of a C file.</p>
<pre><code class="language-nix">{
  description = "stdenv (flake)";

  inputs = { nixpkgs.url = "github:nixos/nixpkgs?ref=nixos-unstable"; };

  outputs = { self, nixpkgs }:
    let
      system = "x86_64-linux";
      pkgs = import nixpkgs { inherit system; };
    in {
      # Enable support for 'nix fmt'.
      formatter.${system} = pkgs.nixfmt;

      # This is the default output that will be build &amp; run if no output is
      # specified, when running the following in the flakes directory.
      # &gt; nix build
      # &gt; nix run
      # &gt; nix log
      packages.${system}.default = pkgs.stdenv.mkDerivation {
        # Either specify 'name' or 'pname &amp; version'.
        # In the latter case, 'name' will be ${pname}-${version}.
        pname = "test";
        version = "0.1";

        # There are different builtins to also unpack or fetch tarballs.
        src = ./src;

        # The default builder of the stdenv defines many different phases that
        # can be overwritten.

        buildPhase = ''
          gcc -O2 -g -o test test.c
        '';

        installPhase = ''
          mkdir -p $out/bin
          cp test $out/bin
        '';
      };
    };
}
</code></pre>
<blockquote>
<p>Use <a href="https://nixos.org/manual/nixpkgs/stable/#var-stdenv-NIX_DEBUG"><code>NIX_DEBUG=[0-7]</code></a> to enable <code>stdenv</code> debug logging.
Use <code>nix log [&lt;installable&gt;]</code> to inspect the build log.</p>
</blockquote>
<p>One can also define multiple <em>output</em> directories using the <code>outputs</code> attribute
in the derivation. Each output turns into an environment variable of the same
name. Use <code>nix derivation show</code> to inspect the outputs and the environment the
builder inherits.</p>
<p>For example the <em>glibc</em> package in the <em>nixpkgs</em> flake provides multiple
outputs.</p>
<pre><code class="language-bash">&gt; nix derivation show nixpkgs#glibc
..
"outputs": {
      ..
      "out": {
        "path": "/nix/store/g3s0z9r7m1lsfxdk8bj88nw8k8q3dmmg-glibc-2.40-66"
      },
      "static": {
        "path": "/nix/store/lfj0w1r0ppj2swb11pz8vkppmsy1rf6y-glibc-2.40-66-static"
      }
    },
..
</code></pre>
<h3 id="a-development-shell-flake"><a class="header" href="#a-development-shell-flake">a development shell flake</a></h3>
<p>The <code>nixpkgs</code> flake also provides the <a href="https://nixos.org/manual/nixpkgs/stable/#sec-pkgs-mkShell"><code>mkShell</code></a> derivation
function (specialization of <code>mkDerivation</code>), which can be used to easily define
a development environment.</p>
<p>Alternatively there is also <a href="https://nixos.org/manual/nixpkgs/stable/#sec-pkgs-mkShell-variants"><code>mkShellNoCC</code></a> which provides
an environment without a C compiler.</p>
<p>The example shows an environment with the <code>zig</code> compiler and <code>zls</code>, the zig lsp
server. Running <code>nix develop</code> will drop into a shell where these packages are
available.</p>
<pre><code class="language-nix">{
  description = "dev shell (flake)";

  inputs = { nixpkgs.url = "github:nixos/nixpkgs?ref=nixos-unstable"; };

  outputs = { self, nixpkgs }:
    let
      system = "x86_64-linux";
      pkgs = import nixpkgs { inherit system; };
    in {
      devShells.${system}.default = pkgs.mkShell {
        packages = [
          pkgs.zig
          pkgs.zls
        ];
      };
    };
}
</code></pre>
<p>When launching a development shell, the environment of the current shell is
inherited. Using <code>-i</code> clears the environment when entering the dev shell, using
<code>-k</code> certain variables can be kept.
For example the following command will only inherit <code>$USER, $HOME, $DISPLAY</code>
into the development shell.</p>
<pre><code class="language-sh">nix develop -i -k USER -k HOME -k DISPLAY
</code></pre>
<p>One can also just run a command in the development shell.</p>
<pre><code class="language-sh">nix develop --command bash -c "mkdir build &amp;&amp; cd build &amp;&amp; cmake .. &amp;&amp; make"
</code></pre>
<h3 id="flake-default-targets"><a class="header" href="#flake-default-targets">flake default targets</a></h3>
<p>When called without an explicit output, certain nix commands have default
outputs. The following gives the most relevant.</p>
<pre><code>nix build
nix run
nix log
# uses -&gt; packages.&lt;SYSTEM&gt;.default

nix develop
# uses -&gt; devShells.&lt;SYSTEM&gt;.default
</code></pre>
<h2 id="nix-lang-basics"><a class="header" href="#nix-lang-basics">nix lang basics</a></h2>
<p>Nix is a functional language, where everything is an expression.
The following shows enough nix lang to come quite far.</p>
<pre><code class="language-nix">$ nix repl

nix-repl&gt; 1 + 2
3

# String interpolation.
# (Assignment operation special to repl).
nix-repl&gt; foo = "bar"
nix-repl&gt; "hello ${foo}"
"hello bar"

# Simple function with argument.
nix-repl&gt; f = a: a + 2
nix-repl&gt; f 4
6

# Attribute sets (kv).
nix-repl&gt; { a = 1; b = 2; }
{
  a = 1;
  b = 2;
}

# Function taking an attribute set.
nix-repl&gt; f = { a, b }: a + b
nix-repl&gt; f { a = 1; b = 2; }
3
nix-repl&gt; f { b = 1; a = 2; }
3

# Function taking an attribute set w/o explicitly naming each input.
# Here, inp will bind to the whole input attribute set.
nix-repl&gt; f = { a, b, ... } @ inp : a + inp.b + inp.c
nix-repl&gt; f { b = 1; a = 2; c = 3; }
6

# Defining local variables with "let .. in".
nix-repl&gt; let x = 1; in x + 3
4
nix-repl&gt; x
error: undefined variable 'x'

# Let .. in expression returning an attribute set (handy when defining derivations).
nix-repl&gt; let x = "abc"; in { name = "bar ${x}"; }
{ name = "bar abc"; }

# Show all builtin functions.
nix-repl&gt; builtins
{
  abort = «primop abort»;
  add = «primop add»;
  ..

# Access a flake inside repl.
nix-repl&gt; pkgs = builtins.getFlake "nixpgs"
nix-repl&gt; pkgs.legacyPackages.x86_64-linux.stdenvNoCC.mkDerivation
nix-repl&gt; pkgs.legacyPackages.x86_64-linux.llvm  # tab
pkgs.legacyPackages.x86_64-linux.llvm                 pkgs.legacyPackages.x86_64-linux.llvmPackages_git
pkgs.legacyPackages.x86_64-linux.llvm-manpages        pkgs.legacyPackages.x86_64-linux.llvmPackages_latest
pkgs.legacyPackages.x86_64-linux.llvmPackages         pkgs.legacyPackages.x86_64-linux.llvm_12

# Factoring out code into multiple files.
# default.nix
#   { x, y }: {
#       a = x + 10;
#       b = y + 20;
#   }
#
# Import nix file by name ..
nix-repl&gt; myfn = import ./default.nix
# .. or use short form for default.nix.
nix-repl&gt; myfn = import ./.
nix-repl&gt; myfn { x = 1; y = 2; }
{ a = 11; b = 22; }
nix-repl&gt; x = 10
nix-repl&gt; myfn { inherit x ; y = 2; }
{ a = 20; b = 22; }
</code></pre>
<h2 id="references-4"><a class="header" href="#references-4">References</a></h2>
<ul>
<li><a href="https://nix.dev/manual/nix/latest/command-ref/new-cli/nix#installables">nix installable</a></li>
<li><a href="https://nix.dev/manual/nix/latest/command-ref/new-cli/nix3-flake#flake-references">nix flakeref</a></li>
<li><a href="https://nix.dev/manual/nix/latest/command-ref/new-cli/nix3-flake">nix flake</a></li>
<li><a href="https://nix.dev/manual/nix/latest/command-ref/new-cli/nix3-store">nix store</a></li>
<li><a href="https://nix.dev/manual/nix/latest/command-ref/new-cli/nix3-profile">nix profile</a></li>
<li><a href="https://nix.dev/manual/nix/latest/command-ref/conf-file">nix conf</a></li>
<li><a href="https://nix.dev/manual/nix/latest/language/derivations"><code>builtin.derivation</code></a></li>
<li><a href="https://nixos.org/manual/nixpkgs/stable/#chap-stdenv"><code>nixpkgs.stdenv</code></a></li>
<li><a href="https://nixos.org/manual/nixpkgs/stable/#sec-pkgs-mkShell"><code>nixpkgs.mkShell</code></a></li>
<li><a href="https://nixos.org/guides/nix-pills/">nix pills</a></li>
<li><a href="https://search.nixos.org/packages">nixpkgs search</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="process-management--inspection"><a class="header" href="#process-management--inspection">Process management &amp; inspection</a></h1>
<ul>
<li><a href="#lsof8">lsof</a></li>
<li><a href="#pidstat1">pidstat</a></li>
<li><a href="#pgrep1">pgrep</a></li>
<li><a href="#ps1">ps</a></li>
<li><a href="#pmap1">pmap</a></li>
<li><a href="#pstack1">pstack</a></li>
<li><a href="#taskset1">taskset</a></li>
<li><a href="#nice1">nice</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="lsof8"><a class="header" href="#lsof8">lsof(8)</a></h1>
<pre><code class="language-markdown">lsof
  -r &lt;s&gt; ..... repeatedly execute command ervery &lt;s&gt; seconds
  -a ......... AND slection filters instead ORing (OR: default)
  -p &lt;pid&gt; ... filter by &lt;pid&gt;
  +fg ........ show file flags for file descripros
  -n ......... don't convert network addr to hostnames
  -P ......... don't convert network port to service names
  -i &lt;@h[:p]&gt;. show connections to h (hostname|ip addr) with optional port p
  -s &lt;p:s&gt; ... in conjunction with '-i' filter for protocol &lt;p&gt; in state &lt;s&gt;
  -U ......... show unix domain sockets ('@' indicates abstract sock name, see unix(7))
</code></pre>
<pre><code class="language-markdown">file flags:
  R/W/RW ..... read/write/read-write
  CR ......... create
  AP ......... append
  TR ......... truncate
</code></pre>
<pre><code class="language-markdown">-s protocols
  TCP, UDP

-s states (TCP)
  CLOSED, IDLE, BOUND, LISTEN, ESTABLISHED, SYN_SENT, SYN_RCDV, ESTABLISHED,
  CLOSE_WAIT, FIN_WAIT1, CLOSING, LAST_ACK, FIN_WAIT_2, TIME_WAIT

-s states (UDP)
  Unbound, Idle
</code></pre>
<h1 id="examples-9"><a class="header" href="#examples-9">Examples</a></h1>
<h2 id="file-flags"><a class="header" href="#file-flags">File flags</a></h2>
<p>Show open files with file flags for process:</p>
<pre><code class="language-markdown">lsof +fg -p &lt;pid&gt;
</code></pre>
<h2 id="open-tcp-connections"><a class="header" href="#open-tcp-connections">Open TCP connections</a></h2>
<p>Show open tcp connections for <code>$USER</code>:</p>
<pre><code class="language-markdown">lsof -a -u $USER -i TCP
</code></pre>
<p><strong>Note</strong>: <code>-a</code> <em>ands</em> the results. If <code>-a</code> is not given all open files matching
<code>$USER</code> and all tcp connections are listed (<em>ored</em>).</p>
<h2 id="open-connection-to-specific-host"><a class="header" href="#open-connection-to-specific-host">Open connection to specific host</a></h2>
<p>Show open connections to <code>localhost</code> for <code>$USER</code>:</p>
<pre><code class="language-markdown">lsof -a -u $USER -i @localhost
</code></pre>
<h2 id="open-connection-to-specific-port"><a class="header" href="#open-connection-to-specific-port">Open connection to specific port</a></h2>
<p>Show open connections to port <code>:1234</code> for <code>$USER</code>:</p>
<pre><code class="language-markdown">lsof -a -u $USER -i :1234
</code></pre>
<h2 id="ipv4-tcp-connections-in-established-state"><a class="header" href="#ipv4-tcp-connections-in-established-state">IPv4 TCP connections in <code>ESTABLISHED</code> state</a></h2>
<pre><code class="language-markdown">lsof -i 4TCP -s TCP:ESTABLISHED
</code></pre>
<h2 id="list-open-files-in-a-mounted-directory"><a class="header" href="#list-open-files-in-a-mounted-directory">List open files in a mounted directory.</a></h2>
<p>This may help to find which processes keep devices busy when trying to unmount
and the device is currently busy.</p>
<pre><code class="language-markdown"># Assuming /proc is a mount point.
lsof /proc
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="pidstat1"><a class="header" href="#pidstat1">pidstat(1)</a></h1>
<pre><code class="language-markdown">pidstat [opt] [interval] [cont]
  -U [user]     show username instead UID, optionally only show for user
  -r            memory statistics
  -d            I/O statistics
  -h            single line per process and no lines with average
</code></pre>
<h1 id="page-fault-and-memory-utilization"><a class="header" href="#page-fault-and-memory-utilization">Page fault and memory utilization</a></h1>
<pre><code class="language-markdown">pidstat -r -p &lt;pid&gt; [interval] [count]
</code></pre>
<pre><code class="language-markdown">minor_pagefault: Happens when the page needed is already in memory but not
                 allocated to the faulting process, in that case the kernel
                 only has to create a new page-table entry pointing to the
                 shared physical page (not required to load a memory page from
                 disk).

major_pagefault: Happens when the page needed is NOT in memory, the kernel
                 has to create a new page-table entry and populate the
                 physical page (required to load a memory page from disk).
</code></pre>
<h1 id="io-statistics"><a class="header" href="#io-statistics">I/O statistics</a></h1>
<pre><code class="language-markdown">pidstat -d -p &lt;pid&gt; [interval] [count]
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="pgrep1"><a class="header" href="#pgrep1">pgrep(1)</a></h1>
<pre><code class="language-markdown">pgrep [opts] &lt;pattern&gt;
  -n         only list newest matching process
  -u &lt;usr&gt;   only show matching for user &lt;usr&gt;
  -l         additionally list command
  -a         additionally list command + arguments
  -x         match exactly
</code></pre>
<h2 id="debug-newest-process"><a class="header" href="#debug-newest-process">Debug newest process</a></h2>
<p>For example attach gdb to newest zsh process from <code>$USER</code>.</p>
<pre><code class="language-markdown">gdb -p $(pgrep -n -u $USER zsh)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ps1"><a class="header" href="#ps1">ps(1)</a></h1>
<pre><code>ps [opt]
  opt:
    --no-header .... do not print column header
    -o &lt;OUT&gt; ....... comma separated list of output columns
    -p &lt;PID&gt; ....... only show pid
    -C &lt;name&gt; ...... only show processes matching name
    -T ............. list threads
    --signames ..... use short signames instead bitmasks
</code></pre>
<blockquote>
<p>Set <code>PS_FORMAT</code> env variable to setup default output columns.</p>
</blockquote>
<p>Frequently used output columns</p>
<pre><code>pid        process id
ppid       parent process id
pgid       process group id
tid        thread id

comm       name of process
cmd        name of process + args (full)

etime      elapsed time (since process started)
user       user owning process
thcount    thread count of process
nice       nice value (-20 highest priority to 19 lowest)

pcpu       cpu utilization (percent)
pmem       physical resident set (rss) (percent)
rss        physical memory (in kb)
vsz        virtual memory (in kb)

sig        mask of pending signals
sigcatch   mask of caught signals
sigignore  mask of ignored signals
sigmask    mask of blocked signals
</code></pre>
<h2 id="example-use-output-for-scripting"><a class="header" href="#example-use-output-for-scripting">Example: Use output for scripting</a></h2>
<pre><code class="language-sh"># Print the cpu affinity for each thread of process 31084.
for tid in $(ps -o tid --no-header -T -p 31084); do
    taskset -c -p $tid;
done
</code></pre>
<h2 id="example-watch-processes-by-name"><a class="header" href="#example-watch-processes-by-name">Example: Watch processes by name</a></h2>
<pre><code class="language-sh">watch -n1 ps -o pid,pcpu,pmem,rss,vsz,state,user,comm -C fish
</code></pre>
<h2 id="example-show-signal-information"><a class="header" href="#example-show-signal-information">Example: Show signal information</a></h2>
<pre><code class="language-sh"># With signal masks.
ps -o pid,user,sig,sigcatch,sigignore,sigmask,comm -p 66570

# With signal names.
ps --signames -o pid,user,sig,sigcatch,sigignore,sigmask,comm -p 66570
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="pmap1"><a class="header" href="#pmap1">pmap(1)</a></h1>
<pre><code class="language-markdown">pmap [opts] &lt;pid&gt;
    Dump virtual memory map of process.
    Compared to /proc/&lt;pid&gt;/maps it shows the size of the mappings.
opts:
  -p         show full path in the mapping
  -x         show details (eg RSS usage of each segment)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="pstack1"><a class="header" href="#pstack1">pstack(1)</a></h1>
<pre><code class="language-markdown">pstack &lt;pid&gt;
    Dump stack for all threads of process.
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="taskset1"><a class="header" href="#taskset1">taskset(1)</a></h1>
<p>Set cpu affinity for new processes or already running ones.</p>
<pre><code class="language-sh"># Pin all (-a) tasks of new command on cores 0,1,2,4.
taskset -ac 0-2,4 CMD [ARGS]

# Pin all tasks of running PID onto cores 0,2,4.
taskset -ac 0-5:2 -p PID
</code></pre>
<h3 id="example-4"><a class="header" href="#example-4">Example</a></h3>
<p>Utility script to extract cpu lists grouped by the last-level-cache.</p>
<pre><code class="language-python">import subprocess

res = subprocess.run(["lscpu", "-p=cpu,cache"], capture_output=True, check=True)

LLC2CPU = dict()

for line in res.stdout.decode().splitlines():
    if line.startswith("#"):
        continue

    cpu, cache = line.split(",")
    llc        = cache.split(":")[-1]

    LLC2CPU.setdefault(llc, list()).append(int(cpu))

LLC2RANGE = dict()

for llc, cpus in LLC2CPU.items():
    first_cpu = cpus[0]
    prev_cpu  = cpus[0]
    for cpu in cpus[1:]:
        if cpu != prev_cpu + 1:
            LLC2RANGE.setdefault(llc, list()).append(f"{first_cpu}-{prev_cpu}")
            # New range begins.
            first_cpu = cpu
        prev_cpu = cpu
    # Trailing range.
    LLC2RANGE.setdefault(llc, list()).append(f"{first_cpu}-{prev_cpu}")

print(LLC2RANGE)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="nice1"><a class="header" href="#nice1">nice(1)</a></h1>
<p>Adjust <code>niceness</code> of a new command or running process.</p>
<p>Niceness influences the scheduling priority and ranges between:</p>
<ul>
<li><code>-20</code> most favorable</li>
<li><code>19</code> least favorable</li>
</ul>
<pre><code class="language-sh"># Adjust niceness +5 for the launched process.
nice -n 5 yes

# Adjust niceness of running process.
renice -n 5 -p PID
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="trace-and-profile"><a class="header" href="#trace-and-profile">Trace and Profile</a></h1>
<ul>
<li><a href="#usrbintime1">time</a></li>
<li><a href="#strace1">strace</a></li>
<li><a href="#ltrace1">ltrace</a></li>
<li><a href="#perf1">perf</a></li>
<li><a href="#oprofile">OProfile</a></li>
<li><a href="#callgrind">callgrind</a></li>
<li><a href="#valgrind1">valgrind</a></li>
<li><a href="#vtune1">vtune</a></li>
<li><a href="#tracy1">tracy</a></li>
<li><a href="#xray-instrument">xray</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="usrbintime1"><a class="header" href="#usrbintime1">/usr/bin/time(1)</a></h1>
<pre><code class="language-markdown"># statistics of process run
/usr/bin/time -v &lt;cmd&gt;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="strace1"><a class="header" href="#strace1">strace(1)</a></h1>
<pre><code class="language-markdown">strace [opts] [prg]
  -f .......... follow child processes on fork(2)
  -ff ......... follow fork and separate output file per child
  -p &lt;pid&gt; .... attach to running process
  -s &lt;size&gt; ... max string size, truncate of longer (default: 32)
  -e &lt;expr&gt; ... expression for trace filtering
  -o &lt;file&gt; ... log output into &lt;file&gt;
  -c .......... dump syscall statitics at the end
  -C .......... like -c but dump regular ouput as well
  -k .......... dump stack trace for each syscall
  -P &lt;path&gt; ... only trace syscall accesing path
  -y .......... print paths for FDs
  -tt ......... print absolute timestamp (with us precision)
  -r .......... print relative timestamp
  -z .......... log only successful syscalls
  -Z .......... log only failed syscalls
  -n .......... print syscall numbers
  -y .......... translate fds (eg file path, socket)
  -yy ......... translate fds with all information (eg IP)
  -x .......... print non-ASCII chars as hex string
  -v .......... print all arguments (non-abbreviated)
</code></pre>
<pre><code class="language-markdown">&lt;expr&gt;:
  trace=syscall[,syscall] .... trace only syscall listed
  trace=file ................. trace all syscall that take a filename as arg
  trace=process .............. trace process management related syscalls
  trace=signal ............... trace signal related syscalls
  signal ..................... trace signals delivered to the process
</code></pre>
<h1 id="examples-10"><a class="header" href="#examples-10">Examples</a></h1>
<p>Trace <code>open(2)</code> &amp; <code>socket(2)</code> syscalls for a running process + child processes:</p>
<pre><code class="language-markdown">strace -f -e trace=open,socket -p &lt;pid&gt;
</code></pre>
<p>Trace signals delivered to a running process:</p>
<pre><code class="language-markdown">strace -e signal -e 'trace=!all' -p &lt;pid&gt;
</code></pre>
<p>Show successful calls to <code>perf_event_open((2)</code> without abbreviating  arguments.</p>
<pre><code class="language-markdown">strace -v -z -e trace=perf_event_open perf stat -e cycles ls
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ltrace1"><a class="header" href="#ltrace1">ltrace(1)</a></h1>
<pre><code class="language-markdown">ltrace [opts] [prg]
  -f .......... follow child processes on fork(2)
  -p &lt;pid&gt; .... attach to running process
  -o &lt;file&gt; ... log output into &lt;file&gt;
  -l &lt;filter&gt; . show who calls into lib matched by &lt;filter&gt;
  -C .......... demangle
  -e &lt;filter&gt; . show calls symbols matched by &lt;filter&gt;
  -x &lt;filter&gt; . which symbol table entry points to trace
                (can be of form sym_pattern@lib_pattern)
  -n &lt;num&gt;      number of spaces to indent nested calls
</code></pre>
<h1 id="example-5"><a class="header" href="#example-5">Example</a></h1>
<p>List which program/libs call into <code>libstdc++</code>:</p>
<pre><code class="language-bash">ltrace -l '*libstdc++*' -C -o ltrace.log ./main
</code></pre>
<p>List calls to specific symbols:</p>
<pre><code class="language-bash">ltrace -e malloc -e free ./main
</code></pre>
<p>Trace symbols from <code>dlopen(3)</code>ed libraries.</p>
<pre><code class="language-bash"># Assume libfoo.so would be dynamically loaded via dlopen.
ltrace -x '@libfoo.so'

# Trace all dlopened symbols.
ltrace -x '*'
# Trace all symbols from dlopened libraries which name match the
# pattern "liby*".
ltrace -x '@liby*'
# Trace symbol "foo" from all dlopened libraries matching the pattern.
ltrace -x 'foo@liby*'
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="perf1"><a class="header" href="#perf1">perf(1)</a></h1>
<pre><code>perf list     show supported hw/sw events &amp; metrics
  -v ........ print longer event descriptions
  --details . print information on the perf event names
              and expressions used internally by events

perf stat
  -p &lt;pid&gt; ..... show stats for running process
  -o &lt;file&gt; .... write output to file (default stderr)
  -I &lt;ms&gt; ...... show stats periodically over interval &lt;ms&gt;
  -e &lt;ev&gt; ...... select event(s)
  -M &lt;met&gt; ..... print metric(s), this adds the metric events
  --all-user ... configure all selected events for user space
  --all-kernel . configure all selected events for kernel space

perf top
  -p &lt;pid&gt; .. show stats for running process
  -F &lt;hz&gt; ... sampling frequency
  -K ........ hide kernel threads

perf record
  -p &lt;pid&gt; ............... record stats for running process
  -o &lt;file&gt; .............. write output to file (default perf.data)
  -F &lt;hz&gt; ................ sampling frequency
  --call-graph &lt;method&gt; .. [fp, dwarf, lbr] method how to caputre backtrace
                           fp   : use frame-pointer, need to compile with
                                  -fno-omit-frame-pointer
                           dwarf: use .cfi debug information
                           lbr  : use hardware last branch record facility
  -g ..................... short-hand for --call-graph fp
  -e &lt;ev&gt; ................ select event(s)
  --all-user ............. configure all selected events for user space
  --all-kernel ........... configure all selected events for kernel space
  -M intel ............... use intel disassembly in annotate

perf report
  -n .................... annotate symbols with nr of samples
  --stdio ............... report to stdio, if not presen tui mode
  -g graph,0.5,callee ... show callee based call chains with value &gt;0.5
</code></pre>
<pre><code>Useful &lt;ev&gt;:
  page-faults
  minor-faults
  major-faults
  cpu-cycles`
  task-clock
</code></pre>
<h2 id="select-specific-events"><a class="header" href="#select-specific-events">Select specific events</a></h2>
<p>Events to sample are specified with the <code>-e</code> option, either pass a comma
separated list or pass <code>-e</code> multiple times.</p>
<p>Events are specified in the following form <code>name[:modifier]</code>. The list and
description of the <code>modifier</code> can be found in the
<a href="https://man7.org/linux/man-pages/man1/perf-list.1.html"><code>perf-list(1)</code></a> manpage under <code>EVENT MODIFIERS</code>.</p>
<pre><code class="language-sh"># L1 i$ misses in user space
# L2 i$ stats in user/kernel space mixed
# Sample specified events.
perf stat -e L1-icache-load-misses:u \
          -e l2_rqsts.all_code_rd:uk,l2_rqsts.code_rd_hit:k,l2_rqsts.code_rd_miss:k \
          -- stress -c 2
</code></pre>
<p>The <code>--all-user</code> and <code>--all-kernel</code> options append a <code>:u</code> and <code>:k</code> modifier to
all specified events. Therefore the following two command lines are equivalent.</p>
<pre><code class="language-sh"># 1)
perf stat -e cycles:u,instructions:u -- ls

# 2)
perf stat --all-user -e cycles,instructions -- ls
</code></pre>
<h3 id="raw-events"><a class="header" href="#raw-events">Raw events</a></h3>
<p>In case perf does not provide a <em>symbolic</em> name for an event, the event can be
specified in a <em>raw</em> form as <code>r + UMask + EventCode</code>.</p>
<p>The following is an example for the <a href="https://github.com/intel/perfmon/blob/09c155f72e1b8f14b09aea346a35467a03a7d62b/SNB/events/sandybridge_core.json#L808">L2_RQSTS.CODE_RD_HIT</a> event
with <code>EventCode=0x24</code> and <code>UMask=0x10</code> on my laptop with a <code>sandybridge</code> uarch.</p>
<pre><code class="language-sh">perf stat -e l2_rqsts.code_rd_hit -e r1024 -- ls
# Performance counter stats for 'ls':
#
#       33.942      l2_rqsts.code_rd_hit
#       33.942      r1024
</code></pre>
<h3 id="find-raw-performance-counter-events-intel"><a class="header" href="#find-raw-performance-counter-events-intel">Find raw performance counter events (intel)</a></h3>
<p>The <a href="https://github.com/intel/perfmon"><code>intel/perfmon</code></a> repository provides a performance event
databases for the different intel uarchs.</p>
<p>The table in <a href="https://github.com/intel/perfmon/blob/main/mapfile.csv"><code>mapfile.csv</code></a> can be used to lookup the
corresponding uarch, just grab the family model from the procfs.</p>
<pre><code class="language-sh"> cat /proc/cpuinfo | awk '/^vendor_id/  { V=$3 }
                          /^cpu family/ { F=$4 }
                          /^model\s*:/  { printf "%s-%d-%x\n",V,F,$3 }'
</code></pre>
<blockquote>
<p>The table in <a href="https://github.com/intel/perfmon/tree/main#performance-monitoring-events">performance monitoring events</a> describes how
events are sorted into the different files.</p>
</blockquote>
<h3 id="raw-events-for-perfs-own-symbolic-names"><a class="header" href="#raw-events-for-perfs-own-symbolic-names">Raw events for perfs own symbolic names</a></h3>
<p>Perf also defines some own <em>symbolic</em> names for events. An example is the
<code>cache-references</code> event. The <a href="https://man7.org/linux/man-pages/man2/perf_event_open.2.html"><code>perf_event_open(2)</code></a> manpage
gives the following description.</p>
<pre><code class="language-man">perf_event_open(2)

PERF_COUNT_HW_CACHE_REFERENCES
    Cache accesses.  Usually this indicates Last Level Cache accesses but this
    may vary depending on your CPU.  This may include prefetches and coherency
    messages; again this depends on the design of your CPU.
</code></pre>
<p>The <code>sysfs</code> can be consulted to get the concrete performance counter on the
given system.</p>
<pre><code class="language-sh">cat /sys/devices/cpu/events/cache-misses
# event=0x2e,umask=0x41
</code></pre>
<h2 id="flamegraph"><a class="header" href="#flamegraph"><a href="https://github.com/brendangregg/FlameGraph"><code>Flamegraph</code></a></a></h2>
<h3 id="flamegraph-with-single-event-trace"><a class="header" href="#flamegraph-with-single-event-trace">Flamegraph with single event trace</a></h3>
<pre><code>perf record -g -e cpu-cycles -p &lt;pid&gt;
perf script | FlameGraph/stackcollapse-perf.pl | FlameGraph/flamegraph.pl &gt; cycles-flamegraph.svg
</code></pre>
<h3 id="flamegraph-with-multiple-event-traces"><a class="header" href="#flamegraph-with-multiple-event-traces">Flamegraph with multiple event traces</a></h3>
<pre><code class="language-sh">perf record -g -e cpu-cycles,page-faults -p &lt;pid&gt;
perf script --per-event-dump
# fold &amp; generate as above
</code></pre>
<h2 id="examples-11"><a class="header" href="#examples-11">Examples</a></h2>
<h3 id="estimate-max-instructions-per-cycle"><a class="header" href="#estimate-max-instructions-per-cycle">Estimate max instructions per cycle</a></h3>
<pre><code class="language-c">#define NOP4        "nop\nnop\nnop\nnop\n"
#define NOP32       NOP4   NOP4   NOP4   NOP4   NOP4   NOP4   NOP4   NOP4
#define NOP256      NOP32  NOP32  NOP32  NOP32  NOP32  NOP32  NOP32  NOP32
#define NOP2048     NOP256 NOP256 NOP256 NOP256 NOP256 NOP256 NOP256 NOP256

int main() {
  for (unsigned i = 0; i &lt; 2000000; ++i) {
    asm volatile(NOP2048);
  }
}
</code></pre>
<pre><code class="language-sh">perf stat -e cycles,instructions ./noploop
# Performance counter stats for './noploop':
#
#     1.031.075.940      cycles
#     4.103.534.341      instructions       #    3,98  insn per cycle
</code></pre>
<h3 id="caller-vs-callee-callstacks"><a class="header" href="#caller-vs-callee-callstacks">Caller vs callee callstacks</a></h3>
<p>The following gives an example for a scenario where we have the following calls</p>
<ul>
<li><code>main -&gt; do_foo() -&gt; do_work()</code></li>
<li><code>main -&gt; do_bar() -&gt; do_work()</code></li>
</ul>
<pre><code class="language-sh">perf report --stdio -g graph,caller

# Children      Self  Command  Shared Object         Symbols
# ........  ........  .......  ....................  .................
#
#  49.71%    49.66%   bench    bench                 [.] do_work
#          |
#           --49.66%--_start                &lt;- callstack bottom
#                     __libc_start_main
#                     0x7ff366c62ccf
#                     main
#                     |
#                     |--25.13%--do_bar
#                     |          do_work    &lt;- callstack top
#                     |
#                      --24.53%--do_foo
#                                do_work

perf report --stdio -g graph,callee

# Children      Self  Command  Shared Object         Symbols
# ........  ........  .......  ....................  .................
#
#  49.71%    49.66%   bench    bench                 [.] do_work
#          |
#          ---do_work                       &lt;- callstack top
#             |
#             |--25.15%--do_bar
#             |          main
#             |          0x7ff366c62ccf
#             |          __libc_start_main
#             |          _start             &lt;- callstack bottom
#             |
#              --24.55%--do_foo
#                        main
#                        0x7ff366c62ccf
#                        __libc_start_main
#                        _start             &lt;- callstack bottom
</code></pre>
<h2 id="references-5"><a class="header" href="#references-5">References</a></h2>
<ul>
<li><a href="https://github.com/intel/perfmon">intel/perfmon</a> - intel PMU event database per uarch</li>
<li><a href="https://perfmon-events.intel.com/">intel/perfmon-html</a> - a html rendered version of the PMU
events with search</li>
<li><a href="https://github.com/intel/perfmon/blob/main/mapfile.csv">intel/perfmon/mapfile.csv</a> - processor family to uarch mapping</li>
<li><a href="https://github.com/torvalds/linux/tree/master/tools/perf/pmu-events/arch/x86">linux/perf/events</a> - x86 PMU events known to perf tools</li>
<li><a href="https://github.com/torvalds/linux/blob/master/arch/x86/events/intel/core.c">linux/arch/events</a> - x86 PMU events linux kernel</li>
<li><a href="https://en.wikichip.org/wiki/WikiChip">wikichip</a> - computer architecture wiki</li>
<li><a href="https://man7.org/linux/man-pages/man1/perf-list.1.html">perf-list(1)</a> - manpage</li>
<li><a href="https://man7.org/linux/man-pages/man2/perf_event_open.2.html">perf_event_open(2)</a> - manpage</li>
<li><a href="https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html">intel/sdm</a> - intel software developer manuals (eg Optimization
Reference Manual)</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="oprofile"><a class="header" href="#oprofile"><a href="https://oprofile.sourceforge.io/">OProfile</a></a></h1>
<pre><code class="language-markdown">operf -g -p &lt;pid&gt;
  -g ...... caputre call-graph information

opreport [opt] FILE
            show time spent per binary image
  -l ...... show time spent per symbol
  -c ...... show callgraph information (see below)
  -a ...... add column with time spent accumulated over child nodes

ophelp      show supported hw/sw events
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="callgrind"><a class="header" href="#callgrind">callgrind</a></h1>
<p>Callgrind is a tracing profiler which records the function call history of a
target program and collects the number of executed instructions. It is part of
the <a href="https://valgrind.org/docs/manual/cl-manual.html">valgrind</a> tool suite.</p>
<p>Profiling data is collected by instrumentation rather than sampling of the
target program.</p>
<p>Callgrind does not capture the actual time spent in a function but computes the
<em>inclusive</em> &amp; <em>exclusive</em> cost of a function based on the instructions fetched
(<code>Ir = Instruction read</code>). This provides reproducibility and high-precision and
is a major difference to sampling profilers like <code>perf</code> or <code>vtune</code>.
Therefore effects like slow IO are not reflected, which should be kept in mind
when analyzing callgrind results.</p>
<p>By default the profiler data is dumped when the target process is terminating,
but <a href="https://valgrind.org/docs/manual/cl-manual.html#cl-manual.callgrind_control-options">callgrind_control</a> allows for interactive control of callgrind.</p>
<pre><code class="language-bash"># Run a program under callgrind.
valgrind --tool=callgrind -- &lt;prog&gt; [&lt;args&gt;]

# Interactive control of callgrind.
callgrind_control [opts]
  opts:
    -b ............. show current backtrace
    -e ............. show current event counters
    -s ............. show current stats
    --dump[=file] .. dump current collection
    -i=on|off ...... turn instrumentation on|off
</code></pre>
<p>Results can be analyzed by using one of the following tools</p>
<ul>
<li><a href="https://valgrind.org/docs/manual/cl-manual.html#cl-manual.callgrind_annotate-options">callgrind_annotate</a> (cli)
<pre><code class="language-sh"># Show only specific trace events (default is all).
callgrind_annotate --show=Ir,Dr,Dw [callgrind_out_file]
</code></pre>
</li>
<li><a href="https://kcachegrind.github.io/html/Home.html">kcachegrind</a> (ui)</li>
</ul>
<p>The following is a collection of frequently used callgrind options.</p>
<pre><code class="language-bash">valgrind --tool=callgrind [opts] -- &lt;prog&gt;
  opts:
    --callgrind-out-file=&lt;file&gt; .... output file, rather than callgrind.out.&lt;pid&gt;
    --dump-instr=&lt;yes|no&gt; .......... annotation on instrucion level,
                                     allows for asm annotations

    --instr-atstart=&lt;yes|no&gt; ....... control if instrumentation is enabled from 
                                     beginning of the program

    --separate-threads=&lt;yes|no&gt; .... create separate output files per thread,
                                     appends -&lt;thread_id&gt; to the output file

    --cache-sim=&lt;yes|no&gt; ........... control if cache simulation is enabled
</code></pre>
<h2 id="trace-events"><a class="header" href="#trace-events">Trace events</a></h2>
<p>By default callgrind collects following events:</p>
<ul>
<li><code>Ir</code>: Instruction read</li>
</ul>
<p>Callgrind also provides a functional cache simulation with their own model,
which is enabled by passing <code>--cache-sim=yes</code>.
This simulates a 2-level cache hierarchy with separate L1 <em>instruction</em> and
<em>data</em> caches (<code>L1i</code>/ <code>L1d</code>) and a <em>unified</em> last level (<code>LL</code>) cache.
When enabled, this collects the following additional events:</p>
<ul>
<li><code>I1mr</code>: L1 cache miss on instruction read</li>
<li><code>ILmr</code>: LL cache miss on instruction read</li>
<li><code>Dr</code>: Data reads access</li>
<li><code>D1mr</code>: L1 cache miss on data read</li>
<li><code>DLmr</code>: LL cache miss on data read</li>
<li><code>Dw</code>: Data write access</li>
<li><code>D1mw</code>: L1 cache miss on data write</li>
<li><code>DLmw</code>: LL cache miss on data write</li>
</ul>
<h2 id="profile-specific-part-of-the-target"><a class="header" href="#profile-specific-part-of-the-target">Profile specific part of the target</a></h2>
<p>Programmatically enable/disable instrumentation using the macros defined in
the callgrind header.</p>
<pre><code class="language-c">#include &lt;valgrind/callgrind.h&gt;

int main() {
    // init ..

    CALLGRIND_START_INSTRUMENTATION;
    compute();
    CALLGRIND_STOP_INSTRUMENTATION;

    // shutdown ..
}
</code></pre>
<blockquote>
<p>In this case, callgrind should be launched with <code>--instr-atstart=no</code>.</p>
</blockquote>
<p>Alternatively instrumentation can be controlled with <code>callgrind_control -i on/off</code>.</p>
<p>The files <a href="trace_profile/callgrind/cg_example.cc">cg_example.cc</a> and
<a href="trace_profile/callgrind/Makefile">Makefile</a> provide a full example.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="valgrind1"><a class="header" href="#valgrind1">valgrind(1)</a></h1>
<h2 id="memcheck---toolmemcheck"><a class="header" href="#memcheck---toolmemcheck">Memcheck <code>--tool=memcheck</code></a></h2>
<p>Is the default tool when invoking <code>valgrind</code> without explicitly specifying
<code>--tool</code>.</p>
<p>Memory checker used to identify:</p>
<ul>
<li>memory leaks</li>
<li>out of bound accesses</li>
<li>uninitialized reads</li>
</ul>
<pre><code class="language-sh">valgrind [OPTIONS] PROGRAM [ARGS]
    --log-file=FILE             Write valgrind output to FILE.
    --leak-check=full           Enable full leak check.
    --show-error-list=yes       List errors at exit again (use 'all' to include suppressed).
    --track-origins=yes         Show origins of undefined values.
    --keep-debuginfo=no|yes     Keep symbols etc for unloaded code.
    --num-callers=N             Max depth for reported backtrace.

    --gen-suppressions=yes      Generate suppressions file from the run.
    --suppressions=FILE         Load suppressions file.

    --vgdb=yes                  Enable builtin gdbserver.
    --vgdb-error=N              Stop after N errors. Starting from then on,
                                each error triggers a breakpoint.
</code></pre>
<h2 id="example-use-gdbserver-to-catch-valgrind-errors"><a class="header" href="#example-use-gdbserver-to-catch-valgrind-errors">Example: use gdbserver to catch valgrind errors</a></h2>
<p>The following shows an example how to connect a gdb to a program running under
valgrind and stop at any valgrind error to inspect the program state.</p>
<p>The example program wich may access an uninitialized variable.</p>
<pre><code class="language-c">// build: gcc -g -o uninit uninit.c

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

int get(int* v, int cond) {
  if (cond)
    *v = 2;
  return *v;
}

void use(int* v) {
  printf("v=%d\n", *v);
}

int main(int argc, char* argv[]) {
  int v;
  get(&amp;v, argc == 2);
  use(&amp;v);
}
</code></pre>
<p>Run the program in valgrind and instruct the gdbserver to stop from the very
first valgrind error encountered.</p>
<pre><code class="language-sh">&gt; valgrind --vgdb=yes --vgdb-error=0 ./uninit
</code></pre>
<p>Connect gdb to valgrinds gdbserver. If one has multiple valgrind gdbserver
running, pass <code>--pid=</code> to <code>vgdb</code> to disambiguate.</p>
<pre><code>&gt; gdb -q -ex 'target remote | vgdb' uninit
(gdb) c
# ...
Program received signal SIGTRAP, Trace/breakpoint trap.
0x00000000048ea522 in _itoa_word (value=&lt;optimized out&gt;, value@entry=0, buflim=0x1fff000177 "", 
    buflim@entry=0x1fff000178 "", base=&lt;optimized out&gt;, upper_case=upper_case@entry=0) at _itoa.c:183
183	      SPECIAL (10);
(gdb)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="vtune1"><a class="header" href="#vtune1"><a href="https://www.intel.com/content/www/us/en/docs/vtune-profiler/user-guide">vtune(1)</a></a></h1>
<p>Vtune offers different analysis. Run <code>vtune -collect help</code> to list the
availale analysis.</p>
<h2 id="profiling"><a class="header" href="#profiling">Profiling</a></h2>
<p>The following shows some common flows with the <code>hotspot</code> analsysis
as an example.</p>
<pre><code># Launch and profile process.
vtune -collect hotspots [opts] -- target [args]

# Attach and profile running process.
vtune -collect hotspots [opts] -target-pid &lt;pid&gt;
</code></pre>
<p>Some common options are the following.</p>
<pre><code>-r &lt;dir&gt;           output directory for the profile
-no-follow-child   dont attach to to child processes (default is to follow)
-start-paused      start with paused profiling
</code></pre>
<h2 id="analyze"><a class="header" href="#analyze">Analyze</a></h2>
<pre><code>vtune-gui &lt;dir&gt;
</code></pre>
<h2 id="programmatically-control-sampling"><a class="header" href="#programmatically-control-sampling">Programmatically control sampling</a></h2>
<p>Vtune offers an API to <em>resume</em> and <em>pause</em> the profile collection from within
the profilee itself.  This can be helpful if either only a certain phase should
be profiled or some phase should be skipped.</p>
<p>The following gives an example where only one phase in the program is profiled.
The program makes calls to the vtune API to resume and pause the collection,
while vtune is invoked with <code>-start-paused</code> to pause profiling initially.</p>
<pre><code class="language-c">#include &lt;ittnotify.h&gt;

void init();
void compute();
void shutdown();

int main() {
  init();

  __itt_resume();
  compute();
  __itt_pause();

  shutdown();
  return 0;
}
</code></pre>
<p>The makefile gives an example how to build and profile the application.</p>
<pre><code class="language-makefile">VTUNE ?= /opt/intel/oneapi/vtune/latest

main: main.c
	gcc -o $@ $^ -I$(VTUNE)/include -L$(VTUNE)/lib64 -littnotify

vtune: main
	$(VTUNE)/bin64/vtune -collect hotspots -start-paused -- ./main
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="tracy1"><a class="header" href="#tracy1">tracy(1)</a></h1>
<p><a href="https://github.com/wolfpld/tracy">Tracy</a> is a frame profiler, supporting manual code instrumentation
and providing a sampling profiler.</p>
<p>One can either record and visualize the profiling data live using
<code>tracy-profiler</code> or record the profiling data to a file using <code>tracy-capture</code>.</p>
<pre><code>tracy-profiler [file] [-p port]

tracy-capture -o file [-f] [-p port]
    -f   overwrite &lt;file&gt; if it exists
</code></pre>
<h2 id="example-6"><a class="header" href="#example-6">Example</a></h2>
<p>The example showcases different cases:</p>
<ol>
<li>Use tracy from a single binary. In that case the <code>TracyClient.cpp</code> can be
directly linked / included in the instrumented binary.</li>
<li>Use tracy from different binaries (eg main executable + shared library). In
this case the <code>TracyClient.cpp</code> should be compiled into its own shared
library, such that there is a single tracy client.</li>
<li>Use tracy from different binaries on windows. In this case the
<code>TracyClient.cpp</code> must be compiled again into a separate shared library,
while defining <code>TRACY_EXPORTS</code>. The code being instrumented must be compiled
with <code>TRACY_IMPORTS</code> defined.</li>
</ol>
<p>An instrumented <code>c++</code> example:</p>
<pre><code class="language-cpp">#include &lt;chrono&gt;
#include &lt;thread&gt;

#include &lt;tracy/Tracy.hpp&gt;

#ifdef USE_FOO
extern "C" void foo_comp_hook(int64_t);
#endif

void init() {
  // Create a named zone (active for the current scope).
  // Name will be used when rendering the zone in the thread timeline.
  ZoneScopedN("init()");
  // Set explicit color for the rendered zone.
  ZoneColor(0xff0000);

  std::this_thread::sleep_for(std::chrono::seconds(1));
}

void comp(const char* name) {
  // Track call count.
  static int64_t ccnt = 0;
  ccnt += 1;

  // Create an unnamed zone for the current scope.
  ZoneScoped;
  // Name the zone by formatting the name dynamically.
  // This name is shown for the zone in the thread timeline, however
  // in the zone statistics they are all accounted under one common
  // zone "comp".
  ZoneNameF("comp(%s)", name);
  // Additional text to attach to the zone.
  ZoneTextF("text(%s)", name);
  // Additional value to attach to the zone measurement.
  ZoneValue(ccnt);

  // Statistics for dynamic names, text and values can be looked at in the zone
  // statistics.There measurements can be grouped by different categories.

  // Add a simple plot.
  TracyPlot("comp-plot", ccnt % 4);

  std::this_thread::sleep_for(std::chrono::milliseconds(100));

#ifdef USE_FOO
  foo_comp_hook(ccnt);
#endif
}

void post_comp() {
  // Create an unnamed zone for the current scope and capture callstack (max
  // depth 10). Capturing callstack requires platform with TRACY_HAS_CALLSTACK
  // support.
  ZoneScopedS(10);
  // Name the zone, w/o formatting.
  const char name[] = "post_comp()";
  ZoneName(name, sizeof(name));

  // Add trace messages to the timeline.
  TracyMessageL("start sleep in post_comp()");
  std::this_thread::sleep_for(std::chrono::milliseconds(50));
  TracyMessageL("end sleep in post_comp()");
}

void fini() {
  // Create a named zone with an explicit color.
  ZoneScopedNC("fini()", 0x00ff00);
  std::this_thread::sleep_for(std::chrono::seconds(1));
}

int main() {
  // Create a named zone.
  ZoneScopedN("main()");

  init();

  int step = 0;
  while (step++ &lt; 10) {
    // Create a frame message, this start a new frame with the name
    // "step" and end the previous frame with the name "step".
    FrameMarkNamed("step");
    // Create a named scope.
    ZoneScopedN("step()");
    comp("a");
    comp("b");
    comp("c");
    post_comp();
  }

  fini();
}
</code></pre>
<p>An instrumented <code>c</code> example:</p>
<pre><code class="language-c">#include &lt;stdint.h&gt;
#include &lt;inttypes.h&gt;
#include &lt;stdio.h&gt;

#include &lt;tracy/TracyC.h&gt;

static void comp_helper(int64_t i) {
  char buf[64];
  int cnt = snprintf(buf, sizeof(buf), "helper(%" PRId64 ")", i);

  // Create an active unnamed zone.
  TracyCZone(ctx, 1);

  // Name the zone.
  TracyCZoneName(ctx, buf, cnt);
  // Add custom text to the zone measurement.
  TracyCZoneText(ctx, buf, cnt);
  // Add custom value to the zone measurement.
  TracyCZoneValue(ctx, i);

  for (int ii = 0; ii &lt; i * 100000; ++ii) {
    /* fake work */
  }

  // End the zone measurement.
  TracyCZoneEnd(ctx);
}

void foo_comp_hook(int64_t cnt) {
  // Create an active named zone.
  TracyCZoneN(ctx, "foo", 1);

  for (int i = 0; i &lt; cnt; ++i) {
    // Plot value.
    TracyCPlot("foo_comp_hook", cnt + i);

    comp_helper(i);
  }

  // Configure plot "foo", probably best done once during initialization..
  TracyCPlotConfig("foo", TracyPlotFormatNumber, 1 /* step */, 1 /* fill */,
                   0xff0000);
  // Plot value.
  TracyCPlot("foo", cnt);

  // End the zone measurement.
  TracyCZoneEnd(ctx);
}
</code></pre>
<p>Raw build commands to demonstrate compiling tracy w/o <code>cmake</code>, in case we need
to integrate it into a different build system.</p>
<pre><code class="language-makefile">B := BUILD

main: $(B)/main-static $(B)/main-dynamic $(B)/main-dynamic-win
tracy: $(B)/tracy
.PHONY: main tracy

# -- TRACY STATIC ---------------------------------------------------------------

$(B)/main-static: main.cpp | $(B)
	clang++ -DTRACY_ENABLE -I$(B)/tracy/public -o $@ $^ $(B)/tracy/public/TracyClient.cpp

# -- TRACY DYNAMIC --------------------------------------------------------------

$(B)/main-dynamic: main.cpp $(B)/foo.so $(B)/TracyClient.so | $(B)
	clang++ -DTRACY_ENABLE -I$(B)/tracy/public -DUSE_FOO -o $@ $^

$(B)/foo.so: foo.c $(B)/TracyClient.so
	clang -DTRACY_ENABLE -I$(B)/tracy/public -fPIC -shared -o $@ $^

$(B)/TracyClient.so: $(B)/tracy/public/TracyClient.cpp
	clang++ -DTRACY_ENABLE -I$(B)/tracy/public -fPIC -shared -o $@ $^

# -- TRACY DYNAMIC WINDOWS ------------------------------------------------------

$(B)/main-dynamic-win: main.cpp $(B)/foo.dll $(B)/TracyClient.dll
	@# eg run with wine
	zig c++ -target x86_64-windows -DTRACY_ENABLE -DTRACY_IMPORTS -DUSE_FOO -o $@ $^ -I $(B)/tracy/public

$(B)/foo.dll: foo.c $(B)/TracyClient.dll
	zig c++ -target x86_64-windows -DTRACY_ENABLE -DTRACY_IMPORTS -fPIC -shared -o $@ $^ -I $(B)/tracy/public

$(B)/TracyClient.dll: $(B)/tracy/public/TracyClient.cpp
	@# win libs from 'pragma comment(lib, ..)'
	zig c++ -target x86_64-windows -DTRACY_ENABLE -DTRACY_EXPORTS -fPIC -shared -o $@ $^ -lws2_32 -ldbghelp -ladvapi32 -luser32

# -- TRACY ----------------------------------------------------------------------

# Get latest tracy and build profiler.
$(B)/tracy: $(B)
	cd $(B); bash $(CURDIR)/get-tracy.sh
.PHONY: $(B)/tracy

$B:
	mkdir -p $(B)
.PHONY: $(B)

# -- CLEAN ----------------------------------------------------------------------

clean:
	$(RM) $(B)/*.so $(B)/*.dll $(B)/*.pdb $(B)/*.lib $(B)/main*

distclean:
	rm -rf $(B)
</code></pre>
<blockquote>
<p>Find <code>get-tracy.sh</code> <a href="https://github.com/johannst/notes/blob/master/src/trace_profile/tracy/get-tracy.sh">here</a>.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="xray-instrument"><a class="header" href="#xray-instrument">xray-instrument</a></h1>
<p><a href="https://llvm.org/docs/XRay.html">Xray</a> offers a function trace instrumentation which has very little
overhead when trace capturing is disabled.</p>
<p>The xray system consists of compile time instrumentation, a runtime library to
control capturing as well as tools for post processing.</p>
<p>During compilation functions are instrumented with nop space which is patched on
the fly when tracing is enabled to hook function entry and exit
points. Additional information for enabling the traces is placed in some special
sections in the elf file.</p>
<p>The following provides an starting point example demonstrating</p>
<ul>
<li><code>account</code> to gather function call statistics.</li>
<li><code>convert</code> to convert the binary trace into a trace format that can be opened
by other tools (eg <a href="https://ui.perfetto.dev/">perfetto.dev</a> or <a href="https://www.speedscope.app/">speedscope.app</a>.</li>
</ul>
<pre><code class="language-make">run: main
	XRAY_OPTIONS="patch_premain=true,xray_mode=xray-basic,verbosity=1" ./$&lt; 1 2 3 4 5 &gt; /dev/null
	llvm-xray account --instr_map=$&lt; --sort=sum $$(ls -t1 xray-log.main.* | head -n1)
	llvm-xray convert --instr_map=$&lt; --symbolize --output-format=trace_event $$(ls -t1 xray-log.main.* | head -n1)  | tee xray-trace.txt

main: main.c
	clang -o $@ $&lt; -g -fxray-instrument -fxray-instruction-threshold=1

clean:
	$(RM) main xray-log.main.* xray-trace.txt
</code></pre>
<pre><code class="language-c">#include &lt;unistd.h&gt;

void work3() {
  usleep(3 * 1000);
}

void work2() {
  usleep(5 * 1000);
  work3();
}

void work1() {
  usleep(10 * 1000);
}

int main(int argc, char* argv[]) {
  for (int i = 0; i &lt; argc; ++i) {
    work1();
    work2();
  }
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="debug-1"><a class="header" href="#debug-1">Debug</a></h1>
<ul>
<li><a href="#gdb1">gdb</a></li>
<li><a href="#gdbserver1">gdbserver</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="gdb1"><a class="header" href="#gdb1">gdb(1)</a></h1>
<h1 id="cli"><a class="header" href="#cli">CLI</a></h1>
<pre><code class="language-markdown">  gdb [opts] [prg [-c coredump | -p pid]]
  gdb [opts] --args prg &lt;prg-args&gt;
    opts:
      -p &lt;pid&gt;        attach to pid
      -c &lt;coredump&gt;   use &lt;coredump&gt;
      -x &lt;file&gt;       execute script &lt;file&gt; before prompt
      -ex &lt;cmd&gt;       execute command &lt;cmd&gt; before prompt
      --tty &lt;tty&gt;     set I/O tty for debugee
      --batch         run in batch mode, exit after processing options (eg used
                      for scripting)
      --batch-silent  link --batch, but surpress gdb stdout
</code></pre>
<h1 id="interactive-usage"><a class="header" href="#interactive-usage">Interactive usage</a></h1>
<h2 id="misc"><a class="header" href="#misc">Misc</a></h2>
<pre><code class="language-markdown">  apropos &lt;regex&gt;
          Search commands matching regex.

  tty &lt;tty&gt;
          Set &lt;tty&gt; as tty for debugee.
          Make sure nobody reads from target tty, easiest is to spawn a shell
          and run following in target tty:
          &gt; while true; do sleep 1024; done

  sharedlibrary [&lt;regex&gt;]
          Load symbols of shared libs loaded by debugee. Optionally use &lt;regex&gt;
          to filter libs for symbol loading.

  display [/FMT] &lt;expr&gt;
          Print &lt;expr&gt; every time debugee stops. Eg print next instr, see
          examples below.

  undisplay [&lt;num&gt;]
          Delete display expressions either all or one referenced by &lt;num&gt;.

  info display
          List display expressions.

  info sharedlibrary [&lt;regex&gt;]
          List shared libraries loaded. Optionally use &lt;regex&gt; to filter.
</code></pre>
<h2 id="breakpoints"><a class="header" href="#breakpoints">Breakpoints</a></h2>
<pre><code class="language-markdown">  break [-qualified] &lt;sym&gt; thread &lt;tnum&gt;
          Set a breakpoint only for a specific thread.
          -qualified: Treat &lt;sym&gt; as fully qualified symbol (quiet handy to set
          breakpoints on C symbols in C++ contexts)

  break &lt;sym&gt; if &lt;cond&gt;
          Set conditional breakpoint (see examples below).

  delete [&lt;num&gt;]
          Delete breakpoint either all or one referenced by &lt;num&gt;.

  info break
          List breakpoints.

  cond &lt;bp&gt; &lt;cond&gt;
          Make existing breakpoint &lt;bp&gt; conditional with &lt;cond&gt;.

  cond &lt;bp&gt;
          Remove condition from breakpoint &lt;bp&gt;.

  tbreak
          Set temporary breakpoint, will be deleted when hit.
          Same syntax as `break`.

  rbreak &lt;regex&gt;
          Set breakpoints matching &lt;regex&gt;, where matching internally is done
          on: .*&lt;regex&gt;.*

  command [&lt;bp_list&gt;]
          Define commands to run after breakpoint hit. If &lt;bp_list&gt; is not
          specified attach command to last created breakpoint. Command block
          terminated with 'end' token.

          &lt;bp_list&gt;: Space separates list, eg 'command 2 5-8' to run command
          for breakpoints: 2,5,6,7,8.

  save break &lt;file&gt;
          Save breakpoints to &lt;file&gt;. Can be loaded with the `source` command.
</code></pre>
<h2 id="watchpoints"><a class="header" href="#watchpoints">Watchpoints</a></h2>
<pre><code class="language-markdown">  watch [-location|-l] &lt;expr&gt; [thread &lt;tnum&gt;]
          Create a watchpoint for &lt;expr&gt;, will break if &lt;expr&gt; is written to.
          Watchpoints respect scope of variables, -l can be used to watch the
          memory location instead.

  rwatch ...
          Sets a read watchpoint, will break if &lt;expr&gt; is read from.

  awatch ...
          Sets an access watchpoint, will break if &lt;expr&gt; is written to or read
          from.
</code></pre>
<h2 id="catchpoints"><a class="header" href="#catchpoints">Catchpoints</a></h2>
<pre><code class="language-markdown">  catch load [&lt;regex&gt;]
          Stop when shared libraries are loaded, optionally specify a &lt;regex&gt;
          to stop only on matches.
  catch unload [&lt;regex&gt;]
          Stop when shared libraries are unloaded, optionally specify a &lt;regex&gt;
          to stop only on matches.

  catch throw
          Stop when an exception is thrown.
  catch rethrow
          Stop when an exception is rethrown.
  catch catch
          Stop when an exception is caught.

  catch fork
          Stop at calls to fork (also stops at clones, as some systems
          implement fork via clone).

  catch syscall [&lt;syscall&gt; &lt;syscall&gt; ..]
          Stop at syscall. If no argument is given, stop at all syscalls.
          Optionally give a list of syscalls to stop at.
</code></pre>
<h2 id="inspection"><a class="header" href="#inspection">Inspection</a></h2>
<pre><code class="language-markdown">  info functions [&lt;regex&gt;]
          List functions matching &lt;regex&gt;. List all functions if no &lt;regex&gt;
          provided.

  info variables [&lt;regex&gt;]
          List variables matching &lt;regex&gt;. List all variables if no &lt;regex&gt;
          provided.

  info register [&lt;reg&gt; &lt;reg&gt; ..]
          Dump content of all registers or only the specified &lt;reg&gt;ister.
</code></pre>
<h2 id="signal-handling"><a class="header" href="#signal-handling">Signal handling</a></h2>
<pre><code class="language-markdown">  info handle [&lt;signal&gt;]
          Print how to handle &lt;signal&gt;. If no &lt;signal&gt; specified print for all
          signals.

  handle &lt;signal&gt; &lt;action&gt;
          Configure how gdb handles &lt;signal&gt; sent to debugee.
          &lt;action&gt;:
            stop/nostop       Catch signal in gdb and break.
            print/noprint     Print message when gdb catches signal.
            pass/nopass       Pass signal down to debugee.

  catch signal &lt;signal&gt;
          Create a catchpoint for &lt;signal&gt;.
</code></pre>
<h2 id="multi-threading"><a class="header" href="#multi-threading">Multi-threading</a></h2>
<pre><code class="language-markdown">info thread
          List all threads.

thread apply &lt;id&gt; [&lt;id&gt;] &lt;command&gt;
          Run command on all threads listed by &lt;id&gt; (space separated list).
          When 'all' is specified as &lt;id&gt; the &lt;command&gt; is run on all threads.

thread name &lt;name&gt;
          The &lt;name&gt; for the current thread.
</code></pre>
<h2 id="multi-process"><a class="header" href="#multi-process">Multi-process</a></h2>
<pre><code class="language-markdown">  set follow-fork-mode &lt;child | parent&gt;
          Specify which process to follow when debuggee makes a fork(2)
          syscall.

  set detach-on-fork &lt;on | off&gt;
          Turn on/off detaching from new child processes (on by default).
          Turning this off allows to debug multiple processes (inferiors) with
          one gdb session.

  info inferiors
          List all processes gdb debugs.

  inferior &lt;id&gt;
          Switch to inferior with &lt;id&gt;.
</code></pre>
<h2 id="scheduling"><a class="header" href="#scheduling">Scheduling</a></h2>
<pre><code class="language-markdown">  set schedule-multiple &lt;on | off&gt;
          on: Resume all threads of all processes (inferiors) when continuing
              or stepping.
          off: (default) Resume only threads of current process (inferior).
</code></pre>
<h2 id="shell-commands-1"><a class="header" href="#shell-commands-1">Shell commands</a></h2>
<pre><code class="language-markdown">  shell &lt;shell_cmd&gt;
          Run the shell_cmd and print the output, can also contain a pipeline.

  pipe &lt;gdb_cmd&gt; | &lt;shell_cmd&gt;
          Evaluate the gdb_cmd and run the shell_cmd which receives the output
          of the gdb_cmd via stdin.
</code></pre>
<h2 id="source-file-locations"><a class="header" href="#source-file-locations">Source file locations</a></h2>
<pre><code class="language-markdown">  dir &lt;path&gt;
          Add &lt;path&gt; to the beginning of the searh path for source files.

  show dir
          Show current search path.

  set substitute-path &lt;from&gt; &lt;to&gt;
          Add substitution rule checked during source file lookup.

  show substitute-path
          Show current substitution rules.
</code></pre>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<pre><code class="language-markdown">  set disassembly-flavor &lt;intel | att&gt;
          Set the disassembly style "flavor".

  set pagination &lt;on | off&gt;
          Turn on/off gdb's pagination.

  set breakpoint pending &lt;on | off | auto&gt;
          on: always set pending breakpoints.
          off: error when trying to set pending breakpoints.
          auto: interatively query user to set breakpoint.

  set print pretty &lt;on | off&gt;
          Turn on/off pertty printing of structures.

  set style enabled &lt;on | off&gt;
          Turn on/off styling (eg colored output).

  set logging &lt;on | off&gt;
          Enable output logging to file (default gdb.txt).

  set logging file &lt;fname&gt;
          Change output log file to &lt;fname&gt;

  set logging redirect &lt;on | off&gt;
          on: only log to file.
          off: log to file and tty.

  set logging overwrite &lt;on | off&gt;
          on: Truncate log file on each run.
          off: Append to logfile (default).

  set trace-commands &lt;on | off&gt;
          on: Echo comamands executed (good with logging).
          off: Do not echo commands executedt (default).

  set history filename &lt;fname&gt;
          Change file where to save and restore command history to and from.

  set history &lt;on | off&gt;
          Enable or disable saving of command history.

  set exec-wrapper &lt;cli&gt;
          Set an exec wrapper which sets up the env and execs the debugee.
</code></pre>
<blockquote>
<p>Logging options should be configured before logging is turned on.</p>
</blockquote>
<h2 id="builtin-variables"><a class="header" href="#builtin-variables">Builtin Variables</a></h2>
<pre><code class="language-markdown">  $_thread
          Thread number of the current thread.

  $_siginfo
          Additional signal information.
</code></pre>
<h1 id="text-user-interface-tui"><a class="header" href="#text-user-interface-tui">Text user interface (TUI)</a></h1>
<pre><code class="language-markdown">  C-x a     Toggle UI.
  C-l       Redraw UI (curses UI can be messed up after the debugee prints to
            stdout/stderr).
  C-x o     Change focus.
</code></pre>
<h1 id="user-commands-macros"><a class="header" href="#user-commands-macros">User commands (macros)</a></h1>
<p>Gdb allows to create &amp; document user commands as follows:</p>
<pre><code class="language-markdown">  define &lt;cmd&gt;
    # cmds
  end

  document &lt;cmd&gt;
    # docu
  end
</code></pre>
<p>To get all user commands or documentations one can use:</p>
<pre><code class="language-markdown">  help user-defined
  help &lt;cmd&gt;
</code></pre>
<h1 id="hooks"><a class="header" href="#hooks">Hooks</a></h1>
<p>Gdb allows to create two types of command <code>hooks</code></p>
<ul>
<li><code>hook-</code> will be run before <code>&lt;cmd&gt;</code></li>
<li><code>hookpost-</code> will be run after <code>&lt;cmd&gt;</code></li>
</ul>
<pre><code class="language-markdown">  define hook-&lt;cmd&gt;
    # cmds
  end

  define hookpost-&lt;cmd&gt;
    # cmds
  end
</code></pre>
<h1 id="examples-12"><a class="header" href="#examples-12">Examples</a></h1>
<h2 id="automatically-print-next-instr"><a class="header" href="#automatically-print-next-instr">Automatically print next instr</a></h2>
<p>When ever the debugee stops automatically print the memory at the current
instruction pointer (<code>$rip</code> x86) and format as instruction <code>/i</code>.</p>
<pre><code class="language-markdown">  # rip - x86
  display /i $rip

  # step instruction, after the step the next instruction is automatically printed
  si
</code></pre>
<h2 id="conditional-breakpoints"><a class="header" href="#conditional-breakpoints">Conditional breakpoints</a></h2>
<p>Create conditional breakpoints for a function <code>void foo(int i)</code> in the debugee.</p>
<pre><code class="language-markdown">  # Create conditional breakpoint
  b foo if i == 42

  b foo     # would create bp 2
  # Make existing breakpoint conditional
  cond 2 i == 7
</code></pre>
<h2 id="set-breakpoint-on-all-threads-except-one"><a class="header" href="#set-breakpoint-on-all-threads-except-one">Set breakpoint on all threads except one</a></h2>
<p>Create conditional breakpoint using the <code>$_thread</code> <a href="https://sourceware.org/gdb/onlinedocs/gdb/Convenience-Vars.html#Convenience-Vars">convenience
variable</a>.</p>
<pre><code class="language-markdown">  # Create conditional breakpoint on all threads except thread 12.
  b foo if $_thread != 12
</code></pre>
<h2 id="catch-sigsegv-and-execute-commands"><a class="header" href="#catch-sigsegv-and-execute-commands">Catch SIGSEGV and execute commands</a></h2>
<p>This creates a <code>catchpoint</code> for the <code>SIGSEGV</code> signal and attached the <code>command</code>
to it.</p>
<pre><code class="language-markdown">  catch signal SIGSEGV
  command
    bt
    c
  end
</code></pre>
<h2 id="run-backtrace-on-thread-1-batch-mode"><a class="header" href="#run-backtrace-on-thread-1-batch-mode">Run <code>backtrace</code> on thread 1 (batch mode)</a></h2>
<pre><code class="language-markdown">  gdb --batch -ex 'thread 1' -ex 'bt' -p &lt;pid&gt;
</code></pre>
<h2 id="script-gdb-for-automating-debugging-sessions"><a class="header" href="#script-gdb-for-automating-debugging-sessions">Script gdb for automating debugging sessions</a></h2>
<p>To script gdb add commands into a file and pass it to gdb via <code>-x</code>.
For example create <code>run.gdb</code>:</p>
<pre><code class="language-markdown">  set pagination off

  break mmap
  command
    info reg rdi rsi rdx
    bt
    c
  end

  #initial drop
  c
</code></pre>
<p>This script can be used as:</p>
<pre><code class="language-markdown">  gdb --batch -x ./run.gdb -p &lt;pid&gt;
</code></pre>
<h2 id="hook-to-automatically-save-breakpoints-on-quit"><a class="header" href="#hook-to-automatically-save-breakpoints-on-quit">Hook to automatically save breakpoints on <code>quit</code></a></h2>
<pre><code class="language-markdown">define break-save
    save breakpoint $arg0.gdb.bp
end
define break-load
    source $arg0.gdb.bp
end

define hook-quit
    break-save quit
end
</code></pre>
<h2 id="watchpoint-on-struct--class-member"><a class="header" href="#watchpoint-on-struct--class-member">Watchpoint on struct / class member</a></h2>
<p>A symbolic watchpoint defined on a member variable for debugging is only valid
as long as the expression is in scope. Once out of scope the watchpoint gets
deleted.</p>
<p>When debugging some memory corruption we want to keep the watchpoint even the
expression goes out of scope to find the location that overrides the variable
and introduces the corruption.</p>
<pre><code class="language-markdown">(gdb) l
1  struct S { int v; };
2
3  void set(struct S* s, int v) {
4      s-&gt;v = v;
5  }
6
7  int main() {
8      struct S s;
9      set(&amp;s, 1);
10     set(&amp;s, 2);
11     set(&amp;s, 3);
...

(gdb) s
set (s=0x7fffffffe594, v=1) at test.c:4
4    s-&gt;v = v;

# Define a new watchpoint on the member of the struct. The expression however
# is only valid in the current functions scope.

(gdb) watch s-&gt;v
Hardware watchpoint 2: s-&gt;v

(gdb) c
Hardware watchpoint 2: s-&gt;v
Old value = 0
New value = 1
set (s=0x7fffffffe594, v=1) at test.c:5
5   }

# The watchpoint gets deleted as soon as we leave the function scope.

(gdb) c
Watchpoint 2 deleted because the program has left the block in
which its expression is valid.
main () at test.c:10
10      set(&amp;s, 2);

# Define the watchpoint on the location of the object to watch.

(gdb) watch -l s-&gt;v

# This is equivalent to the following.

(gdb) p &amp;s-&gt;v
$1 = (int *) 0x7fffffffe594

# Define a watchpoint to the address of the member variable of the s instance.
# This of course only makes sense as long as the s instance is not moved in memory.

(gdb) watch *0x7fffffffe594
Hardware watchpoint 3: *0x7fffffffe594

(gdb) c
Hardware watchpoint 3: *0x7fffffffe594
Old value = 1
New value = 2
set (s=0x7fffffffe594, v=2) at test.c:5
5   }

(gdb) c
Hardware watchpoint 3: *0x7fffffffe594
Old value = 2
New value = 3
set (s=0x7fffffffe594, v=3) at test.c:5
5   }
</code></pre>
<h2 id="shell-commands-1-1"><a class="header" href="#shell-commands-1-1">Shell commands</a></h2>
<pre><code class="language-markdown"># Run shell commands.

(gdb) shell zcat /proc/config.gz | grep CONFIG_KVM=
CONFIG_KVM=m

# Pipe gdb command to shell command.

(gdb) pipe info proc mapping | grep libc
    0x7ffff7a1a000     0x7ffff7a42000    0x28000        0x0  r--p   /usr/lib/libc.so.6
    0x7ffff7a42000     0x7ffff7b9d000   0x15b000    0x28000  r-xp   /usr/lib/libc.so.6
    0x7ffff7b9d000     0x7ffff7bf2000    0x55000   0x183000  r--p   /usr/lib/libc.so.6
    0x7ffff7bf2000     0x7ffff7bf6000     0x4000   0x1d7000  r--p   /usr/lib/libc.so.6
    0x7ffff7bf6000     0x7ffff7bf8000     0x2000   0x1db000  rw-p   /usr/lib/libc.so.6
</code></pre>
<h1 id="know-bugs"><a class="header" href="#know-bugs">Know Bugs</a></h1>
<h2 id="workaround-command--finish-bug"><a class="header" href="#workaround-command--finish-bug">Workaround <code>command + finish</code> bug</a></h2>
<p>When using <code>finish</code> inside a <code>command</code> block, commands after <code>finish</code> are not
executed. To workaround that bug one can create a wrapper function which calls
<code>finish</code>.</p>
<pre><code class="language-markdown">  define handler
    bt
    finish
    info reg rax
  end

  command
    handler
  end
</code></pre>
<h2 id="launch-debuggee-through-an-exec-wrapper"><a class="header" href="#launch-debuggee-through-an-exec-wrapper">Launch debuggee through an exec wrapper</a></h2>
<pre><code class="language-markdown">&gt; cat test.c
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

int main() {
  const char* env = getenv("MOOSE");
  printf("$MOOSE=%s\n", env ? env : "&lt;nullptr&gt;");
}

&gt; cat test.sh
#!/bin/bash

echo "running test.sh wapper"
export MOOSE=moose
exec ./test

&gt; gcc -g -o test test.c

&gt; gdb test
(gdb) r
$MOOSE=&lt;nullptr&gt;

(gdb) set exec-wrapper bash test.sh
(gdb) r
running test.sh wapper
$MOOSE=moose
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="gdbserver1"><a class="header" href="#gdbserver1">gdbserver(1)</a></h1>
<h1 id="cli-1"><a class="header" href="#cli-1">CLI</a></h1>
<pre><code class="language-markdown">  gdbserver [opts] comm prog [args]
    opts:
      --disable-randomization
      --no-disable-randomization
      --wrapper W --

    comm:
      host:port
      tty
</code></pre>
<h2 id="example-7"><a class="header" href="#example-7">Example</a></h2>
<pre><code class="language-markdown"># Start gdbserver.
gdbserver localhost:1234 /bin/ls

# Attach gdb.
gdb -ex 'target remote localhost:1234'
</code></pre>
<h2 id="wrapper-example-set-environment-variables-just-for-the-debugee"><a class="header" href="#wrapper-example-set-environment-variables-just-for-the-debugee">Wrapper example: Set environment variables just for the debugee</a></h2>
<p>Set <code>env</code> as execution wrapper with some variables.
The wrapper will be executed before the debugee.</p>
<pre><code class="language-markdown">gdbserver --wrapper env FOO=123 BAR=321 -- :12345 /bin/ls
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="binary"><a class="header" href="#binary">Binary</a></h1>
<ul>
<li><a href="#od1">od</a></li>
<li><a href="#xxd1">xxd</a></li>
<li><a href="#readelf1">readelf</a></li>
<li><a href="#objdump1">objdump</a></li>
<li><a href="#nm1">nm</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="od1"><a class="header" href="#od1">od(1)</a></h1>
<pre><code class="language-markdown">  od [opts] &lt;file&gt;
    -An         don't print addr info
    -tx4        print hex in 4 byte chunks
    -ta         print as named character
    -tc         printable chars or backslash escape
    -w4         print 4 bytes per line
    -j &lt;n&gt;      skip &lt;n&gt; bytes from &lt;file&gt; (hex if start with 0x)
    -N &lt;n&gt;      dump &lt;n&gt; bytes (hex of start with 0x)
</code></pre>
<h2 id="ascii-to-hex-string"><a class="header" href="#ascii-to-hex-string">ASCII to hex string</a></h2>
<pre><code class="language-markdown">  echo -n AAAABBBB | od -An -w4 -tx4
    &gt;&gt; 41414141
    &gt;&gt; 42424242

  echo -n '\x7fELF\n' | od -tx1 -ta -tc
    &gt;&gt; 0000000  7f  45  4c  46  0a      # tx1
    &gt;&gt;         del   E   L   F  nl      # ta
    &gt;&gt;         177   E   L   F  \n      # tc
</code></pre>
<h2 id="extract-parts-of-file"><a class="header" href="#extract-parts-of-file">Extract parts of file</a></h2>
<p>For example <code>.rodata</code> section from an elf file. We can use <code>readelf</code> to get the
offset into the file where the <code>.rodata</code> section starts.</p>
<pre><code class="language-markdown">  readelf -W -S foo
    &gt;&gt; Section Headers:
    &gt;&gt; [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al
    &gt;&gt; ...
    &gt;&gt; [15] .rodata           PROGBITS        00000000004009c0 0009c0 000030 00   A  0   0 16
</code></pre>
<p>With the offset of <code>-j 0x0009c0</code> we can dump <code>-N 0x30</code> bytes from the beginning of
the <code>.rodata</code> section as follows:</p>
<pre><code class="language-markdown">  od -j 0x0009c0 -N 0x30 -tx4 -w4 foo
    &gt;&gt; 0004700 00020001
    &gt;&gt; 0004704 00000000
    &gt;&gt; *
    &gt;&gt; 0004740 00000001
    &gt;&gt; 0004744 00000002
    &gt;&gt; 0004750 00000003
    &gt;&gt; 0004754 00000004
</code></pre>
<p><strong>Note</strong>: Numbers starting with <code>0x</code> will be interpreted as hex by <code>od</code>.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="xxd1"><a class="header" href="#xxd1">xxd(1)</a></h1>
<pre><code class="language-markdown">  xxd [opts]
    -p          dump continuous hexdump
    -r          convert hexdump into binary ('revert')
    -e          dump as little endian mode
    -i          output as C array
</code></pre>
<h2 id="ascii-to-hex-stream"><a class="header" href="#ascii-to-hex-stream">ASCII to hex stream</a></h2>
<pre><code class="language-markdown">  echo -n 'aabb' | xxd -p
    &gt;&gt; 61616262
</code></pre>
<h2 id="hex-to-binary-stream"><a class="header" href="#hex-to-binary-stream">Hex to binary stream</a></h2>
<pre><code class="language-markdown">  echo -n '61616262' | xxd -p -r
    &gt;&gt; aabb
</code></pre>
<h2 id="ascii-to-binary"><a class="header" href="#ascii-to-binary">ASCII to binary</a></h2>
<pre><code class="language-markdown">  echo -n '\x7fELF' | xxd -p | xxd -p -r | file -p -
    &gt;&gt; ELF
</code></pre>
<h2 id="ascii-to-c-array-hex-encoded"><a class="header" href="#ascii-to-c-array-hex-encoded">ASCII to <code>C</code> array (hex encoded)</a></h2>
<pre><code class="language-markdown">  xxd -i &lt;(echo -n '\x7fELF')
    &gt;&gt; unsigned char _proc_self_fd_11[] = {
    &gt;&gt;   0x7f, 0x45, 0x4c, 0x46
    &gt;&gt; };
    &gt;&gt; unsigned int _proc_self_fd_11_len = 4;
</code></pre>
<h2 id="patching-binary-file-by-hand-in-hex-mode"><a class="header" href="#patching-binary-file-by-hand-in-hex-mode">Patching binary file by hand in hex mode</a></h2>
<pre><code class="language-markdown">  xxd /bin/ls &gt; ls.hex
  # edit binary file in hex format (ascii)
  xxd -r ls.hex &gt; ls
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="readelf1"><a class="header" href="#readelf1">readelf(1)</a></h1>
<pre><code class="language-markdown">  readelf [opts] &lt;elf&gt;
    -W|--wide     wide output, dont break output at 80 chars
    -h            print ELF header
    -S            print section headers
    -l            print program headers + segment mapping
    -d            print .dynamic section (dynamic link information)
    --syms        print symbol tables (.symtab .dynsym)
    --dyn-syms    print dynamic symbol table (exported symbols for dynamic linker)
    -r            print relocation sections (.rel.*, .rela.*)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="objdump1"><a class="header" href="#objdump1">objdump(1)</a></h1>
<pre><code class="language-markdown">  objdump [opts] &lt;elf&gt;
    -M intel                   use intil syntax
    -d                         disassemble text section
    -D                         disassemble all sections
    --disassemble=&lt;sym&gt;        disassemble symbol &lt;sym&gt;
    -S                         mix disassembly with source code
    -C                         demangle
    -j &lt;section&gt;               display info for section
    --[no-]show-raw-insn       [dont] show object code next to disassembly
    --visualize-jumps[=color]  visualize jumps with ascii art, optionally color arrows
    -i                         list supported binary formats (binutils)
</code></pre>
<h2 id="disassemble-section"><a class="header" href="#disassemble-section">Disassemble section</a></h2>
<p>For example <code>.plt</code> section:</p>
<pre><code class="language-markdown">  objdump -j .plt -d &lt;elf&gt;
</code></pre>
<h2 id="example-disassemble-raw-binary"><a class="header" href="#example-disassemble-raw-binary">Example: disassemble raw binary</a></h2>
<p>This can be helpful for example as a cheap analysis tool when toying with JIT
generating code. We could just write thee binary code buffer to a file and
disassemble with <code>objdump</code>.</p>
<p>To re-create that case, we just assemble and link some ELF file and then create
a raw binary of the text section with <code>objcopy</code>.</p>
<pre><code class="language-x86asm"># file: test.s
.section .text, "ax"

.global _start
_start:
    xor %rax, %rax
    mov $0x8, %rax
1:
    cmp $0, %rax
    je 2f
    dec %rax
    jmp 1b
2:
    # x86-64 exit(2) syscall
    mov $0, %rdi
    mov $60, %rax
    syscall
</code></pre>
<pre><code class="language-bash"># Assemble &amp; link.
as -o test.o test.s
ld -o test test.o testc.o
# ELF -&gt; binary (only take .text section).
objcopy -O binary --only-section .text test test-bin

# Disassemble raw binary.
objdump -D -b binary -m i386:x86-64 test-bin
</code></pre>
<h2 id="example-disassemble-specific-symbol"><a class="header" href="#example-disassemble-specific-symbol">Example: disassemble specific symbol</a></h2>
<pre><code class="language-bash"># Disassemble main().
objdump --disassemble=main &lt;bin&gt;
# Disassemble 'foo::bar()' (mangled).
objdump --disassemble=_ZN3foo3barEvr &lt;bin&gt;

# Disassemble 'foo::bar()' (demangled), requires -C
objdump -C --disassemble=foo::bar &lt;bin&gt;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="nm1"><a class="header" href="#nm1">nm(1)</a></h1>
<pre><code class="language-markdown">  nm [opts] &lt;elf&gt;
    -C                  demangle
    -u --undefined-ony  undefined only
    -U --defined-only   defined only
    -g                  exported only
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="development"><a class="header" href="#development">Development</a></h1>
<ul>
<li><a href="#cfilt1">c++filt</a></li>
<li><a href="#c">c++</a></li>
<li><a href="#glibc">glibc</a></li>
<li><a href="#gcc1">gcc</a></li>
<li><a href="#gas">gas</a></li>
<li><a href="#ld1">ld</a></li>
<li><a href="#git1">git</a></li>
<li><a href="#cmake1">cmake</a></li>
<li><a href="#make1">make</a></li>
<li><a href="#ldso8">ld.so</a></li>
<li><a href="#elf-symbol-versioning">symbol versioning</a></li>
<li><a href="#python">python</a></li>
<li><a href="#gcov1">gcov</a></li>
<li><a href="#profile-guided-optimization-pgo">pgo</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="cfilt1"><a class="header" href="#cfilt1">c++filt(1)</a></h1>
<h2 id="demangle-symbol"><a class="header" href="#demangle-symbol">Demangle symbol</a></h2>
<pre><code class="language-markdown">  c++-filt [opts] &lt;symbol_str&gt;
    -t    Try to also demangle types.
</code></pre>
<h2 id="demangle-stream"><a class="header" href="#demangle-stream">Demangle stream</a></h2>
<p>For example dynamic symbol table:</p>
<pre><code class="language-markdown">  readelf -W --dyn-syms &lt;elf&gt; | c++filt
</code></pre>
<h2 id="demangle-types"><a class="header" href="#demangle-types">Demangle types</a></h2>
<pre><code class="language-c++">// file: type.cc
#include &lt;cstdio&gt;
#include &lt;typeinfo&gt;

#define P(ty) printf(#ty " -&gt; %s\n", typeid(ty).name())

template &lt;typename T = void&gt;
struct Foo {};

int main() {
  P(int);
  P(unsigned char);
  P(Foo&lt;&gt;);
  P(Foo&lt;int&gt;);
}
</code></pre>
<p>Build and run:</p>
<pre><code class="language-sh">$ clang++ type.cc &amp;&amp; ./a.out | c++filt
int -&gt; i
unsigned char -&gt; h
Foo&lt;&gt; -&gt; 3FooIvE
Foo&lt;int&gt; -&gt; 3FooIiE

$ clang++ type.cc &amp;&amp; ./a.out | c++filt -t
int -&gt; int
unsigned char -&gt; unsigned char
Foo&lt;&gt; -&gt; Foo&lt;void&gt;
Foo&lt;int&gt; -&gt; Foo&lt;int&gt;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="c"><a class="header" href="#c">c++</a></h1>
<p>openstd <a href="https://www.open-std.org/jtc1/sc22/wg21/docs/standards">cpp standards</a>.</p>
<p>Source files of most examples is available <a href="https://github.com/johannst/notes/tree/master/src/development/c%2B%2B">here</a>.</p>
<h2 id="type-deduction"><a class="header" href="#type-deduction">Type deduction</a></h2>
<p>Force compile error to see what <code>auto</code> is deduced to.</p>
<pre><code class="language-cpp">auto foo = bar();

// force compile error
typename decltype(foo)::_;
</code></pre>
<h2 id="strict-aliasing-and-type-punning"><a class="header" href="#strict-aliasing-and-type-punning">Strict aliasing and type punning</a></h2>
<p>The <code>strict aliasing</code> rules describe via which <code>alias</code> a value can be accessed.</p>
<blockquote>
<p>Informal: an <code>alias</code> is a reference / pointer to a value.</p>
</blockquote>
<p>Accessing a value through an alias that violates the strict aliasing rules is
<code>undefined behavior (UB)</code>.</p>
<p>Examples below on <a href="https://godbolt.org/z/TsvTY9zfj">godbolt</a>.</p>
<pre><code class="language-cpp">int i = 0;

// Valid aliasing (signed / unsigned type).
*reinterpret_cast&lt;signed int*&gt;(&amp;i);
*reinterpret_cast&lt;unsigned int*&gt;(&amp;i);

// Valid aliasing (cv qualified type).
*reinterpret_cast&lt;const int*&gt;(&amp;i);
*reinterpret_cast&lt;const unsigned*&gt;(&amp;i);

// Valid aliasing (byte type).
*reinterpret_cast&lt;char*&gt;(&amp;i);
*reinterpret_cast&lt;std::byte*&gt;(&amp;i);

// Invalid aliasing, dereferencing pointer is UB.
*reinterpret_cast&lt;short*&gt;(&amp;i);
*reinterpret_cast&lt;float*&gt;(&amp;i);
</code></pre>
<blockquote>
<p>NOTE: Casting pointer to invalid aliasing type is not directly UB, but
dereferencing the pointer is UB.</p>
</blockquote>
<pre><code class="language-cpp">short s[2] = { 1, 2 };

// Invalid aliasing (UB) - type punning, UB to deref ptr (int has stricter
// alignment requirements than short).
*reinterpret_cast&lt;int*&gt;(s);


// Arbitrary byte pointer.
char c[4] = { 1, 2, 3, 4 };

// Invalid aliasing (UB) - type punning, UB to deref ptr (int has stricter
// alignment requirements than char).
*reinterpret_cast&lt;int*&gt;(c);
</code></pre>
<p>At the time of writing, the current <a href="http://eel.is/c++draft/basic.lval#11">c++ std draft</a>
contains the following.</p>
<pre><code class="language-text">If a program attempts to access the stored value of an object through a glvalue
whose type is not **similar** (7.3.6) to one of the following types the
behavior is undefined [44]

(11.1) the dynamic type of the object,
(11.2) a type that is the signed or unsigned type corresponding to the dynamic
       type of the object, or
(11.3) a char, unsigned char, or std::byte type.

[44]: The intent of this list is to specify those circumstances in which an
      object can or cannot be aliased.
</code></pre>
<p>The paragraph is short but one also needs to understand the meaning of
<a href="http://eel.is/c++draft/conv.qual#def:similar_types">similar (<em>similar_types</em>)</a>.</p>
<p>This paragraph is actually somewhat more explicit in the <a href="https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2017/n4713.pdf">c++17 std</a>.</p>
<pre><code class="language-text">If a program attempts to access the stored value of an object through a glvalue
of other than one of the following types the behavior is undefined [63]

(11.1) the dynamic type of the object,
(11.2) a cv-qualiﬁed version of the dynamic type of the object,
(11.3) a type similar (as deﬁned in 7.5) to the dynamic type of the object,
(11.4) a type that is the signed or unsigned type corresponding to the dynamic
       type of the object,
(11.5) a type that is the signed or unsigned type corresponding to a
       cv-qualiﬁed version of the dynamic type of the object,
(11.6) an aggregate or union type that includes one of the aforementioned types
       among its elements or non- static data members (including, recursively,
       an element or non-static data member of a subaggregate or contained
       union),
(11.7) a type that is a (possibly cv-qualiﬁed) base class type of the dynamic
       type of the object,
(11.8) a char, unsigned char, or std::byte type.

[63]: The intent of this list is to specify those circumstances in which an
      object may or may not be aliased.
</code></pre>
<p>Additional references:</p>
<ul>
<li>
<p><a href="https://gist.github.com/shafik/848ae25ee209f698763cffee272a58f8">What is the Strict Aliasing Rule and Why do we care</a></p>
<p>The article shows a small example how the compiler may optimized using the
strict aliasing rules.</p>
<pre><code class="language-cpp">int alias(int* i, char* c) {
  *i = 1;
  *c = 'a';  // char* may alias int*
  return *i;
}

int noalias(int* i, short* s) {
    *i = 1;
    *s = 2;  // short* does not alias int*
    return *i;
}
</code></pre>
<pre><code class="language-x86asm">alias(int*, char*):
mov    DWORD PTR [rdi] ,0x1  ; *i = 1;
mov    BYTE PTR [rsi], 0x61  ; *c = 'a';
mov    eax,DWORD PTR [rdi]   ; Must reload, char* can alias int*.
ret

noalias(int*, short*):
mov    DWORD PTR [rdi], 0x1  ; *i = 1;
mov    WORD PTR [rsi], 0x2   ; *s = 2;
mov    eax,0x1               ; Must not reload, short* can not alias int*.
ret
</code></pre>
</li>
<li>
<p><a href="https://en.cppreference.com/w/cpp/language/reinterpret_cast#Type_aliasing">reinterpret_cast</a> type aliasing</p>
<blockquote>
<ol start="5">
<li>Any object pointer type <code>T1*</code> can be converted to another object pointer
type <code>cv T2*</code>. This is exactly equivalent to <code>static_cast&lt;cv T2*&gt;(static_cast&lt;cv void*&gt;(expression))</code> (which implies that if T2’s
alignment requirement is not stricter than T1’s, the value of the pointer
does not change and conversion of the resulting pointer back to its
original type yields the original value). In any case, the resulting
pointer may only be dereferenced safely if allowed by the type aliasing
rules (see below).</li>
</ol>
</blockquote>
<pre><code class="language-cpp">int I;
char* X = reinterpret_cast&lt;char*&gt;(&amp;I);  // Valid, char allowed to alias int.
*X = 42;
int* Y = reinterpret_cast&lt;int*&gt;(X);     // Cast back to original type.
*Y = 1337;  // safe

char C[4];
int* P = reinterpret_cast&lt;int*&gt;(C);     // Cast is ok, not yet UB.
*P = 1337; // UB, violates strict aliasing / alignment rules.
           // https://stackoverflow.com/questions/52492229/c-byte-array-to-int
</code></pre>
</li>
<li>
<p>On <code>gcc</code> strict aliasing is enabled starting with <code>-O2</code>.</p>
<pre><code class="language-bash">for i in {0..3} g s; do echo "-O$i $(g++ -Q --help=optimizers -O$i | grep fstrict-aliasing)"; done
-O0   -fstrict-aliasing           [disabled]
-O1   -fstrict-aliasing           [disabled]
-O2   -fstrict-aliasing           [enabled]
-O3   -fstrict-aliasing           [enabled]
-Og   -fstrict-aliasing           [disabled]
-Os   -fstrict-aliasing           [enabled]
</code></pre>
</li>
</ul>
<h3 id="__restrict-keyword"><a class="header" href="#__restrict-keyword"><code>__restrict</code> keyword</a></h3>
<p>The <code>__restrict</code> keyword allows the programmer to tell the compiler that two
pointer will not alias each other.</p>
<pre><code class="language-cpp">int alias(int* a, int* b) {
    *a = 1;
    *b = 2;
    return *a;
}

// alias(int*, int*):                           # @alias(int*, int*)
//         mov     dword ptr [rdi], 1
//         mov     dword ptr [rsi], 2
//         mov     eax, dword ptr [rdi]
//         ret

int noalias(int* __restrict a, int* __restrict b) {
    *a = 1;
    *b = 2;
    return *a;
}

// noalias(int*, int*):                         # @noalias(int*, int*)
//         mov     dword ptr [rdi], 1
//         mov     dword ptr [rsi], 2
//         mov     eax, 1
//         ret
</code></pre>
<p>However this should only be used with care and in a narrow scope, as it is easy
to violate self defined contract, see <a href="https://godbolt.org/z/e8x1af3Mh">godbolt</a>.</p>
<h3 id="type-punning"><a class="header" href="#type-punning">Type punning</a></h3>
<p>The correct way to do <code>type-punning</code> in c++:</p>
<ol>
<li><a href="https://en.cppreference.com/w/cpp/numeric/bit_cast"><code>std::bit_cast</code></a> (c++20)</li>
<li><a href="https://godbolt.org/z/3PM4jGvEz"><code>std::memcpy</code></a></li>
</ol>
<h2 id="variadic-templates-parameter-pack"><a class="header" href="#variadic-templates-parameter-pack">Variadic templates (<a href="https://en.cppreference.com/w/cpp/language/parameter_pack">parameter pack</a>)</a></h2>
<pre><code class="language-cpp">#include &lt;iostream&gt;

// -- Example 1 - print template value arguments.

// Base case with one parameter.
template&lt;int P&gt;
void show_int() {
    printf("%d\n", P);
}

// General case with at least two parameters, to disambiguate from base case.
template&lt;int P0, int P1, int... Params&gt;
void show_int() {
    printf("%d, ", P0);
    show_int&lt;P1, Params...&gt;();
}

// -- Example 2 - print values of different types.

// Base case with one parameter.
template&lt;typename T&gt;
void show(const T&amp; t) {
    std::cout &lt;&lt; t &lt;&lt; '\n';
}

// General case with at least two parameters, to disambiguate from base case.
template&lt;typename T0, typename T1, typename... Types&gt;
void show(const T0&amp; t0, const T1&amp; t1, const Types&amp;... types) {
    std::cout &lt;&lt; t0 &lt;&lt; ", ";
    show(t1, types...);
}

int main() {
    show_int&lt;1, 2, 3, 4, 5&gt;();
    show(1, 1.0, "foo", 'a');
}
</code></pre>
<h2 id="forwarding-reference-fwd-ref"><a class="header" href="#forwarding-reference-fwd-ref">Forwarding reference (<a href="https://en.cppreference.com/w/cpp/language/reference#Forwarding_references">fwd ref</a>)</a></h2>
<p>A <code>forwarding reference</code> is a special references that preserves the <code>value category</code> of a function parameter and therefore allows for <code>perfect</code>
forwarding.</p>
<p>A forwarding reference is a parameter of a function template, which is declared
as <code>rvalue</code> reference to a <code>non-cv</code> qualified <code>type</code> template parameter.</p>
<pre><code class="language-cpp">template&lt;typename T&gt;
void fn(T&amp;&amp; param); // param is a forwarding reference
</code></pre>
<p>Perfect forwarding can be achieved with <a href="https://en.cppreference.com/w/cpp/utility/forward"><code>std::forward</code></a>. This for
example allows a wrapper function to pass a parameter with the <strong>exact</strong> same
value category to a down-stream function which is being invoked in the wrapper.</p>
<pre><code class="language-cpp">#include &lt;cstdio&gt;
#include &lt;utility&gt;

struct M {};

// -- CONSUMER -----------------------------------------------------------------

void use(M&amp;) {
    puts(__PRETTY_FUNCTION__);
}

void use(M&amp;&amp;) {
    puts(__PRETTY_FUNCTION__);
}

// -- TESTER -------------------------------------------------------------------

template&lt;typename T&gt;
void wrapper(T&amp;&amp; param) {  // forwarding reference
    puts(__PRETTY_FUNCTION__);
    // PARAM is an lvalue, therefore this always calls use(M&amp;).
    use(param);
}

template&lt;typename T&gt;
void fwd_wrapper(T&amp;&amp; param) {  // forwarding reference
    puts(__PRETTY_FUNCTION__);
    // PARAM is an lvalue, but std::forward returns PARAM with the same value
    // category as the forwarding reference takes.
    use(std::forward&lt;T&gt;(param));
}

// -- MAIN ---------------------------------------------------------------------

int main() {
    {
        std::puts("==&gt; wrapper rvalue reference");
        wrapper(M{});
        // calls use(M&amp;).

        std::puts("==&gt; wrapper lvalue reference");
        struct M m;
        wrapper(m);
        // calls use(M&amp;).
    }
    {
        std::puts("==&gt; fwd_wrapper rvalue reference");
        fwd_wrapper(M{});
        // calls use(M&amp;&amp;).

        std::puts("==&gt; fwd_wrapper lvalue reference");
        struct M m;
        fwd_wrapper(m);
        // calls use(M&amp;).
    }
}
</code></pre>
<h2 id="example-any_of-template-meta-function"><a class="header" href="#example-any_of-template-meta-function">Example: <code>any_of</code> template meta function</a></h2>
<pre><code class="language-cpp">#include &lt;type_traits&gt;

template&lt;typename T, typename... U&gt;
struct any_of : std::false_type {};

// Found our type T in the list of types U.
template&lt;typename T, typename... U&gt;
struct any_of&lt;T, T, U...&gt; : std::true_type {};

// Pop off the first element in the list of types U,
// since it didn't match our type T.
template&lt;typename T, typename U0, typename... U&gt;
struct any_of&lt;T, U0, U...&gt; : any_of&lt;T, U...&gt; {};

// Convenience template variable to invoke meta function.
template&lt;typename T, typename... U&gt;
constexpr bool any_of_v = any_of&lt;T, U...&gt;::value;

static_assert(any_of_v&lt;int, char, bool, int&gt;, "");
static_assert(!any_of_v&lt;int, char, bool, float&gt;, "");
</code></pre>
<h2 id="example-sfinae-enable_if"><a class="header" href="#example-sfinae-enable_if">Example: <a href="https://en.cppreference.com/w/cpp/language/sfinae">SFINAE</a> (<a href="https://en.cppreference.com/w/cpp/types/enable_if">enable_if</a>)</a></h2>
<p>Provide a single entry point <code>Invoke</code> to call some <code>Operations</code>.
Use <code>enable_if</code> to enable/disable the template functions depending on the two
available traits an operation can have:</p>
<ul>
<li>Operation returns a result</li>
<li>Operation requires a context</li>
</ul>
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include &lt;type_traits&gt;

// Helper meta fns.

template&lt;typename T&gt;
using enable_if_bool = std::enable_if_t&lt;T::value, bool&gt;;

template&lt;typename T&gt;
using disable_if_bool = std::enable_if_t&lt;!T::value, bool&gt;;

template&lt;typename T&gt;
using has_dst = std::integral_constant&lt;bool, !std::is_same&lt;typename T::Return, void&gt;::value&gt;;

// Template meta programming invoke machinery.

namespace impl {
    // Invoke an OPERATION which *USES* a context.
    template&lt;typename Ctx, template&lt;typename&gt; class Op, typename... P,
             enable_if_bool&lt;typename Op&lt;Ctx&gt;::HasCtx&gt; = true&gt;
    typename Op&lt;Ctx&gt;::Return Invoke(const Ctx&amp; C, P... params) {
        return Op&lt;Ctx&gt;()(C, params...);
    }

    // Invoke an OPERATION which uses *NO* context.
    template&lt;typename Ctx, template&lt;typename&gt; class Op, typename... P,
             disable_if_bool&lt;typename Op&lt;Ctx&gt;::HasCtx&gt; = true&gt;
    typename Op&lt;Ctx&gt;::Return Invoke(const Ctx&amp;, P... params) {
        return Op&lt;Ctx&gt;()(params...);
    }
}  // namespace impl

// Invoke an OPERATION which *HAS* a DESTINATION with arbitrary number of arguments.
template&lt;typename Ctx, template&lt;typename&gt; class Op, typename... P,
         enable_if_bool&lt;has_dst&lt;Op&lt;Ctx&gt;&gt;&gt; = true&gt;
void Invoke(const Ctx&amp; C, P... params) {
    std::cout &lt;&lt; "Invoke " &lt;&lt; Op&lt;Ctx&gt;::Name &lt;&lt; '\n';
    typename Op&lt;Ctx&gt;::Return R = impl::Invoke&lt;Ctx, Op&gt;(C, params...);
    std::cout &lt;&lt; "returned -&gt; " &lt;&lt; R &lt;&lt; '\n';
}

// Invoke an OPERATION which has *NOT* a DESTINATION with arbitrary number of arguments.
template&lt;typename Ctx, template&lt;typename&gt; class Op, typename... P,
         disable_if_bool&lt;has_dst&lt;Op&lt;Ctx&gt;&gt;&gt; = true&gt;
void Invoke(const Ctx&amp; C, P... params) {
    std::cout &lt;&lt; "Invoke " &lt;&lt; Op&lt;Ctx&gt;::Name &lt;&lt; " without destination." &lt;&lt; '\n';
    impl::Invoke&lt;Ctx, Op&gt;(C, params...);
}

// Custom context.

struct Ctx {
    void out(const char* s, unsigned v) const {
        printf("%s%x\n", s, v);
    }
};

// Operations to invoke.

template&lt;typename Ctx&gt;
struct OpA {
    using HasCtx = std::false_type;
    using Return = int;
    static constexpr const char* const Name = "OpA";

    constexpr Return operator()(int a, int b) const {
        return a + b;
    }
};

template&lt;typename Ctx&gt;
struct OpB {
    using HasCtx = std::true_type;
    using Return = void;
    static constexpr const char* const Name = "OpB";

    Return operator()(const Ctx&amp; C, unsigned a) const {
        C.out("a = ", a);
    }
};

int main() {
    Ctx C;

    Invoke&lt;Ctx, OpA&gt;(C, 1, 2);
    Invoke&lt;Ctx, OpB&gt;(C, 0xf00du);

    return 0;
}
</code></pre>
<h2 id="example-minimal-templatized-test-registry"><a class="header" href="#example-minimal-templatized-test-registry">Example: Minimal templatized test registry</a></h2>
<p>A small test function registry bringing together a few different template
features.</p>
<pre><code class="language-cpp">#include &lt;cstdio&gt;
#include &lt;functional&gt;
#include &lt;map&gt;
#include &lt;string&gt;
#include &lt;type_traits&gt;

template&lt;typename R, typename... P&gt;
struct registry {
    using FUNC = R (*)(P...);
    using SELF = registry&lt;R, P...&gt;;
    using RET = R;

    static SELF&amp; get() {
        static SELF r;
        return r;
    }

    bool add(std::string nm, FUNC fn) {
        const auto r = m_fns.insert({std::move(nm), std::move(fn)});
        return r.second;
    }

    R invoke(const std::string&amp; nm, P... p) const {
        return invoke_impl&lt;R&gt;(nm, p...);
    }

    void dump() const {
        for (const auto&amp; it : m_fns) {
            std::puts(it.first.c_str());
        }
    }

  private:
    std::map&lt;std::string, FUNC&gt; m_fns;

    template&lt;typename RET&gt;
    std::enable_if_t&lt;std::is_same_v&lt;RET, void&gt;&gt; invoke_impl(const std::string&amp; nm, P... p) const {
        const auto it = m_fns.find(nm);
        if (it == m_fns.end()) {
            return;
        }
        std::invoke(it-&gt;second, p...);
    }

    template&lt;typename RET&gt;
    std::enable_if_t&lt;!std::is_same_v&lt;RET, void&gt;, RET&gt; invoke_impl(const std::string&amp; nm,
                                                                  P... p) const {
        const auto it = m_fns.find(nm);
        if (it == m_fns.end()) {
            static_assert(std::is_default_constructible_v&lt;RET&gt;,
                          "RET must be default constructible");
            return {};
        }
        return std::invoke(it-&gt;second, p...);
    }
};

#define TEST_REGISTER(REGISTRY, NAME)                                                      \
    static bool regfn_##REGISTRY##NAME() {                                                 \
        const bool r = REGISTRY::get().add(#NAME, NAME);                                   \
        if (!r) {                                                                          \
            std::puts("Failed to register test " #NAME ", same name already registered!"); \
            std::abort();                                                                  \
        }                                                                                  \
        return r;                                                                          \
    }                                                                                      \
    static const bool reg_##REGISTRY##NAME = regfn_##REGISTRY##NAME();

#define TEST(REGISTRY, NAME, ...)    \
    REGISTRY::RET NAME(__VA_ARGS__); \
    TEST_REGISTER(REGISTRY, NAME);   \
    REGISTRY::RET NAME(__VA_ARGS__)

// -- Usage 1 simple usage.

using REG1 = registry&lt;void&gt;;
TEST(REG1, test1) {
    std::puts("REG1::test1");
}
TEST(REG1, test2) {
    std::puts("REG1::test2");
}

// -- Usage 2 with convenience macro wrapper.

using REG2 = registry&lt;void, bool&gt;;
#define TEST2(NAME, ...) TEST(REG2, NAME, ##__VA_ARGS__)

TEST2(test1, bool val) {
    printf("REG2::test1 val %d\n", val);
}

int main() {
    const auto&amp; R1 = REG1::get();
    R1.dump();
    R1.invoke("test1");
    R1.invoke("test2");

    const auto&amp; R2 = REG2::get();
    R2.dump();
    R2.invoke("test1", true);

    return 0;
}
</code></pre>
<h2 id="example-concepts-pre-c20"><a class="header" href="#example-concepts-pre-c20">Example: Concepts pre c++20</a></h2>
<p>Prior to c++20’s concepts, <code>SFINAE</code> and <code>std::void_t</code> can be leveraged to build
something similar allowing to define an interface (aka trait) for a template
parameter.</p>
<pre><code class="language-cpp">
template&lt;typename T, template&lt;typename&gt; class Checker, typename = void&gt;
struct is_valid : std::false_type {};

template&lt;typename T, template&lt;typename&gt; class Checker&gt;
struct is_valid&lt;T, Checker, std::void_t&lt;Checker&lt;T&gt;&gt;&gt; : std::true_type {};

template&lt;typename T, template&lt;typename&gt; class Checker&gt;
static constexpr bool is_valid_v = is_valid&lt;T, Checker&gt;::value;

// -----------------------------------------------------------------------------

template&lt;typename T, typename R, template&lt;typename&gt; class Checker, typename = void&gt;
struct is_valid_with_ret : std::false_type {};

template&lt;typename T, typename R, template&lt;typename&gt; class Checker&gt;
struct is_valid_with_ret&lt;T, R, Checker, std::void_t&lt;Checker&lt;T&gt;&gt;&gt; : std::is_same&lt;R, Checker&lt;T&gt;&gt; {};

template&lt;typename T, typename R, template&lt;typename&gt; class Checker&gt;
static constexpr bool is_valid_with_ret_v = is_valid_with_ret&lt;T, R, Checker&gt;::value;

// -----------------------------------------------------------------------------

template&lt;typename T&gt;
struct is_entry {
    template&lt;typename TT&gt;
    using init = decltype(std::declval&lt;TT&gt;().init());
    template&lt;typename TT&gt;
    using tag = decltype(std::declval&lt;TT&gt;().tag());
    template&lt;typename TT&gt;
    using val = decltype(std::declval&lt;TT&gt;().val());

    static constexpr bool value = is_valid_v&lt;T, init&gt; &amp;&amp; is_valid_with_ret_v&lt;T, int, tag&gt; &amp;&amp;
                                  is_valid_with_ret_v&lt;T, typename T::Type, val&gt;;
};

template&lt;typename T&gt;
static constexpr bool is_entry_v = is_entry&lt;T&gt;::value;

template&lt;typename E&gt;
struct Entry {
    using Type = E;
    void init();
    int tag() const;
    E val() const;
};

int main() {
    static_assert(is_entry_v&lt;Entry&lt;bool&gt;&gt;, "");
}
</code></pre>
<p>The main mechanic can be explained with the following reduced example. If one
of the <code>decltype(std:declval&lt;T&gt;...</code> expressions is ill-formed, the template
specialization for <code>is_valid</code> will be removed from the candidate set due to
<a href="https://en.cppreference.com/w/cpp/language/sfinae">SFINAE</a>.</p>
<pre><code class="language-cpp">#include &lt;type_traits&gt;

// (1) Primary template.
template&lt;typename T, typename = void&gt;
struct is_valid : std::false_type {};

// (2) Partial template specialization.
template&lt;typename T&gt;
struct is_valid&lt;T, std::void_t&lt;decltype(std::declval&lt;T&gt;().some_fun1()),
                               decltype(std::declval&lt;T&gt;().some_fun2())&gt;&gt; : std::true_type {};
struct A {
    void some_fun1() {}
    void some_fun2() {}
};

struct B {};

static_assert(is_valid&lt;A&gt;::value, "is true");
// * Compare template arg list with primary template, we only supplied one
//   arg, the second one will be defaulted as
//   is_valid&lt;A, void&gt;
// * Compare template arg list against available specializations, this will
//   try to match the pattern &lt;A, void&gt; against the patterns defined in the
//   partial specializations.
// * Try specialization (2)
//   * T -&gt; A
//   * Evaluate std::void_t -&gt; decltype's are well-formed
//     std::void_t&lt;...&gt; -&gt; void
//   * Specialization (2) matches &lt;A, void&gt;
// * Pick the most specialized version -&gt; (2)

static_assert(!is_valid&lt;B&gt;::value, "is false");
// * Compare template arg list with primary template, we only supplied one
//   arg, the second one will be defaulted as
//   is_valid&lt;A, void&gt;
// * Compare template arg list against available specializations, this will
//   try to match the pattern &lt;B, void&gt; against the patterns defined in the
//   partial specializations.
// * Try specialization (2)
//   * T -&gt; B
//   * Evaluate std::void_t -&gt; decltype's are ill-formed
//   * Specialization (2) is removed from candidate set, no hard error (SFINAE)
// * No specialization matches, take the primary template.
</code></pre>
<blockquote>
<p><code>std::declval&lt;T&gt;()</code> creates an instance of type T in an unevaluated context.</p>
</blockquote>
<p>A more detailed description is available in the SO discussion <a href="https://stackoverflow.com/a/27688405">How does
<code>void_t</code> work</a>.</p>
<h2 id="example-concepts-since-c20"><a class="header" href="#example-concepts-since-c20">Example: Concepts since c++20</a></h2>
<pre><code class="language-cpp">// REQUIRES EXPRESSION
//   requires { requirement-seq }
//   requires ( parameter-list ) { requirement-seq }
//
// [1] https://en.cppreference.com/w/cpp/language/requires
// [2] https://en.cppreference.com/w/cpp/language/constraints#Constraints
//
// REQUIREMENT CLAUSE
//   Not the same as a REQUIREMENT EXPRESSIONS, and is used to require
//   constraints (express concept bounds).
//
// [1] https://en.cppreference.com/w/cpp/language/constraints#Requires_clauses

// -- HELPER -------------------------------------------------------------------

template&lt;typename T&gt;
using Alias = T;

void print(int);

// -- CONCEPTS &amp; REQUIRE EXPRESSIONS -------------------------------------------

// Simple concept from a type trait.
template&lt;typename T, typename U&gt;
concept Same = std::is_same&lt;T, U&gt;::value;

// Simple requirement concepts.
template&lt;typename T&gt;
concept TraitAddAndPrint = requires(T t, int i) {
    // Adding T + int must be supported.
    t + i;
    // Calling print(T) must be available.
    print(t);
};

// Type requirement concepts.
template&lt;typename T&gt;
concept TraitTypes = requires(T t) {
    // T must have a type definition inner.
    typename T::inner;
    // Type alias must exist.
    typename Alias&lt;T&gt;;
};

// Compound requirement concepts.
template&lt;typename T&gt;
concept TraitFns = requires(T t, const T c) {
    // void T::foo() must exist.
    { t.foo() };
    // bool T::bar() const; must exist.
    { c.bar() } -&gt; Same&lt;bool&gt;;
    // static void T::stat(); must exist.
    { T::stat() } -&gt; Same&lt;int&gt;;
};

// Nested requirement concepts.
template&lt;typename T&gt;
concept TraitNested = requires(T t) {
    // Must satisfy other concepts.
    requires TraitTypes&lt;T&gt;;
    requires TraitFns&lt;T&gt;;
};

// -- REQUIRE EXPRESSIONS ------------------------------------------------------

// Require expressions can be evaluated to booleans.
template&lt;typename T&gt;
static constexpr bool IsTraitFns = requires { requires TraitFns&lt;T&gt;; };

// Require expressions can also be used in static assertions.
static_assert(requires { requires Same&lt;int, int&gt;; });
static_assert(!requires {
    typename Alias&lt;int&gt;;
    requires Same&lt;int, void&gt;;
});

// -- TESTS --------------------------------------------------------------------

static_assert(requires { requires TraitAddAndPrint&lt;int&gt;; });

struct FnTypeGood {
    using inner = int;
};
struct FnTypeBad {};
static_assert(requires { requires TraitTypes&lt;FnTypeGood&gt;; });
static_assert(!requires { requires TraitTypes&lt;FnTypeBad&gt;; });

struct FnGood {
    void foo();
    bool bar() const;
    static int stat();
};
struct FnBad {};
static_assert(requires { requires TraitFns&lt;FnGood&gt;; });
static_assert(!requires { requires TraitFns&lt;FnBad&gt;; });

struct NestedGood : FnTypeGood, FnGood {};
struct NestedBad1 : FnGood {};
struct NestedBad2 : FnTypeGood {};
static_assert(requires { requires TraitNested&lt;NestedGood&gt;; });
static_assert(!requires { requires TraitNested&lt;NestedBad1&gt;; });
static_assert(!requires { requires TraitNested&lt;NestedBad2&gt;; });
</code></pre>
<h2 id="template-selection-with-partially--fully-specializations"><a class="header" href="#template-selection-with-partially--fully-specializations">Template selection with partially / fully specializations.</a></h2>
<pre><code class="language-cpp">enum Kind {
    kPrimary,
    kTT,
    kIntBool,
    kIntInt,
};

// (1) Primary template.
template&lt;typename T, typename U = bool&gt;
struct pair {
    static constexpr Kind kind = kPrimary;
};

// (2) Partial template specialization.
template&lt;typename T&gt;
struct pair&lt;T, T&gt; {
    static constexpr Kind kind = kTT;
};

// (3) Template specialization.
template&lt;&gt;
struct pair&lt;int, bool&gt; {
    static constexpr Kind kind = kIntBool;
};

// (4) Template specialization.
template&lt;&gt;
struct pair&lt;int, int&gt; {
    static constexpr Kind kind = kIntInt;
};

int main() {
    static_assert(pair&lt;int&gt;::kind == kIntBool, "");
    // * Compare template arg list with primary template, we only supplied one
    //   arg, the second one will be defaulted as
    //   pair&lt;int, bool&gt;
    // * Compare template arg list against available specializations, this will
    //   try to match the pattern &lt;int, bool&gt; against the patterns defined in the
    //   partial specializations.
    // * (2) &lt;int, bool&gt; pattern does not match
    // * (3) &lt;int, bool&gt; pattern does match
    // * (4) &lt;int, bool&gt; pattern does not match
    // * Pick the most specialized version -&gt; (3)

    static_assert(pair&lt;char, char&gt;::kind == kTT, "");
    // * Compare template arg list against available specializations, this will
    //   try to match the pattern &lt;char, char&gt; against the patterns defined in the
    //   partial specializations.
    // * (2) &lt;char, char&gt; pattern does match
    // * (3) &lt;char, char&gt; pattern does not match
    // * (4) &lt;char, char&gt; pattern does not match
    // * Pick the most specialized version -&gt; (2)

    static_assert(pair&lt;int, int&gt;::kind == kIntInt, "");
    // * Compare template arg list against available specializations, this will
    //   try to match the pattern &lt;int, int&gt; against the patterns defined in the
    //   partial specializations.
    // * (2) &lt;int, int&gt; pattern does match
    // * (3) &lt;int, int&gt; pattern does match
    // * (4) &lt;int, int&gt; pattern does not match
    // * Pick the most specialized version -&gt; (3)

    static_assert(pair&lt;char, short&gt;::kind == kPrimary, "");
    // * Compare template arg list against available specializations, this will
    //   try to match the pattern &lt;char, short&gt; against the patterns defined in the
    //   partial specializations.
    // * (2) &lt;char, short&gt; pattern does not match
    // * (3) &lt;char, short&gt; pattern does not match
    // * (4) &lt;char, short&gt; pattern does not match
    // * No specialization matches, take the primary template.
}
</code></pre>
<h2 id="example-perfect-forwarding"><a class="header" href="#example-perfect-forwarding">Example: Perfect forwarding</a></h2>
<pre><code class="language-cpp">#include &lt;cassert&gt;
#include &lt;cstdio&gt;
#include &lt;new&gt;
#include &lt;type_traits&gt;
#include &lt;utility&gt;

struct S {};

struct M {
    M() {
        std::puts("M()");
    }
    M(const M&amp;) {
        std::puts("M(M&amp;)");
    }
    M(M&amp;&amp;) {
        std::puts("M(M&amp;&amp;)");
    }
    M&amp; operator=(const M&amp;) = delete;
    M&amp; operator=(M&amp;&amp;) = delete;

    M(S&amp;, int) {
        std::puts("M(S&amp;)");
    }
    M(S&amp;&amp;, int) {
        std::puts("M(S&amp;&amp;)");
    }
    ~M() {
        std::puts("~M()");
    }
};

template&lt;typename T&gt;
struct option {
    static_assert(!std::is_reference_v&lt;T&gt;);

    constexpr option() = default;

    template&lt;typename... Params&gt;
    constexpr option(Params&amp;&amp;... params) : m_has_val(true) {
        // BAD: does not perfectly forward!
        //      eg, if option(S&amp;&amp;) is invoked, this would invoke M(S&amp;).
        // new (&amp;m_val) T(params...);

        // GOOD: perfectly forwards params to constructor of T.
        new (m_val) T(std::forward&lt;Params&gt;(params)...);
    }

    ~option() {
        reset();
    }

    constexpr T&amp; value() {
        assert(m_has_val);
        // Placement new starts a new lifetime, launder pointer returned to the
        // aligned storage.
        //
        // [1] https://en.cppreference.com/w/cpp/utility/launder
        return *__builtin_launder(reinterpret_cast&lt;T*&gt;(m_val));
    }

  private:
    constexpr void reset() {
        if (!m_has_val) {
            return;
        }
        if constexpr (!std::is_trivially_destructible_v&lt;T&gt;) {
            value().~T();
        };
    }

    alignas(T) char m_val[sizeof(T)];
    bool m_has_val{false};
};

int main() {
    std::puts("==&gt; case 1");
    // invokes M(S&amp;&amp;, int)
    option&lt;M&gt; opt1(S{}, 123);

    std::puts("==&gt; case 2");
    // invokes M() + M(M&amp;&amp;)
    option&lt;M&gt; x /* option(M&amp;&amp;) + M(M&amp;&amp;) */ = M{} /* M() */;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="glibc"><a class="header" href="#glibc">glibc</a></h1>
<h2 id="malloc-tracer-mtrace3"><a class="header" href="#malloc-tracer-mtrace3">malloc tracer <a href="http://man7.org/linux/man-pages/man3/mtrace.3.html"><code>mtrace(3)</code></a></a></h2>
<p>Trace memory allocation and de-allocation to detect memory leaks.
Need to call <code>mtrace(3)</code> to install the tracing hooks.</p>
<p>If we can’t modify the binary to call <code>mtrace</code> we can create a small shared
library and pre-load it.</p>
<pre><code class="language-c">// libmtrace.c
#include &lt;mcheck.h&gt;
__attribute__((constructor))  static void init_mtrace() { mtrace(); }
</code></pre>
<p>Compile as:</p>
<pre><code class="language-bash">gcc -shared -fPIC -o libmtrace.so libmtrace.c
</code></pre>
<p>To generate the trace file run:</p>
<pre><code class="language-bash">export MALLOC_TRACE=&lt;file&gt;
LD_PRELOAD=./libmtrace.so &lt;binary&gt;
</code></pre>
<p><strong>Note</strong>: If <code>MALLOC_TRACE</code> is not set <code>mtrace</code> won’t install tracing hooks.</p>
<p>To get the results of the trace file:</p>
<pre><code class="language-bash">mtrace &lt;binary&gt; $MALLOC_TRACE
</code></pre>
<h2 id="malloc-check-mallopt3"><a class="header" href="#malloc-check-mallopt3">malloc check <a href="http://man7.org/linux/man-pages/man3/mallopt.3.html"><code>mallopt(3)</code></a></a></h2>
<p>Configure action when glibc detects memory error.</p>
<pre><code class="language-bash">export MALLOC_CHECK_=&lt;N&gt;
</code></pre>
<p>Useful values:</p>
<pre><code class="language-markdown">1   print detailed error &amp; continue
3   print detailed error + stack trace + memory mappings &amp; abort
7   print simple error message + stack trace + memory mappings &amp; abort
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="gcc1"><a class="header" href="#gcc1">gcc(1)</a></h1>
<h2 id="cli-2"><a class="header" href="#cli-2">CLI</a></h2>
<ul>
<li><code>-v</code> verbose, outputs exact compiler/linker invocations made by the gcc driver</li>
<li><code>-###</code> dry-run, outputting exact compiler/linker invocations</li>
<li><code>-print-multi-lib</code> print available multilib configurations</li>
<li><code>--help=&lt;class&gt;</code> print description of cmdline options for given class, eg
<code>warnings</code>, <code>optimizers</code>, <code>target</code>, <code>c</code>, <code>c++</code></li>
<li><code>-Wl,&lt;opt&gt;</code> additional option passed to the linker invocation (can
be specified multiple times)</li>
<li><code>-Wl,--trace</code> trace each file the linker touches</li>
</ul>
<h3 id="environment-variables"><a class="header" href="#environment-variables">Environment variables</a></h3>
<pre><code># Colon separated list of additional include paths used during preprocessing.
# This has the same effect as adding -isystem on the cmdline, however cmdline
# options take precedence over the environment variables.
C_INCLUDE_PATH
CPLUS_INCLUDE_PATH

# Colon separated list of additional library search paths, used when linking
# with gcc. This has the same effect as adding -L to the cmdline, however cmdline
# options take precedence over the environment variables.
LIBRARY_PATH
</code></pre>
<h3 id="preprocessing"><a class="header" href="#preprocessing">Preprocessing</a></h3>
<p>While debugging can be helpful to just pre-process files.</p>
<pre><code class="language-bash">gcc -E [-dM] ...
</code></pre>
<ul>
<li><code>-E</code> run only preprocessor</li>
<li><code>-dM</code> list only <code>#define</code> statements</li>
</ul>
<h3 id="target-options"><a class="header" href="#target-options">Target options</a></h3>
<pre><code class="language-bash"># List all target options with their description.
gcc --help=target

# Configure for current cpu arch and query (-Q) value of options.
gcc -march=native -Q --help=target
</code></pre>
<h3 id="warnings--optimizations"><a class="header" href="#warnings--optimizations">Warnings / optimizations</a></h3>
<pre><code class="language-bash"># List available warnings with short description.
gcc --help=warnings
# List available optimizations with short description.
gcc --help=optimizers

# Prepend --help with `-Q` to print wheter options are enabled or disabled
# instead showing their description.
</code></pre>
<h3 id="sanitizer"><a class="header" href="#sanitizer">Sanitizer</a></h3>
<pre><code class="language-bash"># Enable address sanitizer, a memory error checker (out of bounds, use after free, ..).
gcc -fsanitize=address ...

# Enable leak sanitizer, a memory leak detector.
gcc -fsanitize=leak

# Enable undefined behavior sanitizer, detects various UBs (integer overflow, ..).
gcc -fsanitize=undefined ...

# Enable thread sanitizer, a data race detector.
gcc -fsanitize=thread
</code></pre>
<h2 id="builtins"><a class="header" href="#builtins"><a href="https://gcc.gnu.org/onlinedocs/gcc/Other-Builtins.html">Builtins</a></a></h2>
<h3 id="__builtin_expectexpr-cond"><a class="header" href="#__builtin_expectexpr-cond"><code>__builtin_expect(expr, cond)</code></a></h3>
<p>Give the compiler a hint which branch is hot, so it can lay out the code
accordingly to reduce number of jump instructions.
See on <a href="https://godbolt.org/z/MbTHAP">compiler explorer</a>.</p>
<p>The semantics of this hint are as follows, the compiler prioritises <code>expr == cond</code>. So <code>__builtin_expect(expr, 0)</code> means that we expect the <code>expr</code> to be <code>0</code>
most of the time.</p>
<pre><code class="language-bash">echo "
extern void foo();
extern void bar();
void run0(int x) {
  if (__builtin_expect(x,0)) { foo(); }
  else { bar(); }
}
void run1(int x) {
  if (__builtin_expect(x,1)) { foo(); }
  else { bar(); }
}
" | gcc -O2 -S -masm=intel -o /dev/stdout -xc -
</code></pre>
<p>Will generate something similar to the following.</p>
<ul>
<li><code>run0</code>: <code>bar</code> is on the path without branch</li>
<li><code>run1</code>: <code>foo</code> is on the path without branch</li>
</ul>
<pre><code class="language-x86asm">run0:
        test    edi, edi
        jne     .L4
        xor     eax, eax
        jmp     bar
.L4:
        xor     eax, eax
        jmp     foo
run1:
        test    edi, edi
        je      .L6
        xor     eax, eax
        jmp     foo
.L6:
        xor     eax, eax
        jmp     bar
</code></pre>
<h2 id="abi-linux"><a class="header" href="#abi-linux">ABI (Linux)</a></h2>
<ul>
<li>C ABI (x86_64) - <a href="https://gitlab.com/x86-psABIs/x86-64-ABI">SystemV ABI</a></li>
<li>C++ ABI - <a href="https://itanium-cxx-abi.github.io/cxx-abi">C++ Itanium ABI</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="gas"><a class="header" href="#gas">gas</a></h1>
<h2 id="frequently-used-directives"><a class="header" href="#frequently-used-directives">Frequently used directives</a></h2>
<ul>
<li><code>.section</code> to define a section (elf files)
<pre><code class="language-x86asm">.section .text.foo, "ax", @progbits
; defines section named .text.foo with alloc+exec perms

.section .data.foo, "aw", @progbits
; defines section named .data.foo with alloc+write perms

.section .rodata.foo, "a", @progbits
; defines section named .rodata.foo with alloc perms
</code></pre>
</li>
<li><code>.byte</code>, <code>.2byte</code>, <code>.4byte</code>, <code>.8byte</code> to define a N byte value
<pre><code class="language-x86asm">.byte 0xaa
.2byte 0xaabb                 # .word
.2byte 0xaa, 0xbb
.4byte 0xaabbccdd             # .long
.8byte 0xaabbccdd11223344     # .quad
</code></pre>
</li>
<li><code>.ascii</code> to define an ascii string
<pre><code class="language-x86asm">.ascii "foo"   ; allocates 3 bytes
</code></pre>
</li>
<li><code>.asciz</code> to define an ascii string with <code>'\0'</code> terminator
<pre><code class="language-x86asm">.asciz "foo"   ; allocates 4 bytes (str + \0)
</code></pre>
</li>
<li><code>.macro</code> to define assembler macros. Arguments are accessed with the
<code>\arg</code> syntax.
<pre><code class="language-x86asm">.macro defstr name str
\name:
    .ascii "\str"
\name\()_len:
    .8byte . - \name
.endm

; use as
defstr foo, "foobar"
</code></pre>
<blockquote>
<p>Use <code>\()</code> to concatenate macro argument and literal.</p>
</blockquote>
</li>
<li><code>.rept</code> to repeat a sequence of lines between <code>.rept</code> and <code>.endr</code>.
<pre><code class="language-x86asm">.rept 4
.4byte 123
.endr
</code></pre>
</li>
<li><code>.fill cnt, elem_size, val</code> write <code>cnt</code> times <code>val</code> with element size <code>elem_size</code>. For example one can use it to create a mbr boot record (magic number 0xaa55 at byte 511, 512).
<pre><code class="language-x86asm">.section .boot, "ax", @progbits
; some code ..
.4byte 0xff

.fill 510 - (. - .boot), 1, 0x00
.2byte 0xaa55

; as foo.s &amp;&amp; objdump -j .boot -s
; Contents of section .boot:
; 0000 ff000000 00000000 00000000 00000000
; ..
; 01f0 00000000 00000000 00000000 000055aa
</code></pre>
<blockquote>
<p>Here <code>.</code> stands for the current location counter.</p>
</blockquote>
</li>
</ul>
<h2 id="references-6"><a class="header" href="#references-6">References</a></h2>
<ul>
<li><a href="https://sourceware.org/binutils/docs/as">GNU Assembler</a></li>
<li><a href="https://sourceware.org/binutils/docs/as/Pseudo-Ops.html#Pseudo-Ops">GNU Assembler Directives</a></li>
<li><a href="https://sourceware.org/binutils/docs/as/i386_002dDependent.html">GNU Assembler <code>x86_64</code> dependent features</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ld1"><a class="header" href="#ld1">ld(1)</a></h1>
<pre><code>ld [opts] files...
    -T &lt;script&gt;        use &lt;script&gt; as linker script
    --trace            report each file the linker touches
    --start-group archives --end-group
                       search archives repearepeatedly until no new
                       undefined  references are created
                       (eg helpfull with list of static libraries)
    --verbose          dump the default linker script
</code></pre>
<h2 id="linker-script"><a class="header" href="#linker-script">Linker Script</a></h2>
<p>Generally speaking, the linker script describes how to map a set of <em>input
sections</em> from different <em>input files</em> to a set of <em>output sections</em> in the
<em>output file</em>.</p>
<p>The output sections are defined as follows (full description at <a href="https://sourceware.org/binutils/docs/ld/Output-Section-Attributes.html">output
section</a> and <a href="https://sourceware.org/binutils/docs/ld/Input-Section.html">input section</a>).</p>
<pre><code>section_name [vaddr] : [AT(paddr)] {
    file_pattern (section_pattern)
}
</code></pre>
<p>The following gives an example of an <code>output</code> section with two <code>input</code> section rules.</p>
<pre><code>.foo : {
    abc.o (.foo)
    *.o (.foo.*)
}
</code></pre>
<p>The first rule includes the section <code>.foo</code> from the object file <code>abc.o</code>.
The second rule is a wildcard rule, which includes all sections match the glob
<code>.foo.*</code> from all object files matching the <code>*.o</code> glob.</p>
<h3 id="common-linker-script-commands-and-functions"><a class="header" href="#common-linker-script-commands-and-functions">Common linker script <em>commands</em> and <em>functions</em></a></h3>
<p>The <code>OUTPUT_FORMAT</code> defines the format of the output file the linker is
creates. This command takes up to three arguments and possible values can be
found by running <code>objdump -i</code>.</p>
<pre><code>OUTPUT_FORMAT(default, little, big)
</code></pre>
<p>The <code>ENTRY</code> command takes a symbols name, which will be used as entry point.</p>
<pre><code>ENTRY(sym)
</code></pre>
<h3 id="linker-script-snippets"><a class="header" href="#linker-script-snippets">Linker script snippets</a></h3>
<p>Using the <a href="https://sourceware.org/binutils/docs/ld/Miscellaneous-Commands.html"><code>INSERT</code></a> command, one can insert linker script
snippets without overwriting the default linker script.</p>
<pre><code>SECTIONS
{
        . = ALIGN(8);
        HIDDEN(_fntab_start = .);
        .fntab : {
               /* Sort entries for numerical priorities in section names. */
               KEEP(*(SORT(.fntab*)));
        }
        HIDDEN(_fntab_end = .);
}
INSERT AFTER .data
</code></pre>
<p>The following shows an example program using two linker script
snippets generating two different sections in the final binary.</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;

#define SECTION(S) __attribute__((section(S)))
#define USED       __attribute__((used))

// -- FUNCTON POINTER TABLE ----------------------------------------------------

typedef void (*fntab_t)();

// Define a function table entry with a priotiy.
#define FNTAB_ENTRY(E, P) \
  SECTION(".fntab" #P) USED static const fntab_t fnentry_##E##P = E;

// Iterate the function table.
#define FNTAB_FOREACH(V)    \
  extern char _fntab_start; \
  extern char _fntab_end;   \
  for (fntab_t* V = (fntab_t*)&amp;_fntab_start; V &lt; (fntab_t*)&amp;_fntab_end; ++V)

// func10 &amp; func11 are defined with the same prority, order not guaranteed.
// func20 has a lower priority, only runs after func10 &amp; func11.

void func10() {
  puts("func10 called");
}
FNTAB_ENTRY(func10, 1);

void func11() {
  puts("func11 called");
}
FNTAB_ENTRY(func11, 1);

void func20() {
  puts("func20 called");
}
FNTAB_ENTRY(func20, 2);

// -- DATA TABLE ---------------------------------------------------------------

struct datatab_t {
  const char* name;
  void (*fn)();
};

#define DATATAB_ENTRY(E) \
  SECTION(".datatab")    \
  USED static const struct datatab_t dentry_##E = {.name = #E, .fn = E};

#define DATATAB_FOREACH(V)                                               \
  extern char _datatab_start;                                            \
  extern char _datatab_end;                                              \
  for (struct datatab_t* V = (struct datatab_t*)&amp;_datatab_start; \
       V &lt; (struct datatab_t*)&amp;_datatab_end; ++V)

DATATAB_ENTRY(func10);
DATATAB_ENTRY(func20);

// -- RUN EXAMPLE --------------------------------------------------------------

int main() {
  FNTAB_FOREACH(f) {
    printf("call fntab entry @%p\n", *f);
    (*f)();
  }

  DATATAB_FOREACH(d) {
    printf("datatab entry d-&gt;name=%s call d-&gt;fn=%p\n", d-&gt;name, d-&gt;fn);
    (*d-&gt;fn)();
  }
}
</code></pre>
<blockquote>
<p>This can be compiled like <code>gcc -o handler handler.c -T handler-fntab.ld -T handler-datatab.ld</code>.
All the sources can be found <a href="https://github.com/johannst/notes/tree/master/src/development/ld">here</a>.</p>
</blockquote>
<pre><code>&gt; readelf -W -S handler
# Section Headers:
#   [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al
#    ..
#   [23] .data             PROGBITS        0000000000404000 003000 000010 00  WA  0   0  8
#   [24] .datatab          PROGBITS        0000000000404010 003010 000020 00  WA  0   0 16
#   [25] .fntab            PROGBITS        0000000000404030 003030 000018 00  WA  0   0  8
</code></pre>
<h2 id="example-virtual-vs-physical-load-address"><a class="header" href="#example-virtual-vs-physical-load-address">Example: virtual vs physical (load) address</a></h2>
<p>Sometimes code is initially located at a different location as when being run.
For example in embedded cases, where code may initially resides in a <em>rom</em> and
startup code will copy a section with writable <em>data</em> into <em>ram</em>. Code accessing
the writable data accesses the data in the <em>ram</em>.</p>
<p>In this case we need different addresses for the same data.</p>
<ul>
<li>The <code>virtual</code> or <em>runtime</em> address, this is the address used when the linker
resolves accesses to the data. Hence, this is the address the data will have
when the code is running.</li>
<li>The <code>physical</code> or <em>load</em> address, this is the address the data is stored at
initially. Startup code typically copies the initial values from the
<code>physical</code> to the <code>virtual</code> address.</li>
</ul>
<p>The following shows an example linker script which uses <em>virtual</em> and <em>physical</em>
addresses. The full source files can be found <a href="https://github.com/johannst/notes/tree/master/src/development/ld">here</a>.</p>
<pre><code>OUTPUT_FORMAT(elf64-x86-64)
ENTRY(_entry)

SECTIONS {
    /* Set the initial location counter (vaddr) */
    . = 0x00800000;

    /* Create .text output section at current vaddr */
    .text : {
        *(.text*)
    }

    ASSERT(. == 0x00800000 + SIZEOF(.text), "inc loc counter automatically")

    /* Create .data section at location counter aligned to the next 0x100 (vaddr) */
    /* Set the load address to  0x00100000 (paddr) */
    .data ALIGN(0x100) : AT(0x00100000) {
        HIDDEN(_data_vaddr = .);
        HIDDEN(_data_paddr = LOADADDR(.data));
        *(.data*)
    }

    /* Create .rodata with explicit vaddr */
    /* Re-adjust the paddr location counter */
    .rodata 0x00804000 : AT(ADDR(.rodata)) {
        *(.rodata*)
    }

    ASSERT(. == 0x00804000 + SIZEOF(.rodata), "inc loc counter automatically")

    .stack ALIGN (0x1000) : {
        . += 0x1000;
        HIDDEN(_stack_top = .);
    }

    /DISCARD/ : {
        *(.*)
    }
}

/* Some example assertions */
ASSERT(ADDR(.data) != LOADADDR(.data), "DATA vaddr and paddr must be different")
ASSERT(ADDR(.rodata) == LOADADDR(.rodata), "RODATA vaddr and paddr must be euqal")
ASSERT(ADDR(.stack) == 0x00805000, "STACK section must aligned to 0x1000")
ASSERT(SIZEOF(.stack) == 0x1000, "STACK section must be 0x1000")
</code></pre>
<p>We can use the following assembly snippet to explore the linker script.</p>
<pre><code class="language-x86asm">.section .text, "ax", @progbits
.global _entry
_entry:
    mov $_stack_top, %rsp
    mov $asm_array, %rax
    mov (asm_len), %eax

    hlt
    jmp _entry

.section .data.asm, "aw", @progbits
asm_array:
    .4byte 0xa
    .4byte 0xb
    .4byte 0xc
    .4byte 0xd
.rept 4
    .4byte 0xff
.endr

.section .rodata.asm, "a", @progbits
asm_len:
    .4byte 8
</code></pre>
<blockquote>
<p><code>gcc -c data.S &amp;&amp; ld -o link-nomem -T link-nomem.ld data.o</code></p>
</blockquote>
<p>The elf load segments show the difference in <em>physical</em> and <em>virtual</em> address
for the segment containing the <code>.data</code> section.</p>
<pre><code class="language-sh">&gt; readelf -W -l link-nomem
# There are 4 program headers, starting at offset 64
#
# Program Headers:
#   Type   Offset   VirtAddr           PhysAddr           FileSiz  MemSiz   Flg Align
#   LOAD   0x001100 0x0000000000800100 0x0000000000100000 0x000020 0x000020 RW  0x1000
#   LOAD   0x002000 0x0000000000800000 0x0000000000800000 0x000018 0x000018 R E 0x1000
#   LOAD   0x003000 0x0000000000804000 0x0000000000804000 0x000004 0x000004 R   0x1000
#   LOAD   0x000000 0x0000000000805000 0x0000000000805000 0x000000 0x001000 RW  0x1000
#
#  Section to Segment mapping:
#   Segment Sections...
#   00     .data
#   01     .text
#   02     .rodata
#   03     .stack
</code></pre>
<p>Startup code could copy data from <code>_data_paddr</code> to <code>_data_vaddr</code>.</p>
<pre><code class="language-sh">&gt; nm link-nomem
# 0000000000800100 d asm_array
# 0000000000804000 r asm_len
# 0000000000100000 a _data_paddr
# 0000000000800100 d _data_vaddr
# 0000000000800000 T _entry
# 0000000000806000 b _stack_top
</code></pre>
<p>The linker resolves symbols to their <em>virtual</em> address, this can be seen by the
access to the <code>asm_array</code> variable.</p>
<pre><code class="language-sh">&gt; objdump -d link-nomem
# Disassembly of section .text:
#
# 0000000000800000 &lt;_entry&gt;:
#   800000:	48 c7 c4 00 60 80 00 	mov    $0x806000,%rsp
#   800007:	48 c7 c0 00 01 80 00 	mov    $0x800100,%rax   ;; mov $asm_array, %rax
#   80000e:	8b 04 25 00 40 80 00 	mov    0x804000,%eax
#   800015:	f4                   	hlt
#   800016:	eb e8                	jmp    800000 &lt;_entry&gt;
</code></pre>
<p>The following linker script shows an example with the <code>MEMORY</code> command.</p>
<pre><code>OUTPUT_FORMAT(elf64-x86-64)
ENTRY(_entry)

MEMORY {
    ROM : ORIGIN = 0x00100000, LENGTH = 0x4000
    RAM : ORIGIN = 0x00800000, LENGTH = 0x4000
}

SECTIONS {
    /* Create .text output section at ROM (vaddr) */
    .text : {
        *(.text*)
    } &gt; ROM

    ASSERT(. == ORIGIN(ROM) + SIZEOF(.text), "inc loc counter automatically")

    /* Create .data output section at RAM (vaddr) */
    /* Set load addr to ROM, right after .text (paddr) */
    .data : {
        HIDDEN(_data_vaddr = .);
        HIDDEN(_data_paddr = LOADADDR(.data));
        *(.data*)
    } &gt; RAM AT &gt; ROM

    /* Append .rodata output section at ROM (vaddr) */
    .rodata : {
        *(.rodata*)
    } &gt; ROM

    /* Append .stack output section at RAM (vaddr) aligned up to next 0x1000 */
    .stack : ALIGN (0x1000) {
        . += 0x1000;
        HIDDEN(_stack_top = .);
    } &gt; RAM

    /DISCARD/ : {
        *(.*)
    }
}

/* Some example assertions */
ASSERT(ADDR(.data) != LOADADDR(.data), "DATA vaddr and paddr must be different")
ASSERT(ADDR(.rodata) == LOADADDR(.rodata), "RODATA vaddr and paddr must be euqal")
ASSERT(ADDR(.stack) == ORIGIN(RAM) + 0x1000, "STACK section must aligned to 0x1000")
ASSERT(SIZEOF(.stack) == 0x1000, "STACK section must be 0x1000")
</code></pre>
<h2 id="references-7"><a class="header" href="#references-7">References</a></h2>
<ul>
<li><a href="https://sourceware.org/binutils/docs/ld/">ld manual</a></li>
<li><a href="https://sourceware.org/binutils/docs/ld/Input-Section.html">ld script: input sections</a></li>
<li><a href="https://sourceware.org/binutils/docs/ld/Output-Section-Attributes.html">ld script: output sections</a></li>
<li><a href="https://sourceware.org/binutils/docs/ld/Simple-Commands.html">ld script: simple commands</a></li>
<li><a href="https://sourceware.org/binutils/docs/ld/Miscellaneous-Commands.html">ld script: other script commands</a></li>
<li><a href="https://sourceware.org/binutils/docs/ld/Builtin-Functions.html">ld script: builtin functions</a></li>
<li><a href="https://github.com/johannst/notes/tree/master/src/development/ld">notes/ld example files</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="git1"><a class="header" href="#git1">git(1)</a></h1>
<h2 id="working-areas"><a class="header" href="#working-areas">Working areas</a></h2>
<pre><code class="language-text">+-------------------+ --- stash -----&gt; +-------+
| working directory |                  | stash |  // Shelving area.
|     (worktree)    | &lt;-- stash pop -- +-------+
+-------------------+
      |       ^
     add      |
      |     reset
      v       |
+-------------------+
|   staging area    |
|      (index)      |
+-------------------+
      |
    commit
      |
      v
+-------------------+
| local repository  |
+-------------------+
      |       ^
     push     |
      |     fetch /
      |      pull
      v       |
+-------------------+
| remote repository |
+-------------------+
</code></pre>
<h2 id="config"><a class="header" href="#config">Config</a></h2>
<pre><code class="language-markdown">  git config --list --show-origin ..... list currently set configs and where
                                        they are coming from
  git --edit [--global] ............... open config in editor (local or global)
</code></pre>
<h2 id="clean"><a class="header" href="#clean">Clean</a></h2>
<pre><code class="language-markdown">  git clean -X ......... remove only ignored files (-n for dry run)
  git clean -f -d -x ... remove untracked &amp; ignored files / folders
  git clean -e &lt;pat&gt; ... exclude pattern from deletion
</code></pre>
<h2 id="staging"><a class="header" href="#staging">Staging</a></h2>
<pre><code class="language-markdown">  git add -p [&lt;file&gt;] ............ partial staging (interactive)
</code></pre>
<h2 id="remote"><a class="header" href="#remote">Remote</a></h2>
<pre><code class="language-markdown">  git remote -v .................. list remotes verbose (with URLs)
  git remote show [-n] &lt;remote&gt; .. list info for &lt;remote&gt; (like remote HEAD,
                                   remote branches, tracking mapping)
</code></pre>
<h2 id="branching"><a class="header" href="#branching">Branching</a></h2>
<pre><code class="language-markdown">  git branch [-a] ................ list available branches; -a to include
                                   remote branches
  git branch -vv ................. list branch &amp; annotate with head sha1 &amp;
                                   remote tracking branch
  git branch &lt;bname&gt; ............. create local branch with name &lt;bname&gt;
  git branch -d &lt;bname&gt; .......... delete local branch with name &lt;bname&gt;
  git checkout &lt;bname&gt; ........... switch to branch with name &lt;bname&gt;
  git checkout --track &lt;branch&gt; .. start to locally track a remote branch
  git branch --unset-upstream .... unset remote tracking branch

  # Remote

  git push -u origin &lt;rbname&gt; ........ push local branch to origin (or other
                                       remote), and setup &lt;rbname&gt; as tracking
                                       branch
  git push origin --delete &lt;rbname&gt; .. delete branch &lt;rbname&gt; from origin (or
                                       other remote)
</code></pre>
<h2 id="update-local-from-remote"><a class="header" href="#update-local-from-remote">Update local from remote</a></h2>
<pre><code class="language-markdown">  git fetch --prune .................. update all remote references and
                                       remove delete non-existing ones
                                       (does not merge into local tracking branch)
  git pull [--rebase] ................ fetch remote references and merge into
                                       local tracking branch (fast-forward by default).
                                       Optionally rebase local tracking branch
                                       on-top of remote branch (in case local
                                       branch has additional commits compared to remote branch).
</code></pre>
<h2 id="tags"><a class="header" href="#tags">Tags</a></h2>
<pre><code class="language-markdown">  git tag -a &lt;tname&gt; -m "descr" ........ creates an annotated tag (full object
                                         containing tagger, date, ...)
  git tag -l ........................... list available tags
  git checkout tag/&lt;tname&gt; ............. checkout specific tag
  git checkout tag/&lt;tname&gt; -b &lt;bname&gt; .. checkout specific tag in a new branch

  # Remote

  git push origin --tags .... push local tags to origin (or other remote)
</code></pre>
<h2 id="merging"><a class="header" href="#merging">Merging</a></h2>
<pre><code class="language-markdown">  git merge [opt] &lt;commit&gt; .... integrate changes from &lt;commit&gt; since
    opt:                        current branch and &lt;commit&gt; diverged
      --squash ................ merge all commits into a single one
      --no-commit ............. dont generate commit if the merge succeeds

  git merge-base &lt;commit&gt; &lt;commit&gt;
                                get the common ancestor, since both commits diverged

  git rebase -i &lt;upstream&gt; .... interactively rebase on &lt;upstream&gt;, also supports actions
                                like squashing, editing, rewording, etc of commits

  git cherry-pick &lt;commit&gt; .... apply commit on current branch
</code></pre>
<h2 id="worktree"><a class="header" href="#worktree">Worktree</a></h2>
<p>Worktrees allow to maintain multiple working trees in the filesystem linked to
the same repository (shared .git folder).</p>
<pre><code class="language-markdown">  git worktree add &lt;path&gt; .............. create a tree at &lt;path&gt; with a new branch
                                         checked out (bname is basename of &lt;path&gt;)
  git worktree add &lt;path&gt; &lt;bname&gt; ...... create a tree at &lt;path&gt; from existing &lt;bname&gt;
  git worktree list .................... list existing work trees
  git worktree remove &lt;tree&gt; ........... remove work tree
  git worktree prune ................... remove stale bookkeeping files
</code></pre>
<h2 id="log--commit-history"><a class="header" href="#log--commit-history">Log &amp; Commit History</a></h2>
<pre><code class="language-markdown">  git log --oneline ......... shows log in single line per commit -&gt; alias for
                              '--pretty=oneline --abbrev-commit'
  git log --graph ........... text based graph of commit history
  git log --decorate ........ decorate log with REFs

  git log -p &lt;file&gt; ......... show commit history + diffs for &lt;file&gt;
  git log --oneline &lt;file&gt; .. show commit history for &lt;file&gt; in compact format
  git log -nN ............... show last N history entries
</code></pre>
<h2 id="diff--commit-info"><a class="header" href="#diff--commit-info">Diff &amp; Commit Info</a></h2>
<pre><code class="language-markdown">  git diff &lt;commit&gt;..&lt;commit&gt; [&lt;file&gt;] .... show changes between two arbitrary
                                            commits. If one &lt;commit&gt; is omitted
                                            it is if HEAD is specified.
  git diff --name-only &lt;commit&gt;..&lt;commit&gt; . show names of files changed
  git diff -U$(wc -l &lt;file&gt;) &lt;file&gt; ....... shows complete file with diffs
                                            instead of usual diff snippets
  git diff --staged ....................... show diffs of staged files

  git show --stat &lt;commit&gt; ................ show files changed by &lt;commit&gt;
  git show &lt;commit&gt; [&lt;file&gt;] .............. show diffs for &lt;commit&gt;

  git show &lt;commit&gt;:&lt;file&gt; ................ show &lt;file&gt; at &lt;commit&gt;
</code></pre>
<h2 id="patching"><a class="header" href="#patching">Patching</a></h2>
<pre><code class="language-markdown">  git format-patch &lt;opt&gt; &lt;since&gt;/&lt;revision range&gt;
    opt:
      -N ................... use [PATCH] instead [PATCH n/m] in subject when
                             generating patch description (for patches spanning
                             multiple commits)
      --start-number &lt;n&gt; ... start output file generation with &lt;n&gt; as start
                             number instead '1'
    since spcifier:
      -3 .................. e.g: create a patch from last three commits
      &lt;commit hash&gt; ....... create patch with commits starting after &lt;commit hash&gt;

  git am &lt;patch&gt; ......... apply patch and create a commit for it

  git apply --stat &lt;PATCH&gt; ... see which files the patch would change
  git apply --check &lt;PATCH&gt; .. see if the patch can be applied cleanly
  git apply [-3] &lt;PATCH&gt; ..... apply the patch locally without creating a commit,
                               if the patch does not cleanly apply -3 allows for
                               a 3-way merge

  # eg: generate patches for each commit from initial commit on
  git format-patch -N $(git rev-list --max-parents=0 HEAD)

  # generate single patch file from a certain commit/ref
  git format-patch &lt;COMMIT/REF&gt; --stdout &gt; my-patch.patch
</code></pre>
<h2 id="resetting"><a class="header" href="#resetting">Resetting</a></h2>
<pre><code class="language-markdown">  git reset [opt] &lt;ref|commit&gt;
    opt:
      --mixed .................... resets index, but not working tree
      --hard ..................... matches the working tree and index to that
                                   of the tree being switched to any changes to
                                   tracked files in the working tree since
                                   &lt;commit&gt; are lost
  git reset HEAD &lt;file&gt; .......... remove file from staging
  git reset --soft HEAD~1 ........ delete most recent commit; dont revert index &amp; worktree
  git reset --mixed HEAD~1 ....... delete most recent commit; revert index; dont revert worktree
  git reset --hard HEAD~1 ........ delete most recent commit; revert index &amp; worktree
</code></pre>
<p>Assuming an initial history <code>A - B - C - D</code> where <code>HEAD</code> currently points at
<code>D</code>, the different reset operations work as shown below.</p>
<p><strong>Soft</strong> reset.</p>
<pre><code>git reset --soft HEAD~2

history:    A - B
                ^HEAD

-&gt; local history is reverted, HEAD moved to B.
-&gt; changes from C + D are still in the worktree &amp; index (appear as staged changes).
</code></pre>
<p><strong>Mixed</strong> reset.</p>
<pre><code>git reset --mixed HEAD~2

history:    A - B
                ^HEAD

-&gt; local history is reverted, HEAD moved to B.
-&gt; changed from C + D are reverted in the index.
-&gt; changes from C + D are still in the worktree (appear as unstaged changes).
</code></pre>
<p><strong>Hard</strong> reset.</p>
<pre><code>git reset --head HEAD~2

history:    A - B
                ^HEAD

-&gt; local history is reverted, HEAD moved to B.
-&gt; changes from C + D also reverted in the worktree &amp; index (no pending changes).
</code></pre>
<h2 id="submodules"><a class="header" href="#submodules">Submodules</a></h2>
<pre><code class="language-markdown">  git submodule add &lt;url&gt; [&lt;path&gt;] .......... add new submodule to current project
  git clone --recursive &lt;url&gt; ............... clone project and recursively all
                                              submodules (same as using
                                              'git submodule update --init
                                              --recursive' after clone)
  git submodule update --init --recursive ... checkout submodules recursively
                                              using the commit listed in the
                                              super-project (in detached HEAD)
  git submodule update --remote &lt;submod&gt; .... fetch &amp; merge remote changes for
                                              &lt;submod&gt;, this will pull
                                              origin/HEAD or a branch specified
                                              for the submodule
  git diff --submodule ...................... show commits that are part of the
                                              submodule diff
</code></pre>
<h2 id="bisect"><a class="header" href="#bisect">Bisect</a></h2>
<pre><code class="language-markdown">  git bisect start BAD GOOD ........ start bisect process in range BAD..GOOD commits
  git bisect good .................. mark current commit as good
  git bisect bad ................... mark current commit as bad

  # Automate bisecting.
  git bisect run &lt;script&gt; &lt;args&gt; ... run script to automate bisect process
                                     exit 0   - mark commit as good
                                     exit 1   - mark commit as bad
                                     exit 125 - skip commit (eg doesn't build)
</code></pre>
<h2 id="inspection-1"><a class="header" href="#inspection-1">Inspection</a></h2>
<pre><code class="language-markdown">  git ls-tree [-r] &lt;ref&gt; .... show git tree for &lt;ref&gt;, -r to recursively ls sub-trees
  git show &lt;obj&gt; ............ show &lt;obj&gt;
  git cat-file -p &lt;obj&gt; ..... print content of &lt;obj&gt;
</code></pre>
<h2 id="revision-specifier"><a class="header" href="#revision-specifier">Revision Specifier</a></h2>
<pre><code class="language-markdown">  HEAD ........ last commit
  HEAD~1 ...... last commit-1
  HEAD~N ...... last commit-N (linear backwards when in tree structure, check
                difference between HEAD^ and HEAD~)
  git rev-list --max-parents=0 HEAD ........... first commit
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="cmake1"><a class="header" href="#cmake1">cmake(1)</a></h1>
<h2 id="frequently-used-variables"><a class="header" href="#frequently-used-variables">Frequently used variables</a></h2>
<pre><code># Install location.
CMAKE_INSTALL_PREFIX=&lt;path&gt;

# Generate compile_commands.json?
CMAKE_EXPORT_COMPILE_COMMANDS={0,1}

# Project build type.
CMAKE_BUILD_TYPE={Debug, Release, RelWithDebInfo, MinSizeRel}

# C++ standard.
CMAKE_CXX_STANDARD={14,17,..}
</code></pre>
<h2 id="private--public--interface"><a class="header" href="#private--public--interface"><code>PRIVATE</code> / <code>PUBLIC</code> / <code>INTERFACE</code></a></h2>
<p>These modifier control where properties for a given target are visible.</p>
<ul>
<li><code>PRIVATE</code>: Only for the target itself.</li>
<li><code>INTERFACE</code>: Only for anyone linking against the target.</li>
<li><code>PUBLIC</code>: For the target itself and anyone linking against it (effectively
<code>PRIVATE</code> + <code>INTERFACE</code>).</li>
</ul>
<p>The following gives an example for preprocessor definitions specified on a
library target. This behaves in the same way for other properties like for
example include directories.</p>
<pre><code class="language-cmake"># CMakeLists.txt

cmake_minimum_required(VERSION 3.14)
project(moose)

# -- LIBRARY
add_library(liba STATIC liba.cc)
target_compile_definitions(liba PUBLIC DEF_PUBLIC)
target_compile_definitions(liba PRIVATE DEF_PRIVATE)
target_compile_definitions(liba INTERFACE DEF_INTERFACE)

# -- APPLICATION
add_executable(main main.cc)
target_link_libraries(main liba)
</code></pre>
<pre><code class="language-sh">&gt; touch liba.cc; echo "int main() {}" &gt; main.cc
&gt; cmake -B build -S . -G Ninja
&gt; ninja -C build -j1 --verbose
[1/4] /usr/bin/c++ -DDEF_PRIVATE -DDEF_PUBLIC  [..] .../liba.cc
[2/4] [..]
[3/4] /usr/bin/c++ -DDEF_INTERFACE -DDEF_PUBLIC [..] .../main.cc
[4/4] [..]
</code></pre>
<h2 id="find_package-ref"><a class="header" href="#find_package-ref"><code>find_package</code> [<a href="https://cmake.org/cmake/help/latest/command/find_package.html">ref</a>]</a></h2>
<p>A small example to play with can be found in <a href="https://github.com/johannst/notes/tree/master/src/development/cmake/module">cmake/module</a>.</p>
<pre><code class="language-cmake">find_package(Name MODULE)
</code></pre>
<p>Looks for <code>FindName.cmake</code> in paths given by <code>CMAKE_MODULE_PATH</code> and then builtin paths.</p>
<pre><code class="language-cmake">find_package(Name CONFIG)
</code></pre>
<p>Looks for <code>name-config.cmake</code> or <code>NameConfig.cmake</code> in paths given by
<code>CMAKE_PREFIX_PATH</code>, or path given by <code>Name_DIR</code> and then builtin paths.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="make1"><a class="header" href="#make1">make(1)</a></h1>
<h2 id="anatomy-of-make-rules"><a class="header" href="#anatomy-of-make-rules">Anatomy of <code>make</code> rules</a></h2>
<pre><code class="language-make">target .. : prerequisite ..
	recipe
	..
</code></pre>
<ul>
<li><code>target</code>: an output generated by the rule</li>
<li><code>prerequisite</code>: an input that is used to generate the target</li>
<li><code>recipe</code>: list of actions to generate the output from the input</li>
</ul>
<blockquote>
<p>Use <code>make -p</code> to print all rules and variables (implicitly + explicitly defined).</p>
</blockquote>
<h2 id="pattern-rules--variables"><a class="header" href="#pattern-rules--variables">Pattern rules &amp; variables</a></h2>
<h3 id="pattern-rules"><a class="header" href="#pattern-rules">Pattern rules</a></h3>
<p>A pattern rule contains the <code>%</code> char (exactly one of them) and look like this example:</p>
<pre><code class="language-make">%.o : %.c
	$(CC) -c $(CFLAGS) $(CPPFLAGS) $&lt; -o $@
</code></pre>
<p>The target matches files of the pattern <code>%.o</code>, where <code>%</code> matches any none-empty
substring and other character match just them self.</p>
<p>The substring matched by <code>%</code> is called the <code>stem</code>.</p>
<p><code>%</code> in the prerequisite stands for the matched <code>stem</code> in the target.</p>
<h3 id="automatic-variables"><a class="header" href="#automatic-variables">Automatic variables</a></h3>
<p>As targets and prerequisites in pattern rules can’t be spelled explicitly in
the recipe, make provides a set of automatic variables to work with:</p>
<ul>
<li><code>$@</code>: Name of the target that triggered the rule.</li>
<li><code>$&lt;</code>: Name of the first prerequisite.</li>
<li><code>$^</code>: Names of all prerequisites (without duplicates).</li>
<li><code>$+</code>: Names of all prerequisites (with duplicates).</li>
<li><code>$*</code>: Stem of the pattern rule.</li>
</ul>
<pre><code class="language-make"># file: Makefile

all: foobar blabla

foo% bla%: aaa bbb bbb
	@echo "@ = $@"
	@echo "&lt; = $&lt;"
	@echo "^ = $^"
	@echo "+ = $+"
	@echo "* = $*"
	@echo "----"

aaa:
bbb:
</code></pre>
<p>Running above <code>Makefile</code> gives:</p>
<pre><code class="language-text">@ = foobar
&lt; = aaa
^ = aaa bbb
+ = aaa bbb bbb
* = bar
----
@ = blabla
&lt; = aaa
^ = aaa bbb
+ = aaa bbb bbb
* = bla
----
</code></pre>
<p>Variables related to filesystem paths:</p>
<ul>
<li><code>$(CURDIR)</code>: Path of current working dir after using <code>make -C path</code></li>
</ul>
<h3 id="multi-line-variables"><a class="header" href="#multi-line-variables">Multi-line variables</a></h3>
<pre><code class="language-make">define my_var
@echo foo
@echo bar
endef

all:
	$(my_var)
</code></pre>
<p>Running above <code>Makefile</code> gives:</p>
<pre><code class="language-text">foo
bar
</code></pre>
<h2 id="arguments"><a class="header" href="#arguments">Arguments</a></h2>
<p>Arguments specified on the command line <em>override</em> ordinary variable
assignments in the makefile (<a href="https://www.gnu.org/software/make/manual/html_node/Overriding.html">overriding variables</a>).</p>
<pre><code class="language-make">VAR = abc
all:
	@echo VAR=$(VAR)
</code></pre>
<pre><code class="language-text"># make
VAR=abc

# make VAR=123
VAR=123
</code></pre>
<h2 id="useful-functions"><a class="header" href="#useful-functions">Useful functions</a></h2>
<h3 id="substitution-references"><a class="header" href="#substitution-references">Substitution references</a></h3>
<p>Substitute strings matching pattern in a list.</p>
<pre><code class="language-make">in  := a.o l.a c.o
out := $(in:.o=.c)
# =&gt; out = a.c l.a c.c
</code></pre>
<h3 id="patsubst-ref"><a class="header" href="#patsubst-ref"><code>patsubst</code> (<a href="https://www.gnu.org/software/make/manual/html_node/Text-Functions.html#index-patsubst-1">ref</a>)</a></h3>
<pre><code class="language-make">in  := a.c b.c
out := $(patsubst %.c, build/%.o, $(in))
# =&gt; out = build/a.o build/b.o

# This is actually equivalent to $(in:%.c=build/%.o)
</code></pre>
<p>Replace multiple patterns, requires multiple <code>patsubst</code> invocations.</p>
<pre><code class="language-make">in  := foo.S bar.zig
out := $(patsubst %.S, a/%.o, $(patsubst %.zig, z/%.o, $(in)))
# =&gt; out = a/foo.o z/bar.o
</code></pre>
<h3 id="filter"><a class="header" href="#filter"><code>filter</code></a></h3>
<p>Keep strings matching a pattern in a list.</p>
<pre><code class="language-make">in  := a.a b.b c.c d.d
out := $(filter %.b %.c, $(in))
# =&gt; out = b.b c.c
</code></pre>
<h3 id="filter-out"><a class="header" href="#filter-out"><code>filter-out</code></a></h3>
<p>Remove strings matching a pattern from a list.</p>
<pre><code class="language-make">in  := a.a b.b c.c d.d
out := $(filter-out %.b %.c, $(in))
# =&gt; out = a.a d.d
</code></pre>
<h3 id="abspath"><a class="header" href="#abspath"><code>abspath</code></a></h3>
<p>Resolve each file name as absolute path (don’t resolve symlinks).</p>
<pre><code class="language-make">$(abspath fname1 fname2 ..)
</code></pre>
<h3 id="realpath"><a class="header" href="#realpath"><code>realpath</code></a></h3>
<p>Resolve each file name as canonical path.</p>
<pre><code class="language-make">$(realpath fname1 fname2 ..)
</code></pre>
<h3 id="call--ref"><a class="header" href="#call--ref"><code>call</code>  (<a href="https://www.gnu.org/software/make/manual/html_node/Call-Function.html">ref</a>)</a></h3>
<p>Invoke parametrized function, which can be an expression saved in a variable
(single line), or a <code>define/endef</code> block (multi line).</p>
<pre><code class="language-make">swap = $(2) $(1)

# Use echo here just for the purpose of the demonstration.
define cc
@echo mkdir -p $(dir $1)
@echo gcc -o $1 $2
endef

all:
	@echo "call swap first second -&gt; $(call swap,first,second)"
	$(call cc,build/abc,def)
</code></pre>
<p>Outputs:</p>
<pre><code class="language-text">call swap first second -&gt; second first
mkdir -p build/
gcc -o build/abc def
</code></pre>
<h3 id="eval-ref"><a class="header" href="#eval-ref"><code>eval</code> (<a href="https://www.gnu.org/software/make/manual/html_node/Eval-Function.html">ref</a>)</a></h3>
<p>Allows to define new makefile constructs by evaluating the result of a variable
or function.</p>
<pre><code class="language-make">define new_rule
$(1):
	@echo "$(1) -&gt; $(2)"
endef

default: rule1 rule2

$(eval $(call new_rule,rule1,foo))
$(eval $(call new_rule,rule2,bar))
</code></pre>
<p>Outputs:</p>
<pre><code class="language-text">rule1 -&gt; foo
rule2 -&gt; bar
</code></pre>
<h3 id="foreach-ref"><a class="header" href="#foreach-ref">foreach (<a href="https://www.gnu.org/software/make/manual/html_node/Foreach-Function.html">ref</a>)</a></h3>
<p>Repeat a piece of text for a list of values, given the syntax <code>$(foreach var,list,text)</code>.</p>
<pre><code class="language-make">myfn = x$(1)x

default:
	@echo $(foreach V,foo bar baz,$(call myfn,$(V)))
</code></pre>
<p>Outputs:</p>
<pre><code class="language-text">xfoox xbarx xbazx
</code></pre>
<h2 id="examples-13"><a class="header" href="#examples-13">Examples</a></h2>
<h3 id="config-based-settings"><a class="header" href="#config-based-settings">Config based settings</a></h3>
<pre><code class="language-make">conf-y      := default
conf-$(FOO) := $(conf-y) foo
conf-$(BAR) := $(conf-y) bar

libs-y      := libdef
libs-$(FOO) += libfoo
libs-$(BAR) += libbar

all:
	@echo "conf-y: $(conf-y)"
	@echo "libs-y: $(libs-y)"
</code></pre>
<p>Yields the following results.</p>
<pre><code class="language-sh">$ make
conf-y: default
libs-y: libdef

$ make FOO=y
conf-y: default foo
libs-y: libdef libfoo

$ make BAR=y
conf-y: default bar
libs-y: libdef libbar

$ make FOO=y BAR=y
conf-y: default foo bar
libs-y: libdef libfoo libbar
</code></pre>
<h3 id="using-foreach--eval--call-to-generate-new-rules"><a class="header" href="#using-foreach--eval--call-to-generate-new-rules">Using <code>foreach / eval / call</code> to generate new rules</a></h3>
<pre><code class="language-make">define new_rule
$(1):
	@echo "$(1) -&gt; $(2)"
endef

arg-rule1 = foo
arg-rule2 = bar

RULES = rule1 rule2

all: $(RULES)

$(foreach R,$(RULES),$(eval $(call new_rule,$(R),$(arg-$(R)))))

# equivalent to
#   $(eval $(call new_rule,rule1,foo))
#   $(eval $(call new_rule,rule2,bar))
</code></pre>
<p>Outputs:</p>
<pre><code class="language-text">rule1 -&gt; foo
rule2 -&gt; bar
</code></pre>
<blockquote>
<p>Use <code>make -R -p</code> to print the make database including the rules.</p>
</blockquote>
<h3 id="verbose-command-similar-to-linux-kernel"><a class="header" href="#verbose-command-similar-to-linux-kernel">Verbose command (similar to linux kernel)</a></h3>
<pre><code class="language-make">VCMD = $(if $(filter-out 0,$(V)), \
         @printf "$(3)\n", \
         @printf "%-8s $(2)\n" $(1)) ; \
      $(3)

# Mock ruls to demonstrate.
all: foo.o
%.o: %.c
	$(call VCMD,CC,$@,true || gcc -c -o $@ $&lt;)
foo.c:
</code></pre>
<blockquote>
<p>The condition in <code>$(if cond,then,else)</code> is expanded as string and stripped,
and any non-empty string is treated as true.</p>
</blockquote>
<p>Outputs:</p>
<pre><code class="language-text">&gt; make
CC       foo.o
&gt; make V=0
CC       foo.o
&gt; make V=1
true || gcc -c -o foo.o foo.c
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ldso8"><a class="header" href="#ldso8">ld.so(8)</a></h1>
<h2 id="environment-variables-1"><a class="header" href="#environment-variables-1">Environment Variables</a></h2>
<pre><code class="language-console">LD_PRELOAD=&lt;l_so&gt;       colon separated list of libso's to be pre loaded
LD_DEBUG=&lt;opts&gt;         comma separated list of debug options
        =help           list available options
        =libs           show library search path
        =files          processing of input files
        =symbols        show search path for symbol lookup
        =bindings       show against which definition a symbol is bound
</code></pre>
<h3 id="ld_library_path-and-dlopen3"><a class="header" href="#ld_library_path-and-dlopen3">LD_LIBRARY_PATH and dlopen(3)</a></h3>
<p>When dynamically loading a shared library during program runtime with
<code>dlopen(3)</code>, only the <code>LD_LIBRARY_PATH</code> as it was during program startup is
evaluated.
Therefore the following is a code smell:</p>
<pre><code class="language-c">// at startup LD_LIBRARY_PATH=/moose

// Assume /foo/libbar.so
setenv("LD_LIBRARY_PATH", "/foo", true /* overwrite */);

// Will look in /moose and NOT in /foo.
dlopen("libbar.so", RTLD_LAZY);
</code></pre>
<h2 id="ld_preload-initialization-order-and-link-map"><a class="header" href="#ld_preload-initialization-order-and-link-map">LD_PRELOAD: Initialization Order and Link Map</a></h2>
<p>Libraries specified in <code>LD_PRELOAD</code> are loaded from <code>left-to-right</code> but
initialized from <code>right-to-left</code>.</p>
<pre><code>&gt; ldd ./main
  &gt;&gt; libc.so.6 =&gt; /usr/lib/libc.so.6

&gt; LD_PRELOAD=liba.so:libb.so ./main
           --&gt;
    preloaded in this order
           &lt;--
    initialized in this order
</code></pre>
<p>The preload order determines:</p>
<ul>
<li>the order libraries are inserted into the <code>link map</code></li>
<li>the initialization order for libraries</li>
</ul>
<p>For the example listed above the resulting <code>link map</code> will look like the
following:</p>
<pre><code>  +------+    +------+    +------+    +------+
  | main | -&gt; | liba | -&gt; | libb | -&gt; | libc |
  +------+    +------+    +------+    +------+
</code></pre>
<p>This can be seen when running with <code>LD_DEBUG=files</code>:</p>
<pre><code>&gt; LD_DEBUG=files LD_PRELOAD=liba.so:libb.so ./main
  # load order (-&gt; determines link map)
  &gt;&gt; file=liba.so [0];  generating link map
  &gt;&gt; file=libb.so [0];  generating link map
  &gt;&gt; file=libc.so.6 [0];  generating link map

  # init order
  &gt;&gt; calling init: /usr/lib/libc.so.6
  &gt;&gt; calling init: &lt;path&gt;/libb.so
  &gt;&gt; calling init: &lt;path&gt;/liba.so
  &gt;&gt; initialize program: ./main
</code></pre>
<p>To verify the <code>link map</code> order we let <code>ld.so</code> resolve the <code>memcpy(3)</code> libc
symbol (used in <em>main</em>) dynamically, while enabling <code>LD_DEBUG=symbols,bindings</code>
to see the resolving in action.</p>
<pre><code>&gt; LD_DEBUG=symbols,bindings LD_PRELOAD=liba.so:libb.so ./main
  &gt;&gt; symbol=memcpy;  lookup in file=./main [0]
  &gt;&gt; symbol=memcpy;  lookup in file=&lt;path&gt;/liba.so [0]
  &gt;&gt; symbol=memcpy;  lookup in file=&lt;path&gt;/libb.so [0]
  &gt;&gt; symbol=memcpy;  lookup in file=/usr/lib/libc.so.6 [0]
  &gt;&gt; binding file ./main [0] to /usr/lib/libc.so.6 [0]: normal symbol `memcpy' [GLIBC_2.14]
</code></pre>
<h2 id="rtld_local-and-rtld_deepbind"><a class="header" href="#rtld_local-and-rtld_deepbind"><code>RTLD_LOCAL</code> and <code>RTLD_DEEPBIND</code></a></h2>
<p>As shown in the <code>LD_PRELOAD</code> section above, when the dynamic linker resolves
symbol relocations, it walks the link map and until the first object provides
the requested symbol.</p>
<p>When libraries are loaded dynamically during runtime with <code>dlopen(3)</code>, one can
control the visibility of the symbols for the loaded library. The following two
flags control this visibility.</p>
<ul>
<li><code>RTLD_LOCAL</code> the symbols of the library (and its dependencies) are not
visible in the global symbol scope and therefore do not participate in global
symbol resolution from other libraries (default).</li>
<li><code>RTLD_GLOBAL</code> the symbols of the library are visible in the global symbol
scope.</li>
</ul>
<p>Additionally to the visibility one can use the <code>RTLD_DEEPBIND</code> flag to define
the lookup order when resolving symbols of the loaded library. With deep
binding, the symbols of the loaded library (and its dependencies) are searched
first before the global scope is searched. Without deep binding, the order is
reversed and the global space is searched first, which is the default.</p>
<p>The sources in <a href="https://github.com/johannst/notes/tree/master/src/development/ldso/deepbind">ldso/deepbind</a> give a minimal example, which can
be used to experiment with the different flags and investigate their behavior.</p>
<pre><code>main
|-&gt; explicitly link against liblink.so
|-&gt; dlopen(libdeep.so, RTLD_LOCAL | RTLD_DEEPBIND)
`-&gt; dlopen(libnodp.so, RTLD_LOCAL)
</code></pre>
<p>The following snippets are taken from <code>LD_DEBUG</code> to demonstrate the
<code>RLTD_LOCAL</code> and <code>RTLD_DEEPBIND</code> flags.</p>
<pre><code class="language-ini"># dlopen("libdeep.so", RTLD_LOCAL | RTLD_DEEPBIND)
# scopes visible to libdeep.so, where scope [0] is the local one.
object=./libdeep.so [0]
 scope 0: ./libdeep.so /usr/lib/libc.so.6 /lib64/ld-linux-x86-64.so.2
 scope 1: ./main ./libprel.so ./liblink.so /usr/lib/libc.so.6 /lib64/ld-linux-x86-64.so.2

# main: dlsym(handle:libdeep.so, "test")
symbol=test;  lookup in file=./libdeep.so [0]
binding file ./libdeep.so [0] to ./libdeep.so [0]: normal symbol `test'

# libdeep.so: dlsym(RTLD_NEXT, "next_libdeep")
symbol=next_libdeep;  lookup in file=/usr/lib/libc.so.6 [0]
symbol=next_libdeep;  lookup in file=/lib64/ld-linux-x86-64.so.2 [0]
./libdeep.so: error: symbol lookup error: undefined symbol: next_libdeep (fatal)

# libdeep.so: dlsym(RTLD_DEFAULT, "default_libdeep")
# first search local scope (DEEPBIND)
symbol=default_libdeep;  lookup in file=./libdeep.so [0]
symbol=default_libdeep;  lookup in file=/usr/lib/libc.so.6 [0]
symbol=default_libdeep;  lookup in file=/lib64/ld-linux-x86-64.so.2 [0]
symbol=default_libdeep;  lookup in file=./main [0]
symbol=default_libdeep;  lookup in file=./libprel.so [0]
symbol=default_libdeep;  lookup in file=./liblink.so [0]
symbol=default_libdeep;  lookup in file=/usr/lib/libc.so.6 [0]
symbol=default_libdeep;  lookup in file=/lib64/ld-linux-x86-64.so.2 [0]
./libdeep.so: error: symbol lookup error: undefined symbol: default_libdeep (fatal)

# main: dlsym(handle:libdeep.so, "libdeep_main")
symbol=libdeep_main;  lookup in file=./libdeep.so [0]
symbol=libdeep_main;  lookup in file=/usr/lib/libc.so.6 [0]
symbol=libdeep_main;  lookup in file=/lib64/ld-linux-x86-64.so.2 [0]
./libdeep.so: error: symbol lookup error: undefined symbol: libdeep_main (fatal)
</code></pre>
<p>The following snippets are taken from <code>LD_DEBUG</code> to demonstrate the
<code>RLTD_LOCAL</code> flag <em>without</em> the <code>RTLD_DEEPBIND</code> flag.</p>
<pre><code class="language-ini"># dlopen("libdeep.so", RTLD_LOCAL)
# scopes visible to libnodp.so, where scope [0] is the global one.
object=./libnodp.so [0]
 scope 0: ./main ./libprel.so ./liblink.so /usr/lib/libc.so.6 /lib64/ld-linux-x86-64.so.2
 scope 1: ./libnodp.so /usr/lib/libc.so.6 /lib64/ld-linux-x86-64.so.2

# main: dlsym(handle:libnodp.so, "test")
symbol=test;  lookup in file=./libnodp.so [0]
binding file ./libnodp.so [0] to ./libnodp.so [0]: normal symbol `test'

# libnodp.so: dlsym(RTLD_NEXT, "next_libnodp")
symbol=next_libnodp;  lookup in file=/usr/lib/libc.so.6 [0]
symbol=next_libnodp;  lookup in file=/lib64/ld-linux-x86-64.so.2 [0]
./libnodp.so: error: symbol lookup error: undefined symbol: next_libnodp (fatal)

# libnodp.so: dlsym(RTLD_DEFAULT, "default_libnodp")
# first search global scope (no DEEPBIND)
symbol=default_libnodp;  lookup in file=./main [0]
symbol=default_libnodp;  lookup in file=./libprel.so [0]
symbol=default_libnodp;  lookup in file=./liblink.so [0]
symbol=default_libnodp;  lookup in file=/usr/lib/libc.so.6 [0]
symbol=default_libnodp;  lookup in file=/lib64/ld-linux-x86-64.so.2 [0]
symbol=default_libnodp;  lookup in file=./libnodp.so [0]
symbol=default_libnodp;  lookup in file=/usr/lib/libc.so.6 [0]
symbol=default_libnodp;  lookup in file=/lib64/ld-linux-x86-64.so.2 [0]
./libnodp.so: error: symbol lookup error: undefined symbol: default_libnodp (fatal)

# main: dlsym(handle:libnodp.so, "libnodp_main")
symbol=libnodp_main;  lookup in file=./libnodp.so [0]
symbol=libnodp_main;  lookup in file=/usr/lib/libc.so.6 [0]
symbol=libnodp_main;  lookup in file=/lib64/ld-linux-x86-64.so.2 [0]
./libnodp.so: error: symbol lookup error: undefined symbol: libnodp_main (fatal)
</code></pre>
<p>The following is a global lookup from the main application, since
<code>lib{deep,nodp}.so</code> were loaded with <code>RTLD_LOCAL</code>, they are not visible in the
global symbol scope.</p>
<pre><code class="language-ini"># main: dlsym(RTLD_DEFAULT, "default_main")
symbol=default_main;  lookup in file=./main [0]
symbol=default_main;  lookup in file=./libprel.so [0]
symbol=default_main;  lookup in file=./liblink.so [0]
symbol=default_main;  lookup in file=/usr/lib/libc.so.6 [0]
symbol=default_main;  lookup in file=/lib64/ld-linux-x86-64.so.2 [0]
./main: error: symbol lookup error: undefined symbol: default_main (fatal)
</code></pre>
<h2 id="load-lib-with-same-name-from-different-locations"><a class="header" href="#load-lib-with-same-name-from-different-locations">Load lib with same name from different locations</a></h2>
<p>The sources in <a href="https://github.com/johannst/notes/tree/master/src/development/ldso/samename">ldso/samename</a> show some experiments, loading the
libs with the same name but potentially from different locations (paths).</p>
<h2 id="dynamic-linking-x86_64"><a class="header" href="#dynamic-linking-x86_64">Dynamic Linking (x86_64)</a></h2>
<p>Dynamic linking basically works via one indirect jump. It uses a combination of
function trampolines (<code>.plt</code> section) and a function pointer table (<code>.got.plt</code>
section).
On the first call the trampoline sets up some metadata and then jumps to the
<code>ld.so</code> runtime resolve function, which in turn patches the table with the
correct function pointer.</p>
<pre><code>.plt ....... procedure linkage table, contains function trampolines, usually
             located in code segment (rx permission)
.got.plt ... global offset table for .plt, holds the function pointer table
</code></pre>
<p>Using <code>radare2</code> we can analyze this in more detail:</p>
<pre><code>[0x00401040]&gt; pd 4 @ section..got.plt
            ;-- section..got.plt:
            ;-- .got.plt:    ; [22] -rw- section size 32 named .got.plt
            ;-- _GLOBAL_OFFSET_TABLE_:
       [0]  0x00404000      .qword 0x0000000000403e10 ; section..dynamic
       [1]  0x00404008      .qword 0x0000000000000000
            ; CODE XREF from section..plt @ +0x6
       [2]  0x00404010      .qword 0x0000000000000000
            ;-- reloc.puts:
            ; CODE XREF from sym.imp.puts @ 0x401030
       [3]  0x00404018      .qword 0x0000000000401036 ; RELOC 64 puts

[0x00401040]&gt; pd 6 @ section..plt
            ;-- section..plt:
            ;-- .plt:       ; [12] -r-x section size 32 named .plt
        ┌─&gt; 0x00401020      ff35e22f0000   push qword [0x00404008]
        ╎   0x00401026      ff25e42f0000   jmp qword [0x00404010]
        ╎   0x0040102c      0f1f4000       nop dword [rax]
┌ 6: int sym.imp.puts (const char *s);
└       ╎   0x00401030      ff25e22f0000   jmp qword [reloc.puts]
        ╎   0x00401036      6800000000     push 0
        └─&lt; 0x0040103b      e9e0ffffff     jmp sym..plt
</code></pre>
<ul>
<li>At address <code>0x00401030</code> in the <code>.plt</code> section we see the indirect jump for
<code>puts</code> using the function pointer in <code>_GLOBAL_OFFSET_TABLE_[3] (GOT)</code>.</li>
<li><code>GOT[3]</code> initially points to instruction after the <code>puts</code> trampoline
<code>0x00401036</code>.</li>
<li>This pushes the relocation index <code>0</code> and then jumps to the first trampoline
<code>0x00401020</code>.</li>
<li>The first trampoline jumps to <code>GOT[2]</code> which will be filled at program
startup by the <code>ld.so</code> with its resolve function.</li>
<li>The <code>ld.so</code> resolve function fixes the relocation referenced by the
relocation index pushed by the <code>puts</code> trampoline.</li>
<li>The relocation entry at index <code>0</code> tells the resolve function which symbol to
search for and where to put the function pointer:
<pre><code>&gt; readelf -r &lt;main&gt;
  &gt;&gt; Relocation section '.rela.plt' at offset 0x4b8 contains 1 entry:
  &gt;&gt;   Offset          Info           Type           Sym. Value    Sym. Name + Addend
  &gt;&gt; 000000404018  000200000007 R_X86_64_JUMP_SLO 0000000000000000 puts@GLIBC_2.2.5 + 0
</code></pre>
As we can see the offset from relocation at index <code>0</code> points to <code>GOT[3]</code>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="elf-symbol-versioning"><a class="header" href="#elf-symbol-versioning">ELF Symbol Versioning</a></h1>
<p>The <a href="https://refspecs.linuxbase.org/LSB_5.0.0/LSB-Core-generic/LSB-Core-generic/symversion.html">ELF symbol versioning</a> mechanism allows to attach version
information to symbols.
This can be used to express symbol version requirements or to provide certain
symbols multiple times in the same ELF file with different versions (eg for
backwards compatibility).</p>
<p>The <code>libpthread.so</code> library is an example which provides the
<code>pthread_cond_wait</code> symbol multiple times but in different versions.
With readelf the version of the symbol can be seen after the <code>@</code>.</p>
<pre><code class="language-bash">&gt; readelf -W --dyn-syms /lib/libpthread.so

Symbol table '.dynsym' contains 342 entries:
   Num:    Value  Size Type    Bind   Vis      Ndx Name
   ...
   141: 0000f080   696 FUNC    GLOBAL DEFAULT   16 pthread_cond_wait@@GLIBC_2.3.2
   142: 00010000   111 FUNC    GLOBAL DEFAULT   16 pthread_cond_wait@GLIBC_2.2.5
</code></pre>
<p>The <code>@@</code> denotes the <strong>default symbol version</strong> which will be used during
static linking against the library.
The following dump shows that the <code>tmp</code> program linked against <code>lpthread</code> will
depend on the symbol version <code>GLIBC_2.3.2</code>, which is the default version.</p>
<pre><code class="language-bash">&gt; echo "#include &lt;pthread.h&gt;
        int main() {
          return pthread_cond_wait(0,0);
        }" | gcc -o tmp -xc - -lpthread;
  readelf -W --dyn-syms tmp | grep pthread_cond_wait;

Symbol table '.dynsym' contains 7 entries:
   Num:    Value  Size Type    Bind   Vis      Ndx Name
   ...
     2: 00000000     0 FUNC    GLOBAL DEFAULT  UND pthread_cond_wait@GLIBC_2.3.2 (2)
</code></pre>
<blockquote>
<p>Only <strong>one</strong> symbol can be annotated as the <code>@@</code> default version.</p>
</blockquote>
<p>Using the <code>--version-info</code> flag with readelf, more details on the symbol
version info compiled into the <code>tmp</code> ELF file can be obtained.</p>
<ul>
<li>The <code>.gnu.version</code> section contains the version definition for each symbol in
the <code>.dynsym</code> section. <code>pthread_cond_wait</code> is at index <code>2</code> in the <code>.dynsym</code>
section, the corresponding symbol version is at index <code>2</code> in the
<code>.gnu.version</code> section.</li>
<li>The <code>.gnu.version_r</code> section contains symbol version requirements per shared
library dependency (<code>DT_NEEDED</code> dynamic entry).</li>
</ul>
<pre><code class="language-bash">&gt; readelf -W --version-info --dyn-syms tmp

Symbol table '.dynsym' contains 7 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND 
     1: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND _ITM_deregisterTMCloneTable
     2: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND pthread_cond_wait@GLIBC_2.3.2 (2)
     3: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND __libc_start_main@GLIBC_2.2.5 (3)
     4: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND __gmon_start__
     5: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND _ITM_registerTMCloneTable
     6: 0000000000000000     0 FUNC    WEAK   DEFAULT  UND __cxa_finalize@GLIBC_2.2.5 (3)

Version symbols section '.gnu.version' contains 7 entries:
 Addr: 0x0000000000000534  Offset: 0x000534  Link: 6 (.dynsym)
  000:   0 (*local*)       0 (*local*)       2 (GLIBC_2.3.2)   3 (GLIBC_2.2.5)
  004:   0 (*local*)       0 (*local*)       3 (GLIBC_2.2.5)

Version needs section '.gnu.version_r' contains 2 entries:
 Addr: 0x0000000000000548  Offset: 0x000548  Link: 7 (.dynstr)
  000000: Version: 1  File: libc.so.6  Cnt: 1
  0x0010:   Name: GLIBC_2.2.5  Flags: none  Version: 3
  0x0020: Version: 1  File: libpthread.so.0  Cnt: 1
  0x0030:   Name: GLIBC_2.3.2  Flags: none  Version: 2
</code></pre>
<p>The gnu dynamic linker allows to inspect the version processing during runtime
by setting the <code>LD_DEBUG</code> environment variable accordingly.</p>
<pre><code class="language-text"># version: Display version dependencies.
&gt; LD_DEBUG=versions ./tmp
    717904: checking for version `GLIBC_2.2.5' in file /usr/lib/libc.so.6 [0] required by file ./tmp [0]
    717904: checking for version `GLIBC_2.3.2' in file /usr/lib/libpthread.so.0 [0] required by file ./tmp [0]
    ...

#  symbols : Display symbol table processing.
#  bindings: Display information about symbol binding.
&gt; LD_DEBUG=symbols,bindings ./tmp
    ...
    718123: symbol=pthread_cond_wait;  lookup in file=./tmp [0]
    718123: symbol=pthread_cond_wait;  lookup in file=/usr/lib/libpthread.so.0 [0]
    718123: binding file ./tmp [0] to /usr/lib/libpthread.so.0 [0]: normal symbol `pthread_cond_wait' [GLIBC_2.3.2]
</code></pre>
<h2 id="example-version-script"><a class="header" href="#example-version-script">Example: version script</a></h2>
<p>The following shows an example C++ library <code>libfoo</code> which provides the same
symbol multiple times but in different versions.</p>
<pre><code class="language-cpp">// file: libfoo.cc
#include&lt;stdio.h&gt;

// Bind function symbols to version nodes.
//
// ..@       -&gt; Is the unversioned symbol.
// ..@@..    -&gt; Is the default symbol.

__asm__(".symver func_v0,func@");
__asm__(".symver func_v1,func@LIB_V1");
__asm__(".symver func_v2,func@@LIB_V2");

extern "C" {
    void func_v0() { puts("func_v0"); }
    void func_v1() { puts("func_v1"); }
    void func_v2() { puts("func_v2"); }
}

__asm__(".symver _Z11func_cpp_v1i,_Z8func_cppi@LIB_V1");
__asm__(".symver _Z11func_cpp_v2i,_Z8func_cppi@@LIB_V2");

void func_cpp_v1(int) { puts("func_cpp_v1"); }
void func_cpp_v2(int) { puts("func_cpp_v2"); }

void func_cpp(int) { puts("func_cpp_v2"); }
</code></pre>
<p>Version script for <code>libfoo</code> which defines which symbols for which versions are
exported from the ELF file.</p>
<pre><code class="language-ld"># file: libfoo.ver
LIB_V1 {
    global:
        func;
        extern "C++" {
            "func_cpp(int)";
        };
    local:
        *;
};

LIB_V2 {
    global:
        func;
        extern "C++" {
            "func_cpp(int)";
        };
} LIB_V1;
</code></pre>
<blockquote>
<p>The <strong>local:</strong> section in <code>LIB_V1</code> is a catch all, that matches any symbol
not explicitly specified, and defines that the symbol is local and therefore
not exported from the ELF file.</p>
</blockquote>
<p>The library <code>libfoo</code> can be linked with the version definitions in <code>libfoo.ver</code>
by passing the version script to the linker with the <code>--version-script</code> flag.</p>
<pre><code class="language-bash">&gt; g++ -shared -fPIC -o libfoo.so libfoo.cc -Wl,--version-script=libfoo.ver
&gt; readelf -W --dyn-syms libfoo.so | c++filt

Symbol table '.dynsym' contains 14 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
   ...
     6: 0000000000000000     0 OBJECT  GLOBAL DEFAULT  ABS LIB_V1
     7: 000000000000114b    29 FUNC    GLOBAL DEFAULT   13 func_cpp(int)@LIB_V1
     8: 0000000000001168    29 FUNC    GLOBAL DEFAULT   13 func_cpp(int)@@LIB_V2
     9: 0000000000001185    29 FUNC    GLOBAL DEFAULT   13 func_cpp(int)@@LIB_V1
    10: 0000000000000000     0 OBJECT  GLOBAL DEFAULT  ABS LIB_V2
    11: 0000000000001109    22 FUNC    GLOBAL DEFAULT   13 func
    12: 000000000000111f    22 FUNC    GLOBAL DEFAULT   13 func@LIB_V1
    13: 0000000000001135    22 FUNC    GLOBAL DEFAULT   13 func@@LIB_V2
</code></pre>
<p>The following program demonstrates how to make use of the different versions:</p>
<pre><code class="language-cpp">// file: main.cc
#include &lt;dlfcn.h&gt;
#include &lt;assert.h&gt;

// Links against default symbol in the lib.so.
extern "C" void func();

int main() {
    // Call the default version.
    func();

#ifdef _GNU_SOURCE
    typedef void (*fnptr)();

    // Unversioned lookup.
    fnptr fn_v0 = (fnptr)dlsym(RTLD_DEFAULT, "func");
    // Version lookup.
    fnptr fn_v1 = (fnptr)dlvsym(RTLD_DEFAULT, "func", "LIB_V1");
    fnptr fn_v2 = (fnptr)dlvsym(RTLD_DEFAULT, "func", "LIB_V2");

    assert(fn_v0 != 0);
    assert(fn_v1 != 0);
    assert(fn_v2 != 0);

    fn_v0();
    fn_v1();
    fn_v2();
#endif

    return 0;
}
</code></pre>
<p>Compiling and running results in:</p>
<pre><code class="language-bash">&gt; g++ -o main main.cc -ldl ./libfoo.so &amp;&amp; ./main
func_v2
func_v0
func_v1
func_v2
</code></pre>
<h2 id="references-8"><a class="header" href="#references-8">References</a></h2>
<ul>
<li><a href="https://akkadia.org/drepper/symbol-versioning">ELF Symbol Versioning</a></li>
<li><a href="https://sourceware.org/binutils/docs/ld/VERSION.html">Binutils ld: Symbol Versioning</a></li>
<li><a href="https://refspecs.linuxbase.org/LSB_5.0.0/LSB-Core-generic/LSB-Core-generic/symversion.html">LSB: Symbol Versioning</a></li>
<li><a href="https://akkadia.org/drepper/dsohowto.pdf">How To Write Shared Libraries</a></li>
<li><a href="https://refspecs.linuxbase.org/elf/elf.pdf">LSB: ELF File Format</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="python"><a class="header" href="#python">python</a></h1>
<h2 id="decorator-run"><a class="header" href="#decorator-run">Decorator [<a href="https://www.online-python.com/IDdiE0gpYU">run</a>]</a></h2>
<p>Some decorator examples with type annotation.</p>
<pre><code class="language-python">from typing import Callable

def log(f: Callable[[int], None]) -&gt; Callable[[int], None]:
    def inner(x: int):
        print(f"log::inner f={f.__name__} x={x}")
        f(x)
    return inner

@log
def some_fn(x: int):
    print(f"some_fn x={x}")


def log_tag(tag: str) -&gt; Callable[[Callable[[int], None]], Callable[[int], None]]:
    def decorator(f: Callable[[int], None]) -&gt; Callable[[int], None]:
        def inner(x: int):
            print(f"log_tag::inner f={f.__name__} tag={tag} x={x}")
            f(x)
        return inner
    return decorator

@log_tag("some_tag")
def some_fn2(x: int):
    print(f"some_fn2 x={x}")
</code></pre>
<h2 id="walrus-operator-run"><a class="header" href="#walrus-operator-run">Walrus operator [<a href="https://www.online-python.com/9T12PvmKVy">run</a>]</a></h2>
<p>Walrus operator <code>:=</code> added since <strong>python 3.8</strong>.</p>
<pre><code class="language-python">from typing import Optional

# Example 1: if let statements

def foo(ret: Optional[int]) -&gt; Optional[int]:
    return ret

if r := foo(None):
    print(f"foo(None) -&gt; {r}")

if r := foo(1337):
    print(f"foo(1337) -&gt; {r}")

# Example 2: while let statements

toks = iter(['a', 'b', 'c'])
while tok := next(toks, None):
    print(f"{tok}")

# Example 3: list comprehension

print([tok for t in ["  a", "  ", " b "] if (tok := t.strip())])
</code></pre>
<h2 id="unittest-run"><a class="header" href="#unittest-run"><a href="https://docs.python.org/3/library/unittest.html">Unittest</a> [<a href="https://www.online-python.com/2fit4UcbzI">run</a>]</a></h2>
<p>Run unittests directly from the command line as <br><code>python3 -m unittest -v test</code></p>
<p>Optionally pass <code>-k &lt;patter&gt;</code> to only run subset of tests.</p>
<pre><code class="language-python"># file: test.py

import unittest

class MyTest(unittest.TestCase):
    def setUp(self):
        pass
    def tearDown(self):
        pass
    # Tests need to start with the prefix 'test'.
    def test_foo(self):
        self.assertEqual(1 + 2, 3)
    def test_bar(self):
        with self.assertRaises(IndexError):
            list()[0]
</code></pre>
<h2 id="doctest-run"><a class="header" href="#doctest-run"><a href="https://docs.python.org/3/library/doctest.html">Doctest</a> [<a href="https://www.online-python.com/LZst51UNIH">run</a>]</a></h2>
<p>Run doctests directly from the command line as <br><code>python -m doctest -v test.py</code></p>
<pre><code class="language-python"># file: test.py

def sum(a: int, b: int) -&gt; int:
    """Sum a and b.

    &gt;&gt;&gt; sum(1, 2)
    3

    &gt;&gt;&gt; sum(10, 20)
    30
    """
    return a + b
</code></pre>
<h2 id="timeit"><a class="header" href="#timeit"><a href="https://docs.python.org/3/library/timeit.html">timeit</a></a></h2>
<p>Micro benchmarking.</p>
<pre><code class="language-bash">python -m timeit '[x.strip() for x in ["a ", " b"]]'
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="gcov1"><a class="header" href="#gcov1">gcov(1)</a></h1>
<p>Generate code coverage reports in text format.</p>
<p>Compile the source files of interest and link the final binary with the
following flags:</p>
<ul>
<li><code>-fprofile-arcs</code> instruments the generated code such that it writes a <code>.gcda</code>
file when being executed with details about which branches are taken</li>
<li><code>-ftest-coverage</code> writes a <code>.gcno</code> notes file which is used by <code>gcov</code> during
generation of the coverage report</li>
</ul>
<p>Depending on the build environment one may also set <code>-fprofile-abs-path</code> to
generate absolute path names into the <code>.gcno</code> note files, this can ease setups
where compilations are done in different directories to the source directory.</p>
<blockquote>
<p><code>gcc</code> / <code>clang</code> also support an alias flag <code>--coverage</code> which during
compilation time is equivalent to <code>-fprofile-arcs -ftest-coverage</code> and during
link time <code>-lgcov</code>.</p>
</blockquote>
<p>After running the instrumented binary, the human readable report can then be
generated for a single file for example such as</p>
<pre><code class="language-shell">gcov &lt;SRC FILE | OBJ FILE&gt;
</code></pre>
<h2 id="example-8"><a class="header" href="#example-8">Example</a></h2>
<pre><code class="language-cpp">#include &lt;cstdio&gt;

void tell_me(int desc) {
  if (desc &amp; 1) {
    std::puts("this");
  } else {
    std::puts("that");
  }
}

int main(int argc, char *argv[]) {
  tell_me(argc);
  tell_me(argc);
  return 0;
}
</code></pre>
<p>The <code>gcov</code> coverage report can be generated as follows for <code>gcc</code> or <code>clang</code>.</p>
<pre><code class="language-make">CXXFLAGS = -fprofile-arcs -ftest-coverage
# or the alias
#CXXFLAGS = --coverage

cov-gcc: clean
	g++ $(CXXFLAGS) -c -o cov.o cov.cc
	g++ $(CXXFLAGS) -o $@ cov.o
	./$@
	gcov --demangled-names cov.cc
	cat cov.cc.gcov
.PHONY: cov-gcc

cov-clang: clean
	clang++ $(CXXFLAGS) -c -o cov.o cov.cc
	clang++ $(CXXFLAGS) -o $@ cov.o
	./$@
	llvm-cov gcov --demangled-names cov.cc
	cat cov.cc.gcov
.PHONY: cov-clang

clean:
	$(RM) *.gcov *.gcno *.gcda *.o cov-*
</code></pre>
<p>The will generate a report similar to the following.</p>
<pre><code class="language-text">cat cov.cc.gcov
        -:    0:Source:cov.cc
        -:    0:Graph:cov.gcno
        -:    0:Data:cov.gcda
        -:    0:Runs:1
        -:    1:// Copyright (C) 2023 johannst
        -:    2:
        -:    3:#include &lt;cstdio&gt;
        -:    4:
        2:    5:void tell_me(int desc) {
        2:    6:  if (desc &amp; 1) {
        2:    7:    std::puts("this");
        -:    8:  } else {
    #####:    9:    std::puts("that");
        -:   10:  }
        2:   11:}
        -:   12:
        1:   13:int main(int argc, char *argv[]) {
        1:   14:  tell_me(argc);
        1:   15:  tell_me(argc);
        1:   16:  return 0;
        -:   17:}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="profile-guided-optimization-pgo"><a class="header" href="#profile-guided-optimization-pgo">Profile guided optimization (pgo)</a></h1>
<p><code>pgo</code> is an optimization technique to optimize a program for its usual
workload.</p>
<p>It is applied in two phases:</p>
<ol>
<li>Collect profiling data (best with representative benchmarks).</li>
<li>Optimize program based on collected profiling data.</li>
</ol>
<p>The following simple program is used as demonstrator.</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;

#define NOINLINE __attribute__((noinline))

NOINLINE void foo() { puts("foo()"); }
NOINLINE void bar() { puts("bar()"); }

int main(int argc, char *argv[]) {
  if (argc == 2) {
    foo();
  } else {
    bar();
  }
}
</code></pre>
<h2 id="clang"><a class="header" href="#clang">clang</a></h2>
<p>On the actual machine with <code>clang 15.0.7</code>, the following code is generated for
the <code>main()</code> function.</p>
<pre><code class="language-x86asm"># clang -o test test.c -O3

0000000000001160 &lt;main&gt;:
    1160:  50                   push   rax
    ; Jump if argc != 2.
    1161:  83 ff 02             cmp    edi,0x2
    1164:  75 09                jne    116f &lt;main+0xf&gt;
    ; foor() is on the hot path (fall-through).
    1166:  e8 d5 ff ff ff       call   1140 &lt;_Z3foov&gt;
    116b:  31 c0                xor    eax,eax
    116d:  59                   pop    rcx
    116e:  c3                   ret
    ; bar() is on the cold path (branch).
    116f:  e8 dc ff ff ff       call   1150 &lt;_Z3barv&gt;
    1174:  31 c0                xor    eax,eax
    1176:  59                   pop    rcx
    1177:  c3                   ret
</code></pre>
<p>The following shows how to compile with profiling instrumentation and how to
optimize the final program with the collected profiling data (<a href="https://clang.llvm.org/docs/UsersManual.html#profile-guided-optimization">llvm
pgo</a>).</p>
<p>The arguments to <code>./test</code> are chosen such that <code>9/10</code> runs call <code>bar()</code>, which
is currently on the <code>cold path</code>.</p>
<pre><code class="language-bash"># Compile test program with profiling instrumentation.
clang -o test test.cc -O3 -fprofile-instr-generate

# Collect profiling data from multiple runs.
for i in {0..10}; do
    LLVM_PROFILE_FILE="prof.clang/%p.profraw" ./test $(seq 0 $i)
done

# Merge raw profiling data into single profile data.
llvm-profdata merge -o pgo.profdata prof.clang/*.profraw

# Optimize test program with profiling data.
clang -o test test.cc -O3 -fprofile-use=pgo.profdata
</code></pre>
<blockquote>
<p>NOTE: If <code>LLVM_PROFILE_FILE</code> is not given the profile data is written to
<code>default.profraw</code> which is re-written on each run. If the <code>LLVM_PROFILE_FILE</code>
contains a <code>%m</code> in the filename, a unique integer will be generated and
consecutive runs will update the same generated profraw file,
<code>LLVM_PROFILE_FILE</code> can specify a new file every time, however that requires
more storage in general.</p>
</blockquote>
<p>After optimizing the program with the profiling data, the <code>main()</code> function
looks as follows.</p>
<pre><code class="language-x86asm">0000000000001060 &lt;main&gt;:
    1060:  50                    push   rax
    ; Jump if argc == 2.
    1061:  83 ff 02              cmp    edi,0x2
    1064:  74 09                 je     106f &lt;main+0xf&gt;
    ; bar() is on the hot path (fall-through).
    1066:  e8 e5 ff ff ff        call   1050 &lt;_Z3barv&gt;
    106b:  31 c0                 xor    eax,eax
    106d:  59                    pop    rcx
    106e:  c3                    ret
    ; foo() is on the cold path (branch).
    106f:  e8 cc ff ff ff        call   1040 &lt;_Z3foov&gt;
    1074:  31 c0                 xor    eax,eax
    1076:  59                    pop    rcx
    1077:  c3                    ret
</code></pre>
<h2 id="gcc"><a class="header" href="#gcc">gcc</a></h2>
<p>With <code>gcc 13.2.1</code> on the current machine, the optimizer puts <code>bar()</code> on the
<code>hot path</code> by default.</p>
<pre><code class="language-x86asm">0000000000001040 &lt;main&gt;:
    1040:  48 83 ec 08          sub    rsp,0x8
    ; Jump if argc == 2.
    1044:  83 ff 02             cmp    edi,0x2
    1047:  74 0c                je     1055 &lt;main+0x15&gt;
    ; bar () is on the hot path (fall-through).
    1049:  e8 22 01 00 00       call   1170 &lt;_Z3barv&gt;
    104e:  31 c0                xor    eax,eax
    1050:  48 83 c4 08          add    rsp,0x8
    1054:  c3                   ret
    ; foo() is on the cold path (branch).
    1055:  e8 06 01 00 00       call   1160 &lt;_Z3foov&gt;
    105a:  eb f2                jmp    104e &lt;main+0xe&gt;
    105c:  0f 1f 40 00          nop    DWORD PTR [rax+0x0]

</code></pre>
<p>The following shows how to compile with profiling instrumentation and how to
optimize the final program with the collected profiling data.</p>
<p>The arguments to <code>./test</code> are chosen such that <code>2/3</code> runs call <code>foo()</code>, which
is currently on the <code>cold path</code>.</p>
<pre><code class="language-bash">gcc -o test test.cc -O3 -fprofile-generate
./test 1
./test 1
./test 2 2
gcc -o test test.cc -O3 -fprofile-use
</code></pre>
<blockquote>
<p>NOTE: Consecutive runs update the generated <code>test.gcda</code> profile data file
rather than re-write it.</p>
</blockquote>
<p>After optimizing the program with the profiling data, the <code>main()</code> function</p>
<pre><code class="language-x86asm">0000000000001040 &lt;main.cold&gt;:
    ; bar() is on the cold path (branch).
    1040:  e8 05 00 00 00       call   104a &lt;_Z3barv&gt;
    1045:  e9 25 00 00 00       jmp    106f &lt;main+0xf&gt;

0000000000001060 &lt;main&gt;:
    1060:  51                   push   rcx
    ; Jump if argc != 2.
    1061:  83 ff 02             cmp    edi,0x2
    1064:  0f 85 d6 ff ff ff    jne    1040 &lt;main.cold&gt;
    ; for() is on the hot path (fall-through).
    106a:  e8 11 01 00 00       call   1180 &lt;_Z3foov&gt;
    106f:  31 c0                xor    eax,eax
    1071:  5a                   pop    rdx
    1072:  c3                   ret
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="linux"><a class="header" href="#linux">Linux</a></h1>
<ul>
<li><a href="#systemd">systemd</a></li>
<li><a href="#core5">coredump</a></li>
<li><a href="#ptrace_scope">ptrace_scope</a></li>
<li><a href="#cryptsetup8">cryptsetup</a></li>
<li><a href="#swap">swap</a></li>
<li><a href="#linux-input">input</a></li>
<li><a href="#access-control-list-acl">acl</a></li>
<li><a href="#zfs">zfs</a></li>
<li><a href="#cpufreq">cpufreq</a></li>
<li><a href="#cups1">cups</a></li>
<li><a href="#namespaces7">namespaces</a></li>
<li><a href="#mount8">mount</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="systemd"><a class="header" href="#systemd">systemd</a></h1>
<h2 id="systemctl"><a class="header" href="#systemctl">systemctl</a></h2>
<p>Inspect units:</p>
<pre><code class="language-text">systemctl [opts] [cmd]
[opts]
    --user
    --type=TYPE             List only given types eg, service, timer, socket (use --type=help for a list)
    --state=STATE           List only given states eg running, enabled (use --state=help for a list)
    --failed                List only failed services

[cmd]
    list-units &lt;pattern&gt;    List units in memory

    status &lt;unit&gt;           Show runtime status of unit

    start &lt;unit&gt;            Start a unit
    stop &lt;unit&gt;             Stop a unit
    restart &lt;unit&gt;          Restart a unit
    reload &lt;unit&gt;           Reload a unit

    enable &lt;unit&gt;           Enable a unit (persistent)
    disable &lt;unit&gt;          Disable a unit

    cat &lt;unit&gt;      Print unit file
    show &lt;unit&gt;     Show properties of unit
</code></pre>
<h3 id="example-list-failed-units"><a class="header" href="#example-list-failed-units">Example: List failed units</a></h3>
<pre><code class="language-bash"># List all system failed units.
systemctl --failed

# List all user failed units.
systemctl --user --failed
</code></pre>
<h3 id="example-trivial-user-unit"><a class="header" href="#example-trivial-user-unit">Example: Trivial user unit</a></h3>
<pre><code class="language-bash"># Generate unit
mkdir -p ~/.config/systemd/user
echo '[Unit]
Description=Test logger

[Service]
Type=oneshot
ExecStart=logger "Hello from test unit"' &gt; ~/.config/systemd/user/test.service

# Run unit
systemctl --user start test

# See log message
journalctl --user -u test -n 5
</code></pre>
<h2 id="journalctl"><a class="header" href="#journalctl">journalctl</a></h2>
<p>Inspect journal logs:</p>
<pre><code class="language-text">journalctl [opts] [matches]
    --user          Current user journal (system by default)
    -u &lt;unit&gt;       Show logs for specified &lt;unit&gt;
    -n &lt;lines&gt;      Show only last &lt;lines&gt;
    -f              Follow journal
    -g &lt;pattern&gt;    Grep for &lt;pattern&gt;
</code></pre>
<p>Cleanup:</p>
<pre><code class="language-text">journalctl [opts]
    --disk-usage            Show current disk usage
    --vacuum-size=&lt;size&gt;    Reduce journal log to &lt;size&gt; (K/M/G)
</code></pre>
<h2 id="references-9"><a class="header" href="#references-9">References</a></h2>
<ul>
<li><a href="https://www.man7.org/linux/man-pages/man5/systemd.unit.5.html">man systemd.unit(5)</a></li>
<li><a href="https://www.man7.org/linux/man-pages/man5/systemd.service.5.html">man systemd.service(5)</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="core5"><a class="header" href="#core5">core(5)</a></h1>
<p>There are multiple requirements that must be satisfied that <code>coredumps</code> are
being generated, a full list can be found in <a href="https://man7.org/linux/man-pages/man5/core.5.html">core(5)</a>.</p>
<p>An important one is to configure the soft resource limit <code>RLMIT_CORE</code>
(typically as unlimited during debugging).
In a typical bash/zsh this can be done as</p>
<pre><code class="language-bash">ulimit -Sc unlimited
</code></pre>
<h2 id="naming-of-coredump-files"><a class="header" href="#naming-of-coredump-files">Naming of coredump files</a></h2>
<p>There are two important kernel configs to control the naming:</p>
<pre><code class="language-config">/proc/sys/kernel/core_pattern
    &lt;pattern&gt;    =&gt; Specifies a name pattern for the coredump file. This can
                    include certain FORMAT specifier.
    |&lt;cmdline&gt;   =&gt; Coredump is pipe through stdin to the user space process
                    specified by the cmdline, this can also contain FORMAT specifier.

  FORMAT specifier (full list, see core(5)):
    %E      Pathname of the executable ('/' replaced by '!').
    %p      PID of the dumping process in its pid namespace.
    %P      PID of the dumping process in the initial pid namespace.
    %u      Real UID of dumping process.
    %s      Signal number causing the dump.


/proc/sys/kernel/core_uses_pid
    1  =&gt; Append ".&lt;pid&gt;" suffic to the coredump file name
          (pid of the dumping process).
    0  =&gt; Do not append the suffix.
</code></pre>
<h2 id="control-which-segments-are-dumped"><a class="header" href="#control-which-segments-are-dumped">Control which segments are dumped</a></h2>
<p>Each process has a coredump filter defined in <code>/proc/&lt;pid&gt;/coredump_filter</code>
which specifies which memory segments are being dumped.
Filters are preseved across <code>fork/exec</code> calls and hence child processes inherit
the parents filters.</p>
<p>The filter is a bitmask where <code>1</code> indicates to dump the given type.</p>
<pre><code>From core(5):
  bit 0  Dump anonymous private mappings.
  bit 1  Dump anonymous shared mappings.
  bit 2  Dump file-backed private mappings.
  bit 3  Dump file-backed shared mappings.
  bit 4  Dump ELF headers.
  bit 5  Dump private huge pages.
  bit 6  Dump shared huge pages.
  bit 7  Dump private DAX pages.
  bit 8  Dump shared DAX pages.

Default filter 0x33.
</code></pre>
<h1 id="some-examples-out-there"><a class="header" href="#some-examples-out-there">Some examples out there</a></h1>
<h2 id="coredumpctl-systemd"><a class="header" href="#coredumpctl-systemd">coredumpctl (systemd)</a></h2>
<pre><code class="language-bash"># List available coredumps.
coredumpctl list
    TIME                             PID  UID  GID SIG     COREFILE EXE               SIZE
    ...
    Fri 2022-03-11 12:10:48 CET     6363 1000 1000 SIGSEGV present  /usr/bin/sleep   18.1K

# Get detailed info on specific coredump.
coredumpctl info 6363

# Debug specific coredump.
coredumpctl debug 6363

# Dump specific coredump to file.
coredumpctl dump 6363 -o &lt;file&gt;
</code></pre>
<h2 id="apport-ubuntu"><a class="header" href="#apport-ubuntu">apport (ubuntu)</a></h2>
<p>Known crash report locations:</p>
<ul>
<li><code>/var/crash</code></li>
</ul>
<p>To get to the raw coredump, crash reports can be unpacked as:</p>
<pre><code class="language-bash">apport-unpack &lt;crash_repot&gt; &lt;dest_dir&gt;
</code></pre>
<p>The coredump resides under <code>&lt;dest_dir&gt;/CoreDump</code>.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ptrace_scope"><a class="header" href="#ptrace_scope">ptrace_scope</a></h1>
<p>In case the kernel was compiled with the <code>yama</code> security module
(<code>CONFIG_SECURITY_YAMA</code>), tracing processes with <code>ptrace(2)</code> can be restricted.</p>
<pre><code class="language-config">/proc/sys/kernel/yama/ptrace_scope
    0 =&gt; No restrictions.
    1 =&gt; Restricted attach, only the following can attach
            - A process in the parent hierarchy.
            - A process with CAP_SYS_PTRACE.
            - A process with the PID that the tracee allowed by via
              PR_SET_PTRACER.
    2 =&gt; Only processes with CAP_SYS_PTRACE in the user namespace of the tracee
         can attach.
    3 =&gt; No tracing allowed.
</code></pre>
<p>Further details in <a href="https://man7.org/linux/man-pages/man2/ptrace.2.html"><code>ptrace(2)</code></a>.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="cryptsetup8"><a class="header" href="#cryptsetup8"><a href="https://www.man7.org/linux/man-pages/man8/cryptsetup.8.html">cryptsetup(8)</a></a></h1>
<pre><code class="language-text">cryptsetup &lt;action&gt; [opts] &lt;action args&gt;

action:
    open &lt;dev&gt; &lt;name&gt; --type &lt;type&gt;    Open (decrypt) &lt;dev&gt; and map with &lt;name&gt;.
                                       Mapped as /dev/mapper/&lt;name&gt;.
                                       Type: {luks,plain,tcrypt,bitlk}
    close &lt;name&gt;                       Close existing mapping &lt;name&gt;.
    status &lt;name&gt;                      Print status for mapping &lt;name&gt;.

    luksFormat &lt;dev&gt;                   Create new LUKS partition and set initial passphrase.
                                       (Keyslot 0)
    luksAddKey &lt;dev&gt;                   Add a new passphrase.
    luksRemoveKey &lt;dev&gt;                Remove existing passphrase.
    luksChangeKey &lt;dev&gt;                Change existing passphrase.
    lusDump &lt;dev&gt;                      Dump LUKS header for device.
</code></pre>
<h2 id="example-create-luks-encrypted-disk"><a class="header" href="#example-create-luks-encrypted-disk">Example: Create <code>LUKS</code> encrypted disk.</a></h2>
<p>For this example we use a file as backing storage and set it up as
<a href="https://man7.org/linux/man-pages/man4/loop.4.html">loop(4)</a> device. The loop device can be replaced by any block
device file.</p>
<blockquote>
<p>Optional: Overwrite existing data on disk.<br><code>sudo dd if=/dev/urandom of=/dev/sdX bs=1M</code></p>
</blockquote>
<p>First create the backing file and setup the loop device.</p>
<pre><code class="language-sh"># Create 100MB file.
dd if=/dev/zero of=blkfile bs=1M count=100

# Attach file to first free (-f) loop device
sudo losetup -f ./blkfile
# List loop devices.
sudo losetup -l
# NAME       SIZELIMIT OFFSET AUTOCLEAR RO BACK-FILE              DIO LOG-SEC
# /dev/loop0         0      0         0  0 /home/johannst/blkfile   0     512
</code></pre>
<p>Create a new LUKS partition and format new filesystem.</p>
<pre><code class="language-sh"># Initialize LUKS partition and set initial passphrase.
sudo cryptsetup luksFormat /dev/loop0

file blkfile
# blkfile: LUKS encrypted file, ver 2 [, , sha256] UUID: 8...

# Open (decrypt) the LUKS device, it will be mapped under /dev/mapper/loop0.
sudo cryptsetup open --type luks /dev/loop0 loop0

# Format partition with new filesystem.
sudo mkfs.vfat /dev/mapper/loop0

lsblk -f
# NAME        FSTYPE    FSVER LABEL  UUID  FSAVAIL FSUSE% MOUNTPOINTS
# loop0       crypto_LU 2            8...
# └─loop0     vfat      FAT16        D...    83.8M     0% /home/johannst/mnt

# Close (re-encrypt) LUKS device.
sudo cryptsetup close loop0
</code></pre>
<h2 id="example-using-an-existing-luks-device"><a class="header" href="#example-using-an-existing-luks-device">Example: Using an existing LUKS device.</a></h2>
<pre><code class="language-sh"># Open (decrypt) the LUKS device, it will be mapped under /dev/mapper/loop0.
sudo cryptsetup open --type luks /dev/loop0 loop0

# Mount filesystem.
sudo mount /dev/mapper/loop0 &lt;mntpoint&gt;

# Use disk ...

# Unmount filesystem.
sudo umount &lt;mntpoint&gt;

# Close (re-encrypt) LUKS device.
sudo cryptsetup close loop0
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="swap"><a class="header" href="#swap">swap</a></h1>
<h2 id="list-active-swap-areas"><a class="header" href="#list-active-swap-areas">List active swap areas</a></h2>
<pre><code class="language-sh"># procfs
cat /proc/swaps

# cli tool
swapon --show
</code></pre>
<h2 id="manual-swapfile-setup"><a class="header" href="#manual-swapfile-setup">Manual swapfile setup</a></h2>
<pre><code class="language-sh"># One time:
#   Create and initialize swapfile.
#   mkswap will initialize swap area over full filesize by default.
sudo dd if=/dev/zero of=/swapfile bs=1G count=1
mkswap /swapfile

# Enable swap file (until next reboot).
swapon /swapfile

# Persistent setup of swap file.
echo "/swapfile none swap sw 0 0" | sudo tee -a /etc/fstab

# Disable swap file (until next reboot).
swapoff /swapfile
</code></pre>
<blockquote>
<p>Recommended file permissions <code>0600</code> and file owner <code>uid=0 (root)</code>.</p>
</blockquote>
<h2 id="using-dphys-swapfile-service"><a class="header" href="#using-dphys-swapfile-service">Using <code>dphys-swapfile</code> service.</a></h2>
<p>Dynamically computes size of swap file based on installed RAM.</p>
<pre><code class="language-sh"># Setup and enable swap based on /etc/dphys-swapfile.
dphys-swapfile setup
dphys-swapfile swapon

# Disable swap on configured file.
dphys-swapfile swapoff
</code></pre>
<blockquote>
<p>Usually comes with a script to be automatically run at system startup and shutdown.
For example as <code>systemd</code> service:</p>
<pre><code>systemctl status dphys-swapfile
</code></pre>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="linux-input"><a class="header" href="#linux-input">Linux input</a></h1>
<p>Some notes on using <code>/dev/input/*</code> device driver files.</p>
<h2 id="mousex--mice"><a class="header" href="#mousex--mice">mouseX / mice</a></h2>
<p>These device files are created by the <a href="https://elixir.bootlin.com/linux/latest/source/drivers/input/mousedev.c#L842">mousedev</a> driver.</p>
<ul>
<li><code>/dev/input/mouseX</code> represents the input stream for a <em>SINGLE</em> mouse device.</li>
<li><code>/dev/input/mice</code> represents the merged input stream for <em>ALL</em> mouse devices.</li>
</ul>
<p>The data stream consists of <code>3 bytes</code> per <code>event</code>. An event is encoded as <code>(BTN, X, Y)</code>.</p>
<ul>
<li><code>BTN</code> button pressed</li>
<li><code>X</code> movement in x-direction <code>-1 -&gt; left</code> and <code>1 -&gt; right</code></li>
<li><code>Y</code> movement in y-direction <code>-1 -&gt; down</code> and <code>1 -&gt; up</code></li>
</ul>
<p>The raw data stream can be inspected as follows.</p>
<pre><code class="language-bash">sudo cat /dev/input/mice | od -tx1 -w3 -v
</code></pre>
<h2 id="eventx"><a class="header" href="#eventx">eventX</a></h2>
<p>These device files are created by the <a href="https://elixir.bootlin.com/linux/latest/source/drivers/input/evdev.c#L1337">evdev</a> driver.</p>
<ul>
<li><code>/dev/input/eventX</code> represents the generic input event interface a <em>SINGLE</em> input device.</li>
</ul>
<p>Input events are encoded as given by the <code>input_event</code> struct below. Reading
from the <code>eventX</code> device file will always yield whole number of input events.</p>
<pre><code class="language-c">struct input_event {
    struct timeval time;
    unsigned short type;
    unsigned short code;
    unsigned int value;
};
</code></pre>
<p>On most 64bit machines the raw data stream can be inspected as follows.</p>
<pre><code class="language-bash">sudo cat /dev/input/event4 | od -tx1 -w24 -v
</code></pre>
<h2 id="identifying-device-files"><a class="header" href="#identifying-device-files">Identifying device files.</a></h2>
<p>To find out which device file is assigned to which input device the following
file <code>/proc/bus/input/devices</code> in the proc filesystem can be consulted.</p>
<p>This yields entries as follows and shows which <code>Handlers</code> are assigned to which
<code>Name</code>.</p>
<pre><code>I: Bus=0018 Vendor=04f3 Product=0033 Version=0000
N: Name="Elan Touchpad"
...
H: Handlers=event15 mouse0
...
</code></pre>
<h2 id="example-toying-with-devinputeventx"><a class="header" href="#example-toying-with-devinputeventx">Example: Toying with <code>/dev/input/eventX</code></a></h2>
<p>Once compiled, the example should be run as <code>sudo ./event /dev/input/eventX</code>.</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;assert.h&gt;
#include &lt;unistd.h&gt;
#include &lt;time.h&gt;

#include &lt;sys/time.h&gt;
#include &lt;linux/input-event-codes.h&gt;

struct input_event {
    struct timeval time;
    unsigned short type;
    unsigned short code;
    unsigned int value;
};

const char* type(unsigned short t) {
    static char buf[32];
    const char* fmt = "0x%x";
    switch (t) {
#define FMT(TYPE) case TYPE: fmt = #TYPE"(0x%x)"; break
        FMT(EV_SYN);
        FMT(EV_KEY);
        FMT(EV_REL);
        FMT(EV_ABS);
#undef FMT
    }
    snprintf(buf, sizeof(buf), fmt, t);
    return buf;
}

const char* code(unsigned short c) {
    static char buf[32];
    const char* fmt = "0x%x";
    switch (c) {
#define FMT(CODE) case CODE: fmt = #CODE"(0x%x)"; break
        FMT(BTN_LEFT);
        FMT(BTN_RIGHT);
        FMT(BTN_MIDDLE);
        FMT(REL_X);
        FMT(REL_Y);
#undef FMT
    }
    snprintf(buf, sizeof(buf), fmt, c);
    return buf;
}

const char* timefmt(const struct timeval* t) {
    assert(t);
    struct tm* lt = localtime(&amp;t-&gt;tv_sec); // Returns pointer to static tm object.
    static char buf[64];
    strftime(buf, sizeof(buf), "%H:%M:%S", lt);
    return buf;
}

int main(int argc, char* argv[]) {
    assert(argc == 2);

    int fd = open(argv[1], O_RDONLY);
    assert(fd != -1);

    struct input_event inp;
    while (1) {
        int ret = read(fd, &amp;inp, sizeof(inp));
        assert(ret == sizeof(inp));
        printf("time: %s type: %s code: %s value: 0x%x\n",
               timefmt(&amp;inp.time), type(inp.type), code(inp.code), inp.value);
    }
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="access-control-list-acl"><a class="header" href="#access-control-list-acl">access control list (acl)</a></h1>
<blockquote>
<p>This describes <code>POSIX</code> acl.</p>
</blockquote>
<p>The access control list provides a flexibel permission mechanism next to the
<code>UNIX</code> file permissions. This allows to specify fine grained permissions for
users/groups on filesystems.</p>
<p>Filesystems which support acl typically have an <code>acl</code> option, which must be
specified while mounting when it is not a default option.
Filesystems must be mounted with the <code>acl</code> option if not enabled as default
option.</p>
<p>Files or folder that have an <code>acl</code> defined, can be identified by the <code>+</code> sign
next to the UNIX permissions.</p>
<p>The following shows on example for a zfs filesystem.</p>
<pre><code class="language-bash"># mount | grep tank
tank on /tank type zfs (rw,xattr,noacl)
tank/foo on /tank/foo type zfs (rw,xattr,posixacl)

# ls -h /tank
drwxrwxr-x+ 2 root root 4 11. Jun 14:26 foo/
</code></pre>
<h2 id="show-acl-entries"><a class="header" href="#show-acl-entries">Show acl entries</a></h2>
<pre><code class="language-bash"># List current acl entries.
getfacl /tank/foo
</code></pre>
<h2 id="modify-acl-entries"><a class="header" href="#modify-acl-entries">Modify acl entries</a></h2>
<pre><code class="language-bash"># Add acl entry for user "user123".
setfacl -m "u:user123:rwx" /tank/foo

# Remove entry for user "user123".
setfacl -x "u:user123" /tank/foo

# Add acl entry for group "group456".
setfacl -m "g:group456:rx" /tank/foo

# Add acl entry for others.
setfacl -m "o:rx" /tank/foo

# Remove extended acl entries.
setfacl -b /tank/foo
</code></pre>
<h2 id="masking-of-acl-entries"><a class="header" href="#masking-of-acl-entries">Masking of acl entries</a></h2>
<p>The <code>mask</code> defines the maximum access rights that can be given to <strong>users</strong> and
<strong>groups</strong>.</p>
<pre><code class="language-bash"># Update the mask.
setfacl -m "m:rx" /tank/foo

# List acl entries.
getfacl /tank/foo
# file: tank/foo
# owner: root
# group: root
user::rwx
user:user123:rwx     # effective:r-x
group::r-x
mask::r-x
other::rwx
</code></pre>
<h2 id="references-10"><a class="header" href="#references-10">References</a></h2>
<ul>
<li><a href="https://www.man7.org/linux/man-pages/man5/acl.5.html">acl(5)</a></li>
<li><a href="https://www.man7.org/linux/man-pages/man1/getfacl.1.html">getfacl(1)</a></li>
<li><a href="https://www.man7.org/linux/man-pages/man1/setfacl.1.html">setfacl(1)</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="zfs"><a class="header" href="#zfs">zfs</a></h1>
<p>Pools are managed with the <a href="https://openzfs.github.io/openzfs-docs/man/8/zpool.8.html"><code>zpool(8)</code></a> command and have the
following hierarchy:</p>
<ul>
<li><code>pool</code>: consists of one or more virtual devices (<code>vdev</code>)</li>
<li><code>vdev</code>: consists of one or more physical devices (<code>dev</code>) and come in
different kinds such as <a href="https://openzfs.github.io/openzfs-docs/man/7/zpoolconcepts.7.html#Virtual_Devices_(vdevs)"><code>disk</code>, <code>mirror</code>, <code>raidzX</code>, …</a>
<ul>
<li><code>disk</code>: single physical disk (<code>vdev == dev</code>)</li>
<li><code>mirror</code>: data is identically replicated on all <code>devs</code> (requires at least 2
physical devices).</li>
</ul>
</li>
</ul>
<p>Data stored in a pool is distributed and stored across all <code>vdevs</code> by zfs.
Therefore a total failure of a single <code>vdev</code> can lead to total loss of a pool.</p>
<p>A <code>dataset</code> is a logical volume which can be created on top of a <code>pool</code>. Each
<code>dataset</code> can be configured with its own set of <code>properties</code> like
<a href="https://openzfs.github.io/openzfs-docs/man/7/zfsprops.7.html"><code>encryption</code>, <code>quota</code>, …</a>.
Datasets are managed with the <a href="https://openzfs.github.io/openzfs-docs/man/8/zfs.8.html"><code>zfs(8)</code></a> command.</p>
<h2 id="zfs-pool-management"><a class="header" href="#zfs-pool-management">zfs pool management</a></h2>
<p>Pools are by default mounted at <code>/&lt;POOL&gt;</code>.</p>
<h3 id="create-modify-and-destroy-zfs-pools"><a class="header" href="#create-modify-and-destroy-zfs-pools">Create, modify and destroy zfs pools</a></h3>
<pre><code class="language-bash"># Create a pool MOOSE with a two mirror vdevs.
zpool create moose mirror &lt;dev1&gt; &lt;dev2&gt; mirror &lt;dev3&gt; &lt;dev4&gt;..

# Add new raidz1 vdev to a pool.
zpool add moose raidz1 &lt;devA&gt; &lt;devB&gt; &lt;devC&gt;..

# Remove a vdev from a pool.
zpool remove moose &lt;vdevX&gt;

# Destroy a pool.
zpool destroy moose
</code></pre>
<blockquote>
<p>For stable device names in small home setups it is recommended to use names
from <a href="https://openzfs.github.io/openzfs-docs/Project%20and%20Community/FAQ.html#selecting-dev-names-when-creating-a-pool-linux"><code>/dev/disk/by-id</code></a>.</p>
</blockquote>
<h3 id="inspect-zfs-pools"><a class="header" href="#inspect-zfs-pools">Inspect zfs pools</a></h3>
<pre><code class="language-bash"># Show status of all pools or a single one.
zpool status [&lt;pool&gt;]

# Show information / statistics about pools or single one.
zpool list [&lt;pool&gt;]

# Show statistics for all devices.
zpool list -v

# Show command history for pools.
zpool history
</code></pre>
<h3 id="modify-vdevs"><a class="header" href="#modify-vdevs">Modify <code>vdevs</code></a></h3>
<pre><code class="language-bash"># vdev MIRROR-0 with two devs.
zpool status
    NAME            STATE     READ WRITE CKSUM
    moose           ONLINE       0     0     0
      mirror-0      ONLINE       0     0     0
        virtio-200  ONLINE       0     0     0
        virtio-300  ONLINE       0     0     0

# Attach new device to an existing vdev.
zpool attach moose virtio-200 virtio-400

# vdev MIRROR-0 with three devs.
zpool status
    NAME            STATE     READ WRITE CKSUM
    moose           ONLINE       0     0     0
      mirror-0      ONLINE       0     0     0
        virtio-200  ONLINE       0     0     0
        virtio-300  ONLINE       0     0     0
        virtio-400  ONLINE       0     0     0

# Detach device from vdev.
zpool detach moose virtio-200
</code></pre>
<h3 id="replace-faulty-disk"><a class="header" href="#replace-faulty-disk">Replace faulty disk</a></h3>
<pre><code class="language-bash"># MIRROR-0 is degraded as one disk failed, but still intact.
zpool status
    NAME            STATE     READ WRITE CKSUM
    moose           DEGRADED     0     0     0
      mirror-0      DEGRADED     0     0     0
        virtio-200  UNAVAIL      0     0     0  invalid label
        virtio-300  ONLINE       0     0     0

# Replace faulty disk, in mirror.
# No data is lost since mirror still has one good disk.
zpool replace moose virtio-200 virtio-400

# MIRROR-0 back in ONLINE (good) state.
zpool status
    NAME            STATE     READ WRITE CKSUM
    moose           ONLINE       0     0     0
      mirror-0      ONLINE       0     0     0
        virtio-400  ONLINE       0     0     0
        virtio-300  ONLINE       0     0     0
</code></pre>
<h3 id="import-or-export-zfs-pools"><a class="header" href="#import-or-export-zfs-pools">Import or export zfs pools</a></h3>
<p>When moving pools between hosts, the pool must be <code>exported</code> on the currently
active host and <code>imported</code> on the new host.</p>
<pre><code class="language-bash"># Export a pool called MOOSE.
zpool export moose
# If datasets are busy, use lsof to check which processes keep it busy.
#   lsof &lt;mntpoint&gt;

# List pools that can be imported using BY-ID deivce names (for example).
zpool import -d /dev/disk/by-id

# Import pool MOOSE using BY-ID device names (for example).
zpool import -d /dev/disk/by-id moose
</code></pre>
<blockquote>
<p>Device names used by an existing pool can be changed by <a href="https://openzfs.github.io/openzfs-docs/Project%20and%20Community/FAQ.html#changing-dev-names-on-an-existing-pool">exporting and
importing</a> a pool again.</p>
</blockquote>
<h2 id="zfs-dataset-management"><a class="header" href="#zfs-dataset-management">zfs dataset management</a></h2>
<p>Datasets are by default mounted at <code>/&lt;POOL&gt;/&lt;DATASET&gt;</code>.</p>
<h3 id="create-and-destroy-zfs-datasets"><a class="header" href="#create-and-destroy-zfs-datasets">Create and destroy zfs datasets</a></h3>
<pre><code class="language-bash"># Create dataset FOO on pool MOOSE.
zfs create moose/foo

# Destroy dataset.
zfs destroy moose/foo
</code></pre>
<h3 id="list-all-zfs-datasets"><a class="header" href="#list-all-zfs-datasets">List all zfs datasets</a></h3>
<pre><code class="language-bash"># List all zfs datasets.
zfs list
</code></pre>
<h3 id="mount-zfs-datasets"><a class="header" href="#mount-zfs-datasets">Mount zfs datasets</a></h3>
<pre><code class="language-bash"># List currently mounted datasets.
zfs mount

# Mount dataset.
zfs mount moose/foo

# Unmount dataset.
zfs unmount moose/foo
</code></pre>
<h3 id="encrypted-datasets"><a class="header" href="#encrypted-datasets">Encrypted datasets</a></h3>
<p>Encryption is a readonly property, can only be set when creating a dataset.</p>
<pre><code class="language-bash"># Create encrypted dataset FOO on pool MOOSE.
zfs create -o encryption=on -o keyformat=passphrase moose/foo

# Mount encrypte dataset and load encryption key (if not loaded).
zfs mount -l moose/foo
# -l is equivalent to first loading the key via zfs load-key moose/foo.

# Unmount dataset and unload encryption key (unload is optional).
zfs umount -u moose/foo
</code></pre>
<h3 id="manage-zfs-encryption-keys"><a class="header" href="#manage-zfs-encryption-keys">Manage zfs encryption keys</a></h3>
<pre><code class="language-bash"># Preload encryption key for dataset.
zfs load-key moose/foo

# Preload encryption key for all datasets.
zfs load-key -a

# Change encryption key for dataset.
zfs change-key moose/foo

# Unload encryption key for dataset.
zfs unload-key moose/foo
</code></pre>
<h3 id="manage-dataset-properties"><a class="header" href="#manage-dataset-properties">Manage dataset properties</a></h3>
<pre><code class="language-bash"># Get all properties for dataset.
zfs get quota moose/foo

# Get single property for dataset.
zfs get all moose/foo

# Get single property for all datasets.
zfs get quota

# Set property on dataset.
zfs set quota=10G moose/foo
</code></pre>
<h3 id="snapshots"><a class="header" href="#snapshots">Snapshots</a></h3>
<pre><code class="language-bash"># Create snapshot called V2 for dataset moose/foo.
zfs snapshot moose/foo@v2

# List all snapshots.
zfs list -t snapshot

# Make .zfs direcotry visible in the root of the dataset.
zfs set snapdir=visible moose/foo

# Browse available snapshots in visible .zfs direcotry (readonly).
ls /moose/foo/.zfs/snapshot
v1/  v2/

# Create a new dataset based on the V1 snapshot
zfs clone moose/foo@v1 moose/foov1

# Destroy snapshot.
zfs destroy moose/foo@v1
</code></pre>
<h3 id="access-control-list"><a class="header" href="#access-control-list">Access control list</a></h3>
<p>Focus on <a href="#access-control-list-acl">posix acl</a>.</p>
<pre><code class="language-bash"># Set the ACL type for the FOO dataset to POSIXACL.
zfs set acltype=posixacl moose/foo

# Get the ACL type of a given dataset.
zfs get acltype moose/foo
</code></pre>
<blockquote>
<p>For performance reasons it is recommended to also set <code>zfs set xattr=sa moose/foo</code> [<a href="https://github.com/openzfs/zfs/issues/170#issuecomment-27348094">ref</a>].</p>
</blockquote>
<h2 id="example-zfs-pool-import-during-startup-systemd"><a class="header" href="#example-zfs-pool-import-during-startup-systemd">Example: zfs pool import during startup (<code>systemd</code>)</a></h2>
<p>The default zpool cache file is <code>/etc/zfs/zpool.cache</code>. When pools are imported
the cache is updated.</p>
<p>Enable the following targets / services to automatically import pools from the
cache.</p>
<pre><code class="language-bash">systemctl list-dependencies
  ...
    └─zfs.target
      └─zfs-import.target
        └─zfs-import-cache.service
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="cpufreq"><a class="header" href="#cpufreq">cpufreq</a></h1>
<p>The <code>sysfs</code> interface to cpu frequency settings and current state.</p>
<pre><code>/sys/devices/system/cpu/cpu*/cpufreq/
</code></pre>
<h2 id="cpupower1"><a class="header" href="#cpupower1">cpupower(1)</a></h2>
<p>A CLI interface to peek and poke the cpu frequency settings.</p>
<pre><code># Show current frequency of all cores.
cpupower -c all frequency-info -f -m

# Show currently set frequency governor.
cpupower -c all frequency-info -p

# List available frequency governors.
cpupower -c all frequency-info -g

# Change frequency governor to POWERSAVE (eg).
cpupower -c all frequency-set -g powersave
</code></pre>
<h2 id="example-9"><a class="header" href="#example-9">Example</a></h2>
<p>Watch cpu frequency.</p>
<pre><code class="language-sh">watch -n1 "cpupower -c all frequency-info -f -m | xargs -n2 -d'\n'"
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="cups1"><a class="header" href="#cups1">cups(1)</a></h1>
<h2 id="discover"><a class="header" href="#discover">Discover</a></h2>
<pre><code class="language-sh"># List available printer driver.
lpinfo -m

# List available printer devices (connected + network).
lpinfo -v
</code></pre>
<h2 id="install-printer"><a class="header" href="#install-printer">Install printer</a></h2>
<pre><code class="language-sh"># Add device with PRINTER name, practically all modern network printer use the
# everywhere driver.
lpadmin -p PRINTER -m everywhere -v DEVICE_URI

# Delete named printer.
lpadmin -x PRINTER
</code></pre>
<h2 id="printer--printing-options"><a class="header" href="#printer--printing-options">Printer &amp; Printing options</a></h2>
<pre><code class="language-sh"># List printer options.
# CHECK printer-make-and-model
lpoptions -p PRINTER
# List printing options.
lpoptions -p PRINTER -l
# Set an options, eg duplex mode.
lpoptions -p PRINTER -o 'Duplex=DuplexNoTumble

# Set the default printer (stored in ~/.cups/lpoptions).
lpoptions -d PRINTER
</code></pre>
<h2 id="inspect-installed-printer"><a class="header" href="#inspect-installed-printer">Inspect installed printer.</a></h2>
<pre><code class="language-sh"># List default printer.
lpstat -d
# List installed printer (-l for longer output).
lpstat -p
# List printer accepting state.
lpstat -a
# List printer and the attached device (eg device uri).
lpstat -v

# List all states at once.
lpstat -t
</code></pre>
<h2 id="print-jobs"><a class="header" href="#print-jobs">Print jobs</a></h2>
<pre><code class="language-sh"># Create print job.
lp -d PRINTER FILE
    -n NUM                           number of copies
    -P PAGE_LIST                     pages to print (eg 1,3-5,10)
    -o media=a4                      paper format
    -o number-up={2|4|6|9|16}        input pages per output page
    -o sides=one-sided               print front-page only
    -o sides=two-sided-long-edge     print duplex

# Show job queue
lpq -P PRINTER

# Remove pending print job.
lprm JOOBID
</code></pre>
<h2 id="control-printer"><a class="header" href="#control-printer">Control printer</a></h2>
<pre><code class="language-sh"># Enable/disable printer.
cupsenable PRINTER
cupsdisable PRINTER

# Accept/rejects jobs for printer.
cupsaccept PRINTER
cupsreject PRINTER
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="namespaces7"><a class="header" href="#namespaces7">namespaces(7)</a></h1>
<h2 id="list-namespaces"><a class="header" href="#list-namespaces">List namespaces</a></h2>
<pre><code class="language-sh"># List all namespaces.
lsns
# List all namespaces of specific type.
lsns -t net
lsns -t pid
</code></pre>
<h2 id="enter-namespaces"><a class="header" href="#enter-namespaces">Enter namespaces</a></h2>
<pre><code class="language-sh"> # Enter all namespaces of a pid.
 nsenter -t &lt;pid&gt; --all
 # Enter specific namespaces of a pid.
 nsenter -t &lt;pid&gt; --net
 nsenter -t &lt;pid&gt; --pid --mount
</code></pre>
<h3 id="example-enter-podman-container"><a class="header" href="#example-enter-podman-container">Example: Enter podman container</a></h3>
<p>Running <code>podman exec -it webserver /bin/sh</code> is basically equivalent to the
following.</p>
<pre><code class="language-sh">sudo nsenter -t (podman inspect -f '{{.State.Pid}}' webserver) --all /bin/sh
</code></pre>
<h3 id="example-move-ethernet-interface-into-network-namespace"><a class="header" href="#example-move-ethernet-interface-into-network-namespace">Example: Move ethernet interface into network namespace</a></h3>
<p>The creates a network namespace called <code>apple</code> and moves the ethernet
interface <code>eth0</code> into the network namespace.</p>
<pre><code class="language-sh"># Create a new named network namespace, by convention the network ns file is
# located at /var/run/netns/apple.
ip netns add apple

# Move the interface eth0 into the network namespace.
ip link set dev eth0 netns apple

# Run 'ip addr' in the network namespace.
ip -n apple addr

# Eg, manually configure the interface in the namespace.
ip -n apple addr add 10.10.10.123/24 dev eth0
ip -n apple route add default via 10.10.10.1 dev eth0
ip -n apple link set dev eth0 up

# Execute a command in the network namespace.
ip netns exec apple firefox

# ip-netns(8) is considered a network namespace aware application.
# Such an application follows the convention to look for global configuration
# files in /etc/netns/&lt;name&gt;/ and then in /etc. This is done by ip-netns, by
# also unsharing the mount namespace and bind mounting the files in
# /etc/netns/&lt;name&gt; onto /etc.
echo 'nameserver 9.9.9.9' &gt; /etc/netns/apple/resolv.conf
cat /etc/resolv.conf
# nameserver '1.2.3.4'
ip netns exec apple cat /etc/resolv.conf
# nameserver '9.9.9.9'

# Kill all processes in the network namespace.
ip netns pids apple | xargs kill
# Delete the network namespace.
ip netns del apple
</code></pre>
<p>The unsharing of the <em>network</em> and <em>mount</em> namespace with <code>ip-netns(8)</code> can be
seen in the example below.</p>
<pre><code class="language-sh">ip netns exec apple bash -c 'echo $BASHPID; sleep 60' &amp;
# 1689

lsns -p 1689
#         NS TYPE   NPROCS   PID USER COMMAND
# 4026531834 time      175     1 root /usr/lib/systemd/systemd --switched-root --s
# 4026531835 cgroup    175     1 root /usr/lib/systemd/systemd --switched-root --s
# 4026531836 pid       175     1 root /usr/lib/systemd/systemd --switched-root --s
# 4026531837 user      173     1 root /usr/lib/systemd/systemd --switched-root --s
# 4026531838 uts       171     1 root /usr/lib/systemd/systemd --switched-root --s
# 4026531839 ipc       175     1 root /usr/lib/systemd/systemd --switched-root --s
# 4026532622 mnt         1  1689 root sleep 60
# 4026532674 net         1  1689 root sleep 60
</code></pre>
<h3 id="example-move-wireless-interface-into-network-namespace"><a class="header" href="#example-move-wireless-interface-into-network-namespace">Example: Move wireless interface into network namespace</a></h3>
<p>Similar to the above example, wireless interfaces can be moved into a network
namespace. However, wireless interfaces are a bit special as the whole physical
device has to be moved.</p>
<pre><code class="language-sh"># Find phy for given wireless interface 'wlan0'.
iw dev wlan0 info | grep phy
# wiphy 0

# Check if this phy supports network namespaces.
iw phy phy0 info | grep netns
# * set_wiphy_netns
</code></pre>
<p>The following moves the <code>wlan0</code> wireless interface with its physical device
(radio) <code>phy0</code> into a network namespace.</p>
<pre><code class="language-sh"># Create network namespace.
ip netns add moose

# Move wireless radio into network namespace.
iw phy phy0 set netns name moose

# Ensure wireless radio is not blocked.
ip netns exec moose rfkill ...

# Create wpa config for password protected ssids.
# Provide password on stdin.
wpa_passphrase "&lt;ssid&gt;" &gt; ssid_wpa.conf

# Start wpa supplicant in the network namespace.
ip netns exec moose wpa_supplicant -B -i wlan0 -c ssid_wpa.conf

# Then manually configure and bring up the wireless network in the network
# namespace ..
ip -n moose addr add 10.10.10.123/24 dev wlan0
ip -n moose route add default via 10.10.10.1 dev wlan0
ip -n moose link set dev wlan0 up
# .. or dynamically with a dhcp client for example.
ip netns exec moose dhclient wlan0

# One can run some commands now in the network namespace which isolates the
# wireless interface.
ip netns exec moose firefox

# Kill all processes in the network namespace and delete the network ns.
ip netns pids moose | xargs kill
ip netns del moose
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="mount8"><a class="header" href="#mount8">mount(8)</a></h1>
<h2 id="list-supported-filesystems"><a class="header" href="#list-supported-filesystems">List supported filesystems</a></h2>
<p>If the kernel is compiled with <a href="https://elixir.bootlin.com/linux/v6.18.6/source/fs/filesystems.c#L240-L263"><code>CONFIG_PROC_FS</code></a> one can
list the supported filesystems via the following procfs node.</p>
<pre><code class="language-sh">cat /proc/filesystems
</code></pre>
<h2 id="mount-options"><a class="header" href="#mount-options">Mount options</a></h2>
<p>The mount operation allows to specify additional <em>mout options</em>.</p>
<ul>
<li>The <a href="https://www.man7.org/linux/man-pages/man8/mount.8.html"><code>mount(8)</code></a> manpage provides some generic options under
<code>FILESYSTEM-INDEPENDENT MOUNT OPTIONS</code> as well as some filesystem specific
options under <code>FILESYSTEM-SPECIFIC MOUNT OPTIONS</code>.</li>
<li>The manpage for the specific filesystems list additional mount options, as
for example <a href="https://www.man7.org/linux/man-pages/man5/tmpfs.5.html"><code>tmpfs(5)</code></a>.</li>
</ul>
<h2 id="example-mount-tmpfs-with-given-user-id"><a class="header" href="#example-mount-tmpfs-with-given-user-id">Example: Mount tmpfs with given user id</a></h2>
<p>This creates a in memory filesystems with a size limit where the root folder is
owned by <code>uid=gid=1000</code>.</p>
<pre><code class="language-sh">sudo mount -t tmpfs -o size=1G,uid=1000,gid=1000,mode=0755 none ./tmp
</code></pre>
<h2 id="example-bind-mount"><a class="header" href="#example-bind-mount">Example: Bind mount</a></h2>
<pre><code class="language-sh"># Bind mount src onto dir, this does not rebind and recursive mountpoints.
mount --bind &lt;src&gt; &lt;dst&gt;
# Similar but rebind also recursive mountpoints.
mount --rbind &lt;src&gt; &lt;dst&gt;

# Mount file ./resolv.conf onto /etc/resolv.conf.
mount --bind ./resolv.conf /etc/resolv.conf
# Mount dir ./etc onto /etc.
mount --bind ./etc /etc
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="network-1"><a class="header" href="#network-1">Network</a></h1>
<ul>
<li><a href="#ssh-1">ssh</a></li>
<li><a href="#tcpdump1">tcpdump</a></li>
<li><a href="#tshark-1">tshark</a></li>
<li><a href="#firewall-cmd1">firewall-cmd</a></li>
<li><a href="#nftables">nftables</a></li>
<li><a href="#pasta1">pasta</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ssh-1"><a class="header" href="#ssh-1">ssh (1)</a></h1>
<h2 id="ssh-tunnel"><a class="header" href="#ssh-tunnel">ssh tunnel</a></h2>
<p>Abbreviations used:</p>
<ul>
<li><code>LPORT</code>: local port</li>
<li><code>LADDR</code>: local address</li>
<li><code>RPORT</code>: remote port</li>
<li><code>RADDR</code>: remote address</li>
</ul>
<p>The <code>-L</code> flag sets up a ssh tunnel to forward port <code>LPORT</code> on the local host to
<code>RADDR:RPORT</code> via the machine <code>gateway</code> (ssh tunnel endpoint).</p>
<pre><code class="language-sh"># Forward local port to remote port on gateway.
ssh -L LPORT:RPORT gateway

# Forward local port to remote port on remote address via gateway.
ssh -L LPORT:RADDR:RPORT gateway
</code></pre>
<p>In this scenario, requests are issued on the local machine and target some
remote resource, effectively making a remote resource accessible on the local
machine, which may be hidden behind the tunnel endpoint (gateway).</p>
<p>The <code>-R</code> flag sets up a ssh tunnel to expose the local port <code>LPORT</code> as <code>RPORT</code>
on the remote machine <code>gateway</code>.</p>
<pre><code class="language-sh"># Expose local port via remote port on gateway.
ssh -R RPORT:LPORT gateway

# Expose local port of machine with local address via remote port on gateway.
ssh -R RPORT:LADDR:LPORT gateway
</code></pre>
<p>In this scenario, requests are issued on the gateway and target some resource
in the local network, effectively exposing the local resource on the remote
machine (gateway).</p>
<p>The trick to memorize the syntax is to read the forwarding rules left
(source) to right (destination) while <code>-L</code> means that requests are issued
locally and <code>-R</code> means that requests are issued remotely.</p>
<p>The following flags are useful for setting up ssh tunnels:</p>
<ul>
<li><code>-N</code> just stop before running the command on the remote side (w/o cmd dont
drop into shell)</li>
<li><code>-f</code> run <code>ssh</code> command in the background</li>
</ul>
<h3 id="example-10"><a class="header" href="#example-10">Example</a></h3>
<pre><code class="language-sh"># Forward requests on localhost:8080 to moose:1234 and keep ssh in forground
# but dont drop into a shell.
ssh -N -L 8080:1234 moose

# Forward requests on moose:80 to localhost:8080 and keep ssh in forground but
# dont drop into a shell.
ssh -N -R 80:8080 moose
</code></pre>
<h2 id="ssh-keys"><a class="header" href="#ssh-keys">ssh keys</a></h2>
<p>Utility script to generate ssh key pairs.</p>
<pre><code class="language-sh">NAME=${1:?Pass new keyname as first arg}

TYPE=ed25519
FILE=${HOME}/.ssh/${NAME}-${TYPE}

if [[ -f ${FILE} || -f ${FILE}.pub ]]; then
    echo "Key with name '${NAME}' already exists, remove following files explicitly:"
    echo "  ${FILE} ${FILE}.pub"
    exit 1;
fi

set -x
ssh-keygen -C "${NAME}.${USER}@${HOSTNAME}" -f ${FILE} -t ${TYPE} -a 100
</code></pre>
<blockquote>
<p>In case one needs to generate many keys at one, one can provide a passphrase
by <code>-N "toor"</code> or an empty one as <code>-N ""</code>.</p>
</blockquote>
<h2 id="ssh-config---sshconfig"><a class="header" href="#ssh-config---sshconfig">ssh config - <code>~/.ssh/config</code></a></h2>
<p>Frequently used configs for single match.</p>
<pre><code class="language-nginx"># When ssh-ing into FOO or BAR do it as user git with given key.
host foo bar
    user git
    identityfile ~/.ssh/some-key

# When ssh-ing into moose actually log into host with ip addr 1.2.3.4.
# Can be used as alias for machines w/o DNS entries.
host moose
    user root
    port 8022
    hostname 1.2.3.4
    identityfile ~/.ssh/some-key
</code></pre>
<p>Pattern matching and evaluation order.</p>
<pre><code class="language-nginx"># For parameters, the first valued obtained will be used.
# Therefore, more host-specific blocks should come first.

host tree7
    user banana

hoste tree*
    user cherry
    # can reference matched hostname with %h
    hostname %h.some-dns-path

# ssh tree7 -&gt; banana@tree7.some-dns-path
# ssh tree5 -&gt; cherry@tree5.some-dns-path
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ss8"><a class="header" href="#ss8">ss(8)</a></h1>
<pre><code class="language-markdown">ss [option] [filter]
</code></pre>
<pre><code class="language-markdown">[option]
  -p ..... Show process using socket
  -l ..... Show sockets in listening state
  -4/-6 .. Show IPv4/6 sockets
  -x ..... Show unix sockets
  -n ..... Show numeric ports (no resolve)
  -O ..... Oneline output per socket
</code></pre>
<pre><code class="language-markdown">[filter]
  dport/sport PORT .... Filter for destination/source port
  dst/src ADDR ........ Filter for destination/source address

  and/or .............. Logic operator
  ==/!= ............... Comparison operator

  (EXPR) .............. Group exprs
</code></pre>
<h1 id="examples-14"><a class="header" href="#examples-14">Examples</a></h1>
<p>Show all tcp IPv4 sockets connecting to port <code>443</code>:</p>
<pre><code class="language-markdown">ss -4 'dport 443'
</code></pre>
<p>Show all tcp IPv4 sockets that don’t connect to port <code>443</code> or connect to address <code>1.2.3.4</code>.</p>
<pre><code class="language-markdown">ss -4 'dport != 443 or dst 1.2.3.4'
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="tcpdump1"><a class="header" href="#tcpdump1">tcpdump(1)</a></h1>
<h1 id="cli-3"><a class="header" href="#cli-3">CLI</a></h1>
<pre><code class="language-markdown">tcpdump [opts] -i &lt;if&gt; [&lt;filter&gt;]
    -n              Don't convert host/port names.
    -w &lt;file|-&gt;     Write pcap trace to file or stdout (-).
    -r &lt;file&gt;       Read &amp; parse pcap file.
</code></pre>
<p>Some useful filters, for the full syntax see <a href="https://www.tcpdump.org/manpages/pcap-filter.7.html">pcap-filter(7)</a>.</p>
<pre><code class="language-markdown">src &lt;ip&gt;                Filter for source IP.
dst &lt;ip&gt;                Filter for destination IP.
host &lt;ip&gt;               Filter for IP (src + dst).
net &lt;ip&gt;/&lt;range&gt;        Filter traffic on subnet.
[src/dst] port &lt;port&gt;   Filter for port (optionally src/dst).
tcp/udp/icmp            Filter for protocol.
</code></pre>
<blockquote>
<p>Use <code>and/or/not</code> and <code>()</code> to build filter expressions.</p>
</blockquote>
<h1 id="examples-15"><a class="header" href="#examples-15">Examples</a></h1>
<h2 id="capture-packets-from-remote-host"><a class="header" href="#capture-packets-from-remote-host">Capture packets from remote host</a></h2>
<pre><code class="language-makrdown"># -k: Start capturing immediately.
ssh &lt;host&gt; tcpdump -i any -w - | sudo wireshark -k -i -
</code></pre>
<blockquote>
<p>The <code>any</code> interface is a special keyword to capture traffic on all interfaces.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="tshark-1"><a class="header" href="#tshark-1">tshark (1)</a></h1>
<pre><code class="language-text">tshark [opts] -i &lt;if&gt;
    --color         Colorize output.
    -w &lt;file|-&gt;     Write pcap trace to file or stdout (-).
    -r &lt;file&gt;       Read &amp; parse pcap file.
    -f &lt;filter&gt;     Apply capture filter (see pcap-filter(7) or tcpdump).
                    Only applicable during capturing.
    -Y &lt;filter&gt;     Apply display filter.
                    Only applicable during viewing capture.
    -c &lt;count&gt;      Stop capturing after COUNT packets (INF by default).
</code></pre>
<p>Some useful display filters.</p>
<pre><code class="language-text">ip.addr != 192.168.1.0/24      Filter out whole ip subnet (source + destination).
ip.dst == 192.168.1.42         Filter for destination ip address.
tcp.dstport == 80              Filter for tcp destinatio port.
!wg                            Filter out all wireguard traffic.

tcp/udp/ssh/wg/...             Filter for protocol.

"and/or/not/!" and "()" can be used to build filter expressions.
</code></pre>
<blockquote>
<p>Use <code>tshak -G</code> to list all fields that can be used in display filters.</p>
</blockquote>
<h1 id="examples-16"><a class="header" href="#examples-16">Examples</a></h1>
<h2 id="capture-and-filter-packet-to-file"><a class="header" href="#capture-and-filter-packet-to-file">Capture and filter packet to file</a></h2>
<pre><code class="language-bash"># Capture TCP traffic with port 80 on interface eth0 to file.
sudo tshark -i eht0 -f 'tcp and port 80' -w tx.pcap

# View captured packets.
sudo tshark -r tx.pcap

# View captured packets and apply additionaly display filters.
sudo tshark -r tx.pcap -Y 'ip.addr != 192.168.1.42'
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="firewall-cmd1"><a class="header" href="#firewall-cmd1">firewall-cmd(1)</a></h1>
<p>Command line interface to the <a href="https://firewalld.org/documentation/man-pages/firewalld.html">firewalld(1)</a> daemon.</p>
<h2 id="list-current-status-of-the-firewall"><a class="header" href="#list-current-status-of-the-firewall">List current status of the firewall</a></h2>
<pre><code class="language-sh"># List all services and ports for all zones.
firewall-cmd --list-all
# List all services.
firewall-cmd --list-services
# List all ports.
firewall-cmd --list-ports
</code></pre>
<blockquote>
<p>Add <code>--zone &lt;ZONE&gt;</code> to limit output to a given <code>ZONE</code>. Use <code>--get-zones</code> to
see all available zones.</p>
</blockquote>
<h2 id="add-entries"><a class="header" href="#add-entries">Add entries</a></h2>
<pre><code class="language-sh"># Add a service to the firewall, use `--get-services` to list all available
# service names.
firewall-cmd --add-service &lt;SERVICE&gt;
# Add a specific port.
firewall-cmd --add-port 8000/tcp
# Add a rich rule (eg port forwarding, dnat).
firewall-cmd --add-rich-rule 'rule family="ipv4" forward-port port="80" protocol="tcp" to-port="8080"'
</code></pre>
<h2 id="remove-entries"><a class="header" href="#remove-entries">Remove entries</a></h2>
<pre><code class="language-sh"># Remove service.
firewall-cmd --remove-service &lt;SERVICE&gt;
# Remove port.
firewall-cmd --remove-port 8000/tcp
# Remove rich rule.
firewall-cmd --remove-rich-rule 'rule family="ipv4" forward-port port="80" protocol="tcp" to-port="8080"'
</code></pre>
<h2 id="references-11"><a class="header" href="#references-11">References</a></h2>
<ul>
<li>man <a href="https://firewalld.org/documentation/man-pages/firewall-cmd.html">firewall-cmd(1)</a></li>
<li>man <a href="https://firewalld.org/documentation/man-pages/firewalld.html">firewalld(1)</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="nftables"><a class="header" href="#nftables">nftables</a></h1>
<p><a href="https://nftables.org/projects/nftables/index.html">Nftables</a> is a stateful Linux firewall which uses the
<a href="https://nftables.org">netfilter</a> kernel hooks.
It is used for stateless, stateful packet filtering and all sorts of NAT.</p>
<p>Nftables is the successor to <a href="https://nftables.org/projects/iptables/index.html">iptables</a>.</p>
<p>In nftables, <code>rules</code> are organized with <code>chains</code> and <code>tables</code>.</p>
<ul>
<li><code>chain</code>: Orders <code>rules</code>. Chains exist in two kinds:
<ul>
<li><code>base chain</code>: Entry point from netfilter hooks (network stack).</li>
<li><code>regular chain</code>: Can be used as jump target to group rules for better organization.</li>
</ul>
</li>
<li><code>table</code>: Groups chains together. Tables are defined by a <code>name</code> and an
<code>address family</code> (eg <code>inet</code>, <code>ip</code>, <code>ip6</code>, ..).</li>
</ul>
<h2 id="ruleset"><a class="header" href="#ruleset">Ruleset</a></h2>
<pre><code class="language-bash">nft list ruleset        # List all tables/chains/rules (whole ruleset).
nft flush ruleset       # Clear whole ruleset.
</code></pre>
<h2 id="examples-save-rules-to-files-and-re-apply"><a class="header" href="#examples-save-rules-to-files-and-re-apply">Examples: Save rules to files and re-apply</a></h2>
<pre><code class="language-bash">nft list ruleset &gt; nft.rules
nft flush ruleset
nft -f nft.rules
</code></pre>
<h2 id="example-fully-trace-evaluation-of-nftables-rules"><a class="header" href="#example-fully-trace-evaluation-of-nftables-rules">Example: Fully trace evaluation of nftables rules</a></h2>
<pre><code class="language-text">table ip traceall {
    chain filter_prerouting {
        # Install chain with higher priority as the RAW standard priority.
        type filter hook prerouting priority raw - 50; policy accept;
        # Trace each and every packet (very verbose).
        #meta nftrace set 1;
        # Trace packet to port 80/81/8081 from localhost.
        tcp dport { 80, 81, 8081 } ip saddr 127.0.0.1 meta nftrace set 1;
    }
}
</code></pre>
<p>Use <code>nft monitor trace</code> to get trace output on tty.</p>
<h2 id="example-ipv4-port-forwarding"><a class="header" href="#example-ipv4-port-forwarding">Example: IPv4 port forwarding</a></h2>
<pre><code class="language-text">table ip fwd {
    chain nat_preroute {
        # Register this chain to the PREROUTE:NAT hook (stateful packet tracking via conntrack).
        type nat hook prerouting priority dstnat + 10 ; policy accept;
        meta nfproto ipv4 tcp dport 81 redirect to :8081
    }
}
</code></pre>
<h2 id="example-base-vs-regular-chain"><a class="header" href="#example-base-vs-regular-chain">Example: Base vs regular chain</a></h2>
<pre><code class="language-text"># Table named 'playground' handling 'ip' (ipv4) address family.
table ip playground {
    # Base chain.
    chain filter_input_base {
        # Register this chain to the INPUT:FILTER hook in the netfilter package flow.
        # Specify a prioirty relative to the inbuilt 'filter' priority (smaller
        # number means higher priority).
        # Set the default policy to ACCEPT, to let every packet pass by default.
        type filter hook input priority filter - 10; policy accept;

        # Create a rule for tcp packets arriving on either port 8000 or 8100.
        tcp dport { 8000, 8100 } jump input_reg_log;
        # Create a rule for tcp packets arriving on port 8200.
        tcp dport 8200 jump input_reg_log_all;
    }

    # Regular chain.
    chain input_reg_log {
        # Log every packet traversing this chain.
        # Message lands in the kernel ring buffer.
        log;
    }

    # Regular chain.
    chain input_reg_log_all {
        # Log every packet with all flags traversing this chain.
        log flags all;
    }
}
</code></pre>
<pre><code class="language-bash"># Load the nf rules.
sudo nft -f playground.rules
# Create test servers.
nc -lk 0.0.0.0 8000
nc -lk 0.0.0.0 8100
nc -lk 0.0.0.0 8200
# See the nftables logging in the kernel ring buffer.
sudo dmesg -w
# Make some client connections.
nc localhost 8000
nc localhost 8200
</code></pre>
<h2 id="mental-model-for-netfilter-packet-flow"><a class="header" href="#mental-model-for-netfilter-packet-flow">Mental model for netfilter packet flow</a></h2>
<p><img src="network/assets/nf_pkt_flow.png" alt="nf_pkt_flow.png"></p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="pasta1"><a class="header" href="#pasta1">pasta(1)</a></h1>
<pre><code class="language-sh">pasta [opts]
  opts:
    --ipv4-only            Enable only ipv4 operations.
    --outbound-if4 &lt;if&gt;    Bind ipv4 outbound sockets to this network interface.
                           This forces all outbound traffic via that interface.
                           If -i is not specified used this interface to derive
                           ipv4 address and routes.
    --ns-ifname &lt;name&gt;     Name of tap device in network namespace. Default is
                           the same as the one on the host which the ip addresses
                           and routes are derived from.
</code></pre>
<h2 id="example-pass-extra-arguments-to-pasta-in-podman"><a class="header" href="#example-pass-extra-arguments-to-pasta-in-podman">Example: Pass extra arguments to pasta in podman</a></h2>
<p>This shows an example how to bind outbound traffic to the host interface <code>wlp123</code>
and name the tap interface in the container <code>eth42</code>.</p>
<pre><code>&gt; podman run --rm -it \
    --network pasta:--ipv4-only,--outbound-if4,wlp123,--ns-ifname,eth42 \
    alpine
</code></pre>
<h1 id="references-12"><a class="header" href="#references-12">References</a></h1>
<ul>
<li>https://passt.top/passt/about/</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="web"><a class="header" href="#web">Web</a></h1>
<ul>
<li><a href="#html">html</a></li>
<li><a href="#css">css</a></li>
<li><a href="#chartjs">chartjs</a></li>
<li><a href="#plotly-js">plotly</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="html"><a class="header" href="#html">html</a></h1>
<h2 id="collapsible-element"><a class="header" href="#collapsible-element">Collapsible element</a></h2>
<p><a href="web/src/details.html">Rendered html</a></p>
<pre><code class="language-html">&lt;details&gt;
  &lt;summary&gt;Some text goes here&lt;/summary&gt;
  ... some more text goes here.
&lt;/details&gt;
</code></pre>
<blockquote>
<p>With the <code>open</code> attribute <code>&lt;details open&gt;</code> the details are unfolded by default.</p>
</blockquote>
<h1 id="minimal-2-column-layout"><a class="header" href="#minimal-2-column-layout">Minimal 2 column layout</a></h1>
<p><a href="web/src/grid-2col.html">Rendered html</a></p>
<pre><code class="language-html">&lt;style&gt;
.grid-2col {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 1em
}
.col1 {
  grid-column-start: 1;
  background-color: red;
  padding-left: 1em;
}
.col2 {
  grid-column-start: 2;
  background-color: green;
  padding-left: 1em;
}
&lt;/style&gt;
&lt;div class="grid-2col"&gt;
  &lt;div class="col1"&gt;
    &lt;p&gt;Some text in the first column.&lt;/p&gt;
  &lt;/div&gt;
  &lt;div class="col2"&gt;
    &lt;p&gt;Some text in the second column.&lt;/p&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<h1 id="minimal-grid-area"><a class="header" href="#minimal-grid-area">Minimal grid area</a></h1>
<p><a href="web/src/grid-area.html">Rendered html</a></p>
<pre><code class="language-html">&lt;style&gt;
.page-grid {
  display: grid;
  grid-template-columns: 1fr 2fr;
  grid-template-areas:
      "h h"
      "s m"
      "f f";
  gap: 1em;
}
.gh {
  grid-area: h;
  background-color: orange;
}
.gs {
  grid-area: s;
  background-color: green;
}
.gm {
  grid-area: m;
  background-color: gray;
}
.gf {
  grid-area: f;
  background-color: yellow;
}
.nav-items {
  display: flex;                  /* flexbox model =&gt; flexible layout on row */
  justify-content: space-around;  /* align flex boxes horizontally with space around */
  align-items: center;            /* center flex items vertically */
  list-style: none;
}
p {
  margin: 1em;
}
&lt;/style&gt;
&lt;div class="page-grid"&gt;
  &lt;div class="gh"&gt;
      &lt;ul class="nav-items"&gt;
          &lt;li class="nav-item"&gt;&lt;a href=""&gt;aa&lt;/a&gt;&lt;/li&gt;
          &lt;li class="nav-item"&gt;&lt;a href=""&gt;bb&lt;/a&gt;&lt;/li&gt;
          &lt;li class="nav-item"&gt;&lt;a href=""&gt;cc&lt;/a&gt;&lt;/li&gt;
      &lt;/ul&gt;
  &lt;/div&gt;
  &lt;div class="gs"&gt;
    &lt;p&gt;Some text in the second column.&lt;/p&gt;
  &lt;/div&gt;
  &lt;div class="gm"&gt;
    &lt;p&gt;Some text in the second column.&lt;/p&gt;
  &lt;/div&gt;
  &lt;div class="gf"&gt;
    &lt;p&gt;Some text in the second column.&lt;/p&gt;
  &lt;/div&gt;
&lt;/div&gt;

</code></pre>
<h1 id="minimal-tabs"><a class="header" href="#minimal-tabs">Minimal tabs</a></h1>
<p><a href="web/src/tabs.html">Rendered html</a></p>
<pre><code class="language-html">&lt;script&gt;
const showTab = (E, T) =&gt; {
    const TABS = Array.from(document.getElementsByClassName("content"));
    TABS.forEach(T =&gt; {
        T.style.display = "none";
    });

    document.getElementById(T).style.display = "block";
};

window.onload = () =&gt; {
    document.getElementById("bTab1").onclick = (E) =&gt; {
        showTab(E, "tTab1");
    };
    document.getElementById("bTab2").onclick = (E) =&gt; {
        showTab(E, "tTab2");
    };
}
&lt;/script&gt;

&lt;button type="button" id="bTab1"&gt;Tab1&lt;/button&gt;
&lt;button type="button" id="bTab2"&gt;Tab2&lt;/button&gt;

&lt;div id="tTab1" class="content" style="display: block;"&gt;
    &lt;p&gt;Some content goes here ...&lt;/p&gt;
&lt;/div&gt;

&lt;div id="tTab2" class="content" style="display: none;"&gt;
    &lt;p&gt;... and there.&lt;/p&gt;
&lt;/div&gt;
</code></pre>
<h1 id="minimal-tags-filter"><a class="header" href="#minimal-tags-filter">Minimal tags filter</a></h1>
<h2 id="single-active-filter-tag"><a class="header" href="#single-active-filter-tag">Single active filter tag</a></h2>
<p><a href="web/src/tags.html">Rendered html</a></p>
<pre><code class="language-html">&lt;script&gt;
/// Map HTML elements to display kinds.
const elementToDisplay = (E) =&gt; {
    switch (E.nodeName) {
        case "LI":
            return "list-item";
        default:
            return "block";
    }
}

/// Display only elements with tag T.
const showTag = (T) =&gt; {
    Array.from(document.getElementsByClassName("content")).forEach(E =&gt; {
        E.style.display = "none";
    });

    Array.from(document.getElementsByClassName(T)).forEach(E =&gt; {
        E.style.display = elementToDisplay(E);
    });
};

/// Initialize buttons and callbacks.
window.onload = () =&gt; {
    // Handle to the filter placeholder.
    const filter = document.getElementById("filter");

    // Create buttons for each tag T.
    ["arm", "x86", "clear"].forEach(T =&gt; {
        const btn = document.createElement("button");
        btn.innerHTML = T;
        btn.onclick = T === "clear"
            ? (E) =&gt; {
                showTag("content");
                filter.innerHTML = "";
            }
            : (E) =&gt; {
                showTag(T);
                filter.innerHTML = `&lt;p&gt;filter: &lt;mark&gt;${T}&lt;/mark&gt;&lt;/p&gt;`;
            };

        document.body.prepend(btn);
    });
}
&lt;/script&gt;

&lt;div id = "filter"&gt;&lt;/div&gt;

&lt;ul&gt;
    &lt;li class = "content arm"&gt;arm 1&lt;/li&gt;
    &lt;li class = "content arm"&gt;arm 2&lt;/li&gt;
    &lt;li class = "content arm"&gt;arm 3&lt;/li&gt;
    &lt;li class = "content x86"&gt;x86 1&lt;/li&gt;
    &lt;li class = "content x86"&gt;x86 2&lt;/li&gt;
    &lt;li class = "content x86 arm"&gt;x86 + arm&lt;/li&gt;
&lt;/ul&gt;

&lt;div class = "content arm"&gt;arm&lt;/div&gt;
&lt;div class = "content arm x86"&gt;arm x86&lt;/div&gt;
&lt;div class = "content x86"&gt;x86&lt;/div&gt;
</code></pre>
<h2 id="multiple-active-filter-tags"><a class="header" href="#multiple-active-filter-tags">Multiple active filter tags</a></h2>
<p><a href="web/src/tags2.html">Rendered html</a></p>
<pre><code class="language-html">&lt;script&gt;
/// Map HTML elements to display kinds.
const elementToDisplay = (E) =&gt; {
    switch (E.nodeName) {
        case "LI":
            return "list-item";
        default:
            return "block";
    }
}

/// Display only elements which have all TAGS.
const showTag = (TAGS) =&gt; {
    Array.from(document.getElementsByClassName("content")).forEach(E =&gt; {
        // Display the element, iff the element contains every tag T in TAGS.
        if (TAGS.every(T =&gt; Array.from(E.classList).includes(T))) {
            E.style.display = elementToDisplay(E);
        } else {
            E.style.display = "none";
        }
    });
};

/// Initialize buttons and callbacks.
window.onload = () =&gt; {
    // Handle to the filter placeholder.
    const filter_node = document.getElementById("filter");
    // Active filter tags.
    const filter = Array();

    // Create buttons for each tag T.
    ["arm", "x86", "clear"].forEach(T =&gt; {
        const btn = document.createElement("button");
        btn.innerHTML = T;
        btn.onclick = T === "clear"
            ? (E) =&gt; {
                // Clear active filter.
                while (filter.length) { filter.pop(); }

                showTag(["content"]);
                filter_node.innerHTML = "&lt;p&gt;filter:&lt;/p&gt;";
            }
            : (E) =&gt; {
                // Toggle tag T in Active filter.
                if ((idx = filter.indexOf(T)) &gt; -1) {
                    filter.splice(idx, 1);
                } else {
                    filter.push(T);
                }

                showTag(filter);
                out = filter.map(T =&gt; `&lt;mark&gt;${T}&lt;/mark&gt;`).join(" + ");
                filter_node.innerHTML = `&lt;p&gt;filter: ${out}&lt;/p&gt;`;
            };

        document.body.prepend(btn);
    });
}
&lt;/script&gt;

&lt;div id = "filter"&gt;&lt;p&gt;filter:&lt;/p&gt;&lt;/div&gt;

&lt;ul&gt;
    &lt;li class = "content arm"&gt;arm 1&lt;/li&gt;
    &lt;li class = "content arm"&gt;arm 2&lt;/li&gt;
    &lt;li class = "content arm"&gt;arm 3&lt;/li&gt;
    &lt;li class = "content x86"&gt;x86 1&lt;/li&gt;
    &lt;li class = "content x86"&gt;x86 2&lt;/li&gt;
    &lt;li class = "content x86 arm"&gt;x86 + arm&lt;/li&gt;
&lt;/ul&gt;

&lt;div class = "content arm"&gt;arm&lt;/div&gt;
&lt;div class = "content arm x86"&gt;arm x86&lt;/div&gt;
&lt;div class = "content x86"&gt;x86&lt;/div&gt;
</code></pre>
<h1 id="floating-figures-with-caption"><a class="header" href="#floating-figures-with-caption">Floating figures with caption</a></h1>
<p><a href="web/src/figure.html">Rendered html</a></p>
<pre><code class="language-html">&lt;style&gt;
img {
    width: 100%;
    height: auto;
}
figure {
    width: 20%;
}
&lt;/style&gt;

&lt;!-- EXAMPLE 1 ----------------------------------------------------------------&gt;

&lt;figure style="float: left;"&gt;
    &lt;img src="grad.png"&gt;
    &lt;figcaption&gt;Fig 1: wow such colors&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;&lt;i&gt;
Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor
incididunt ut labore et dolore magna aliqua. Nunc lobortis mattis aliquam
faucibus. A iaculis at erat pellentesque adipiscing. Dolor morbi non arcu risus
quis varius quam quisque. Fermentum odio eu feugiat pretium. Nibh nisl
condimentum id venenatis. Gravida dictum fusce ut placerat orci nulla. Pulvinar
etiam non quam lacus suspendisse faucibus interdum posuere. Pulvinar
pellentesque habitant morbi tristique senectus et netus et malesuada. Sem
fringilla ut morbi tincidunt augue interdum. Consectetur purus ut faucibus
pulvinar elementum. Dui faucibus in ornare quam. Sodales ut etiam sit amet
nisl. Nunc scelerisque viverra mauris in aliquam. Nec sagittis aliquam
malesuada bibendum arcu vitae elementum curabitur.
&lt;/i&gt;&lt;/p&gt;

&lt;figure style="float: right;"&gt;
    &lt;img src="grad.png"&gt;
    &lt;figcaption&gt;Fig 2: wow such colors again&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;&lt;i&gt;
Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor
incididunt ut labore et dolore magna aliqua. Nunc lobortis mattis aliquam
faucibus. A iaculis at erat pellentesque adipiscing. Dolor morbi non arcu risus
quis varius quam quisque. Fermentum odio eu feugiat pretium. Nibh nisl
condimentum id venenatis.
&lt;/i&gt;&lt;/p&gt;

&lt;!-- EXAMPLE 2 ----------------------------------------------------------------&gt;

&lt;hr style="clear: both"&gt;

&lt;figure style="float: left;"&gt;
    &lt;img src="grad.png"&gt;
&lt;/figure&gt;

Floats can be next to each other on the same height.

&lt;figure style="float: right;"&gt;
    &lt;img src="grad.png"&gt;
&lt;/figure&gt;

&lt;!-- EXAMPLE 3 ----------------------------------------------------------------&gt;

&lt;hr style="clear: both"&gt;

&lt;figure style="float: left;"&gt;
    &lt;img src="grad.png"&gt;
&lt;/figure&gt;

The css property &lt;code&gt;clear: {left, right, both};&lt;/code&gt; controls how elements
should be handled relative to the previous floating element.

&lt;figure style="float: right; clear: left;"&gt;
    &lt;img src="grad.png"&gt;
&lt;/figure&gt;

&lt;p&gt;&lt;i&gt;
Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor
incididunt ut labore et dolore magna aliqua. Nunc lobortis mattis aliquam
faucibus. A iaculis at erat pellentesque adipiscing. Dolor morbi non arcu risus
quis varius quam quisque. Fermentum odio eu feugiat pretium. Nibh nisl
condimentum id venenatis. Gravida dictum fusce ut placerat orci nulla. Pulvinar
etiam non quam lacus suspendisse faucibus interdum posuere.
&lt;/i&gt;&lt;/p&gt;

&lt;!-- EXAMPLE 4 ----------------------------------------------------------------&gt;

&lt;hr style="clear: both"&gt;

&lt;div style="overflow: auto; border: 2px solid red;"&gt;
&lt;figure style="float: left;"&gt;
    &lt;img src="grad.png"&gt;
&lt;/figure&gt;
&lt;code&gt;overflow: auto&lt;/code&gt; gives an alternative to &lt;code&gt;clear&lt;/code&gt; to
control placement of the floats. The red boarder visualizes the size of the
&lt;code&gt;&amp;ltdiv&amp;gt&lt;/code&gt; block. One can remove the &lt;code&gt;overflow&lt;/code&gt; property
and observe how the border changes.
&lt;/div&gt;

&lt;figure style="float: right;"&gt;
    &lt;img src="grad.png"&gt;
&lt;/figure&gt;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="css"><a class="header" href="#css">css</a></h1>
<h2 id="selector"><a class="header" href="#selector">selector</a></h2>
<p><code>.moose</code> element with class</p>
<pre><code class="language-html">&lt;div class = "moose"&gt;&lt;/div&gt;  // selected
&lt;div class = "bar"&gt;&lt;/div&gt;    // NOT selected
</code></pre>
<p><code>.moose.bar</code> element with multiple classes</p>
<pre><code class="language-html">&lt;div class = "moose bar"&gt;&lt;/div&gt;  // selected
&lt;div class = "bar"&gt;&lt;/div&gt;        // NOT selected
</code></pre>
<p><code>.moose .bar</code> descendant element with classes</p>
<pre><code class="language-html">&lt;div class = "moose"&gt;
    &lt;div class = "bar"&gt;&lt;/div&gt;  // selected
&lt;/div&gt;
&lt;div class = "bar"&gt;&lt;/div&gt;      // NOT selected
</code></pre>
<p><code>p</code> specific element</p>
<pre><code class="language-html">&lt;p&gt;&lt;/p&gt;      // selected
&lt;div&gt;&lt;/div&gt;  // NOT selected
</code></pre>
<p><code>p.bar</code> specific element with class</p>
<pre><code class="language-html">&lt;p class = "bar"&gt;&lt;/p&gt;  // selected
&lt;p class = "foo"&gt;&lt;/p&gt;  // NOT selected
</code></pre>
<p><code>p,div</code> any element</p>
<pre><code class="language-html">&lt;p&gt;&lt;/p&gt;      // selected
&lt;div&gt;&lt;/div&gt;  // selected
&lt;a&gt;&lt;/a&gt;      // NOT selected
</code></pre>
<p><code>div p</code> descendant element of other element</p>
<pre><code class="language-html">&lt;div&gt;&lt;p&gt;&lt;/p&gt;&lt;/div&gt;           // selected
&lt;div&gt;&lt;ul&gt;&lt;p&gt;&lt;/p&gt;&lt;/ul&gt;&lt;/div&gt;  // NOT selected
</code></pre>
<p><code>div &gt; o</code> direct descendant element of other element</p>
<pre><code class="language-html">&lt;div&gt;&lt;p&gt;&lt;/p&gt;&lt;/div&gt;           // selected
&lt;div&gt;&lt;ul&gt;&lt;p&gt;&lt;/p&gt;&lt;/ul&gt;&lt;/div&gt;  // NOT selected
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="chartjs"><a class="header" href="#chartjs">Chart.js</a></h1>
<h2 id="minimal-example-with-external-tooltips"><a class="header" href="#minimal-example-with-external-tooltips">Minimal example with <em>external</em> tooltips</a></h2>
<p><a href="web/src/chartjs-ext-tooltip.html">Rendered html</a></p>
<pre><code class="language-html">&lt;canvas id="myChart" style="margin:5em;"&gt;&lt;/canvas&gt;

&lt;script&gt;
const get_or_create_tooltip = (id) =&gt; {
  if (tooltip = document.getElementById(id)) {
    return tooltip;
  } else {
    // -- Create a new Tooltip element.
    const tooltip = document.createElement('div');
    tooltip.id = id;
    document.body.appendChild(tooltip);

    // -- Some minimal styling.
    tooltip.style.background = 'rgba(0, 0, 0, 0.1)';
    tooltip.style.position   = 'absolute';
    tooltip.style.transition = 'all .2s ease';

    // -- Add a table element for the tooltip content.
    const table = document.createElement('table');
    tooltip.appendChild(table);

    return tooltip
  }
}

const render_tooltip = (context) =&gt; {
  const {chart, tooltip} = context;

  // -- Get Tooltip element.
  const tooltip_elem = get_or_create_tooltip('myTooltip');

  // -- Get data point values (only one data point).
  const {label: x, formattedValue: y} = tooltip.dataPoints[0];

  // -- Format new tooltip.
  const link = document.createElement('a');
  link.href =  "https://github.com/johannst";
  link.innerHTML = "X:" + x + " Y:" + y;

  // -- Remove previous child element and add new one.
  const table = tooltip_elem.querySelector('table');
  table.innerHTML = ""; 
  table.appendChild(link);

  // -- Get absolute X/Y position of the top left corner of the canvas.
  const {offsetLeft: canvas_x, offsetTop: canvas_y} = chart.canvas;

  // -- Set position and minimal style for the tooltip.
  tooltip_elem.style.left = canvas_x + tooltip.caretX + 'px';
  tooltip_elem.style.top  = canvas_y + tooltip.caretY + 'px';
  tooltip_elem.style.font = tooltip.options.bodyFont.string;

  // -- Place the tooltip (I) left or (II) right of the data point.
  if (tooltip.xAlign === "right") {
    tooltip_elem.style.transform = 'translate(-100%, 0)'; // (I)
  } else if (tooltip.xAlign === "left") {
    tooltip_elem.style.transform = 'translate(0%, 0)';    // (II)
  }
}

// -- Render a chart with some dummy data on the canvas.
const chart = new Chart(
  document.getElementById('myChart'),
  {
    data: {
      datasets: [{
        // -- A single dataset.
        label: 'Just some values',
        type: 'scatter',
        data: [
          {x: 4, y: 4},
          {x: 5, y: 1},
          {x: 7, y: 6},
          {x: 10, y: 8},
          {x: 10, y: 7},
          {x: 10, y: 3},
        ],
        backgroundColor: 'rgba(255, 99, 132, 0.5)',
        borderColor: 'rgb(255, 99, 132)',
      }],
    },
    options: {
      scales: {
        y: {
          beginAtZero: true, // -- Start the Y-Axis at zero instead min(y) of dataset.
        }
      },
      plugins: {
        tooltip: {
          enabled: false, // -- Disable builtin tooltips.
          mode: 'nearest', // -- Get the item that is nearest to the mouse.
          intersect: false, // -- 'mode' is active also when the mouse doesnt intersect with an item on the chart.
          external: render_tooltip, // -- External tooltip handler, allows to create own HTML.
        }
      }
    }
  }
);
&lt;/script&gt;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="plotly-js"><a class="header" href="#plotly-js">Plotly js</a></h1>
<p>Visualization library for javascript based on <code>d3</code>.</p>
<p>Official documentation is <a href="https://plotly.com/javascript/">here</a>.</p>
<h2 id="line-chart-example"><a class="header" href="#line-chart-example">Line chart example</a></h2>
<p>The following is an example for a <em>line</em> chart which contains many options that
I frequently use. It is bloated on purpose to document the options for myself.</p>
<p><a href="web/src/plotly.html">Rendered html</a></p>
<pre><code class="language-html">&lt;div id="plot-1"&gt;&lt;/div&gt;

&lt;script&gt;
  const commits = [ "b5a7c219", "72bb8889", "fa9e9079",  "f5178ed1", "e830fa71" ]

  const common_layout  = {
    xaxis: {
      // Set range explicitly because of markers+lines mode used.
      // https://stackoverflow.com/questions/46383368
      range: [0, commits.length - 1],
      gridcolor: "ligthgray",
      rangeslider: {},
    },
    yaxis: {
      title: "runtime in sec",
      // Disable interactive y-axis zoom.
      fixedrange: true,
      gridcolor: "ligthgray",
    },
    legend: {
      orientation: "h",
      x: 0,
      y: 1,
    },
    modebar: {
      add: [ "hoverclosest", "hovercompare" ],
      remove: [ "pan", "lasso", "select", "zoomin", "zoomout" ],
    },
    // Transparent plot + paper background.
    plot_bgcolor: "rgba(0, 0, 0, 0)",
    paper_bgcolor: "rgba(0, 0, 0, 0)",
  }
  const common_config = {
    // Automatically resize plot when page resizes.
    responsive: true,
    // Dont display the plotly logo.
    displaylogo: false,
  }

  const plot_1 = document.getElementById("plot-1")
  const data_10 = {
    x: commits,
    y: [ 10.2, 11.4, 10.5, 11.0, 10.0 ],
    name: "plot 10",
    mode: "lines+markers",
  }
  const data_11 = {
    x: commits,
    y: [ 20.2, 21.4, 20.5, 21.0, 20.0 ],
    name: "plot 11",
    mode: "lines+markers",
  }

  Plotly.newPlot(plot_1, [data_10, data_11], {
    ...common_layout,
    title: "plot-1",
  }, common_config)

  plot_1.on("plotly_click", data =&gt; {
    if (data.points.length == 1) {
      // Change page to following url.
      window.location = "https://github.com/johannst/notes/commit/" + data.points[0].x
    } else {
      console.log("ignore click event, multiple elements selected")
    }
  })
&lt;/script&gt;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="arch"><a class="header" href="#arch">Arch</a></h1>
<ul>
<li><a href="#cache">cache</a></li>
<li><a href="#x86_64">x86_64</a></li>
<li><a href="#armv8">armv8</a></li>
<li><a href="#arm64">arm64</a></li>
<li><a href="#armv7a">armv7</a></li>
<li><a href="#riscv">riscv</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="cache"><a class="header" href="#cache">cache</a></h1>
<p>Caches are organized by the following components</p>
<ul>
<li><code>sets</code></li>
<li><code>ways</code></li>
<li><code>entries</code></li>
</ul>
<p>Each <code>set</code> consists of one or more <code>ways</code> and  a <code>way</code> is a single slot which
can hold an <code>entry</code>.</p>
<pre><code>S-set / W-way cache

         +----------------- .. -----------+
SET 0    | WAY 0 | WAY 1 |      | WAY W-1 |
         +----------------- .. -----------+
SET 1    | WAY 0 | WAY 1 |      | WAY W-1 |
         +----------------- .. -----------+
..       |                                |
         +----------------- .. -----------+
SET S-1  | WAY 0 | WAY 1 |      | WAY W-1 |
         +----------------- .. -----------+
</code></pre>
<p>In general a cache is described by the number of <code>sets S</code> and the number of
<code>ways W</code>. Depending on the values for <code>S</code> and <code>W</code> caches can be further
classified.</p>
<ul>
<li><code>W=1</code> is a <code>direct-mapped</code> cache, which means that each entry can be placed
at exactly <strong>ONE</strong> location in the cache. It is also called a <em>one-way set
associative</em> cache.</li>
<li><code>S&gt;1 &amp; W&gt;1</code> is a <code>W-way set associative</code> cache, which consists of S sets where
each set consists of W ways. Each entry maps to a <strong>UNIQUE</strong> set, but to
<strong>ANY</strong> way in that set.</li>
<li><code>S=1</code> is a <code>fully-associative</code> cache, which means that each entry can be
placed at <strong>ANY</strong> location in the cache.</li>
</ul>
<p>To determine which set an entry falls into, a <code>hash function</code> is applied on the
<code>key</code> which is associated with the entry. The set is then given by applying the
modulo operation to the hash value <code>hash % num_sets</code>.</p>
<p>The following figure illustrates the different cache classes and gives an
example which entries the given hash value <code>5</code> can map to.</p>
<pre><code>direct-mapped      2-way set associative      fully-associative

HASH=5 (IDX=5%4)   HASH=5 (IDX=5%4)           HASH=5 (only one IDX)
|                  |                          |
|    S=4, W=1      |   S=4, W=2               |   S=1, W=4
|    +--------+    |   +--------+--------+    |   +--------+--------+--------+--------+
|   0|        |    |  0|        |        |    `-&gt;0| xxxxxx | xxxxxx | xxxxxx | xxxxxx |
|    +--------+    |   +--------+--------+        +--------+--------+--------+--------+
`- &gt;1| xxxxxx |    `-&gt;1| xxxxxx | xxxxxx |
     +--------+        +--------+--------+
    2|        |       2|        |        |
     +--------+        +--------+--------+
    3|        |       3|        |        |
     +--------+        +--------+--------+
</code></pre>
<h2 id="cpu-hardware-caches"><a class="header" href="#cpu-hardware-caches">CPU (hardware) caches</a></h2>
<p>The number of sets in a hardware cache is usually a power of two. The <code>address</code>
acts as the key and some bits in the address are used to select the set in the
cache. The hash function in this case is simple, as it just extracts the bits
from the address which are used to select the set.</p>
<p>The <code>address</code> is usually split up into the <code>{ TAG, IDX, OFF }</code> bits which are
used to lookup an entry in the cache.</p>
<p>The <code>IDX</code> bits are used to index into the corresponding set, where the <code>TAG</code>
bits are then compared against the stored <code>TAG</code> bits in each way. If any way
holds an entry with the matching <code>TAG</code> bits, the lookup is a <code>HIT</code>, else a
<code>MISS</code>.</p>
<p>In case the entry is in the cache, the <code>OFF</code> bits are used to index into the
cache line. Hence, the number of offset bits available define the cache line
size.</p>
<p>The following gives an example for <em>64-bit addresses</em> and a <em>direct-mapped</em> cache.</p>
<pre><code>        63                      0
        +-----------------------+
ADDR:   |  TAG  |  IDX  |  OFF  |
        +-----------------------+
            |       |       `------------------,
            |       |                          |
            |       |    CACHE                 |
            |       |    +----------------+    |
            |       |    | TAG | CACHE_LN |    |
            |       |    +----------------+    |
            |       |    | TAG | CACHE_LN |    |
            |       |    +----------------+    |
            |       |    | ..             |    |
            |       |    +----------------+    |
            |       `--&gt; | TAG | CACHE_LN |    |
            |            +----------------+    |
            |               |     |            |
            |               v     v            |
            `-------------&gt; =     + &lt;----------`
                            |     |
                            v     v
                           HIT?  DATA


OFF bits: ln2 (cache_line_sz)
IDX bits: ln2 (num_sets)
TAG bits: 64 - IDX bits - OFF bits
</code></pre>
<p>The total size of a cache can be computed by <code>cache_line_sz * num_sets * num_ways</code>.</p>
<pre><code>Example
  SETS: 64        =&gt; 6 IDX bits
  WAYS: 8
  LINE: 64 bytes  =&gt; 6 OFF bits

  SIZE: 64 sets * 8 ways * 64 bytes =&gt; 32k bytes
</code></pre>
<h2 id="hardware-caches-with-virtual-memory"><a class="header" href="#hardware-caches-with-virtual-memory">Hardware caches with virtual memory</a></h2>
<p>In the context of <em>virtual memory</em>, caches can be placed at different location
in the memory path, either <em>before</em> or <em>after</em> the <code>virtual address (VA)</code> to
<code>physical address (PA)</code> translation. Each placement has different properties
discussed in the following.</p>
<p>If the cache is placed <em>before</em> the <code>VA -&gt; PA</code> translation, it is called
<code>virtually indexed virtually tagged (VIVT)</code> cache, as it is indexed by a virtual
address and data in the cache is tagged with the virtual address as well.</p>
<p>The benefit of VIVT caches is that lookups are very fast as there is no need to
wait for the result of the address translation. However, VIVT caches may suffer
from the following problems.</p>
<ul>
<li><code>synonyms</code>: different VAs map to the same PA. This can happen in a single
address space (same page table), if for example a process maps the same file
at different VAs (also commonly referred to as <em>aliasing</em> or <em>cache-line
sharing</em>). This can also happen in different address spaces (different page
tables), if for example pages are shared between two processes.
<pre><code>PT1
+-------+
|       |        PHYSMEM          PT2
+-------+        +-------+        +-------+
|  VA1  |---,    |       |        |       |
+-------+   |    +-------+        +-------+
|       |   +---&gt;|  PA1  |&lt;-------|  VA3  |
+-------+   |    +-------+        +-------+
|  VA2  |---`    |       |        |       |
+-------+        +-------+        +-------+
|       |
+-------+

Assume VA1 != VA2 != VA3

CACHE
 TAG     DATA
+-------+-------------+        Problems:
|  VA1  | Copy of PA1 |        * multiple copies of the same data.
|  VA3  | Copy of PA1 |        * write through one VA and read through a
|       |             |          different VA results in reading stale data.
|  VA2  | Copy of PA1 |
+-------+-------------+
</code></pre>
</li>
<li><code>homonyms</code>: same VA corresponds to different PAs. This is the standard case
between two different address spaces (eg in a multi-tasking os), for example
if the same VA is used in two different processes, but it maps to a different
PA for each process.
<pre><code>PT1              PHYSMEM          PT2
+-------+        +-------+        +-------+
|  VA1  |-------&gt;|  PA1  |    ,---|  VA2  |
+-------+        +-------+    |   +-------+
|       |        |       |    |   |       |
|       |        +-------+    |   |       |
|       |        |  PA2  |&lt;---`   |       |
+-------+        +-------+        +-------+

Assume VA1 == VA2

CACHE
 TAG     DATA
+-------+-------------+        Problems:
|  VA1  | Copy of PA1 |        * same VA from different address spaces map to
|       |             |          different PA
|       |             |        * read thorugh VA2 returns data from PA1
+-------+-------------+          rather than from PA2
</code></pre>
</li>
</ul>
<p>While <code>synonyms</code> may lead to accessing <em>stale</em> data, if there is no hardware to
guarantee coherency between aliased entries, <code>homonyms</code> may lead to accessing
the <em>wrong</em> data.</p>
<p>On one hand there are multiple counter measures to avoid <code>homonyms</code>, for example
physical tagging, tags could contain an address space identifier (ASID), or the
cache could be flushed on context switches (changing the page table).
Approaches like physical tagging and ASIDs work, as the same VA always maps to
the same index in the cache, which would then result in a cache miss in case of
the homonym.</p>
<p>Preventing <code>synonyms</code> on the other hand is harder, as neither physical tagging
nor ASIDs help in this case. Flushing the cache during context switches only
helps with the case where different address spaces alias shared pages, but it
won’t help if the same PA is aliased by different VAs in a single address space.
There are to alternative approaches, one is to have hardware support to detect
synonyms and the other one is to have the operating system only allow shared
mappings with VAs that have the same index bits for the cache. However, the
latter only works for direct-mapped caches, as there is only a single location
where those VAs could map to in the cache.</p>
<p>If the cache is placed <em>after</em> the <code>VA -&gt; PA</code> translation, it is called
<code>physically indexed physically tagged (PIPT)</code> cache, as it is indexed by a
physical address and data in the cache is tagged with the physical address as
well.</p>
<p>Compared to VIVT caches, PIPT caches do not suffer from <code>synonyms</code> or
<code>homonyms</code>. However, their major drawback is that the lookup depends on the
result of the address translation, and hence the translation and the cache
lookup happen sequentially which greatly decreases access latency.</p>
<p>Between VIVT and PIPT caches there is also a hybrid approach called <code>virtually indexed physically tagged (VIPT)</code> cache, where the cache lookup is done with a
virtual address and the data is tagged with the physical address.</p>
<p>The benefit of this approach is that the cache lookup and the address
translation can be done in parallel, and due to the physical tagging, <code>homonyms</code>
are not possible.</p>
<p>For VIPT caches, <code>synonyms</code> may still happen depending on how the cache is
constructed.</p>
<ul>
<li>if the <code>index</code> bits for the cache lookup, exceed the <code>page offset</code> in the
virtual address, then <code>synonyms</code> are still possible.</li>
<li>if all the <code>index</code> bits for the cache lookup fall into the <code>page offset</code> of
the virtual address, then the bits used for the cache lookup won’t change
during the <code>VA -&gt; PA</code> translation, and hence the cache effectively operates as
a PIPT cache. The only downside is that the number of sets in the cache is
limited by the page size.</li>
</ul>
<h3 id="vipt-as-pipt-example"><a class="header" href="#vipt-as-pipt-example">VIPT as PIPT example</a></h3>
<p>The following example shows that for a system with <code>4k</code> pages and cache lines of
<code>64 bytes</code> a VIPT cache can have at most <code>64 sets</code> to still act as PIPT cache.</p>
<pre><code>      63      12              0
      +-----------------------+
VA:   |       |     PG_OFF    |
      +-----------------------+
CACHE BITS:   | C_IDX | C_OFF |
              +---------------+

PAGE SIZE  : 4k
PAGE OFFSET: ln (PAGE SIZE) = 12 bits

CACHE LINE  : 64 bytes
CACHE OFFSET: ln (CACHE LINE) = 6 bits

CACHE INDEX: PG_OFF - C_OFF = 6 bits
CACHE SETS : 2^CACHE INDEX = 64 sets
</code></pre>
<p>The total cache size can be increased by adding additional ways, however that
also has a practical upper limit, as adding more ways reduces the latency.</p>
<h2 id="cache-info-in-linux"><a class="header" href="#cache-info-in-linux">Cache info in Linux</a></h2>
<pre><code class="language-sh"># Info about different caches (size, ways, sets, type, ..).
lscpu -C
# NAME ONE-SIZE ALL-SIZE WAYS TYPE        LEVEL SETS PHY-LINE COHERENCY-SIZE
# L1d       32K     128K    8 Data            1   64        1             64
# L1i       32K     128K    8 Instruction     1   64        1             64
# L2       256K       1M    4 Unified         2 1024        1             64
# L3         6M       6M   12 Unified         3 8192        1             64

# Info about how caches are shared between cores / hw-threads. Identified by
# the same cache ids on the same level.
lscpu -e
# CPU  CORE  L1d:L1i:L2:L3  ONLINE
#   0     0  0:0:0:0           yes
#   1     1  1:1:1:0           yes
#   4     0  0:0:0:0           yes
#   5     1  1:1:1:0           yes
#
# =&gt; CPU 0,4 share L1d, L1i, L2 caches (here two hw-threads of a core).
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="x86_64"><a class="header" href="#x86_64">x86_64</a></h1>
<p>keywords: x86_64, x86, abi</p>
<ul>
<li>64bit synonyms: <code>x86_64</code>, <code>x64</code>, <code>amd64</code>, <code>intel 64</code></li>
<li>32bit synonyms: <code>x86</code>, <code>ia32</code>, <code>i386</code></li>
<li>ISA type: <code>CISC</code></li>
<li>Endianness: <code>little</code></li>
</ul>
<h2 id="registers"><a class="header" href="#registers">Registers</a></h2>
<h3 id="general-purpose-register"><a class="header" href="#general-purpose-register">General purpose register</a></h3>
<pre><code class="language-markdown">bytes
[7:0]      [3:0]   [1:0]   [1]   [0]     desc
----------------------------------------------------------
rax        eax     ax      ah    al      accumulator
rbx        ebx     bx      bh    bl      base register
rcx        ecx     cx      ch    cl      counter
rdx        edx     dx      dh    dl      data register
rsi        esi     si      -     sil     source index
rdi        edi     di      -     dil     destination index
rbp        ebp     bp      -     bpl     base pointer
rsp        esp     sp      -     spl     stack pointer
r8-15      rNd     rNw     -     rNb
</code></pre>
<h3 id="special-register"><a class="header" href="#special-register">Special register</a></h3>
<pre><code class="language-markdown">bytes
[7:0]      [3:0]     [1:0]      desc
---------------------------------------------------
rflags     eflags    flags      flags register
rip        eip       ip         instruction pointer
</code></pre>
<h3 id="flags-register"><a class="header" href="#flags-register">FLAGS register</a></h3>
<pre><code class="language-markdown">rflags
bits    desc                            instr        comment
--------------------------------------------------------------------------------------------------------------
   [21]   ID   identification                        ability to set/clear -&gt; indicates support for CPUID instr
   [18]   AC   alignment check                       alignment exception for PL 3 (user), requires CR0.AM
[13:12] IOPL   io privilege level
   [11]   OF   overflow flag
   [10]   DF   direction flag           cld/std      increment (0) or decrement (1) registers in string operations
    [9]   IF   interrupt enable         cli/sti
    [7]   SF   sign flag
    [6]   ZF   zero flag
    [4]   AF   auxiliary carry flag
    [2]   PF   parity flag
    [0]   CF   carry flag
</code></pre>
<p>Change flag bits with <code>pushf</code> / <code>popf</code> instructions:</p>
<pre><code class="language-x86asm">pushfd                          // push flags (4bytes) onto stack
or dword ptr [esp], (1 &lt;&lt; 18)   // enable AC flag
popfd                           // pop flags (4byte) from stack
</code></pre>
<blockquote>
<p>There is also <code>pushfq</code> / <code>popfq</code> to push and pop all 8 bytes of <code>rflags</code>.</p>
</blockquote>
<h3 id="model-specific-register-msr"><a class="header" href="#model-specific-register-msr">Model Specific Register (MSR)</a></h3>
<pre><code class="language-x86asm">rdmsr     // Read MSR register, effectively does EDX:EAX &lt;- MSR[ECX]
wrmsr     // Write MSR register, effectively does MSR[ECX] &lt;- EDX:EAX
</code></pre>
<blockquote>
<p>See <a href="https://github.com/johannst/mini-kvm-rs/blob/main/guest/guest64-msr.S">guest64-msr.S</a> as an example.</p>
</blockquote>
<h4 id="some-interesting-msrs"><a class="header" href="#some-interesting-msrs">Some interesting MSRs</a></h4>
<ul>
<li><code>C000_0082: IA32_LSTAR</code> target address for <a href="https://www.felixcloutier.com/x86/syscall"><code>syscall</code></a> instruction
in <strong>IA-32e</strong> (64 bit) mode.</li>
<li><code>C000_0100: IA32_FS_BASE</code> storage for <strong>%fs</strong> segment base address.</li>
<li><code>C000_0101: IA32_GS_BASE</code> storage for <strong>%gs</strong> segment base address.</li>
<li><code>C000_0102: IA32_KERNEL_GS_BASE</code> additional register, <a href="https://www.felixcloutier.com/x86/swapgs"><code>swapgs</code></a>
swaps <strong>GS_BASE</strong> and <strong>KERNEL_GS_BASE</strong>, without altering any register state.
Can be used to swap in a pointer to a kernel data structure on syscall entry,
as for example in <a href="https://web.git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/entry/entry_64.S?h=v6.13#n87"><code>entry_SYSCALL_64</code></a>.</li>
</ul>
<h2 id="current-privilege-level"><a class="header" href="#current-privilege-level">Current privilege level</a></h2>
<p>The current privilege level can be found at any time in the last two bits of the
code segment selector <code>cs</code>. The following shows an example debugging an entry
and exit of a syscall in x86_64-linux.</p>
<pre><code>Breakpoint 1, entry_SYSCALL_64 () at arch/x86/entry/entry_64.S:90
90		swapgs
(gdb) info r rax rcx cs
rax            0x0                 0                ; syscall nr
rcx            0x7feb16399e56      140647666916950  ; ret addr
cs             0x10                16               ; cs &amp; 0x3 -&gt; 0 (ring0,kernel)

(gdb) c
Breakpoint 2, entry_SYSCALL_64 () at arch/x86/entry/entry_64.S:217
217		sysretq
(gdb) info r rcx cs
rcx            0x7feb16399e56      140647666916950  ; ret addr
cs             0x10                16               ; cs &amp; 0x3 -&gt; 0 (ring0,kernel)

(gdb) b *$rcx
(gdb) s
Breakpoint 3, 0x00007feb16399e56 in ?? ()
(gdb) info r cs
cs             0x33                51  ; cs &amp; 0x3 -&gt; 3 (ring3,user)
</code></pre>
<h2 id="size-directives"><a class="header" href="#size-directives">Size directives</a></h2>
<p>Explicitly specify size of the operation.</p>
<pre><code class="language-x86asm">mov  byte ptr [rax], 0xff    // save 1 byte(s) at [rax]
mov  word ptr [rax], 0xff    // save 2 byte(s) at [rax]
mov dword ptr [rax], 0xff    // save 4 byte(s) at [rax]
mov qword ptr [rax], 0xff    // save 8 byte(s) at [rax]
</code></pre>
<h2 id="addressing"><a class="header" href="#addressing">Addressing</a></h2>
<pre><code class="language-x86asm">mov qword ptr [rax], rbx         // save val in rbx at [rax]
mov qword ptr [imm], rbx         // save val in rbx at [imm]
mov rax, qword ptr [rbx+4*rcx]   // load val at [rbx+4*rcx] into rax
</code></pre>
<p><code>rip</code> relative addressing:</p>
<pre><code class="language-x86asm">lea rax, [rip+.my_str]       // load addr of .my_str into rax
...
.my_str:
.asciz "Foo"
</code></pre>
<p>Load effective address:</p>
<pre><code class="language-x86asm">mov rax, 2
lea r11, [rax + 3]   // r11 &lt;- 5
</code></pre>
<h2 id="string-instructions"><a class="header" href="#string-instructions">String instructions</a></h2>
<p>The operand size of a string instruction is defined by the instruction suffix
<code>b | w | d | q</code>.</p>
<p>Source and destination registers are modified according to the <code>direction flag (DF)</code> in the <code>flags</code> register</p>
<ul>
<li><code>DF=0</code> increment src/dest registers</li>
<li><code>DF=1</code> decrement src/dest registers</li>
</ul>
<p>Following explanation assumes <code>byte</code> operands with <code>DF=0</code>:</p>
<pre><code class="language-x86asm">movsb   // move data from string to string
        // ES:[DI] &lt;- DS:[SI]
        // DI &lt;- DI + 1
        // SI &lt;- SI + 1

lodsb   // load string
        // AL &lt;- DS:[SI]
        // SI &lt;- SI + 1

stosb   // store string
        // ES:[DI] &lt;- AL
        // DI &lt;- DI + 1

cmpsb   // compare string operands
        // DS:[SI] - ES:[DI]    ; set status flag (eg ZF)
        // SI &lt;- SI + 1
        // DI &lt;- DI + 1

scasb   // scan string
        // AL - ES:[DI]         ; set status flag (eg ZF)
        // DI &lt;- DI + 1
</code></pre>
<p>String operations can be repeated:</p>
<pre><code class="language-x86asm">rep     // repeat until rcx = 0
repz    // repeat until rcx = 0 or while ZF = 0
repnz   // repeat until rcx = 0 or while ZF = 1
</code></pre>
<h3 id="example-simple-memset"><a class="header" href="#example-simple-memset">Example: Simple <code>memset</code></a></h3>
<pre><code class="language-x86asm">// memset (dest, 0xaa /* char */, 0x10 /* len */)

lea di, [dest]
mov al, 0xaa
mov cx, 0x10
rep stosb
</code></pre>
<h2 id="att-syntax-for-intel-syntax-users"><a class="header" href="#att-syntax-for-intel-syntax-users">AT&amp;T syntax for intel syntax users</a></h2>
<pre><code class="language-x86asm">mov %rax, %rbx           // mov rbx, rax
mov $12, %rax            // mov rax, 12

mov (%rsp), %rax         // mov rax, [rsp]
mov 8(%rsp), %rax        // mov rax, [rsp + 8]
mov (%rsp,%rcx,4), %rax  // mov rax, [rsp + 8 * rcx]
mov 0x100, %rax          // mov rax, [0x100]
mov (0x100), %rax        // mov rax, [0x100]

mov %gs:8, %rax          // mov rax, gs:8
</code></pre>
<h2 id="time-stamp-counter---rdtsc"><a class="header" href="#time-stamp-counter---rdtsc">Time stamp counter - <code>rdtsc</code></a></h2>
<pre><code class="language-c">static inline uint64_t rdtsc() {
  uint32_t eax, edx;
  asm volatile("rdtsc" : "=d"(edx), "=a"(eax)::);
  return (uint64_t)edx &lt;&lt; 32 | eax;
}
</code></pre>
<blockquote>
<p>Constant TSC behavior ensures that the duration of each clock tick is uniform
and supports the use of the TSC as a wall clock timer even if the processor
core changes frequency. This is the architectural behavior moving forward.</p>
<ul>
<li>18.17 TIME-STAMP COUNTER - <a href="https://software.intel.com/content/www/us/en/develop/download/intel-64-and-ia-32-architectures-sdm-combined-volumes-3a-3b-3c-and-3d-system-programming-guide.html">intel64-vol3</a></li>
</ul>
</blockquote>
<p>On linux one can check the <code>constant_tsc</code> cpu flag, to validate if the
implemented TSC ticks with a constant frequency.</p>
<pre><code class="language-sh">grep constant_tsc /proc/cpuinfo
</code></pre>
<h2 id="cpu--hw-features---cpuid"><a class="header" href="#cpu--hw-features---cpuid">Cpu &amp; hw features - <code>cpuid</code></a></h2>
<pre><code class="language-x86asm">cpuid   // in:  eax leaf; ecx sub-leaf
        // out: eax, ebx, ecx, edx (interpreting depends on leaf)
</code></pre>
<p>This instruction is used to query for availability of certain
instructions or hardware details like cache sizes and so on.</p>
<p>An example how to read cpuid leafs is show in <a href="arch/x86/cpuid/cpuid.c">cpuid.c</a>.</p>
<h2 id="sysv-x86_64-abi"><a class="header" href="#sysv-x86_64-abi"><a href="https://gitlab.com/x86-psABIs/x86-64-ABI">SysV x86_64 ABI</a></a></h2>
<h3 id="passing-arguments-to-functions"><a class="header" href="#passing-arguments-to-functions">Passing arguments to functions</a></h3>
<ul>
<li>Integer/Pointer arguments
<pre><code class="language-markdown">reg     arg
-----------
rdi       1
rsi       2
rdx       3
rcx       4
r8        5
r9        6
</code></pre>
</li>
<li>Floating point arguments
<pre><code class="language-markdown">reg     arg
-----------
xmm0      1
  ..     ..
xmm7      8
</code></pre>
</li>
<li>Additional arguments are passed on the stack. Arguments are pushed
right-to-left (RTL), meaning next arguments are closer to current <code>rsp</code>.</li>
</ul>
<h3 id="return-values-from-functions"><a class="header" href="#return-values-from-functions">Return values from functions</a></h3>
<ul>
<li>Integer/Pointer return values
<pre><code class="language-markdown">reg          size
-----------------
rax        64 bit
rax+rdx   128 bit
</code></pre>
</li>
<li>Floating point return values
<pre><code class="language-markdown">reg            size
-------------------
xmm0         64 bit
xmm0+xmm1   128 bit
</code></pre>
</li>
</ul>
<h3 id="caller-saved-registers"><a class="header" href="#caller-saved-registers">Caller saved registers</a></h3>
<p>Caller must save these registers if they should be preserved across function
calls.</p>
<ul>
<li><code>rax</code></li>
<li><code>rcx</code></li>
<li><code>rdx</code></li>
<li><code>rsi</code></li>
<li><code>rdi</code></li>
<li><code>rsp</code></li>
<li><code>r8</code> - <code>r11</code></li>
</ul>
<h3 id="callee-saved-registers"><a class="header" href="#callee-saved-registers">Callee saved registers</a></h3>
<p>Caller can expect these registers to be preserved across function calls. Callee
must must save these registers in case they are used.</p>
<ul>
<li><code>rbx</code></li>
<li><code>rbp</code></li>
<li><code>r12</code> – <code>r15</code></li>
</ul>
<h3 id="stack"><a class="header" href="#stack">Stack</a></h3>
<ul>
<li>grows downwards</li>
<li>frames aligned on 16 byte boundary
<pre><code class="language-text">Hi ADDR
 |                +------------+
 |                | prev frame |
 |                +------------+ &lt;--- 16 byte aligned (X &amp; ~0xf)
 |       [rbp+8]  | saved RIP  |
 |       [rbp]    | saved RBP  |
 |       [rbp-8]  | func stack |
 |                | ...        |
 v                +------------+
Lo ADDR
</code></pre>
</li>
</ul>
<h3 id="function-prologue--epilogue"><a class="header" href="#function-prologue--epilogue">Function prologue &amp; epilogue</a></h3>
<ul>
<li>prologue
<pre><code class="language-x86asm">push rbp        // save caller base pointer
mov rbp, rsp    // save caller stack pointer
</code></pre>
</li>
<li>epilogue
<pre><code class="language-x86asm">mov rsp, rbp    // restore caller stack pointer
pop rbp         // restore caller base pointer
</code></pre>
<blockquote>
<p>Equivalent to <code>leave</code> instruction.</p>
</blockquote>
</li>
</ul>
<h2 id="windows-x64-abi"><a class="header" href="#windows-x64-abi"><a href="https://learn.microsoft.com/en-us/cpp/build/x64-software-conventions">Windows x64 ABI</a></a></h2>
<h3 id="passing-arguments-to-functions-ref"><a class="header" href="#passing-arguments-to-functions-ref">Passing arguments to functions (<a href="https://learn.microsoft.com/en-us/cpp/build/x64-calling-convention">ref</a>)</a></h3>
<blockquote>
<p>A single argument is never spread across multiple registers.</p>
</blockquote>
<ul>
<li>Integer/Pointer arguments
<pre><code class="language-markdown">reg     arg
-----------
rcx       1
rdx       2
r8        3
r9        4
</code></pre>
</li>
<li>Floating point arguments
<pre><code class="language-markdown">reg     arg
-----------
xmm0      1
  ..     ..
xmm3      4
</code></pre>
</li>
<li>Additional arguments are passed on the stack. Arguments are pushed
right-to-left (RTL), meaning next arguments are closer to current <code>rsp</code>.
<a href="https://godbolt.org/z/oT5Tjdf7Y">See example</a>.</li>
</ul>
<h3 id="return-values-from-functions-1"><a class="header" href="#return-values-from-functions-1">Return values from functions</a></h3>
<ul>
<li>Integer/Pointer return values
<pre><code class="language-markdown">reg          size
-----------------
rax        64 bit
</code></pre>
</li>
<li>Floating point return values
<pre><code class="language-markdown">reg            size
-------------------
xmm0         64 bit
</code></pre>
</li>
</ul>
<h3 id="caller-saved-registers-1"><a class="header" href="#caller-saved-registers-1">Caller saved registers</a></h3>
<p>Caller must save these registers if they should be preserved across function
calls.</p>
<ul>
<li><code>rax</code></li>
<li><code>rcx</code></li>
<li><code>rdx</code></li>
<li><code>r8</code> - <code>r11</code></li>
<li><code>xmm0</code> - <code>xmm5</code></li>
</ul>
<h3 id="callee-saved-registers-1"><a class="header" href="#callee-saved-registers-1">Callee saved registers</a></h3>
<p>Caller can expect these registers to be preserved across function calls. Callee
must must save these registers in case they are used.</p>
<ul>
<li><code>rbx</code></li>
<li><code>rbp</code></li>
<li><code>rdi</code></li>
<li><code>rsi</code></li>
<li><code>rsp</code></li>
<li><code>r12</code> - <code>r15</code></li>
<li><code>xmm6</code> - <code>xmm15</code></li>
</ul>
<h2 id="asm-skeleton---linux-userspace"><a class="header" href="#asm-skeleton---linux-userspace">ASM skeleton - linux userspace</a></h2>
<p>Small assembler skeleton, ready to use with following properties:</p>
<ul>
<li>use raw Linux syscalls (<code>man 2 syscall</code> for ABI)</li>
<li>no <code>C runtime (crt)</code></li>
<li>gnu assembler <a href="https://sourceware.org/binutils/docs/as"><code>gas</code></a></li>
<li>intel syntax</li>
</ul>
<pre><code class="language-x86asm">// file: greet.S
#include &lt;asm/unistd.h&gt;

    .intel_syntax noprefix

    .section .text, "ax", @progbits
    .global _start
_start:
    mov rdi, 1                      # fd (stdout)
    lea rsi, [rip + greeting]       # buf
    mov rdx, [rip + greeting_len]   # count
    mov rax, __NR_write             # write(2) syscall nr
    syscall

    mov rdi, __NR_exit              # exit code
    mov rax, 60                     # exit(2) syscall nr
    syscall

    .section .rdonly, "a", @progbits
greeting:
    .ascii "Hi ASM-World!\n"
greeting_len:
    .int .-greeting
</code></pre>
<blockquote>
<p>Files with <code>.S</code> suffix are pre-processed, while files with <code>.s</code> suffix are not.</p>
</blockquote>
<p>To compile and run:</p>
<pre><code class="language-bash">&gt; gcc -o greet greet.S -nostartfiles -nostdlib &amp;&amp; ./greet
Hi ASM-World!
</code></pre>
<h2 id="mbr-boot-sectors-example"><a class="header" href="#mbr-boot-sectors-example">MBR boot sectors example</a></h2>
<p>The following shows a non-minimal <a href="https://en.wikipedia.org/wiki/Master_boot_record">MBR</a> boot sector, which transitions from
16-bit <em>real mode</em> to 32-bit <em>protected mode</em> by setting up a small <em>global
descriptor table (GDT)</em>. A string is printed in each mode.</p>
<pre><code class="language-x86asm">.code16
.intel_syntax noprefix

.section .boot, "ax", @progbits
    // Disable interrupts.
    cli

    // Clear segment selectors.
    xor ax, ax
    mov ds, ax
    mov es, ax
    mov ss, ax
    mov fs, ax
    mov gs, ax

    // Set cs to 0x0000, as some BIOSes load the MBR to either 07c0:0000 or 0000:7c000.
    jmp 0x0000:entry_rm16

entry_rm16:
    // Set video mode 3h, see [1].
    //   * 80x25 text mode
    //   * 640x200 pixel resolution (8x8 pixel per char)
    //   * 16 colors (4bit)
    //   * 4 pages
    //   * 0xB8000 screen address
    //
    // [1] http://www.ctyme.com/intr/rb-0069.htm
    mov ax, 0x3
    int 0x10

    // Move cursor to second row.
    // http://www.ctyme.com/intr/rb-0087.htm
    mov ah, 0x02
    mov bh, 0  // page
    mov dh, 1  // row
    mov dl, 0  // col
    int 0x10

    // Clear direction flag for lodsb below.
    cld

    // Load pointer to msg_rm string (null terminated).
    lea si, [msg_rm]

    // Teletype output char at current cursor position.
    // http://www.ctyme.com/intr/rb-0106.htm
    mov ah, 0x0e
1:
    lodsb         // al &lt;- ds:si ; si+=1 ; (al char to write)
    test al,al    // test for null terminator
    jz 2f
    int 0x10
    jmp 1b
2:

    // Enable A20 address line.
    in al, 0x92
    or al, 2
    out 0x92, al

    // Load GDT descriptor.
    lgdt [gdt_desc]

    // Enable protected mode (set CR0.PE bit).
    mov eax, cr0
    or  eax, (1 &lt;&lt; 0)
    mov cr0, eax

    // Far jump which loads segment selector (0x0008) into cs.
    // 0x0008 -&gt; RPL=0, TI=0(GDT), I=1
    jmp 0x0008:entry_pm32

.code32
entry_pm32:
    // Select data segment selector (0x0010) for ds.
    mov ax, gdt_data - gdt
    mov ds, ax

    // Write through VGA interface (video memory).
    // Each character is represented by 2 bytes.
    //   4 bit bg | 4 bit fg | 8 bit ascii char
    //
    // Start writing at third line.
    mov edi, 0xb8000 + (80 * 2 * 2)

    lea esi, [msg_pm]
1:
    lodsb           // al &lt;- ds:esi ; esi+=1
    test al, al     // test for null terminator
    jz 2f
    or eax, 0x1f00  // blue bg, white fg
    stosw           // ds:[edi] &lt;- ax; edi+=2
    jmp 1b
2:
    hlt
    jmp 2b

// For simplicity keep data used by boot sector in the same section.
.balign 8
msg_rm:
    .asciz "Hello from Real Mode!"
msg_pm:
    .asciz "Hello from Protected Mode!"

.balign 8
gdt:
    .8byte 0x0000000000000000 // 0x00 | null descriptor
    .8byte 0x00cf9a000000ffff // 0x08 | 32 bit, code (rx), present, dpl=0, g=4K, base=0, limit=fffff
gdt_data:
    .8byte 0x00cf92000000ffff // 0x10 | 32 bit, data (rw), present, dpl=0, g=4K, base=0, limit=fffff
gdt_desc:
    .2byte .-gdt-1  // size
    .4byte gdt      // address

// Write MBR boot magic value.
.fill 510 - (. - .boot), 1, 0x00
.2byte 0xaa55
</code></pre>
<p>The linker script.</p>
<pre><code class="language-x86asm">OUTPUT_FORMAT(elf32-i386)
OUTPUT_ARCH(i386)

SECTIONS {
    . = 0x7c00;
    .boot     : { *(.boot) }
    _boot_end = .;
    /DISCARD/ : { *(.*) }

    ASSERT(_boot_end - 0x7c00 == 512, "boot sector must be exact 512 bytes")
}
</code></pre>
<p>The build instructions.</p>
<pre><code class="language-make">mbr: mbr.ld mbr.o
	ld -o $@.elf -nostdlib -T $^
	objcopy -O binary $@.elf $@

mbr.o: mbr.S
	gcc -c -o $@ -m32 -ffreestanding $^
</code></pre>
<p>One can boot into the bootsector from legacy BIOS, either with qemu or by
writing the mbr boot sector as first sector onto a usb stick.</p>
<pre><code class="language-sh">qemu-system-i386 -hda mbr
</code></pre>
<p>The following gives some more detailed description for the <em>segment selector</em>
registers, the <em>segment descriptors</em> in the GDT, and the <em>GDT descriptor</em>
itself.</p>
<pre><code># Segment Selector (cs, ds, es, ss, fs, gs).

[15:3] I   Descriptor Index
   [2] TI  Table Indicator (0=GTD | 1=LDT)
 [1:0] RPL Requested Privilege Level


# Segment Descriptor (2 x 4 byte words).

0x4 [31:24] Base[31:24]
0x4    [23] G            Granularity, scaling of limit (0=1B | 1=4K)
0x4    [22] D/B          (0=16bit | 1=32bit)
0x4    [21] L            (0=compatibility mode | 1=64bit code) if 1 -&gt; D/B = 0
0x4    [20] AVL          Free use for system sw
0x4 [19:16] Limit[19:16]
0x4    [15] P            Present
0x4 [14:13] DPL          Descriptor privilege level
0x4    [12] S            (0=system segment | 1=code/data)
0x4  [11:0] Type         Code or data and access information.
0x4   [7:0] Base[23:16]

0x0 [31:16] Base[15:0]
0x0  [15:0] Limit[15:0]


# GDT descriptor (32bit mode)

[47:16] Base address of GDT table.
 [15:0] Length of GDT table.
</code></pre>
<blockquote>
<p>In 64-bit mode the <code>{cs, ds, es, ss}</code> segment register have no
effect, segmentation is effectively disabled. The <code>{gs, fs}</code> segment
register however can still be used for segmented memory access in
64-bit with paging enabled. Segmentation takes place before VA -&gt; PA
address translation.</p>
<p>The example in <a href="arch/x86/seg/seg.c">seg.c</a> shows how to set the <code>gs</code> base
address and to relative accesses.</p>
</blockquote>
<h2 id="references-13"><a class="header" href="#references-13">References</a></h2>
<ul>
<li><a href="https://gitlab.com/x86-psABIs/x86-64-ABI">SystemV AMD64 ABI</a></li>
<li><a href="https://www.amd.com/system/files/TechDocs/24592.pdf">AMD64 Vol1: Application Programming</a></li>
<li><a href="https://www.amd.com/system/files/TechDocs/24593.pdf">AMD64 Vol2: System Programming</a></li>
<li><a href="https://www.amd.com/system/files/TechDocs/24594.pdf">AMD64 Vol3: General-Purpose &amp; System Instructions</a></li>
<li><a href="https://cs.brown.edu/courses/cs033/docs/guides/x64_cheatsheet.pdf">X86_64 Cheat-Sheet</a></li>
<li><a href="https://software.intel.com/content/www/us/en/develop/download/intel-64-and-ia-32-architectures-software-developers-manual-volume-1-basic-architecture.html">Intel 64 Vol1: Basic Architecture</a></li>
<li><a href="https://software.intel.com/content/www/us/en/develop/download/intel-64-and-ia-32-architectures-sdm-combined-volumes-2a-2b-2c-and-2d-instruction-set-reference-a-z.html">Intel 64 Vol2: Instruction Set Reference</a></li>
<li><a href="https://software.intel.com/content/www/us/en/develop/download/intel-64-and-ia-32-architectures-sdm-combined-volumes-3a-3b-3c-and-3d-system-programming-guide.html">Intel 64 Vol3: System Programming Guide</a></li>
<li><a href="https://sourceware.org/binutils/docs/as">GNU Assembler</a></li>
<li><a href="https://sourceware.org/binutils/docs/as/Pseudo-Ops.html#Pseudo-Ops">GNU Assembler Directives</a></li>
<li><a href="https://sourceware.org/binutils/docs/as/i386_002dDependent.html">GNU Assembler <code>x86_64</code> dependent features</a></li>
<li><a href="https://github.com/johannst/juicebox-asm"><code>juicebox-asm</code> an <code>x86_64</code> jit assembler playground</a></li>
<li><a href="https://git.memzero.de/testground/x86-bare-metal-playground">zig x86 bare metal examples</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="armv8"><a class="header" href="#armv8">armv8</a></h1>
<p>keywords: aarch64, arm64, A64, aarch32, A32, T32, abi</p>
<p>The <code>armv8</code> architecture introduces support for 64-bit and defines two
<em>execution states</em> <code>aarch64</code> and <code>aarch32</code>.</p>
<p>Implementations are <strong>not</strong> required to implement all execution states for all
<em>exception levels (EL)</em>. For example the <a href="https://en.wikichip.org/wiki/arm_holdings/microarchitectures/cortex-a32">coretex-a32</a> only
implements <code>aarch32</code>, while  the <a href="https://en.wikichip.org/wiki/arm_holdings/microarchitectures/cortex-a34">coretex-a34</a> only implements
<code>aarch64</code>.</p>
<p>The execution states support different instruction sets.</p>
<ul>
<li><code>aarch64</code> only supports the new <a href="https://developer.arm.com/documentation/ddi0602/latest"><code>A64</code></a> instruction set, where all
instructions have the fixed size of of 32 bits.</li>
<li><code>aarch32</code> supports the <a href="https://developer.arm.com/documentation/ddi0597/latest"><code>A32</code></a> and <a href="https://developer.arm.com/documentation/ddi0597/latest"><code>T32</code></a> instruction sets. These
are updated versions of the <code>armv7</code> instruction sets, kept backwards
compatible allowing <code>armv7</code> programs to run on <code>armv8</code>.
<blockquote>
<p>In <code>armv7</code> the instruction sets <code>A32</code> an <code>T32</code> were called <code>arm</code> and
<code>thumb</code> respectively.</p>
</blockquote>
</li>
</ul>
<p>A <em>program</em> always runs in either the <code>aarch64</code> or the <code>aarch32</code> execution
state, but never in a <em>mixture</em> of both. Transitions between execution states
only occur when raising or lowering the exception level.</p>
<ul>
<li><code>aarch64 -&gt; aarch32</code> can only occur when switching from <em>higher EL</em> to <em>lower
EL</em>.</li>
<li><code>aarch32 -&gt; aarch64</code> can only occur when switching from <em>lower EL</em> to <em>higher
EL</em>.</li>
</ul>
<p>The following figure depicts which execution state Transitions are allowed.</p>
<pre><code>      (user) EL0     ^       |
        (os) EL1     |    32-&gt;64
(hypervisor) EL2  64-&gt;32     |
    (secure) EL3     |       v
</code></pre>
<p>This means for example, an <em>os</em> running in <code>aarch32</code> can only support <code>aarch32</code>
user applications, while an <em>os</em> running in <code>aarch64</code> can support
<code>aarch32 / aarch64</code> user applications.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="arm64"><a class="header" href="#arm64">arm64</a></h1>
<blockquote>
<p>This page only talks about the 64 bit part of the <code>armv8</code> architecture. For
an overview see <a href="#armv8"><code>armv8</code></a>.</p>
</blockquote>
<p>keywords: arm64, aarch64, abi</p>
<ul>
<li>64bit synonyms: <code>arm64</code>, <code>aarch64</code></li>
<li>ISA type: <code>RISC</code></li>
<li>Endianness: <code>little</code>, <code>big</code></li>
</ul>
<h2 id="registers-1"><a class="header" href="#registers-1">Registers</a></h2>
<h3 id="general-purpose-registers"><a class="header" href="#general-purpose-registers">General purpose registers</a></h3>
<pre><code class="language-markdown">bytes
[7:0]     [3:0]     desc
---------------------------------------------
x0-x28    w0-w28    general purpose registers
x29       w29       frame pointer (FP)
x30       w30       link register (LR)
sp        wsp       stack pointer (SP)
pc                  program counter (PC)
xzr       wzr       zero register
</code></pre>
<blockquote>
<p>Write to <code>wN</code> register clears upper 32bit.</p>
</blockquote>
<h3 id="special-registers-per-el"><a class="header" href="#special-registers-per-el">Special registers per EL</a></h3>
<pre><code class="language-markdown">bytes
[7:0]       desc
---------------------------------------------
sp_el0      stack pointer EL0

sp_el1      stack pointer EL1
elr_el1     exception link register EL1
spsr_el1    saved process status register EL1

sp_el2      stack pointer EL2
elr_el2     exception link register EL2
spsr_el2    saved process status register EL2

sp_el3      stack pointer EL3
elr_el3     exception link register EL3
spsr_el3    saved process status register EL3
</code></pre>
<h2 id="instructions-cheatsheet"><a class="header" href="#instructions-cheatsheet">Instructions cheatsheet</a></h2>
<h3 id="accessing-system-registers"><a class="header" href="#accessing-system-registers">Accessing system registers</a></h3>
<p>Reading from system registers:</p>
<pre><code class="language-armasm">mrs x0, vbar_el1      // move vbar_el1 into x0
</code></pre>
<p>Writing to system registers:</p>
<pre><code class="language-armasm">msr vbar_el1, x0      // move x0 into vbar_el1
</code></pre>
<h3 id="control-flow-1"><a class="header" href="#control-flow-1">Control Flow</a></h3>
<pre><code class="language-armasm">b &lt;offset&gt;    // relative forward/back branch
br &lt;Xn&gt;       // absolute branch to address in register Xn

// branch &amp; link, store return address in X30 (LR)
bl &lt;offset&gt;   // relative forward/back branch
blr &lt;Xn&gt;      // absolute branch to address in register Xn

ret {Xn}      // return to address in X30, or Xn if supplied
</code></pre>
<h2 id="addressing-1"><a class="header" href="#addressing-1">Addressing</a></h2>
<h3 id="offset"><a class="header" href="#offset">Offset</a></h3>
<pre><code class="language-armasm">ldr x0, [x1]                // x0 = [x1]
ldr x0, [x1, 8]             // x0 = [x1 + 8]
ldr x0, [x1, x2, lsl #3]    // x0 = [x1 + (x2&lt;&lt;3)]
ldr x0, [x1, w2, stxw]      // x0 = [x1 + sign_ext(w2)]
ldr x0, [x1, w2, stxw #3]   // x0 = [x1 + (sign_ext(w2)&lt;&lt;3)]
</code></pre>
<blockquote>
<p>Shift amount can either be <code>0</code> or <code>log2(access_size_bytes)</code>. Eg for 8byte
access it can either be <code>{0, 3}</code>.</p>
</blockquote>
<h3 id="index"><a class="header" href="#index">Index</a></h3>
<pre><code class="language-armasm">ldr x0, [x1, 8]!    // pre-inc : x1+=8; x0 = [x1]
ldr x0, [x1], 8     // post-inc: x0 = [x1]; x1+=8
</code></pre>
<h3 id="pair-access"><a class="header" href="#pair-access">Pair access</a></h3>
<pre><code class="language-armasm">ldp x1, x2, [x0]    // x1 = [x0]; x2 = [x0 + 8]
stp x1, x2, [x0]    // [x0] = x1; [x0 + 8] = x2
</code></pre>
<h2 id="procedure-call-standard-arm64-aapcs64"><a class="header" href="#procedure-call-standard-arm64-aapcs64">Procedure Call Standard ARM64 (<a href="https://github.com/ARM-software/abi-aa/blob/master/aapcs64/aapcs64.rst"><code>aapcs64</code></a>)</a></h2>
<h3 id="passing-arguments-to-functions-1"><a class="header" href="#passing-arguments-to-functions-1">Passing arguments to functions</a></h3>
<ul>
<li>Integer/Pointer arguments
<pre><code class="language-markdown">reg     arg
-----------
x0        1
..       ..
x7        8
</code></pre>
</li>
<li>Additional arguments are passed on the stack. Arguments are pushed
<code>right-to-left (RTL)</code>, meaning next arguments are closer to current <code>sp</code>.
<pre><code class="language-markdown">void take(..., int a9, int a10);
                   |       |   | ... |       Hi
                   |       +--&gt;| a10 |       |
                   +----------&gt;| a9  | &lt;-SP  |
                               +-----+       v
                               | ... |       Lo
</code></pre>
</li>
</ul>
<h3 id="return-values-from-functions-2"><a class="header" href="#return-values-from-functions-2">Return values from functions</a></h3>
<ul>
<li>Integer/Pointer return values
<pre><code class="language-markdown">reg          size
-----------------
x0         64 bit
</code></pre>
</li>
</ul>
<h3 id="callee-saved-registers-2"><a class="header" href="#callee-saved-registers-2">Callee saved registers</a></h3>
<ul>
<li><code>x19</code> - <code>x28</code></li>
<li><code>SP</code></li>
</ul>
<h3 id="stack-1"><a class="header" href="#stack-1">Stack</a></h3>
<ul>
<li>full descending
<ul>
<li>full: <code>sp</code> points to the last used location (valid item)</li>
<li>descending: stack grows downwards</li>
</ul>
</li>
<li><code>sp</code> must be 16byte aligned when used to access memory for r/w</li>
<li><code>sp</code> must be 16byte aligned on public interface interfaces</li>
</ul>
<h3 id="frame-chain"><a class="header" href="#frame-chain">Frame chain</a></h3>
<ul>
<li>linked list of stack-frames</li>
<li>each frame links to the frame of its caller by a <code>frame record</code>
<ul>
<li>a frame record is described as a <code>(FP,LR)</code> pair</li>
</ul>
</li>
<li><code>x29 (FP)</code> must point to the frame record of the current stack-frame
<pre><code class="language-markdown">      +------+                   Hi
      |   0  |     frame0        |
   +-&gt;|   0  |                   |
   |  |  ... |                   |
   |  +------+                   |
   |  |  LR  |     frame1        |
   +--|  FP  |&lt;-+                |
      | ...  |  |                |
      +------+  |                |
      |  LR  |  |  current       |
x29 -&gt;|  FP  |--+  frame         v
      | ...  |                   Lo
</code></pre>
</li>
<li>end of the frame chain is indicated by following frame record <code>(0,-)</code></li>
<li>location of the frame record in the stack frame is not specified</li>
</ul>
<h3 id="function-prologue--epilogue-1"><a class="header" href="#function-prologue--epilogue-1">Function prologue &amp; epilogue</a></h3>
<ul>
<li>prologue
<pre><code class="language-armasm">sub sp, sp, 16
stp x29, x30, [sp]      // [sp] = x29; [sp + 8] = x30
mov x29, sp             // FP points to frame record
</code></pre>
</li>
<li>epilogue
<pre><code class="language-armasm">ldp x29, x30, [sp]      // x29 = [sp]; x30 = [sp + 8]
add sp, sp, 16
ret
</code></pre>
</li>
</ul>
<h2 id="asm-skeleton"><a class="header" href="#asm-skeleton">ASM skeleton</a></h2>
<p>Small assembler skeleton, ready to use with following properties:</p>
<ul>
<li>use raw Linux syscalls (<code>man 2 syscall</code> for ABI)</li>
<li>no <code>C runtime (crt)</code></li>
<li>gnu assembler <a href="https://sourceware.org/binutils/docs/as"><code>gas</code></a></li>
</ul>
<pre><code class="language-armasm">// file: greet.S

#include &lt;asm/unistd.h&gt;      // syscall NRs

    .arch armv8-a

    .section .text, "ax", @progbits
    .balign 4                // align code on 4byte boundary
    .global _start
_start:
    mov x0, 2                // fd
    ldr x1, =greeting        // buf
    ldr x2, =greeting_len    // &amp;len
    ldr x2, [x2]             // len
    mov w8, __NR_write       // write(2) syscall
    svc 0

    mov x0, 0                // exit code
    mov w8, __NR_exit        // exit(2) syscall
    svc 0

    .balign 8                // align data on 8byte boundary
    .section .rodata, "a", @progbits
greeting:
    .asciz "Hi ASM-World!\n"
greeting_len:
    .int .-greeting
</code></pre>
<blockquote>
<p>man gcc: <code>file.S</code> assembler code that must be preprocessed.</p>
</blockquote>
<p>To cross-compile and run:</p>
<pre><code class="language-bash">&gt; aarch64-linux-gnu-g++ -o greet greet.S -nostartfiles -nostdlib          \
    -Wl,--dynamic-linker=/usr/aarch64-linux-gnu/lib/ld-linux-aarch64.so.1 \
  &amp;&amp; qemu-aarch64 ./greet
Hi ASM-World!
</code></pre>
<blockquote>
<p>Cross-compiling on <code>Ubuntu 20.04 (x86_64)</code>, paths might differ on other
distributions. Explicitly specifying the dynamic linker should not be
required when compiling natively on arm64.</p>
</blockquote>
<h2 id="references-14"><a class="header" href="#references-14">References</a></h2>
<ul>
<li><a href="https://github.com/ARM-software/abi-aa/blob/master/aapcs64/aapcs64.rst">Procedure Call Standard ARM64</a></li>
<li><a href="https://developer.arm.com/documentation/den0024/latest">ARMv8-A Programmer’s Guide</a></li>
<li><a href="https://developer.arm.com/documentation/ddi0487/latest">ARMv8-A Architecture Reference Manual</a></li>
<li><a href="https://developer.arm.com/documentation/dai0527/latest">AppNote: ARMv8 Bare-metal boot code</a></li>
<li><a href="https://sourceware.org/binutils/docs/as">GNU Assembler</a></li>
<li><a href="https://sourceware.org/binutils/docs/as/Pseudo-Ops.html#Pseudo-Ops">GNU Assembler Directives</a></li>
<li><a href="https://sourceware.org/binutils/docs/as/AArch64_002dDependent.html">GNU Assembler <code>AArch64</code> dependent features</a></li>
<li><a href="https://developer.arm.com/documentation/ddi0602/latest/Base-Instructions">ARM64-A Instruction Browser</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="armv7a"><a class="header" href="#armv7a">armv7a</a></h1>
<p>keywords: arm, armv7, abi</p>
<ul>
<li>ISA type: <code>RISC</code></li>
<li>Endianness: <code>little</code>, <code>big</code></li>
</ul>
<h2 id="registers-2"><a class="header" href="#registers-2">Registers</a></h2>
<h3 id="general-purpose-registers-1"><a class="header" href="#general-purpose-registers-1">General purpose registers</a></h3>
<pre><code class="language-markdown">bytes
[3:0]     alt     desc
---------------------------------------------
r0-r12            general purpose registers
r11       fp
r13       sp      stack pointer
r14       lr      link register
r15       pc      program counter
</code></pre>
<h3 id="special-registers"><a class="header" href="#special-registers">Special registers</a></h3>
<pre><code class="language-markdown">bytes
[3:0]             desc
---------------------------------------------
cpsr              current program status register
</code></pre>
<h3 id="cpsr-register"><a class="header" href="#cpsr-register">CPSR register</a></h3>
<pre><code class="language-markdown">cpsr
bits  desc
-----------------------------
 [31]  N negative flag
 [30]  Z zero flag
 [29]  C carry flag
 [28]  V overflow flag
 [27]  Q cummulative saturation (sticky)
  [9]  E load/store endianness
  [8]  A disable asynchronous aborts
  [7]  I disable IRQ
  [6]  F disable FIQ
  [5]  T indicate Thumb state
[4:0]  M process mode (USR, FIQ, IRQ, SVC, ABT, UND, SYS)
</code></pre>
<h2 id="instructions-cheatsheet-1"><a class="header" href="#instructions-cheatsheet-1">Instructions cheatsheet</a></h2>
<h3 id="accessing-system-registers-1"><a class="header" href="#accessing-system-registers-1">Accessing system registers</a></h3>
<p>Reading from system registers:</p>
<pre><code class="language-armasm">mrs r0, cpsr      // move cpsr into r0
</code></pre>
<p>Writing to system registers:</p>
<pre><code class="language-armasm">msr cpsr, r0      // move r0 into cpsr
</code></pre>
<h3 id="control-flow-2"><a class="header" href="#control-flow-2">Control Flow</a></h3>
<pre><code class="language-armasm">b &lt;lable&gt;     // relative forward/back branch
bl &lt;lable&gt;    // relative forward/back branch &amp; link return addr in r14 (LR)

// branch &amp; exchange (can change between ARM &amp; Thumb instruction set)
//   bit Rm[0] == 0 -&gt; ARM
//   bit Rm[0] == 1 -&gt; Thumb
bx &lt;Rm&gt;       // absolute branch to address in register Rm
blx &lt;Rm&gt;      // absolute branch to address in register Rm &amp;
              // link return addr in r14 (LR)
</code></pre>
<h3 id="loadstore"><a class="header" href="#loadstore">Load/Store</a></h3>
<p>Different addressing modes.</p>
<pre><code class="language-armasm">ldr r1, [r0]                // r1 = [r0]
ldr r1, [r0, #4]            // r1 = [r0+4]

ldr r1, [r0, #4]!           // pre-inc : r0+=4; r1 = [r0]
ldr r1, [r0], #4            // post-inc: [r0] = r1; r0+=4

ldr r0, [r1, r2, lsl #3]    // r0 = [r1 + (r2&lt;&lt;3)]
</code></pre>
<p>Load/store multiple registers full-descending.</p>
<pre><code class="language-armasm">stmfd r0!, {r1-r2, r5}    // r0-=4; [r0]=r5
                          // r0-=4; [r0]=r2
                          // r0-=4; [r0]=r1
ldmfd r0!, {r1-r2, r5}    // r1=[r0]; r0+=4
                          // r2=[r0]; r0+=4
                          // r5=[r0]; r0+=4
</code></pre>
<blockquote>
<p><code>!</code> is optional but has the effect to update the base pointer register <code>r0</code> here.</p>
</blockquote>
<p>Push/Pop</p>
<pre><code class="language-armasm">push {r0-r2}    // effectively stmfd sp!, {r0-r2}
pop {r0-r2}     // effectively ldmfd sp!, {r0-r2}
</code></pre>
<h2 id="procedure-call-standard-arm-aapcs32"><a class="header" href="#procedure-call-standard-arm-aapcs32">Procedure Call Standard ARM (<a href="https://github.com/ARM-software/abi-aa/blob/master/aapcs32/aapcs32.rst"><code>aapcs32</code></a>)</a></h2>
<h3 id="passing-arguments-to-functions-2"><a class="header" href="#passing-arguments-to-functions-2">Passing arguments to functions</a></h3>
<ul>
<li>integer/pointer arguments
<pre><code class="language-markdown">reg     arg
-----------
r0        1
..       ..
r3        4
</code></pre>
</li>
<li>a double word (64bit) is passed in two consecutive registers (eg <code>r1+r2</code>)</li>
<li>additional arguments are passed on the stack. Arguments are pushed
<code>right-to-left (RTL)</code>, meaning next arguments are closer to current <code>sp</code>.
<pre><code class="language-markdown">void take(..., int a5, int a6);
                   |       |   | ... |       Hi
                   |       +--&gt;| a6  |       |
                   +----------&gt;| a5  | &lt;-SP  |
                               +-----+       v
                               | ... |       Lo
</code></pre>
</li>
</ul>
<h3 id="return-values-from-functions-3"><a class="header" href="#return-values-from-functions-3">Return values from functions</a></h3>
<ul>
<li>integer/pointer return values
<pre><code class="language-markdown">reg          size
-----------------
r0         32 bit
r0+r1      64 bit
</code></pre>
</li>
</ul>
<h3 id="callee-saved-registers-3"><a class="header" href="#callee-saved-registers-3">Callee saved registers</a></h3>
<ul>
<li><code>r4</code> - <code>r11</code></li>
<li><code>sp</code></li>
</ul>
<h3 id="stack-2"><a class="header" href="#stack-2">Stack</a></h3>
<ul>
<li>full descending
<ul>
<li>full: <code>sp</code> points to the last used location (valid item)</li>
<li>descending: stack grows downwards</li>
</ul>
</li>
<li><code>sp</code> must be 4byte aligned (word boundary) at all time</li>
<li><code>sp</code> must be 8byte aligned on public interface interfaces</li>
</ul>
<h3 id="frame-chain-1"><a class="header" href="#frame-chain-1">Frame chain</a></h3>
<ul>
<li>not strictly required by each platform</li>
<li>linked list of stack-frames</li>
<li>each frame links to the frame of its caller by a <code>frame record</code>
<ul>
<li>a frame record is described as a <code>(FP,LR)</code> pair (2x32bit)</li>
</ul>
</li>
<li><code>r11 (FP)</code> must point to the frame record of the current stack-frame
<pre><code class="language-markdown">      +------+                   Hi
      |   0  |     frame0        |
   +-&gt;|   0  |                   |
   |  |  ... |                   |
   |  +------+                   |
   |  |  LR  |     frame1        |
   +--|  FP  |&lt;-+                |
      | ...  |  |                |
      +------+  |                |
      |  LR  |  |  current       |
r11 -&gt;|  FP  |--+  frame         v
      | ...  |                   Lo
</code></pre>
</li>
<li>end of the frame chain is indicated by following frame record <code>(0,-)</code></li>
<li>location of the frame record in the stack frame is not specified</li>
<li><code>r11</code> is not updated before the new frame record is fully constructed</li>
</ul>
<h3 id="function-prologue--epilogue-2"><a class="header" href="#function-prologue--epilogue-2">Function prologue &amp; epilogue</a></h3>
<ul>
<li>prologue
<pre><code class="language-armasm">push {fp, lr}
mov fp, sp              // FP points to frame record
</code></pre>
</li>
<li>epilogue
<pre><code class="language-armasm">pop {fp, pc}            // pop LR directly into PC
</code></pre>
</li>
</ul>
<h2 id="asm-skeleton-1"><a class="header" href="#asm-skeleton-1">ASM skeleton</a></h2>
<p>Small assembler skeleton, ready to use with following properties:</p>
<ul>
<li>use raw Linux syscalls (<code>man 2 syscall</code> for ABI)</li>
<li>no <code>C runtime (crt)</code></li>
<li>gnu assembler <a href="https://sourceware.org/binutils/docs/as"><code>gas</code></a></li>
</ul>
<pre><code class="language-armasm">// file: greet.S

#include &lt;asm/unistd.h&gt;      // syscall NRs

    .arch armv7-a

    .section .text, "ax"
    .balign 4

    // Emit `arm` instructions, same as `.arm` directive.
    .code 32
    .global _start
_start:
    // Branch with link and exchange instruction set.
    blx _do_greet

    mov r0, #0               // exit code
    mov r7, #__NR_exit       // exit(2) syscall
    swi 0x0

    // Emit `thumb` instructions, same as `.thumb` directive.
    .code 16
    .thumb_func
_do_greet:
    mov r0, #2               // fd
    ldr r1, =greeting        // buf
    ldr r2, =greeting_len    // &amp;len
    ldr r2, [r2]             // len
    mov r7, #__NR_write      // write(2) syscall
    swi 0x0

    // Branch and exchange instruction set.
    bx lr

    .balign 8                // align data on 8byte boundary
    .section .rodata, "a"
greeting:
    .asciz "Hi ASM-World!\n"
greeting_len:
    .int .-greeting
</code></pre>
<blockquote>
<p>man gcc: <code>file.S</code> assembler code that must be preprocessed.</p>
</blockquote>
<p>To cross-compile and run:</p>
<pre><code class="language-bash">&gt; arm-linux-gnueabi-gcc -o greet greet.S -nostartfiles -nostdlib  \
    -Wl,--dynamic-linker=/usr/arm-linux-gnueabi/lib/ld-linux.so.3 \
  &amp;&amp; qemu-arm ./greet
Hi ASM-World!
</code></pre>
<blockquote>
<p>Cross-compiling on <code>Ubuntu 20.04 (x86_64)</code>, paths might differ on other
distributions. Explicitly specifying the dynamic linker should not be
required when compiling natively on arm.</p>
</blockquote>
<h2 id="references-15"><a class="header" href="#references-15">References</a></h2>
<ul>
<li><a href="https://github.com/ARM-software/abi-aa/blob/master/aapcs32/aapcs32.rst">Procedure Call Standard ARM</a></li>
<li><a href="https://developer.arm.com/documentation/den0013/latest">ARMv7-A Programmer’s Guide</a></li>
<li><a href="https://developer.arm.com/documentation/ddi0406/latest">ARMv7-A Architecture Reference Manual</a></li>
<li><a href="https://sourceware.org/binutils/docs/as">GNU Assembler</a></li>
<li><a href="https://sourceware.org/binutils/docs/as/Pseudo-Ops.html#Pseudo-Ops">GNU Assembler Directives</a></li>
<li><a href="https://sourceware.org/binutils/docs/as/ARM_002dDependent.html">GNU Assembler <code>ARM</code> dependent features</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="riscv"><a class="header" href="#riscv">riscv</a></h1>
<p>keywords: rv32, rv64</p>
<ul>
<li>ISA type: <code>RISC</code></li>
<li>Endianness: <code>little</code>, <code>big</code></li>
</ul>
<h2 id="registers-3"><a class="header" href="#registers-3">Registers</a></h2>
<ul>
<li>riscv32 =&gt; <code>XLEN=32</code></li>
<li>riscv64 =&gt; <code>XLEN=64</code></li>
</ul>
<h3 id="general-purpose-registers-2"><a class="header" href="#general-purpose-registers-2">General purpose registers</a></h3>
<pre><code class="language-markdown">[XLEN-1:0]     abi name     desc
---------------------------------------------
x0             zero         zero register
x1             ra           return addr
x2             sp           stack ptr
x3             gp           global ptr
x4             tp           thread ptr
x5-x7          t0-t2        temp regs
x8-x9          s0-s1        saved regs
x10-x17        a0-a7        arg regs
x18-x27        s2-s11       saved regs
x28-x31        t3-t6        temp regs
</code></pre>
<h2 id="asm-skeleton-2"><a class="header" href="#asm-skeleton-2">ASM skeleton</a></h2>
<p>Small assembler skeleton, ready to use with following properties:</p>
<ul>
<li>use raw Linux syscalls (<code>man 2 syscall</code> for ABI)</li>
<li>no <code>C runtime (crt)</code></li>
<li>gnu assembler <a href="https://sourceware.org/binutils/docs/as"><code>gas</code></a></li>
</ul>
<pre><code class="language-mipsasm">// file: greet.S

#include &lt;asm/unistd.h&gt;     // syscall NRs

    .section .text, "ax", @progbits
    .balign 4               // align code on 4byte boundary
    .global _start
_start:
    li a0, 2                // fd
    la a1, greeting         // buf
    ld a2, (greeting_len)   // &amp;len
    li a7, __NR_write       // write(2) syscall
    ecall

    li a0, 42               // exit code
    li a7, __NR_exit        // exit(2) syscall
    ecall

    .balign 8               // align data on 8byte boundary
    .section .rodata, "a", @progbits
greeting:
    .asciz "Hi ASM-World!\n"
greeting_len:
    .int .-greeting
</code></pre>
<blockquote>
<p>man gcc: <code>file.S</code> assembler code that must be preprocessed.</p>
</blockquote>
<p>To cross-compile and run:</p>
<pre><code class="language-bash">&gt; riscv64-linux-gnu-gcc -o greet greet.S -nostartfiles -nostdlib                \
    -Wl,--dynamic-linker=/usr/riscv64-linux-gnu/lib/ld-linux-riscv64-lp64d.so.1 \
  &amp;&amp; qemu-riscv64 ./greet
Hi ASM-World!
</code></pre>
<blockquote>
<p>Cross-compiling on <code>Ubuntu 20.04 (x86_64)</code>, paths might differ on other
distributions. Explicitly specifying the dynamic linker should not be
required when compiling natively on riscv.</p>
<p>Select dynamic linker according to abi used during compile &amp; link.</p>
</blockquote>
<h2 id="references-16"><a class="header" href="#references-16">References</a></h2>
<ul>
<li><a href="https://sourceware.org/binutils/docs/as">GNU Assembler</a></li>
<li><a href="https://sourceware.org/binutils/docs/as/Pseudo-Ops.html#Pseudo-Ops">GNU Assembler Directives</a></li>
<li><a href="https://github.com/johannst/rv64i-linux-user-no-std">rv64i-linux-user-no-std</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-4f6b82a4.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>


    </div>
    </body>
</html>
